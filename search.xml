<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title></title>
    <url>/bloger/2021/08/23/%E5%9B%BE%E8%A7%A3Google%20V8/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%87%BD%E6%95%B0%E6%98%AF%E4%B8%80%E7%AD%89%E5%85%AC%E6%B0%91%EF%BC%9F/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/bloger/2021/05/04/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>Electron Forge å…¥é—¨</title>
    <url>/bloger/2021/04/12/Electron/%5B%E8%AF%91%5DElectron%20Forge%20%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h1 id="Electron-Forge-å…¥é—¨"><a href="#Electron-Forge-å…¥é—¨" class="headerlink" title="Electron Forge å…¥é—¨"></a>Electron Forge å…¥é—¨</h1><blockquote>
<p>Electron Forge æ˜¯ä¸€ä¸ªé›†åˆ›å»ºï¼Œå‘å¸ƒå’Œå®‰è£…ç°ä»£ Electron åº”ç”¨äºä¸€èº«çš„å®Œå¤‡å·¥å…·é“¾ã€‚</p>
</blockquote>
<hr>
<h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># with yarn</span></span><br><span class="line">yarn create electron-app my-app</span><br><span class="line"><span class="comment"># with npm</span></span><br><span class="line">npx create-electron-app my-app</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ä½ çš„ <code>my-app</code>æ–‡ä»¶å¤¹ä¸‹é¢å°±æœ‰äº†ä¸€ä¸ªè¶…çº§å°çš„ Electron åº”ç”¨æ¨¡æ¿ã€‚è¿›å…¥ <code>my-app</code>æ–‡ä»¶å¤¹ï¼Œå¯åŠ¨é¡¹ç›®ï¼Œä½ å°±å¯ä»¥å¼€å§‹å¼€å‘äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># with yarn</span></span><br><span class="line"><span class="built_in">cd</span> my-app</span><br><span class="line">yarn start</span><br><span class="line"><span class="comment"># with npm</span></span><br><span class="line"><span class="built_in">cd</span> my-app</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>

<h2 id="æ„å»ºå‘è¡Œç‰ˆ"><a href="#æ„å»ºå‘è¡Œç‰ˆ" class="headerlink" title="æ„å»ºå‘è¡Œç‰ˆ"></a>æ„å»ºå‘è¡Œç‰ˆ</h2><p>ç°åœ¨ä½ å¯ä»¥æŠŠä½ çš„åº”ç”¨å’Œå…¨ä¸–ç•Œåˆ†äº«ã€‚å½“ä½ è¿è¡Œ<code>make</code> è„šæœ¬æ—¶ï¼Œ Electron Forge<br>ä¼šç”Ÿæˆå¯¹åº”å¹³å°çš„å‘è¡Œç‰ˆã€‚äº†è§£ä½ å¯ä»¥æ„å»ºçš„å‘è¡Œç‰ˆç±»å‹ï¼Œè¯·å‚è€ƒ<a href="https://www.electronforge.io/config/makers">Makers </a>æ–‡æ¡£ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># with yarn</span></span><br><span class="line">yarn make</span><br><span class="line"><span class="comment"># with npm</span></span><br><span class="line">npm run make</span><br></pre></td></tr></table></figure>

<h2 id="é«˜é˜¶ä½¿ç”¨"><a href="#é«˜é˜¶ä½¿ç”¨" class="headerlink" title="é«˜é˜¶ä½¿ç”¨"></a>é«˜é˜¶ä½¿ç”¨</h2><p>æœ‰äº†ä¸€ä¸ªå…¥é—¨çº§çš„åº”ç”¨ï¼Œä½ å°±å¯ä»¥æ„å»ºå‘è¡Œç‰ˆäº†ã€‚äº†è§£æ›´å¤šé«˜é˜¶åŠŸèƒ½ï¼Œå¯ä»¥å‚è€ƒï¼š</p>
<p><a href="https://www.electronforge.io/config/publishers">Publishers</a></p>
<p><a href="https://www.electronforge.io/advanced/debugging">Debugging your app</a></p>
<p><a href="https://www.electronforge.io/config/plugins/webpack">Webpack support</a></p>
<p><a href="https://www.electronforge.io/advanced/extending-electron-forge">Writing your own makers, publishers and plugins</a></p>
]]></content>
      <categories>
        <category>Electron</category>
      </categories>
  </entry>
  <entry>
    <title>How to build an Electron app using Create React App and Electron Builder</title>
    <url>/bloger/2021/07/31/Electron/%5B%E8%AF%91%5D%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Create%20React%20App%E5%92%8CElectron%20Builder%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAElectron%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<h1 id="å¦‚ä½•ä½¿ç”¨-Create-React-App-å’Œ-Electron-Builder-æ„å»º-Electron-åº”ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨-Create-React-App-å’Œ-Electron-Builder-æ„å»º-Electron-åº”ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ Create React App å’Œ Electron Builder æ„å»º Electron åº”ç”¨"></a>å¦‚ä½•ä½¿ç”¨ Create React App å’Œ Electron Builder æ„å»º Electron åº”ç”¨</h1><p><img src="https://finbits.io/images/blog/electron-react.jpg" alt="Electron-React"></p>
<p>æœ€è¿‘æˆ‘å†³å®šåšä¸€ä¸ªæ¡Œé¢åº”ç”¨æ¥ä¸‹è½½å’Œä¿å­˜æˆ‘çš„ Google Photosã€‚å› ä¸ºæˆ‘æ›¾è¢«ä¸¢å¤±æ‰€æœ‰ç…§ç‰‡æŠ˜ç£¨å¤Ÿäº†ã€‚è™½ç„¶ Google æœ¬èº«æœ‰ä¸€äº›é€‰é¡¹å¯ä»¥é…ç½®å®ç°ï¼Œä½†æ˜¯å®è·µä¸‹æ¥è²Œä¼¼éƒ½æœ‰é—®é¢˜ã€‚</p>
<p>å¦‚æœä½ æƒ³ä½¿ç”¨è¿™æ¬¾åº”ç”¨ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½ <a href="https://finbits.io/downloads/photosdownloader-0.1.1.dmg">OSX</a><br>æˆ–è€… <a href="https://finbits.io/downloads/photosdownloader-0.1.1.exe">WIN</a>ã€‚</p>
<p>æŠ€æœ¯æ ˆä¸Šæˆ‘é€‰æ‹© Electron å’Œ React,å› ä¸ºè¿™ä½¿å¾—æˆ‘çš„å·¥ä½œå¾ˆæœ‰è¶£,è€Œä¸”æœ€ç»ˆæ•ˆæœä¸é”™.</p>
<p>åœ¨è¿™ç¯‡åšå®¢ä¸­,æˆ‘ä¼šåˆ†äº«ä¸€äº›é…ç½®å’Œæˆ‘è¸©è¿‡çš„å‘ã€‚</p>
<p>æˆ‘åˆšå¼€å§‹å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘å‚è€ƒäº†è¿™ä¸¤ç¯‡åšå®¢ <a href="https://medium.com/@kitze/%EF%B8%8F-from-react-to-an-electron-app-ready-for-production-a0468ecb1da3">1</a><br>å’Œ <a href="https://medium.freecodecamp.org/building-an-electron-application-with-create-react-app-97945861647c">2</a>ï¼Œæ„Ÿè°¢ã€‚</p>
<p>å¥½çš„ï¼Œç»“ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥å­¦å­¦å¦‚ä½•æ„å»ºä¸€ä¸ªä½¿ç”¨ Create React App å¼€å‘çš„ Electron åº”ç”¨ï¼Œç„¶ååœ¨ä½¿ç”¨ Electron Builder è¿›è¡Œæ‰“åŒ…åˆ†å‘ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æ•´ä¸ªæŠ€æœ¯æ ˆç„¶åå†å¼€å§‹ã€‚å¦‚æœä½ æƒ³è·³è¿‡ï¼Œå¯ä»¥ç›´æ¥çœ‹<a href="https://github.com/rgfindl/electron-cra-boilerplate">æºç </a></p>
<h2 id="æŠ€æœ¯æ ˆ"><a href="#æŠ€æœ¯æ ˆ" class="headerlink" title="æŠ€æœ¯æ ˆ"></a>æŠ€æœ¯æ ˆ</h2><ul>
<li><a href="https://electronjs.org/">Electron</a></li>
<li><a href="https://github.com/facebook/create-react-app">React - Create React App</a></li>
<li><a href="https://github.com/harrysolovay/rescripts">Rescripts</a></li>
<li><a href="https://github.com/electron-userland/electron-builder">Electron Builder</a></li>
</ul>
<p><a href="https://electronjs.org/">Electron</a> æ˜¯ä¸€ä¸ªä½¿ç”¨ JavaScript, HTML, and CSS ç­‰ Web æŠ€æœ¯åˆ›å»ºåŸç”Ÿåº”ç”¨çš„æ¡†æ¶ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ React</p>
<p><a href="https://reactjs.org/">React</a> æ˜¯æ„å»ºç”¨æˆ·ç•Œé¢çš„ JavaScript åº“â€¦â€¦</p>
<p>ä¸ºäº†è®©æˆ‘ä»¬çš„ React é¡¹ç›®é…ç½®æ›´å®¹æ˜“ï¼Œæˆ‘ä»¬ä½¿ç”¨<a href="https://github.com/facebook/create-react-app">Create React App</a>å¿«é€Ÿåˆ›å»º React é¡¹ç›®ã€‚Create React<br>App (CRA)å¾ˆæ£’ï¼Œå› ä¸ºå®ƒèŠ‚çœäº†æ—¶é—´ï¼Œå¹¶æ¶ˆé™¤äº†é…ç½®éš¾é¢˜ã€‚</p>
<p>Create React App æ˜¯ä¸€ä¸ªå¯ä»¥è®©ä½ åœ¨æ„å»ºåº”ç”¨æ—¶è·å¾—å…ˆå‘ä¼˜åŠ¿çš„å·¥å…·ï¼Œç”± Facebook å¼€å‘è€…åˆ›å»ºã€‚å®ƒèŠ‚çœäº†å®‰è£…å’Œé…ç½®çš„æ—¶é—´ã€‚ä½ åªéœ€è¦ç®€å•åœ°è¿è¡Œä¸€ä¸ªå‘½ä»¤ï¼ŒCreate React App å°±ä¼šå¸®ä½ å®‰è£…å¥½ç”¨äºå¯åŠ¨é¡¹ç›®çš„å·¥å…·</p>
<p><a href="https://github.com/harrysolovay/rescripts">Rescripts</a> å¯ä»¥è®©ä½ æ— éœ€<code>eject</code>ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ CRAã€‚</p>
<p>å¼¹å‡º(<code>eject</code>) CRA æ˜¯ä½ åº”è¯¥é¿å…çš„æ“ä½œï¼Œå› ä¸ºè¿™å°†æ„å‘³ç€ä½ å†ä¹Ÿä¸ä¼šå—ç›Šäº CRA çš„æœªæ¥æ›´æ–°ã€‚</p>
<p><a href="https://github.com/electron-userland/electron-builder">Electron Builder</a> ç”¨äºæ‰“åŒ…æˆ‘ä»¬çš„æ¡Œé¢åº”ç”¨è¿›è¡Œåˆ†å‘ã€‚</p>
<h2 id="é¡¹ç›®æ­å»º"><a href="#é¡¹ç›®æ­å»º" class="headerlink" title="é¡¹ç›®æ­å»º"></a>é¡¹ç›®æ­å»º</h2><p>ä½¿ç”¨ Create React App å¿«é€Ÿåˆ›å»ºé¡¹ç›®</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npx create-react-app my-app</span><br><span class="line">cd my-app</span><br></pre></td></tr></table></figure>

<p>å®‰è£… Electron</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn add electron electron-builder --dev</span><br></pre></td></tr></table></figure>

<p>å’Œä¸€äº›æˆ‘ä»¬éœ€è¦çš„å·¥å…·</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn add wait-on concurrently --dev</span><br><span class="line">yarn add electron-is-dev</span><br></pre></td></tr></table></figure>

<p>åˆ›å»º<code>public/electron.js</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> electron = <span class="built_in">require</span>(<span class="string">&quot;electron&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = electron.app;</span><br><span class="line"><span class="keyword">const</span> BrowserWindow = electron.BrowserWindow;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> isDev = <span class="built_in">require</span>(<span class="string">&quot;electron-is-dev&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mainWindow;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWindow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  mainWindow = <span class="keyword">new</span> BrowserWindow(&#123; <span class="attr">width</span>: <span class="number">900</span>, <span class="attr">height</span>: <span class="number">680</span> &#125;);</span><br><span class="line">  mainWindow.loadURL(</span><br><span class="line">    isDev</span><br><span class="line">      ? <span class="string">&quot;http://localhost:3000&quot;</span></span><br><span class="line">      : <span class="string">`file://<span class="subst">$&#123;path.join(__dirname, <span class="string">&quot;../build/index.html&quot;</span>)&#125;</span>`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (isDev) &#123;</span><br><span class="line">    <span class="comment">// Open the DevTools.</span></span><br><span class="line">    <span class="comment">//BrowserWindow.addDevToolsExtension(&#x27;&lt;location to your react chrome extension&gt;&#x27;);</span></span><br><span class="line">    mainWindow.webContents.openDevTools();</span><br><span class="line">  &#125;</span><br><span class="line">  mainWindow.on(<span class="string">&quot;closed&quot;</span>, <span class="function">() =&gt;</span> (mainWindow = <span class="literal">null</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&quot;ready&quot;</span>, createWindow);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&quot;window-all-closed&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.platform !== <span class="string">&quot;darwin&quot;</span>) &#123;</span><br><span class="line">    app.quit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&quot;activate&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (mainWindow === <span class="literal">null</span>) &#123;</span><br><span class="line">    createWindow();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>package.json</code>æ–‡ä»¶çš„<code>scripts</code> é¡¹æ·»åŠ å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&quot;electron-dev&quot;: &quot;concurrently \&quot;BROWSER=none yarn start\&quot; \&quot;wait-on http://localhost:3000 &amp;&amp; electron .\&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª<code>script</code>å°†ä¼šåœ¨å¯åŠ¨ Electron ä¹‹å‰ ç­‰å¾…åº”ç”¨åœ¨<code>localhost:3000</code>è¿è¡Œèµ·æ¥ã€‚</p>
<p>åœ¨<code>package.json</code>æ–‡ä»¶çš„<code>main</code> é¡¹æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;main&quot;: &quot;public/electron.js&quot;,</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œä½ çš„ <code>package.json</code>åº”è¯¥æ˜¯è¿™æ ·çš„</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;my-app&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;private&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;electron-is-dev&quot;</span>: <span class="string">&quot;^1.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react&quot;</span>: <span class="string">&quot;^16.8.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-dom&quot;</span>: <span class="string">&quot;^16.8.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-scripts&quot;</span>: <span class="string">&quot;2.1.5&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;public/electron.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;react-scripts start&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;react-scripts build&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;test&quot;</span>: <span class="string">&quot;react-scripts test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eject&quot;</span>: <span class="string">&quot;react-scripts eject&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron-dev&quot;</span>: <span class="string">&quot;concurrently \&quot;BROWSER=none yarn start\&quot; \&quot;wait-on http://localhost:3000 &amp;&amp; electron .\&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;eslintConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;extends&quot;</span>: <span class="string">&quot;react-app&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;browserslist&quot;</span>: [<span class="string">&quot;&gt;0.2%&quot;</span>, <span class="string">&quot;not dead&quot;</span>, <span class="string">&quot;not ie &lt;= 11&quot;</span>, <span class="string">&quot;not op_mini all&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;concurrently&quot;</span>: <span class="string">&quot;^4.1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron&quot;</span>: <span class="string">&quot;^4.0.6&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron-builder&quot;</span>: <span class="string">&quot;^20.38.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;wait-on&quot;</span>: <span class="string">&quot;^3.2.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä»¥å¼€å‘æ¨¡å¼å¯åŠ¨ä½ çš„é¡¹ç›®</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn electron-dev</span><br></pre></td></tr></table></figure>

<p>ä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸‹å›¾è¿™æ ·<br><img src="https://finbits.io/images/blog/electron-boilerplate.png" alt="electron-boilerplate"><br>å¦‚æœä½ çœ‹åˆ°äº†ï¼Œæ­å–œä½ å¯ä»¥è¿›è¡Œæ¥ä¸‹æ¥çš„å¼€å‘äº†ã€‚ğŸ¤©</p>
<p>Now, if you need to access the <code>fs</code> module like I did, youâ€™ll quickly hit the <code>Module not found</code> error.<br>See <a href="https://stackoverflow.com/questions/35428639/how-can-i-use-fs-in-react-with-electron">here</a>. å¦‚æœä½ éœ€è¦ä½¿ç”¨<code>fs</code><br>æ¨¡å—ï¼Œä½ å¯èƒ½å¾ˆå¿«å°±ä¼šé‡åˆ°<code>Module not found</code><br>è¿™æ ·çš„é”™è¯¯ã€‚<a href="https://stackoverflow.com/questions/35428639/how-can-i-use-fs-in-react-with-electron">å‚è€ƒ</a></p>
<p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®<code>Webpack</code>çš„<code>target</code>ä¸º<code>electron-renderer</code>ã€‚ä½†æ˜¯å“¦æˆ‘ä»¬ä¸æƒ³å¼¹å‡º(eject) CRA<br>å»åšè¿™ä»¶äº‹ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨<a href="https://github.com/harrysolovay/rescripts">Rescripts</a>ã€‚ä¸‹é¢æ•™ä½ å¦‚ä½•ä½¿ç”¨ã€‚</p>
<p>é¦–å…ˆï¼Œå®‰è£…<code>Rescripts</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn add @rescripts/cli @rescripts/rescript-env --dev</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œå°† <code>package.json</code>é‡Œé¢çš„<code>scripts</code> é¡¹ä»</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&quot;start&quot;: &quot;react-scripts start&quot;,</span><br><span class="line">&quot;build&quot;: &quot;react-scripts build&quot;,</span><br><span class="line">&quot;test&quot;: &quot;react-scripts test&quot;,</span><br></pre></td></tr></table></figure>

<p>æ”¹ä¸º</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&quot;start&quot;: &quot;rescripts start&quot;,</span><br><span class="line">&quot;build&quot;: &quot;rescripts build&quot;,</span><br><span class="line">&quot;test&quot;: &quot;rescripts test&quot;,</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æ–°å»º <code>.rescriptsrc.js</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = [<span class="built_in">require</span>.resolve(<span class="string">&quot;./.webpack.config.js&quot;</span>)];</span><br></pre></td></tr></table></figure>

<p>æœ€åæ–°å»º<code>.webpack.config.js</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// define child rescript</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">  config.target = <span class="string">&quot;electron-renderer&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°±å¯ä»¥æ— éœ€æ‹…å¿ƒåœ°ä½¿ç”¨<code>fs</code> æ¨¡å—äº†</p>
<h2 id="å¼€å§‹æ‰“åŒ…"><a href="#å¼€å§‹æ‰“åŒ…" class="headerlink" title="å¼€å§‹æ‰“åŒ…"></a>å¼€å§‹æ‰“åŒ…</h2><p>éå¸¸æ£’ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å‡†å¤‡æ‰“åŒ…æˆ‘ä»¬çš„é¡¹ç›®äº†</p>
<p>é¦–å…ˆï¼Œå®‰è£… Electron Builder å’Œ Typescript</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn add electron-builder typescript --dev</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹ CRA ä¼šä½¿ç”¨ç»å¯¹è·¯å¾„æ„å»ºä¿®æ”¹<code>index.html</code>æ–‡ä»¶ã€‚è¿™ä¼šä½¿å¾— Electron åŠ è½½å‡ºé”™ã€‚è¿™éœ€è¦ä¸€äº›é…ç½®æ¥ä¿®æ­£ã€‚</p>
<p>å°† <code>package.json</code>ä¸­çš„<code>homepage</code>é¡¹çš„å€¼è®¾ä¸º</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;homepage&quot;: &quot;./&quot;,</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ·»åŠ ç»™<code>package.json</code>çš„<code>scripts</code> é¡¹æ·»åŠ <code>electron-pack</code>å‘½ä»¤ç”¨äºæ‰“åŒ…æ„å»º(build)ç»“æœ</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;postinstall&quot;: &quot;electron-builder install-app-deps&quot;,</span><br><span class="line">&quot;preelectron-pack&quot;: &quot;yarn build&quot;,</span><br><span class="line">&quot;electron-pack&quot;: &quot;build -mw&quot;</span><br></pre></td></tr></table></figure>

<p><code>&quot;postinstall&quot;: &quot;electron-builder install-app-deps&quot;</code> å°†ä¼šç¡®ä¿ä½ çš„åŸç”Ÿä¾èµ–æ€»æ˜¯ä¼šåŒ¹é… <code>electron</code> çš„ç‰ˆæœ¬</p>
<p><code>&quot;preelectron-pack&quot;: &quot;yarn build&quot;</code> ç”¨äºæ„å»º(build) CRA é¡¹ç›®</p>
<p><code>&quot;electron-pack&quot;: &quot;build -mw&quot;</code> ç”¨äºæ‰“åŒ… <code>Mac (m) </code>å’Œ <code>Windows (w)</code>åº”ç”¨</p>
<p>åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œè¿™ä¸ªå‘½ä»¤ä¹‹å‰åœ¨<code>package.json</code>é‡Œç»™ Electron Builder é…ç½®å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;author&quot;: &#123;</span><br><span class="line">&quot;name&quot;: &quot;Your Name&quot;,</span><br><span class="line">&quot;email&quot;: &quot;your.email@domain.com&quot;,</span><br><span class="line">&quot;url&quot;: &quot;https://your-website.com&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;build&quot;: &#123;</span><br><span class="line">&quot;appId&quot;: &quot;com.my-website.my-app&quot;,</span><br><span class="line">&quot;productName&quot;: &quot;MyApp&quot;,</span><br><span class="line">&quot;copyright&quot;: &quot;Copyright Â© 2019 $&#123;author&#125;&quot;,</span><br><span class="line">&quot;mac&quot;: &#123;</span><br><span class="line">&quot;category&quot;: &quot;public.app-category.utilities&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;files&quot;: [</span><br><span class="line">&quot;build/**/*&quot;,</span><br><span class="line"><span class="string">&quot;node_modules/**/*&quot;</span></span><br><span class="line">],</span><br><span class="line">&quot;directories&quot;: &#123;</span><br><span class="line">&quot;buildResources&quot;: &quot;assets&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥åœ¨åœ¨ <a href="https://www.electron.build/configuration/configuration">è¿™é‡Œ</a>æŸ¥çœ‹åœ¨æ‰€æœ‰çš„ Electron Builder é…ç½®é¡¹</p>
<p>ä½ å¯èƒ½è¿˜ä¼šåˆ›å»º<code>assets</code> æ–‡ä»¶å¤¹ä»¥å­˜æ”¾åº”ç”¨çš„å›¾æ ‡(icon)ã€‚æ ¼å¼å¯ä»¥å‚è€ƒ <a href="https://www.electron.build/icons">è¿™é‡Œ</a></p>
<p>æœ€ç»ˆæ•´ä¸ª <code>package.json</code> å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;my-app&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Electron + Create React App + Electron Builder&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;private&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Your Name&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;your.email@domain.com&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://your-website.com&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;build&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;appId&quot;</span>: <span class="string">&quot;com.my-website.my-app&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;productName&quot;</span>: <span class="string">&quot;MyApp&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;copyright&quot;</span>: <span class="string">&quot;Copyright Â© 2019 $&#123;author&#125;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;mac&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;public.app-category.utilities&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;files&quot;</span>: [<span class="string">&quot;build/**/*&quot;</span>, <span class="string">&quot;node_modules/**/*&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;directories&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;buildResources&quot;</span>: <span class="string">&quot;assets&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;electron-is-dev&quot;</span>: <span class="string">&quot;^1.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react&quot;</span>: <span class="string">&quot;^16.8.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-dom&quot;</span>: <span class="string">&quot;^16.8.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-scripts&quot;</span>: <span class="string">&quot;2.1.5&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;homepage&quot;</span>: <span class="string">&quot;./&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;public/electron.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;rescripts start&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;rescripts build&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;test&quot;</span>: <span class="string">&quot;rescripts test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eject&quot;</span>: <span class="string">&quot;react-scripts eject&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron-dev&quot;</span>: <span class="string">&quot;concurrently \&quot;BROWSER=none yarn start\&quot; \&quot;wait-on http://localhost:3000 &amp;&amp; electron .\&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;postinstall&quot;</span>: <span class="string">&quot;electron-builder install-app-deps&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;preelectron-pack&quot;</span>: <span class="string">&quot;yarn build&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron-pack&quot;</span>: <span class="string">&quot;build -mw&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;eslintConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;extends&quot;</span>: <span class="string">&quot;react-app&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;browserslist&quot;</span>: [<span class="string">&quot;&gt;0.2%&quot;</span>, <span class="string">&quot;not dead&quot;</span>, <span class="string">&quot;not ie &lt;= 11&quot;</span>, <span class="string">&quot;not op_mini all&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@rescripts/cli&quot;</span>: <span class="string">&quot;^0.0.10&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@rescripts/rescript-env&quot;</span>: <span class="string">&quot;^0.0.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;concurrently&quot;</span>: <span class="string">&quot;^4.1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron&quot;</span>: <span class="string">&quot;^4.0.6&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron-builder&quot;</span>: <span class="string">&quot;^20.38.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;typescript&quot;</span>: <span class="string">&quot;^3.3.3333&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;wait-on&quot;</span>: <span class="string">&quot;^3.2.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬å‡†å¤‡å¥½æ‰“åŒ…åº”ç”¨ã€‚è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn electron-pack</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆä½ ä¼šåœ¨ <code>dist</code> ç›®å½•çœ‹åˆ°æ‰“åŒ…ç»“æœ</p>
<p>å¥½äº†ï¼Œè¯¥ä½ ä¸Šæ‰‹å®è·µäº†ã€‚</p>
<p>æºç åœ¨ <a href="https://github.com/rgfindl/electron-cra-boilerplate">è¿™é‡Œ</a></p>
<p>å¸Œæœ›è¿™è¿™ç¯‡åšå®¢å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚ Bye!</p>
]]></content>
      <categories>
        <category>Electron</category>
      </categories>
  </entry>
  <entry>
    <title>ES6ç›¸å…³</title>
    <url>/bloger/2021/08/24/JavaScript/ES6%E7%9B%B8%E5%85%B3/</url>
    <content><![CDATA[<h1 id="ES6-ç›¸å…³"><a href="#ES6-ç›¸å…³" class="headerlink" title="ES6 ç›¸å…³"></a>ES6 ç›¸å…³</h1><h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><p>Proxy ç”¨äºä¿®æ”¹æŸäº›æ“ä½œçš„é»˜è®¤è¡Œä¸ºï¼Œç­‰åŒäºåœ¨è¯­è¨€å±‚é¢åšå‡ºä¿®æ”¹ï¼Œæ‰€ä»¥å±äºä¸€ç§â€œå…ƒç¼–ç¨‹â€ï¼ˆmeta programmingï¼‰ï¼Œå³å¯¹ç¼–ç¨‹è¯­è¨€è¿›è¡Œç¼–ç¨‹</p>
<p>å¯ä»¥è¿™æ ·ç†è§£ï¼ŒProxy å°±æ˜¯åœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰è®¾ç½®çš„ä¸€å±‚æ‹¦æˆª,å¤–ç•Œæƒ³è¦è®¿é—®éƒ½è¦ç»è¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚</p>
<p>Proxy åœ¨è¿™é‡Œå¯ä»¥ç†è§£ä¸ºä»£ç†å™¨</p>
<p>å£°æ˜ï¼š const proxy = new Proxy(target, handler)</p>
<ul>
<li>target: æ‹¦æˆªçš„å¯¹è±¡</li>
<li>handler: å®šä¹‰æ‹¦æˆªçš„æ–¹æ³•</li>
</ul>
<p>æ–¹æ³•ï¼š</p>
<ul>
<li>get(): æ‹¦æˆªå¯¹è±¡å±æ€§çš„è¯»å–</li>
<li>set(): æ‹¦æˆªå¯¹è±¡è®¾ç½®å±æ€§,è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼</li>
<li>has(): æ‹¦æˆª propKey in proxy çš„æ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼</li>
<li>ownKeys(): æ‹¦æˆªå¯¹è±¡å±æ€§éå†ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„</li>
<li>deleteProperty()ï¼šæ‹¦æˆª delete proxy[propKey] çš„æ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼()</li>
<li>apply()ï¼šæ‹¦æˆªå‡½æ•°çš„è°ƒç”¨ï¼Œcall å’Œ apply æ“ä½œ</li>
<li>construct()ï¼šæ‹¦æˆª new å‘½ä»¤ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡: æ‹¦æˆª new å‘½ä»¤ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  name: <span class="string">&quot;oliver&quot;</span>,</span><br><span class="line">  time: <span class="string">&quot;2022-01-27&quot;</span>,</span><br><span class="line">  value: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">  <span class="comment">//get()</span></span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> target[key].replace(<span class="string">&quot;2022&quot;</span>, <span class="string">&quot;2015&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">//set()</span></span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&quot;name&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (target[key] = value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> target[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// has()</span></span><br><span class="line">  <span class="function"><span class="title">has</span>(<span class="params">target, key</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&quot;name&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> target[key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// deleteProperty()</span></span><br><span class="line">  <span class="function"><span class="title">deleteProperty</span>(<span class="params">target, key</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.indexOf(<span class="string">&quot;_&quot;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> target[key];</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> target[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ownKeys()</span></span><br><span class="line">  <span class="function"><span class="title">ownKeys</span>(<span class="params">target</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.keys(target).filter(<span class="function">(<span class="params">item</span>) =&gt;</span> item != <span class="string">&quot;time&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(data.time); <span class="comment">// 2015-01-27</span></span><br><span class="line"></span><br><span class="line">data.time = <span class="string">&quot;2020&quot;</span>;</span><br><span class="line">data.name = <span class="string">&quot;React&quot;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(data); <span class="comment">//ProxyÂ &#123;name: &#x27;React&#x27;, time: &#x27;2022-01-27&#x27;, value: 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹¦æˆªhas()</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;name&quot;</span> <span class="keyword">in</span> data); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;time&quot;</span> <span class="keyword">in</span> data); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤deleteProperty()</span></span><br><span class="line"><span class="keyword">delete</span> monitor.time; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éå† ownKeys()</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.keys(data)); <span class="comment">//[&#x27;name&#x27;, &#x27;value&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//apply()</span></span><br><span class="line"><span class="keyword">let</span> sum = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> num = <span class="number">0</span>;</span><br><span class="line">  args.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    num += item;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> num;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">sum = <span class="keyword">new</span> <span class="built_in">Proxy</span>(sum, &#123;</span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">target, ctx, args</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> target(...args) * <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(sum(<span class="number">1</span>, <span class="number">2</span>)); <span class="comment">// 6</span></span><br><span class="line"><span class="built_in">console</span>.log(sum.call(<span class="literal">null</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)); <span class="comment">// 12</span></span><br><span class="line"><span class="built_in">console</span>.log(sum.apply(<span class="literal">null</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])); <span class="comment">// 12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//constructor()</span></span><br><span class="line"><span class="keyword">let</span> User = <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">User = <span class="keyword">new</span> <span class="built_in">Proxy</span>(User, &#123;</span><br><span class="line">  <span class="function"><span class="title">construct</span>(<span class="params">target, args, newTarget</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> target(...args);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> User(<span class="string">&quot;oliver&quot;</span>)); <span class="comment">// UserÂ &#123;name: &#x27;oliver&#x27;&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
  </entry>
  <entry>
    <title>å¸¸è§æ‰‹å†™æ–¹æ³•</title>
    <url>/bloger/2021/08/28/JavaScript/%E5%B8%B8%E8%A7%81%E6%89%8B%E5%86%99%E4%BB%A3%E7%A0%81/</url>
    <content><![CDATA[<h1 id="å¸¸è§æ‰‹å†™æ–¹æ³•"><a href="#å¸¸è§æ‰‹å†™æ–¹æ³•" class="headerlink" title="å¸¸è§æ‰‹å†™æ–¹æ³•"></a>å¸¸è§æ‰‹å†™æ–¹æ³•</h1><h2 id="é˜²æŠ–å‡½æ•°"><a href="#é˜²æŠ–å‡½æ•°" class="headerlink" title="é˜²æŠ–å‡½æ•°"></a>é˜²æŠ–å‡½æ•°</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é˜²æŠ–debounce</span></span><br><span class="line"><span class="comment">// åŸç†ï¼šä¸€å®šæ—¶é—´å†…è¿ç»­è§¦å‘çš„äº‹ä»¶åªåœ¨æœ€åæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨åœºæ™¯ï¼šçŸ­ä¿¡éªŒè¯ç ï¼Œæäº¤è¡¨å•ï¼Œæœç´¢ï¼Œ è¾“å…¥ï¼Œresizeç­‰</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">func, delay</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> timeout = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…æ¥šå‰ä¸€ä¸ªtimeout</span></span><br><span class="line">    <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line"></span><br><span class="line">    timeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      func.apply(<span class="built_in">this</span>, argrments);</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="èŠ‚æµå‡½æ•°"><a href="#èŠ‚æµå‡½æ•°" class="headerlink" title="èŠ‚æµå‡½æ•°"></a>èŠ‚æµå‡½æ•°</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// èŠ‚æµthrottle</span></span><br><span class="line"><span class="comment">// åŸç†ï¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œåªæ‰§è¡Œä¸€æ¬¡å‡½æ•°</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨åœºæ™¯ï¼šscroll, load, input, search, video</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">func, delay</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> canNext = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!canNext) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    canNext = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      func.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      canNext = <span class="literal">true</span>;</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ·±æ‹·è´"><a href="#æ·±æ‹·è´" class="headerlink" title="æ·±æ‹·è´"></a>æ·±æ‹·è´</h2><p>JSON.parse(JSON.stringify) æˆ–è€… é€’å½’å…‹éš†</p>
<p>å‰è€…ä»…æ”¯æŒ object, array, string, number, true, false, null</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‚è€ƒ: https://github.com/Matthrews/node_study/blob/main/%E6%89%8B%E5%86%99%E6%BA%90%E7%A0%81/Object/deepCopy/note.md</span></span><br><span class="line"><span class="comment">// TODO cacheä¼šè¶Šæ¥æ„ˆå¤šï¼Œcacheåº”è¯¥åªæ˜¯å’Œå¯¹è±¡ç›¸å…³çš„ï¼Œè§£å†³æ–¹æ³•æ˜¯å°†deepCloneæ–¹æ³•å¸è½½å¯¹è±¡Cloneré‡Œé¢ï¼Œcacheä½œä¸ºClonerå±æ€§å­˜åœ¨</span></span><br><span class="line"><span class="keyword">const</span> cache = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deepClone</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (source <span class="keyword">instanceof</span> <span class="built_in">Object</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cacheDist = findCache(source);</span><br><span class="line">    <span class="keyword">if</span> (cacheDist) &#123;</span><br><span class="line">      <span class="keyword">return</span> cacheDist;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> dist;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (source <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">        dist = [];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (source <span class="keyword">instanceof</span> <span class="built_in">Function</span>) &#123;</span><br><span class="line">        dist = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> source.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (source <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">        dist = <span class="keyword">new</span> <span class="built_in">RegExp</span>(source.source, source.flags);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (source <span class="keyword">instanceof</span> <span class="built_in">Date</span>) &#123;</span><br><span class="line">        dist = <span class="keyword">new</span> <span class="built_in">Date</span>(source);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dist = &#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      cache.push([source, dist]);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> sourceKey <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (source.hasOwnProperty(sourceKey)) &#123;</span><br><span class="line">          dist[sourceKey] = deepClone(source[sourceKey]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> dist;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findCache</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> source_dist <span class="keyword">of</span> cache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (source_dist[<span class="number">0</span>] === source) &#123;</span><br><span class="line">      <span class="keyword">return</span> source_dist[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ·±æ¯”è¾ƒ"><a href="#æ·±æ¯”è¾ƒ" class="headerlink" title="æ·±æ¯”è¾ƒ"></a>æ·±æ¯”è¾ƒ</h2><p>JSON.stringify æˆ–è€… Object.toJSON æˆ–è€… é€’å½’æ¯”è¾ƒ</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®ç°ä¸€ä¸ªæ·±åº¦æ¯”è¾ƒå‡½æ•°ï¼Œéœ€è¦æ”¯æŒ å¯¹è±¡ã€æ•°ç»„ã€æ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compare</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i, l, leftChain, rightChain;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">compare2Objects</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> p;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember that NaN === NaN returns false</span></span><br><span class="line">    <span class="comment">// and isNaN(undefined) returns true</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="built_in">isNaN</span>(x) &amp;&amp;</span><br><span class="line">      <span class="built_in">isNaN</span>(y) &amp;&amp;</span><br><span class="line">      <span class="keyword">typeof</span> x === <span class="string">&quot;number&quot;</span> &amp;&amp;</span><br><span class="line">      <span class="keyword">typeof</span> y === <span class="string">&quot;number&quot;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compare primitives and functions</span></span><br><span class="line">    <span class="keyword">if</span> (x === y) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Works in case when functions are created in constructor</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (<span class="keyword">typeof</span> x === <span class="string">&quot;function&quot;</span> &amp;&amp; <span class="keyword">typeof</span> y === <span class="string">&quot;function&quot;</span>) ||</span><br><span class="line">      (x <span class="keyword">instanceof</span> <span class="built_in">Date</span> &amp;&amp; y <span class="keyword">instanceof</span> <span class="built_in">Date</span>) ||</span><br><span class="line">      (x <span class="keyword">instanceof</span> <span class="built_in">RegExp</span> &amp;&amp; y <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) ||</span><br><span class="line">      (x <span class="keyword">instanceof</span> <span class="built_in">String</span> &amp;&amp; y <span class="keyword">instanceof</span> <span class="built_in">String</span>) ||</span><br><span class="line">      (x <span class="keyword">instanceof</span> <span class="built_in">Number</span> &amp;&amp; y <span class="keyword">instanceof</span> <span class="built_in">Number</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> x.toString() === y.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// At last checking prototypes as good as we can</span></span><br><span class="line">    <span class="keyword">if</span> (!(x <span class="keyword">instanceof</span> <span class="built_in">Object</span> &amp;&amp; y <span class="keyword">instanceof</span> <span class="built_in">Object</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x.isPrototypeOf(y) || y.isPrototypeOf(x)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x.constructor !== y.constructor) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x.prototype !== y.prototype) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for infinitive linking loops</span></span><br><span class="line">    <span class="keyword">if</span> (leftChain.indexOf(x) &gt; -<span class="number">1</span> || rightChain.indexOf(y) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Quick checking infinitive linking loops</span></span><br><span class="line">    <span class="keyword">for</span> (p <span class="keyword">in</span> y) &#123;</span><br><span class="line">      <span class="keyword">if</span> (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> y[p] !== <span class="keyword">typeof</span> x[p]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (p <span class="keyword">in</span> x) &#123;</span><br><span class="line">      <span class="keyword">if</span> (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> y[p] !== <span class="keyword">typeof</span> x[p]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">typeof</span> x[p]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;object&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;function&quot;</span>:</span><br><span class="line">          leftChain.push(x);</span><br><span class="line">          rightChain.push(y);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!compare2Objects(x[p], y[p])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          leftChain.pop();</span><br><span class="line">          rightChain.pop();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">if</span> (x[p] !== y[p]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">arguments</span>.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//Die silently? Don&#x27;t know how to handle such case, please help...</span></span><br><span class="line">    <span class="comment">// throw &quot;Need two or more arguments to compare&quot;;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>, l = <span class="built_in">arguments</span>.length; i &lt; l; i++) &#123;</span><br><span class="line">    leftChain = [];</span><br><span class="line">    rightChain = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!compare2Objects(<span class="built_in">arguments</span>[<span class="number">0</span>], <span class="built_in">arguments</span>[i])) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> testData1 = [</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">    age: <span class="number">19</span>,</span><br><span class="line">    list: [</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">2</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        address: <span class="string">&quot;China&quot;</span>,</span><br><span class="line">        male: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;Hello world&quot;</span>,</span><br><span class="line">  [</span><br><span class="line">    <span class="string">&quot;white&quot;</span>,</span><br><span class="line">    <span class="string">&quot;yellow&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      red: <span class="string">&quot;red&quot;</span>,</span><br><span class="line">      deep: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> testData2 = [</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">    age: <span class="number">19</span>,</span><br><span class="line">    list: [</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">2</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        address: <span class="string">&quot;China&quot;</span>,</span><br><span class="line">        male: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;Hello world&quot;</span>,</span><br><span class="line">  [</span><br><span class="line">    <span class="string">&quot;white&quot;</span>,</span><br><span class="line">    <span class="string">&quot;yellow&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      red: <span class="string">&quot;red&quot;</span>,</span><br><span class="line">      deep: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = compare(testData1, testData2);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;result:&quot;</span>, result);</span><br></pre></td></tr></table></figure>

<h2 id="ç»§æ‰¿"><a href="#ç»§æ‰¿" class="headerlink" title="ç»§æ‰¿"></a>ç»§æ‰¿</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ES5</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parent</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Parent.prototype.eat = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&quot; is eating&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child</span>(<span class="params">name, age</span>) </span>&#123;</span><br><span class="line">  Parent.call(<span class="built_in">this</span>, name);</span><br><span class="line">  <span class="built_in">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Child.prototype = <span class="built_in">Object</span>.create(Parent.prototype);</span><br><span class="line">Child.prototype.constructor = Child;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ES6</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">eat</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&quot; is eating&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, age</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(name);</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è·å–-URL-å‚æ•°"><a href="#è·å–-URL-å‚æ•°" class="headerlink" title="è·å– URL å‚æ•°"></a>è·å– URL å‚æ•°</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªURLSearchParamså®ä¾‹</span></span><br><span class="line"><span class="keyword">const</span> urlSearchParams = <span class="keyword">new</span> URLSearchParams(<span class="built_in">window</span>.location.search);</span><br><span class="line"><span class="comment">// æŠŠé”®å€¼å¯¹åˆ—è¡¨è½¬æ¢ä¸ºä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> params = <span class="built_in">Object</span>.fromEntries(urlSearchParams.entries());</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
  </entry>
  <entry>
    <title>Nodeæµå’Œå­è¿›ç¨‹</title>
    <url>/bloger/2021/02/10/NodeJS/Node%E6%B5%81%E5%92%8C%E5%AD%90%E8%BF%9B%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="æ ¸å¿ƒä¸€ï¼šæµ-Stream"><a href="#æ ¸å¿ƒä¸€ï¼šæµ-Stream" class="headerlink" title="æ ¸å¿ƒä¸€ï¼šæµ Stream"></a>æ ¸å¿ƒä¸€ï¼šæµ Stream</h3><p>####æµ</p>
<ul>
<li>éé˜»å¡å¼çš„æ•°æ®å¤„ç†æ–¹å¼å¯æå‡æ•ˆç‡</li>
<li>chunk æ•°æ®åˆ†å—å¯ä»¥èŠ‚çœå†…å­˜</li>
<li>ç®¡é“å¯æé«˜æ‰©å±•æ€§ï¼Œæ–¹ä¾¿ç»„åˆ</li>
</ul>
<h4 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h4><ul>
<li>pipe</li>
<li>ä¸¤ç§æ–¹å¼å®ç° pipe</li>
</ul>
<h4 id="Stream-å¯¹è±¡çš„åŸå‹é“¾"><a href="#Stream-å¯¹è±¡çš„åŸå‹é“¾" class="headerlink" title="Stream å¯¹è±¡çš„åŸå‹é“¾"></a>Stream å¯¹è±¡çš„åŸå‹é“¾</h4><ul>
<li>fs.createReadStream</li>
<li>è‡ªèº«å±æ€§ ç”± fs.ReadStream æ„é€ </li>
<li>åŸå‹ï¼šstream.Readable.prototype</li>
<li>äºŒçº§åŸå‹ï¼šstream.Stream.prototype</li>
<li>ä¸‰çº§åŸå‹ï¼ševents.EventEmitter.prototype</li>
<li>å››çº§åŸå‹ï¼šObject.prototype</li>
<li>ç»“è®ºï¼šStream å¯¹è±¡éƒ½ç»§æ‰¿äº† EventEmitter</li>
</ul>
<h4 id="Stream-åˆ†ç±»"><a href="#Stream-åˆ†ç±»" class="headerlink" title="Stream åˆ†ç±»"></a>Stream åˆ†ç±»</h4><ul>
<li>Readable Stream</li>
<li>Writable Stream</li>
<li>Duplex Stream</li>
<li>Transform Stream</li>
</ul>
<h4 id="å¦‚ä½•è‡ªå®šä¹‰-Stream"><a href="#å¦‚ä½•è‡ªå®šä¹‰-Stream" class="headerlink" title="å¦‚ä½•è‡ªå®šä¹‰ Stream"></a>å¦‚ä½•è‡ªå®šä¹‰ Stream</h4><h3 id="æ ¸å¿ƒäºŒï¼šå­è¿›ç¨‹-child-process"><a href="#æ ¸å¿ƒäºŒï¼šå­è¿›ç¨‹-child-process" class="headerlink" title="æ ¸å¿ƒäºŒï¼šå­è¿›ç¨‹ child_process"></a>æ ¸å¿ƒäºŒï¼šå­è¿›ç¨‹ child_process</h3><h4 id="ä»€ä¹ˆæ˜¯è¿›ç¨‹"><a href="#ä»€ä¹ˆæ˜¯è¿›ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯è¿›ç¨‹"></a>ä»€ä¹ˆæ˜¯è¿›ç¨‹</h4><ul>
<li>è¿›ç¨‹æ˜¯ç¨‹åºçš„æ‰§è¡Œå®ä¾‹</li>
<li>ç¨‹åºåœ¨ CPU ä¸Šæ‰§è¡Œæ—¶çš„æ´»åŠ¨å«åšè¿›ç¨‹</li>
<li>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºå¦ä¸€ä¸ªè¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ï¼‰</li>
<li>é€šè¿‡ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥çœ‹åˆ°è¿›ç¨‹</li>
</ul>
<h4 id="äº†è§£-CPU"><a href="#äº†è§£-CPU" class="headerlink" title="äº†è§£ CPU"></a>äº†è§£ CPU</h4><ul>
<li>ç‰¹ç‚¹ï¼šä¸€ä¸ªå•æ ¸ CPUï¼Œåœ¨ä¸€ä¸ªæ—¶åˆ»ï¼Œåªèƒ½åšä¸€ä»¶äº‹</li>
<li>é‚£å¦‚ä½•è®©ä»–ç”¨æˆ·ç”¨æ—¶çœ‹ç”µå½±ï¼Œå¬éŸ³ä¹ï¼Œå†™ä»£ç å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­å¿«é€Ÿåˆ‡æ¢</li>
<li>ã€å¤šç¨‹åºå¹¶å‘æ‰§è¡Œã€‘æ˜¯æŒ‡å¤šä¸ªç¨‹åºåœ¨å®è§‚ä¸Šå¹¶è¡Œï¼Œå¾®è§‚ä¸Šä¸²è¡Œ</li>
<li>æ¯ä¸ªè¿›ç¨‹ä¼šå‡ºç°ã€æ‰§è¡Œ-æš‚åœ-æ‰§è¡Œã€‘çš„è§„å¾‹ï¼Œå¤šä¸ªè¿›ç¨‹ä¹‹é—´ä¼šå‡ºç°æŠ¢èµ„æºçš„ç°è±¡</li>
</ul>
<h4 id="ä»€ä¹ˆæ˜¯é˜»å¡è¿›ç¨‹"><a href="#ä»€ä¹ˆæ˜¯é˜»å¡è¿›ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯é˜»å¡è¿›ç¨‹"></a>ä»€ä¹ˆæ˜¯é˜»å¡è¿›ç¨‹</h4><ul>
<li>ç­‰å¾…æ‰§è¡Œçš„è¿›ç¨‹é˜Ÿåˆ—ä¸­ï¼Œéƒ½æ˜¯éè¿è¡Œæ€çš„ï¼Œä¸€äº›åœ¨ç­‰å¾… CPU èµ„æºï¼Œå¦ä¸€äº› B åœ¨ç­‰å¾… I/O å®Œæˆï¼Œ<br>æ­¤æ—¶æŠŠ CPU åˆ†é…ç»™ B è¿›ç¨‹ï¼ŒB è¿˜æ˜¯åœ¨ç­‰ I/Oï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ª B å«åšé˜»å¡è¿›ç¨‹ï¼Œ<br>å› æ­¤ï¼Œåˆ†æ´¾ç¨‹åºåªä¼šæŠŠ CPU åˆ†é…ç»™éé˜»å¡è¿›ç¨‹</li>
<li><a href="https://blog.csdn.net/Shangxingya/article/details/113799269">è¿›ç¨‹çŠ¶æ€</a></li>
</ul>
<h4 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹</h4><h5 id="çº¿ç¨‹å¼•å…¥åŸå› "><a href="#çº¿ç¨‹å¼•å…¥åŸå› " class="headerlink" title="çº¿ç¨‹å¼•å…¥åŸå› "></a>çº¿ç¨‹å¼•å…¥åŸå› </h5><ul>
<li>è¿›ç¨‹æ˜¯æ‰§è¡Œçš„åŸºæœ¬å®ä½“ï¼Œä¹Ÿæ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å®ä½“</li>
<li>å¯¼è‡´è¿›ç¨‹çš„åˆ›å»ºï¼Œåˆ‡æ¢ï¼Œå’Œé”€æ¯å¤ªè€—æ—¶é—´</li>
<li>äºæ˜¯å¼•å…¥çº¿ç¨‹ï¼Œçº¿ç¨‹ä½œä¸ºæ‰§è¡Œçš„åŸºæœ¬å®ä½“</li>
<li>è€Œè¿›ç¨‹åªä½œä¸ºèµ„æºåˆ†é…çš„åŸºæœ¬å®ä½“</li>
</ul>
<h5 id="çº¿ç¨‹-Thread"><a href="#çº¿ç¨‹-Thread" class="headerlink" title="çº¿ç¨‹ Thread"></a>çº¿ç¨‹ Thread</h5><ul>
<li>CPU è°ƒåº¦å’Œæ‰§è¡Œçš„æœ€å°å•å…ƒ</li>
<li>ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶ä¸€ä¸ªçº¿ç¨‹åªèƒ½å±äºä¸€ä¸ªè¿›ç¨‹</li>
<li>ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹çš„æ‰€æœ‰èµ„æº</li>
<li>è¿›ç¨‹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹å«åšåˆå§‹åŒ–çº¿ç¨‹</li>
<li>çº¿ç¨‹çš„è°ƒåº¦å¯ä»¥ç”±æ“ä½œç³»ç»Ÿè´Ÿè´£ï¼Œä¹Ÿå¯ä»¥ç”±ç”¨æˆ·è‡ªå·±è´Ÿè´£</li>
<li>ä¸¾ä¾‹ï¼šæµè§ˆå™¨è¿›ç¨‹é‡Œé¢æœ‰æ¸²æŸ“å¼•æ“ï¼ŒV8 å¼•æ“ï¼Œå­˜å‚¨æ¨¡å—ï¼Œç½‘ç»œæ¨¡å—ï¼Œç”¨æˆ·ç•Œé¢æ¨¡å—ç­‰ï¼Œæ¯ä¸€ä¸ªæ¨¡å—éƒ½å¯ä»¥æ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢</li>
</ul>
<h4 id="Node-js-çš„è¿›ç¨‹æ§åˆ¶"><a href="#Node-js-çš„è¿›ç¨‹æ§åˆ¶" class="headerlink" title="Node.js çš„è¿›ç¨‹æ§åˆ¶"></a>Node.js çš„è¿›ç¨‹æ§åˆ¶</h4><ul>
<li>ä½¿ç”¨ç›®çš„ï¼šå­è¿›ç¨‹è¿è¡Œç»“æœå­˜å‚¨åœ¨ç³»ç»Ÿç¼“å­˜ä¸­ï¼ˆæœ€å¤§ 200KBï¼‰ï¼Œç­‰åˆ°å­è¿›ç¨‹è¿è¡Œç»“æŸåï¼Œä¸»è¿›ç¨‹å†ç”¨å›è°ƒå‡½æ•°è¯»å–å­è¿›ç¨‹è¿è¡Œç»“æœ</li>
<li>API<ul>
<li>exec</li>
<li>æµå¼</li>
<li>Promise</li>
<li>ä¸ºé˜²æ­¢ cmd æ³¨å…¥ï¼Œæ¨èä½¿ç”¨ execFile</li>
<li>execFile</li>
<li>spawn<ul>
<li>ç”¨æ³•å’Œ execFile ç±»ä¼¼</li>
<li>æ²¡æœ‰å›è°ƒå‡½æ•°ï¼Œåªèƒ½é€šè¿‡ç•™æµäº‹ä»¶è·å–ç»“æœ</li>
<li>æ²¡æœ‰æœ€å¤§ 200KB é™åˆ¶ï¼Œå› ä¸ºæ˜¯æµå¼çš„</li>
</ul>
</li>
<li>fork<ul>
<li>åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ‰§è¡Œ Node è„šæœ¬</li>
<li>fork(â€˜./child.jsâ€™)ç›¸å½“äº spawn(â€˜nodeâ€™, [â€˜./child.jsâ€™])</li>
<li>ç‰¹ç‚¹ 1ï¼šä¼šå¤šå‡ºä¸€ä¸ª message äº‹ä»¶ï¼Œç”¨äºçˆ¶å­é€šä¿¡</li>
<li>ç‰¹ç‚¹ 2ï¼šä¼šå¤šå‡ºä¸€ä¸ª send æ–¹æ³•</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Node-js-çš„çº¿ç¨‹æ§åˆ¶"><a href="#Node-js-çš„çº¿ç¨‹æ§åˆ¶" class="headerlink" title="Node.js çš„çº¿ç¨‹æ§åˆ¶"></a>Node.js çš„çº¿ç¨‹æ§åˆ¶</h4><ul>
<li>åŠ å…¥è¾ƒè¿Ÿï¼Œæ•ˆç‡ä¸å¦‚å†…ç½® I/O æ“ä½œ</li>
<li>API<ul>
<li>isMainThread</li>
<li>new Worker(filename)</li>
<li>parentPort</li>
<li>postMessage</li>
<li>message</li>
<li>exit</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>NodeJS</category>
      </categories>
  </entry>
  <entry>
    <title>æ•°ç»„å¸¸è§æ–¹æ³•ä½¿ç”¨</title>
    <url>/bloger/2021/08/24/JavaScript/%E6%95%B0%E7%BB%84%E5%B8%B8%E8%A7%81%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="æ•°ç»„å¸¸è§æ–¹æ³•ä½¿ç”¨"><a href="#æ•°ç»„å¸¸è§æ–¹æ³•ä½¿ç”¨" class="headerlink" title="æ•°ç»„å¸¸è§æ–¹æ³•ä½¿ç”¨"></a>æ•°ç»„å¸¸è§æ–¹æ³•ä½¿ç”¨</h1><h2 id="reduce-ç¯‡"><a href="#reduce-ç¯‡" class="headerlink" title="reduce ç¯‡"></a>reduce ç¯‡</h2><h3 id="æ‰‹å†™-reduce"><a href="#æ‰‹å†™-reduce" class="headerlink" title="æ‰‹å†™ reduce"></a>æ‰‹å†™ reduce</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myReduce</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ·±æ‹·è´ æ­¤å¤„çœç•¥</span></span><br><span class="line">  <span class="comment">// å¼‚å¸¸å¤„ç†  æ­¤å¤„çœç•¥</span></span><br><span class="line">  <span class="keyword">let</span> callback = <span class="built_in">arguments</span>[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">let</span> initialValue = <span class="built_in">arguments</span>[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">let</span> acc;</span><br><span class="line">  <span class="keyword">let</span> i;</span><br><span class="line"></span><br><span class="line">  i = initialValue === <span class="literal">undefined</span> ? <span class="number">1</span> : <span class="number">0</span>;\</span><br><span class="line">  acc = initialValue == <span class="literal">undefined</span> ? <span class="built_in">this</span>[<span class="number">0</span>] : initialValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i; i &lt; <span class="built_in">this</span>.length; i++) &#123;</span><br><span class="line">      acc = callback(acc, <span class="built_in">this</span>[i], i, <span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="keyword">return</span> acc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Array</span>.prototype.myReduce = myReduce;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">result, currentValue, index</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> result + currentValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">let</span> a = arr.myReduce(func, <span class="number">10</span>);  <span class="comment">// 24</span></span><br><span class="line"><span class="keyword">let</span> b = arr.myReduce(func);      <span class="comment">// 14</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;myReduce&quot;</span>, a, b);</span><br></pre></td></tr></table></figure>

<h3 id="æ±‚å’Œï¼Œæ±‚ç§¯ï¼Œæ±‚æœ€å€¼"><a href="#æ±‚å’Œï¼Œæ±‚ç§¯ï¼Œæ±‚æœ€å€¼" class="headerlink" title="æ±‚å’Œï¼Œæ±‚ç§¯ï¼Œæ±‚æœ€å€¼"></a>æ±‚å’Œï¼Œæ±‚ç§¯ï¼Œæ±‚æœ€å€¼</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. æ±‚å’Œã€ä¹˜ç§¯</span></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">let</span> sum = arr.reduce(<span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;sum&quot;</span>, sum);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ±‚æœ€å€¼</span></span><br><span class="line"><span class="keyword">let</span> nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">let</span> max = nums.reduce(<span class="function">(<span class="params">x, y</span>) =&gt;</span> (x &gt; y ? x : y));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;max&quot;</span>, max);</span><br></pre></td></tr></table></figure>

<h3 id="è¯é¢‘ç»Ÿè®¡"><a href="#è¯é¢‘ç»Ÿè®¡" class="headerlink" title="è¯é¢‘ç»Ÿè®¡"></a>è¯é¢‘ç»Ÿè®¡</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> names = [<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Tiff&quot;</span>, <span class="string">&quot;Bruce&quot;</span>, <span class="string">&quot;Alice&quot;</span>];</span><br><span class="line"><span class="keyword">let</span> nameObj = names.reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (cur <span class="keyword">in</span> pre) &#123;</span><br><span class="line">    pre[cur]++;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pre[cur] = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pre;</span><br><span class="line">&#125;, &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;nameObj&quot;</span>, nameObj);</span><br></pre></td></tr></table></figure>

<h3 id="æ•°æ®å»é‡"><a href="#æ•°æ®å»é‡" class="headerlink" title="æ•°æ®å»é‡"></a>æ•°æ®å»é‡</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> slice = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>];</span><br><span class="line"><span class="keyword">let</span> uniqueArr = slice.reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!pre.includes(cur)) &#123;</span><br><span class="line">    <span class="keyword">return</span> pre.concat(cur);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, []);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;uniqueArr&quot;</span>, uniqueArr);</span><br></pre></td></tr></table></figure>

<h3 id="æ•°ç»„æ‹å¹³"><a href="#æ•°ç»„æ‹å¹³" class="headerlink" title="æ•°ç»„æ‹å¹³"></a>æ•°ç»„æ‹å¹³</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> arr_nD = [</span><br><span class="line">  [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">  [<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  [<span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]],</span><br><span class="line">];</span><br><span class="line"><span class="comment">// äºŒç»´è½¬ä¸€ç»´</span></span><br><span class="line"><span class="comment">// let newArr = arr_nD.reduce((pre, cur) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     return pre.concat(cur)</span></span><br><span class="line"><span class="comment">// &#125;, [])</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flat = <span class="function"><span class="keyword">function</span> (<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arr.reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre.concat(<span class="built_in">Array</span>.isArray(cur) ? flat(cur) : cur);</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;flat&quot;</span>, flat(arr_nD));</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹è±¡å±æ€§æ±‚å’Œ"><a href="#å¯¹è±¡å±æ€§æ±‚å’Œ" class="headerlink" title="å¯¹è±¡å±æ€§æ±‚å’Œ"></a>å¯¹è±¡å±æ€§æ±‚å’Œ</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> result = [</span><br><span class="line">  &#123;</span><br><span class="line">    subject: <span class="string">&quot;math&quot;</span>,</span><br><span class="line">    score: <span class="number">60</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    subject: <span class="string">&quot;chinese&quot;</span>,</span><br><span class="line">    score: <span class="number">75</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    subject: <span class="string">&quot;english&quot;</span>,</span><br><span class="line">    score: <span class="number">80</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> summary = result.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">prev, cur</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> cur.score + prev;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="é«˜é˜¶å‡½æ•°"><a href="#é«˜é˜¶å‡½æ•°" class="headerlink" title="é«˜é˜¶å‡½æ•°"></a>é«˜é˜¶å‡½æ•°</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> args = [].slice.apply(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> args.reduceRight(<span class="function">(<span class="params">res, cb</span>) =&gt;</span> cb(res), params);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pipe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> args = [].slice.apply(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> args.reduce(<span class="function">(<span class="params">res, cb</span>) =&gt;</span> cb(res), params);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»™å®šä¸€ä¸ªè¾“å…¥å€¼xï¼Œå…ˆç»™è¿™ä¸ªå€¼åŠ 10ï¼Œç„¶åç»“æœä¹˜ä»¥10</span></span><br><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">x</span>) =&gt;</span> x + <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> multiply = <span class="function">(<span class="params">x</span>) =&gt;</span> x * <span class="number">10</span>;</span><br><span class="line"><span class="comment">// å‚æ•°ä»å³å¾€å·¦æ‰§è¡Œï¼Œæ‰€ä»¥multiplyåœ¨å‰ï¼Œaddåœ¨å</span></span><br><span class="line"><span class="keyword">let</span> ret = compose(multiply, add)(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;composeå‡½æ•°&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‚æ•°ä»å·¦å¾€å³æ‰§è¡Œï¼Œæ‰€ä»¥addåœ¨å‰ï¼Œmultiplyåœ¨å</span></span><br><span class="line"><span class="keyword">let</span> rep = pipe(add, multiply)(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;pipeå‡½æ•°&quot;</span>, rep);</span><br></pre></td></tr></table></figure>

<h3 id="LeetCode-ç›¸å…³"><a href="#LeetCode-ç›¸å…³" class="headerlink" title="LeetCode ç›¸å…³"></a>LeetCode ç›¸å…³</h3><p>L14 æœ€é•¿å…¬å…±å‰ç¼€</p>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
  </entry>
  <entry>
    <title>æ·±å…¥REACTæŠ€æœ¯æ ˆ é˜…è¯»ç¬”è®°</title>
    <url>/bloger/2021/02/03/UI%E6%A1%86%E6%9E%B6/%5B%E9%99%88%E5%B1%B9%5D%E6%B7%B1%E5%85%A5REACT%E6%8A%80%E6%9C%AF%E6%A0%88/</url>
    <content><![CDATA[<h2 id="React-äº‹ä»¶ç³»ç»Ÿ"><a href="#React-äº‹ä»¶ç³»ç»Ÿ" class="headerlink" title="React äº‹ä»¶ç³»ç»Ÿ"></a>React äº‹ä»¶ç³»ç»Ÿ</h2><h3 id="æè¿°æ€§å®šä¹‰"><a href="#æè¿°æ€§å®šä¹‰" class="headerlink" title="æè¿°æ€§å®šä¹‰"></a>æè¿°æ€§å®šä¹‰</h3><ol>
<li>React åŸºäº Virtual DOM å®ç°çš„ä¸€ä¸ª SyntheticEvent ï¼ˆåˆæˆäº‹ä»¶ï¼‰å±‚</li>
<li>æ¯”å¦‚æˆ‘ä»¬åœ¨ JSX é‡Œç»™ä¸€ä¸ªæŒ‰é’®æ·»åŠ çš„ onClick å¤„ç†æ–¹æ³•å°±æ˜¯ React åˆæˆäº‹ä»¶</li>
<li>å®ƒå®Œå…¨ç¬¦åˆ W3C æ ‡å‡†ï¼Œä¸å­˜åœ¨æµè§ˆå™¨å…¼å®¹é—®é¢˜</li>
<li>ä¸åŸç”Ÿæµè§ˆå™¨äº‹ä»¶æ¥å£ä¸€æ ·ï¼ŒåŒæ ·æ”¯æŒäº‹ä»¶å†’æ³¡</li>
<li>æ‰€æœ‰äº‹ä»¶éƒ½è‡ªåŠ¨ç»‘å®šåˆ°æœ€å¤–å±‚ï¼Œå¦‚æœéœ€è¦è®¿é—®åŸç”Ÿäº‹ä»¶å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ nativeEvent å±æ€§</li>
</ol>
<h4 id="åˆæˆäº‹ä»¶å¦‚ä½•ç»‘å®šï¼Ÿ"><a href="#åˆæˆäº‹ä»¶å¦‚ä½•ç»‘å®šï¼Ÿ" class="headerlink" title="åˆæˆäº‹ä»¶å¦‚ä½•ç»‘å®šï¼Ÿ"></a>åˆæˆäº‹ä»¶å¦‚ä½•ç»‘å®šï¼Ÿ</h4><ol>
<li>åœ¨ React ç»„ä»¶ä¸­ï¼Œæ¯ä¸ªæ–¹æ³•çš„ä¸Šä¸‹æ–‡éƒ½ä¼šæŒ‡å‘è¯¥ç»„ä»¶çš„å®ä¾‹ï¼Œå³è‡ªåŠ¨ç»‘å®š this ä¸ºå½“å‰ç»„ä»¶</li>
<li>åœ¨ä½¿ç”¨ ES6 class æˆ–è€… å‡½æ•°ç»„ä»¶çš„æ—¶å€™ï¼Œéœ€è¦æ‰‹åŠ¨ç»‘å®š</li>
<li>æ‰‹åŠ¨ç»‘å®šæ–¹æ³•æœ‰ï¼šbind ç»‘å®šï¼Œconstructor ç»‘å®šï¼Œç®­å¤´å‡½æ•°è¿™ä¸‰ç§</li>
</ol>
<h4 id="åˆæˆäº‹ä»¶ä»£ç†æœºåˆ¶"><a href="#åˆæˆäº‹ä»¶ä»£ç†æœºåˆ¶" class="headerlink" title="åˆæˆäº‹ä»¶ä»£ç†æœºåˆ¶"></a>åˆæˆäº‹ä»¶ä»£ç†æœºåˆ¶</h4><ol>
<li>React å¹¶ä¸ä¼šæŠŠäº‹ä»¶å¤„ç†å‡½æ•°ç›´æ¥ç»‘å®šåˆ°çœŸå®èŠ‚ç‚¹ä¸Šï¼Œè€Œæ˜¯ç»‘å®šåœ¨æœ€å¤–å±‚ï¼Œä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œè¿™ä¸ªäº‹ä»¶ç›‘å¬å™¨ç»´æŒäº†ä¸€ä¸ªæ˜ å°„æ¥ä¿å­˜æ‰€æœ‰ç»„ä»¶å†…éƒ¨çš„äº‹ä»¶ç›‘å¬å’Œå¤„ç†å‡½æ•°</li>
<li>å½“ç»„ä»¶æŒ‚è½½æˆ–è€…å¸è½½æ—¶ï¼Œåªæ˜¯åœ¨è¿™ä¸ªç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å™¨ä¸Šæ’å…¥æˆ–è€…åˆ é™¤ä¸€äº›å¯¹è±¡</li>
<li>å½“ç»„ä»¶äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé¦–å…ˆè¢«è¿™ä¸ªç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å™¨å¤„ç†ï¼Œç„¶åå†æ˜ å°„é‡Œæ‰¾åˆ°çœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°å¹¶è°ƒç”¨</li>
</ol>
<h4 id="å¯ä»¥åœ¨-React-ä¸­ä½¿ç”¨åŸç”Ÿäº‹ä»¶å—ï¼Ÿ"><a href="#å¯ä»¥åœ¨-React-ä¸­ä½¿ç”¨åŸç”Ÿäº‹ä»¶å—ï¼Ÿ" class="headerlink" title="å¯ä»¥åœ¨ React ä¸­ä½¿ç”¨åŸç”Ÿäº‹ä»¶å—ï¼Ÿ"></a>å¯ä»¥åœ¨ React ä¸­ä½¿ç”¨åŸç”Ÿäº‹ä»¶å—ï¼Ÿ</h4><ol>
<li>å¯ä»¥çš„ã€‚è™½ç„¶ React äº‹ä»¶å¥½å¤„å¤šå¤šï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å®ç°æ‰€æœ‰çš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ resize äº‹ä»¶</li>
<li>åœ¨ React ä¸­æœ‰ä¸‰ç§æ–¹æ³•ä½¿ç”¨åŸç”Ÿäº‹ä»¶</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  btnRef = createRef();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleClick</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;handleClick&quot;</span>, e.target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// åŸç”Ÿäº‹ä»¶refs</span></span><br><span class="line">    <span class="comment">// this.refs.button.addEventListener(&#x27;click&#x27;, this.handleClick);</span></span><br><span class="line">    <span class="comment">// callback</span></span><br><span class="line">    <span class="comment">// this.btn.addEventListener(&#x27;click&#x27;, this.handleClick);</span></span><br><span class="line">    <span class="comment">// createRef</span></span><br><span class="line">    <span class="built_in">this</span>.btnRef.current.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="built_in">this</span>.handleClick);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="comment">/* &lt;button type=&quot;button&quot; ref=&quot;button&quot;&gt;Test button&lt;/button&gt; */</span>&#125;</span><br><span class="line">        &#123;<span class="comment">/* &lt;button type=&quot;button&quot; ref=&#123;obj =&gt; this.btn = obj&#125;&gt;Test button&lt;/button&gt; */</span>&#125;</span><br><span class="line">        &lt;button type=<span class="string">&quot;button&quot;</span> ref=&#123;<span class="built_in">this</span>.btnRef&#125;&gt;</span><br><span class="line">          Test button</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¯¹æ¯”-React-åˆæˆäº‹ä»¶å’Œ-JavaScript-åŸç”Ÿäº‹ä»¶"><a href="#å¯¹æ¯”-React-åˆæˆäº‹ä»¶å’Œ-JavaScript-åŸç”Ÿäº‹ä»¶" class="headerlink" title="å¯¹æ¯” React åˆæˆäº‹ä»¶å’Œ JavaScript åŸç”Ÿäº‹ä»¶"></a>å¯¹æ¯” React åˆæˆäº‹ä»¶å’Œ JavaScript åŸç”Ÿäº‹ä»¶</h4><ol>
<li>äº‹ä»¶ä¼ æ’­å’Œé˜»æ­¢äº‹ä»¶ä¼ æ’­</li>
</ol>
<ul>
<li>æµè§ˆå™¨åŸç”Ÿ DOM äº‹ä»¶ä¼ æ’­åˆ†ä¸‰ä¸ªé˜¶æ®µï¼šäº‹ä»¶æ•è·é˜¶æ®µï¼Œç›®æ ‡å¤„ç†é˜¶æ®µï¼Œäº‹ä»¶å†’æ³¡é˜¶æ®µ</li>
<li>ä½†æ˜¯äº‹ä»¶æ•è·é˜¶æ®µå…¼å®¹æ€§å¹¶ä¸å¥½ï¼Œæ‰€ä»¥ React å¹¶æ²¡æœ‰å®ç°äº‹ä»¶æ•è·é˜¶æ®µï¼Œåªå®ç°äº†äº‹ä»¶å†’æ³¡</li>
<li>é˜»æ­¢åŸç”Ÿäº‹ä»¶éœ€è¦ä½¿ç”¨<code>e.preventDefault()</code>å’Œ<code>e.cancelBubble = true</code>ï¼ŒReact äº‹ä»¶ç³»ç»Ÿä¸­åªéœ€ä½¿ç”¨<code>e.preventDefault()</code>å³å¯</li>
</ul>
<ol start="2">
<li>äº‹ä»¶ç±»å‹ React åˆæˆäº‹ä»¶çš„äº‹ä»¶ç±»å‹æ˜¯åŸç”Ÿäº‹ä»¶ç±»å‹çš„å­é›†</li>
<li>äº‹ä»¶ç»‘å®šæ–¹å¼</li>
</ol>
<ul>
<li><p>åŸç”Ÿäº‹ä»¶ç»‘å®šæœ‰ä¸‰ç§</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>// ç›´æ¥åœ¨ DOM å…ƒç´ ä¸­ç»‘å®šï¼š<br><button onclick="alert(1);">Test</button><br>// åœ¨ JavaScript ä¸­ï¼Œé€šè¿‡ä¸ºå…ƒç´ çš„äº‹ä»¶å±æ€§èµ‹å€¼çš„æ–¹å¼å®ç°ç»‘å®šï¼š el.onclick = e =&gt; { console.log(e); } // é€šè¿‡äº‹ä»¶ç›‘å¬å‡½æ•°æ¥å®ç°ç»‘å®šï¼š el.addEventListener(â€˜<br>clickâ€™, () =&gt; { }, false); el.attachEvent(â€˜onclickâ€™, () =&gt; { });</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- ç›¸æ¯”è€Œè¨€ï¼ŒReact åˆæˆäº‹ä»¶çš„ç»‘å®šæ–¹å¼åˆ™ç®€å•å¾—å¤šï¼š&#96;&lt;button onClick&#x3D;&#123;this.handleClick&#125;&gt;Test&lt;&#x2F;button&gt; &#96;</span><br><span class="line"></span><br><span class="line">4. äº‹ä»¶å¯¹è±¡ åŸç”ŸDOMäº‹ä»¶å¯¹è±¡åœ¨W3Cæ ‡å‡†å’ŒIEæ ‡å‡†ä¸‹å®ç°æœ‰æ‰€ä¸åŒï¼Œå„¿åœ¨Reactåˆæˆäº‹ä»¶ç³»ç»Ÿä¸­ï¼Œä¸å­˜åœ¨å…¼å®¹é—®é¢˜</span><br><span class="line"></span><br><span class="line">## CSS Modulesæ˜¯ä»€ä¹ˆ</span><br><span class="line"></span><br><span class="line">1. CSSæ¨¡å—åŒ–è§£å†³æ–¹æ¡ˆä¸»è¦æœ‰ä¸¤ç±»ï¼šInlineå’ŒMOdule</span><br><span class="line">2. CSSæ¨¡å—åŒ–è¿‡ç¨‹ä¸­é‡åˆ°äº†å¦‚ä¸‹é—®é¢˜ï¼š</span><br><span class="line">  - å…¨å±€æ±¡æŸ“</span><br><span class="line">  - å‘½åæ··ä¹±</span><br><span class="line">  - ä¾èµ–ç®¡ç†ä¸å½»åº•</span><br><span class="line">  - æ— æ³•å…±äº«å˜é‡</span><br><span class="line">  - ä»£ç å‹ç¼©ä¸å½»åº•</span><br><span class="line">3. CSSæ¨¡å—åŒ–æ–¹æ¡ˆå®è·µå‘å±•ï¼šSMACSS-&gt;OOCSS-&gt;BEM</span><br><span class="line">4. webpackçš„css-loaderæ”¯æŒæ¨¡å—åŒ–CSS</span><br><span class="line">5. CSS Modules ç»“åˆ React å®è·µ</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;js</span><br><span class="line">&#x2F;* dialog.css *&#x2F;</span><br><span class="line">.</span><br><span class="line">root</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">.</span><br><span class="line">confirm</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">.</span><br><span class="line">disabledConfirm</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* dialog.js *&#x2F;</span><br><span class="line">import React, &#123;Component&#125; from &#39;react&#39;;</span><br><span class="line">import classNames from &#39;classnames&#39;;</span><br><span class="line">import CSSModules from &#39;react-css-modules&#39;;</span><br><span class="line">import styles from &#39;.&#x2F;dialog.css&#39;;</span><br><span class="line"></span><br><span class="line">class Dialog extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">      const cx &#x3D; classNames(&#123;</span><br><span class="line">          confirm: !this.state.disabled,</span><br><span class="line">          disabledConfirm: this.state.disabled,</span><br><span class="line">      &#125;);</span><br><span class="line">      return (</span><br><span class="line">          &lt;div styleName&#x3D;&quot;root&quot;&gt;</span><br><span class="line">              &lt;a styleName&#x3D;&#123;cx&#125;&gt;Confirm&lt;&#x2F;a&gt;</span><br><span class="line">          &lt;&#x2F;div&gt;</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default CSSModules(Dialog, styles);</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>è¿™ç¯‡æ–‡ç« å†™çš„å·®ä¸å¤šï¼š<a href="https://zhuanlan.zhihu.com/p/100133524">https://zhuanlan.zhihu.com/p/100133524</a></li>
</ol>
<h2 id="ç»„ä»¶é—´é€šä¿¡"><a href="#ç»„ä»¶é—´é€šä¿¡" class="headerlink" title="ç»„ä»¶é—´é€šä¿¡"></a>ç»„ä»¶é—´é€šä¿¡</h2><h4 id="çˆ¶ç»„ä»¶åˆ°å­ç»„ä»¶"><a href="#çˆ¶ç»„ä»¶åˆ°å­ç»„ä»¶" class="headerlink" title="çˆ¶ç»„ä»¶åˆ°å­ç»„ä»¶"></a>çˆ¶ç»„ä»¶åˆ°å­ç»„ä»¶</h4><p>props</p>
<h4 id="å­ç»„ä»¶åˆ°çˆ¶ç»„ä»¶"><a href="#å­ç»„ä»¶åˆ°çˆ¶ç»„ä»¶" class="headerlink" title="å­ç»„ä»¶åˆ°çˆ¶ç»„ä»¶"></a>å­ç»„ä»¶åˆ°çˆ¶ç»„ä»¶</h4><ol>
<li>å›è°ƒå‡½æ•°</li>
<li>è‡ªå®šä¹‰äº‹ä»¶æœºåˆ¶</li>
</ol>
<h4 id="æ— åµŒå¥—å…³ç³»çš„ç»„ä»¶é—´"><a href="#æ— åµŒå¥—å…³ç³»çš„ç»„ä»¶é—´" class="headerlink" title="æ— åµŒå¥—å…³ç³»çš„ç»„ä»¶é—´"></a>æ— åµŒå¥—å…³ç³»çš„ç»„ä»¶é—´</h4><p>è‡ªå®šä¹‰äº‹ä»¶æœºåˆ¶ï¼Œæ¯”å¦‚ EventEmitter</p>
<h4 id="è·¨çº§ç»„ä»¶é€šä¿¡"><a href="#è·¨çº§ç»„ä»¶é€šä¿¡" class="headerlink" title="è·¨çº§ç»„ä»¶é€šä¿¡"></a>è·¨çº§ç»„ä»¶é€šä¿¡</h4><p>context</p>
<h2 id="ç»„ä»¶é—´æŠ½è±¡"><a href="#ç»„ä»¶é—´æŠ½è±¡" class="headerlink" title="ç»„ä»¶é—´æŠ½è±¡"></a>ç»„ä»¶é—´æŠ½è±¡</h2><h4 id="minxin"><a href="#minxin" class="headerlink" title="minxin"></a>minxin</h4><p>ä¸æ¨èä½¿ç”¨ï¼š<a href="https://github.com/tcatche/tcatche.github.io/issues/53">https://github.com/tcatche/tcatche.github.io/issues/53</a></p>
<h4 id="decorator"><a href="#decorator" class="headerlink" title="decorator"></a>decorator</h4><p>core-decorators stage-2</p>
<h4 id="é«˜é˜¶ç»„ä»¶"><a href="#é«˜é˜¶ç»„ä»¶" class="headerlink" title="é«˜é˜¶ç»„ä»¶"></a>é«˜é˜¶ç»„ä»¶</h4><ol>
<li>å®ç°é«˜é˜¶ç»„ä»¶ä¸¤ç§æ–¹æ³•ï¼šå±æ€§ä»£ç†å’Œåå‘ç»§æ‰¿</li>
<li>å…·ä½“å‚è€ƒï¼š<a href="https://github.com/Matthrews/rfzhu_blogs/blob/main/%E6%8A%80%E6%9C%AF/React/React%E4%B8%AD%E7%9A%84%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF.md">é«˜é˜¶ç»„ä»¶åŠå…¶åº”ç”¨åœºæ™¯</a></li>
</ol>
<h2 id="è‡ªåŠ¨åŒ–æµ‹è¯•"><a href="#è‡ªåŠ¨åŒ–æµ‹è¯•" class="headerlink" title="è‡ªåŠ¨åŒ–æµ‹è¯•"></a>è‡ªåŠ¨åŒ–æµ‹è¯•</h2><p><a href="https://jestjs.io/">Jest</a><br><a href="https://enzymejs.github.io/enzyme/">Enzyme</a><br><a href="https://github.com/Matthrews/edb/actions/new">GitHub Actions</a></p>
]]></content>
      <categories>
        <category>UIæ¡†æ¶</category>
      </categories>
      <tags>
        <tag>React</tag>
      </tags>
  </entry>
  <entry>
    <title>å‰ç«¯å·¥ç¨‹åŒ–å®è·µ</title>
    <url>/bloger/2021/05/05/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<h1 id="å‰ç«¯å·¥ç¨‹åŒ–å®è·µ"><a href="#å‰ç«¯å·¥ç¨‹åŒ–å®è·µ" class="headerlink" title="å‰ç«¯å·¥ç¨‹åŒ–å®è·µ"></a>å‰ç«¯å·¥ç¨‹åŒ–å®è·µ</h1><blockquote>
<p>å‚è€ƒï¼šã€Šå‰ç«¯æŠ€æœ¯æ¶æ„ä¸å·¥ç¨‹ã€‹ä½œè€…: <a href="https://book.douban.com/search/%E5%91%A8%E4%BF%8A%E9%B9%8F">å‘¨ä¿Šé¹</a></p>
</blockquote>
<p>å‰ç«¯å·¥ç¨‹åŒ–æ˜¯å‰ç«¯å¼€å‘çš„ä¸€ç§æ€ç»´æ–¹å¼ï¼Œæ˜¯é’ˆå¯¹å‰ç«¯å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›åˆ—é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚å‰ç«¯å·¥ç¨‹åŒ–å›´ç»•ç¼–ç ã€æ–¹æ³•ã€å·¥å…·ä¸‰ä¸ªè¦ç´ å±•å¼€ã€‚<br>ä»å‰ç«¯åº”ç”¨çš„æŠ€æœ¯æ¶æ„æœ¬èº«å‡ºå‘ï¼Œå…³æ³¨ç‚¹èšç„¦äºæ¨¡å—è§£è€¦ã€æ•°æ®ç®¡ç†æ¶æ„æ¨¡å¼ã€æ€§èƒ½ä»¥åŠå‰åç«¯åˆ†ç¦»ï¼Œç›®æ ‡æ˜¯å®ç°æ¶æ„çš„é«˜å¯ç”¨æ€§ã€å¯æ‰©å±•æ€§ã€å¯ä¼¸ç¼©æ€§ï¼ŒåŒæ—¶æé«˜ç‹¬ç«‹å¼€å‘å’Œè·¨å›¢é˜Ÿåä½œå¼€å‘çš„æ•ˆç‡ï¼›<br>ä»æ¶æ„ä¹‹å¤–çš„è§’åº¦å‡ºå‘ï¼Œå…³æ³¨ç‚¹èšç„¦äºå‰ç«¯åº”ç”¨çš„å¼€å‘ã€æ¶æ„ã€æµ‹è¯•ã€éƒ¨ç½²ä»¥åŠæŒç»­åŒ–å·¥ç¨‹ä½“ç³»ï¼Œç›®æ ‡æ˜¯å»ºç«‹è§„èŒƒã€æœ‰åºã€é«˜æ•ˆçš„è¿­ä»£æµç¨‹ï¼Œé™ä½äº§å“è¿­ä»£æ‰€æ¶ˆè€—çš„äººåŠ›å’Œæ²Ÿé€šæˆæœ¬ã€‚</p>
<h2 id="å¼€å‘é˜¶æ®µ"><a href="#å¼€å‘é˜¶æ®µ" class="headerlink" title="å¼€å‘é˜¶æ®µ"></a>å¼€å‘é˜¶æ®µ</h2><ul>
<li><p>ç»Ÿä¸€æŠ€æœ¯æ ˆå‡å°‘å›¢é˜Ÿæˆå‘˜å­¦ä¹ æˆæœ¬ä»¥åŠåä½œæˆæœ¬</p>
</li>
<li><p>è‡ªå»º Mock å¹³å°è®©åŠ å¿«å‰ç«¯å¼€å‘æ•ˆç‡</p>
<p><a href="https://github.com/Matthrews/mock_server">å…·ä½“å®è·µ</a></p>
</li>
<li><p>é€šè¿‡ Git è¿›è¡Œä»£ç ç‰ˆæœ¬ç®¡ç†, ä¾¿äº Code Review å’Œ Version Revert</p>
</li>
<li><p>é€šè¿‡ husky, @commitlint/cli, @commitlint/config-conventional è§„èŒƒ Git commit</p>
</li>
<li><p>é€šè¿‡ ESLint æ£€æŸ¥ä»£ç é”™è¯¯ï¼Œä½¿ç”¨ Prettier æ ¼å¼åŒ–ä»£ç </p>
</li>
<li><p>é€šè¿‡ Code Review è´£ä»»è¿å¸¦æœºåˆ¶ä¸¥æ ¼æŠŠæ§ä»£ç è´¨é‡</p>
</li>
</ul>
<h2 id="æ„å»ºé˜¶æ®µ"><a href="#æ„å»ºé˜¶æ®µ" class="headerlink" title="æ„å»ºé˜¶æ®µ"></a>æ„å»ºé˜¶æ®µ</h2><p>æ„å»ºé˜¶æ®µä¸»è¦å›´ç»•ä»¥ä¸‹æ–¹é¢å±•å±•å¼€ï¼š</p>
<ul>
<li><p>ç¼–ç¨‹è¯­è¨€ï¼Œå°†æºä»£ç ç¼–è¯‘ä¸ºå®¢æˆ·ç«¯å¯æ‰§è¡Œä»£ç ä»£ç çš„è¿‡ç¨‹ï¼ŒBabel/Typescript/PostCSS ç­‰å·¥å…·å‡å±äºæ­¤ç±»</p>
</li>
<li><p>æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”å¦‚å‹ç¼©æ··æ·†ï¼Œè‡ªåŠ¨ç”Ÿæˆ CSS Spriteï¼ŒåŠ¨æ€æ¨¡å—æŒ‰éœ€åŠ è½½ï¼Œæ–‡ä»¶ hashï¼Œå›¾ç‰‡ä¼˜åŒ–ç­‰</p>
</li>
<li><p>éƒ¨ç½²ç­–ç•¥ï¼Œæ¯”å¦‚ç»™é™æ€èµ„æº URL åŠ å…¥ Hash æŒ‡çº¹æˆ–è€… CDN è·¯å¾„ç­‰</p>
</li>
<li><p>å¼€å‘æ•ˆç‡ï¼Œæ¯”å¦‚æ–‡æ¡£ç”Ÿæˆï¼ŒåŠ¨æ€æ„å»ºç­‰<br><a href="https://github.com/Matthrews/typescript-doc-gen">å…·ä½“å®è·µ</a></p>
</li>
<li><p>å®¡æŸ¥è¯„ä¼°ï¼Œæ¯”å¦‚è§„èŒƒå®¡æŸ¥ï¼Œæ€§èƒ½è¯„ä¼°ç­‰</p>
</li>
</ul>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p><a href="https://testing-library.com/docs/ecosystem-jest-dom/">jest-dom</a><br><a href="https://www.jestjs.cn/">Jest</a><br><a href="https://mochajs.cn/">JavaScript æµ‹è¯•æ¡†æ¶ Mocha</a><br><a href="https://www.chaijs.com/">æ–­è¨€åº“ Chai</a><br><a href="https://www.cypress.io/">ä¸‹ä¸€ä»£è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ Cypress</a></p>
<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>å…¶ç›®çš„å°±æ˜¯å°†èµ„æºå‡†ç¡®åœ°æ”¾åˆ°ä¸åŒç¯å¢ƒçš„æœåŠ¡å™¨ä¸Šï¼Œå…¶æ ¸å¿ƒåœ¨äºæµç¨‹çš„æ§åˆ¶ã€‚</p>
<h2 id="æŒç»­åŒ–"><a href="#æŒç»­åŒ–" class="headerlink" title="æŒç»­åŒ–"></a>æŒç»­åŒ–</h2><ul>
<li>CI/CD</li>
</ul>
<h2 id="ç›‘æ§ä¸ç»Ÿè®¡"><a href="#ç›‘æ§ä¸ç»Ÿè®¡" class="headerlink" title="ç›‘æ§ä¸ç»Ÿè®¡"></a>ç›‘æ§ä¸ç»Ÿè®¡</h2><p><a href="https://www.elastic.co/cn/elastic-stack/">The Elastic Stack</a></p>
]]></content>
      <categories>
        <category>å‰ç«¯å·¥ç¨‹åŒ–</category>
      </categories>
      <tags>
        <tag>å‰ç«¯å·¥ç¨‹åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„æ€§èƒ½æŒ‡æ ‡</title>
    <url>/bloger/2021/05/04/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%BB%A5%E7%94%A8%E6%88%B7%E4%B8%BA%E4%B8%AD%E5%BF%83%E7%9A%84%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/</url>
    <content><![CDATA[<p>æˆ‘ä»¬éƒ½å¬è¯´è¿‡æ€§èƒ½å¦‚ä½•é‡è¦å¦‚ä½•é‡è¦ï¼Œä½†å½“æˆ‘ä»¬è®¨è®ºæ€§èƒ½â€”â€”å¯èƒ½å°±æ˜¯è®©ç½‘ç«™â€œå¿«â€ï¼Œé‚£ä¹ˆå…·ä½“æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ äº‹å®ä¸Šï¼Œæ€§èƒ½æ˜¯ä¸€ä¸ªç›¸å¯¹çš„æ¦‚å¿µï¼š</p>
<ul>
<li>ä¸€ä¸ªç½‘ç«™å¯èƒ½å¯¹æŸä¸€ä¸ªç”¨æˆ·æ¥è¯´å¾ˆå¿«(åœ¨ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§å¹¶ä¸”ç½‘ç»œä¼˜è´¨çš„è®¾å¤‡ä¸Šçš„æ—¶å€™)ï¼Œä½†æ˜¯å¯¹å¦ä¸€ä¸ªç”¨æˆ·æ¥è¯´å°±å¾ˆæ…¢(åœ¨ä¸€ä¸ªç½‘é€Ÿå¾ˆæ…¢çš„ä½ç«¯è®¾å¤‡ä¸Šçš„æ—¶å€™)ã€‚</li>
<li>ä¸¤ä¸ªç½‘ç«™åŒæ—¶åŠ è½½å®Œæˆå¯èƒ½æ€»è€—æ—¶ç›¸åŒï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¯èƒ½ä¼šåŠ è½½åœ°æ›´å¿«(å¦‚æœè¿™ä¸ªç½‘ç«™æ¸è¿›å¼åŠ è½½è€Œä¸æ˜¯ç­‰åˆ°æœ€åæ‰å±•ç¤ºé¡µé¢)</li>
<li>ä¸€ä¸ªç½‘ç«™å¯èƒ½çœ‹èµ·æ¥åŠ è½½çš„å¾ˆå¿«ï¼Œä½†æ˜¯å¯¹ç”¨æˆ·äº¤äº’å´å“åº”çš„å¾ˆæ…¢(ç”šè‡³ä¸å“åº”)</li>
</ul>
<p>æ‰€ä»¥å½“è°ˆåˆ°æ€§èƒ½ï¼Œç²¾ç¡®åŒ–å’Œå¯ä»¥ä½¿ç”¨é‡åŒ–çš„å®¢è§‚æ ‡å‡†è®¡ç®—æ˜¯éå¸¸é‡è¦çš„ã€‚è¿™äº›æ ‡å‡†æˆ‘ä»¬ç§°ä¹‹ä¸ºæŒ‡æ ‡ã€‚</p>
<p>ä½†æ˜¯ä»…ä»…å› ä¸ºæŒ‡æ ‡æ˜¯åŸºäºå®¢è§‚æ ‡å‡†å¹¶ä¸”å¯ä»¥è¢«é‡åŒ–ï¼Œé‚£ä¹Ÿå¹¶ä¸æ„å‘³ç€è¿™äº›è®¡ç®—æ˜¯æœ‰ç”¨çš„ã€‚</p>
<h2 id="æŒ‡æ ‡å®šä¹‰"><a href="#æŒ‡æ ‡å®šä¹‰" class="headerlink" title="æŒ‡æ ‡å®šä¹‰"></a>æŒ‡æ ‡å®šä¹‰</h2><p>ä¼ ç»Ÿä¸Šï¼Œweb æ€§èƒ½æ˜¯é€šè¿‡<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event">åŠ è½½äº‹ä»¶</a>æ¥è®¡ç®—çš„ã€‚ä½†æ˜¯ï¼Œå³ä½¿<code>åŠ è½½äº‹ä»¶</code>æ˜¯ä¸€ä¸ªé¡µé¢ç”Ÿå‘½å‘¨æœŸä¸­å®šä¹‰çš„ä¸€ä¸ªç²¾å‡†çš„æ—¶åˆ»ï¼Œè¿™ä¸ªæ—¶åˆ»ä¹Ÿå¹¶ä¸ä¸ç”¨æˆ·å…³å¿ƒçš„ä»»ä½•ä¸œè¥¿ç›¸å¯¹åº”ã€‚</p>
<p>æ¯”å¦‚ï¼Œä¸€ä¸ªæœåŠ¡å™¨å¯èƒ½å‘é€äº†ä¸€ä¸ªæœ€å°åŒ–çš„é¡µé¢ç«‹åˆ»å°±åŠ è½½äº†ï¼Œä½†æ˜¯æ¨è¿Ÿæ‹‰å–å†…å®¹å’Œå±•ç¤ºå†…å®¹ï¼Œç›´åˆ°æ•°ç§’å<code>è´Ÿè½½äº‹ä»¶</code>å‘èµ·ã€‚è™½ç„¶è¿™ä¸ªé¡µé¢å¯èƒ½åŠ è½½çš„å¾ˆå¿«ï¼Œä½†æ˜¯è¿™ä¸ªå¾ˆå¿«å¹¶ä¸å¯¹åº”ä¸€ä¸ªç”¨æˆ·æ„Ÿè§‰è¿™ä¸ªé¡µé¢å¾ˆå¿«ã€‚</p>
<p>è¿‡å»æ•°å¹´é‡Œï¼ŒChrome å›¢é˜Ÿæˆå‘˜å’Œ<a href="https://www.w3.org/webperf/">W3C Web Performance Working Group</a>ä¸€ç›´é½å¿ƒåŠªåŠ›æ ‡å‡†åŒ–ä¸€äº›å¯ä»¥æ›´ç²¾ç¡®è®¡ç®—ç”¨æˆ·å¦‚ä½•æ„ŸçŸ¥ç½‘é¡µæ€§èƒ½çš„ API å’ŒæŒ‡æ ‡ã€‚</p>
<p>ä¸ºäº†ç¡®ä¿è¿™äº›æŒ‡æ ‡æ˜¯ç”¨æˆ·ç›¸å…³çš„ï¼Œæˆ‘ä»¬å›´ç»•ä¸€äº›å…³é”®æ€§é—®é¢˜å±•å¼€ï¼š</p>
<table>
<thead>
<tr>
<th>å…³é”®æ€§é—®é¢˜</th>
<th>ä¸¾ä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td>æ˜¯å¦å‘ç”Ÿ</td>
<td>å¯¼èˆªæˆåŠŸå¯åŠ¨äº†å—ï¼ŸæœåŠ¡å™¨å“åº”äº†å—ï¼Ÿ</td>
</tr>
<tr>
<td>æ˜¯å¦æœ‰ç”¨</td>
<td>æ˜¯å¦å†…å®¹éƒ½æ¸²æŸ“å®Œæ¯•äº†ï¼Ÿ</td>
</tr>
<tr>
<td>æ˜¯å¦å¯ç”¨</td>
<td>ç”¨æˆ·å¯å¯ä»¥ä¸é¡µé¢äº¤äº’äº†å—ï¼Œè¿˜æ˜¯é¡µé¢å¾ˆå¿™ï¼Ÿ</td>
</tr>
<tr>
<td>æ˜¯å¦ä¼˜é›…</td>
<td>äº¤äº’æ˜¯å¦é¡ºç•…è‡ªç„¶ï¼Œæ²¡æœ‰æ»åå’Œåœé¡¿ï¼Ÿ</td>
</tr>
</tbody></table>
<h2 id="æŒ‡æ ‡å¦‚ä½•è®¡ç®—"><a href="#æŒ‡æ ‡å¦‚ä½•è®¡ç®—" class="headerlink" title="æŒ‡æ ‡å¦‚ä½•è®¡ç®—"></a>æŒ‡æ ‡å¦‚ä½•è®¡ç®—</h2><p>æ€§èƒ½æŒ‡æ ‡ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼å¯ä»¥è®¡ç®—ï¼š</p>
<ul>
<li><strong>å®éªŒç¯å¢ƒï¼š</strong>ä½¿ç”¨å·¥å…·æ¨¡æ‹Ÿé¡µé¢åœ¨ä¸€ä¸ªç›¸åŒçš„å—æ§ç¯å¢ƒä¸‹åŠ è½½</li>
<li><strong>çœŸå®ç¯å¢ƒï¼š</strong>é€šè¿‡å®é™…åŠ è½½é¡µé¢å’Œä¸ä¹‹äº¤äº’çš„ç”¨æˆ·è®¡ç®—</li>
</ul>
<p>è¿™äº›æ–¹æ³•å¹¶æ²¡æœ‰ä¸€ä¸ªç¡®å®šçš„å­°ä¼˜å­°åŠ£çš„å…³ç³»ã€‚å®é™…ä¸Šï¼Œä½ é€šå¸¸ä¼šåŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹æ³•ä»¥ç¡®ä¿æ›´å¥½çš„æ€§èƒ½</p>
<h2 id="å¼€å‘ç¯å¢ƒ"><a href="#å¼€å‘ç¯å¢ƒ" class="headerlink" title="å¼€å‘ç¯å¢ƒ"></a>å¼€å‘ç¯å¢ƒ</h2><p>å½“å¼€å‘æ–°åŠŸèƒ½çš„æ—¶å€™ï¼Œå¼€å‘ç¯å¢ƒä¸‹æµ‹è¯•æ€§èƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æ–°åŠŸèƒ½å‘å¸ƒä¹‹å‰ï¼Œé€šè¿‡çœŸå®ç”¨æˆ·æµ‹è¯•æ€§èƒ½ç‰¹å¾æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åœ¨äº§å“å‘å¸ƒä¹‹å‰ï¼Œå¼€å‘ç¯å¢ƒæµ‹è¯•ä»¥å…æ€§èƒ½é™ä½æ˜¯æœ€å¥½çš„æ–¹æ³•ã€‚</p>
<h2 id="çœŸå®ç¯å¢ƒ"><a href="#çœŸå®ç¯å¢ƒ" class="headerlink" title="çœŸå®ç¯å¢ƒ"></a>çœŸå®ç¯å¢ƒ</h2><p>å¦ä¸€æ–¹é¢ï¼Œè™½ç„¶åœ¨å¼€å‘ç¯å¢ƒä¸‹æµ‹è¯•æ˜¯æµ‹è¯•æ€§èƒ½çš„ä¸€ç§åˆç†æ›¿ä»£ï¼Œä½†æ˜¯è¿™ä¹Ÿå¹¶ä¸ä¸€å®šåæ˜ äº†æ‰€æœ‰ç”¨æˆ·åœ¨ä½ çš„ç½‘ç«™ä¸Šçš„ä½“éªŒã€‚</p>
<p>ç”¨æˆ·è®¾å¤‡çš„ä¸åŒå’Œç”¨æˆ·ç½‘ç»œè´¨é‡å¥½çš„å¥½åéƒ½ä¼šä½¿å¾—ä¸åŒç”¨æˆ·å¯¹åº”çš„ç½‘é¡µæ€§èƒ½å·®è·å¾ˆå¤§ã€‚å½“ç„¶è¿™è¿˜åŸºäºç”¨æˆ·æ˜¯å¦ä¸é¡µé¢äº¤äº’æˆ–è€…å¦‚ä½•ä¸é¡µé¢è¿›è¡Œäº¤äº’ã€‚</p>
<p>æ­¤å¤–ï¼ŒåŠ è½½çš„ç½‘é¡µä¸ä¸€å®šæ˜¯ç¡®å®šçš„ã€‚æ¯”å¦‚ï¼Œä¸€äº›åŠ è½½ä¸ªæ€§åŒ–å†…å®¹æˆ–è€…å¹¿å‘Šçš„ç½‘ç«™çš„æ€§èƒ½å¯èƒ½ä¼šå› äººè€Œå¼‚ã€‚è€Œå¼€å‘ç¯å¢ƒå¹¶ä¸èƒ½æ•æ‰åˆ°è¿™äº›ä¸åŒã€‚</p>
<h2 id="æŒ‡æ ‡ç±»å‹"><a href="#æŒ‡æ ‡ç±»å‹" class="headerlink" title="æŒ‡æ ‡ç±»å‹"></a>æŒ‡æ ‡ç±»å‹</h2><p>è¿˜æœ‰ä¸€äº›å…¶ä»–ç±»å‹çš„æŒ‡æ ‡å’Œç”¨æˆ·çœ‹å¾…æ€§èƒ½æœ‰å…³</p>
<ul>
<li><strong>æ„ŸçŸ¥åŠ è½½é€Ÿåº¦ï¼š</strong> é¡µé¢åŠ è½½å¹¶æ¸²æŸ“æ‰€æœ‰å¯è§å…ƒç´ åˆ°å±å¹•ä¸Šçš„é€Ÿåº¦</li>
<li><strong>åŠ è½½å“åº”åº¦ï¼š</strong> é¡µé¢åŠ è½½å’Œæ‰§è¡Œ<code>JavaScript</code>ä»£ç ç”Ÿæˆç”¨æ¥äº¤äº’çš„ç»„ä»¶çš„é€Ÿåº¦</li>
<li><strong>è¿è¡Œæ—¶å“åº”åº¦ï¼š</strong> é¡µé¢åŠ è½½å®Œæ¯•åï¼Œé¡µé¢å¯ä»¥å“åº”ç½‘é¡µäº¤äº’çš„é€Ÿåº¦</li>
<li><strong>è§†è§‰ç¨³å®šæ€§ï¼š</strong> ç½‘é¡µå…ƒç´ æ˜¯å¦ä¸å¦‚ç”¨æˆ·æœŸå¾…é‚£æ ·ç§»åŠ¨äº†å¹¶ä¸”è¿˜æ½œåœ¨çš„å¹²æ‰°äº†ç”¨æˆ·çš„äº¤äº’</li>
</ul>
<p>é‰´äºä»¥ä¸Šæ‰€æœ‰ç±»å‹çš„æ€§èƒ½æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°æ„è¯†åˆ°ï¼šæ²¡æœ‰ä¸€ä¸ªå•ç‹¬çš„æŒ‡æ ‡å¯ä»¥éå¸¸æœ‰æ•ˆçš„æ•æ‰åˆ°ä¸€ä¸ªé¡µé¢çš„æ‰€æœ‰æ€§èƒ½ç‰¹å¾ã€‚</p>
<h2 id="é‡è¦çš„æŒ‡æ ‡"><a href="#é‡è¦çš„æŒ‡æ ‡" class="headerlink" title="é‡è¦çš„æŒ‡æ ‡"></a>é‡è¦çš„æŒ‡æ ‡</h2><ul>
<li><a href="https://web.dev/fcp/">First Contentful Paint(FCP)</a>ï¼šé¡µé¢ä¸›å¼€å§‹åŠ è½½åˆ°ä»»ä¸€å…ƒç´ æ¸²æŸ“åˆ°å±å¹•ä¸Šçš„æ—¶é—´ã€‚</li>
<li><a href="https://web.dev/lcp/">Largest Contentful Paint(LCP)</a>ï¼šé¡µé¢ä¸›å¼€å§‹åŠ è½½åˆ°æœ€å¤šçš„å…ƒç´ æ¸²æŸ“åˆ°å±å¹•ä¸Šçš„æ—¶é—´ã€‚</li>
<li><a href="https://web.dev/fid/">First Input Delay(FID)</a>ï¼šç”¨æˆ·é¦–æ¬¡ä¸é¡µé¢äº¤äº’(æ¯”å¦‚å½“ç‚¹å‡»é“¾æ¥æˆ–è€…ä¸€ä¸ªæŒ‰é’®æˆ–è€…ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>JavaScript</code>é©±åŠ¨)åˆ°æµè§ˆå™¨å®é™…å“åº”çš„æ—¶é—´ã€‚</li>
<li><a href="https://web.dev/tti/">Time to Interactive(TTI)</a>ï¼šé¡µé¢ä»åŠ è½½åˆ°è¿›è¡Œè§†è§‰æ¸²æŸ“å¹¶å¯èƒ½å¯é å“åº”ç”¨æˆ·è¾“å…¥çš„é¡µé¢çš„æ—¶é—´ã€‚</li>
<li><a href="https://web.dev/tbt/">Total Blocking Time(TBT)</a>ï¼šé¡µé¢ä¸›å¼€å§‹åŠ è½½åˆ°ä»»ä¸€å…ƒç´ æ¸²æŸ“åˆ°å±å¹•ä¸Šçš„æ—¶é—´ã€‚</li>
</ul>
<h2 id="è‡ªå®šä¹‰æŒ‡æ ‡"><a href="#è‡ªå®šä¹‰æŒ‡æ ‡" class="headerlink" title="è‡ªå®šä¹‰æŒ‡æ ‡"></a>è‡ªå®šä¹‰æŒ‡æ ‡</h2>]]></content>
      <categories>
        <category>æ€§èƒ½ä¼˜åŒ–</category>
      </categories>
      <tags>
        <tag>Webæ€§èƒ½</tag>
        <tag>æ€§èƒ½æŒ‡æ ‡</tag>
      </tags>
  </entry>
  <entry>
    <title>å‰ç«¯æ€§èƒ½ä¼˜åŒ–----ç½‘ç»œç¯‡</title>
    <url>/bloger/2021/04/01/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96----%E7%BD%91%E7%BB%9C%E7%AF%87/</url>
    <content><![CDATA[<h1 id="å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-ç½‘ç»œç¯‡"><a href="#å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-ç½‘ç»œç¯‡" class="headerlink" title="å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-ç½‘ç»œç¯‡"></a>å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-ç½‘ç»œç¯‡</h1><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>DNS è¿‡ç¨‹ï¼šæµè§ˆå™¨(cache) ==&gt; æ“ä½œç³»ç»Ÿ(hosts) ==&gt; ISP</p>
<h3 id="ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸‰æ¬¡æ¡æ‰‹</h3><p><code>SYN</code>ï¼š åŒæ­¥ä¿¡å·ï¼Œ <code>ACK</code>ï¼š çŸ¥é“ï¼Œ <code>FIN</code>: è¯´å®Œäº†</p>
<p>Round1: <code>A</code>å‘é€<code>SYN(x)</code>ç»™<code>B</code></p>
<p>Round2: <code>B</code>å‘é€<code>ACK(x+1)</code>å’Œ<code>SYN(Y)</code>ç»™<code>A</code></p>
<p>Round3: <code>A</code>å‘é€<code>ACK(y+1)</code>ç»™<code>B</code></p>
<p>ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„å¿…è¦æ€§ï¼šå‰ä¸¤æ¬¡ç»“æŸè¯´æ˜<code>A</code>èƒ½å‘ï¼Œ<code>B</code>èƒ½æ”¶ï¼Œ<code>B</code>èƒ½å‘ï¼Œéœ€è¦æœ€å<code>A</code>å‘é€<code>ACK(y+1)</code>è¿™æ ·<code>B</code>æ‰èƒ½çŸ¥é“<code>A</code>èƒ½æ”¶</p>
<p>ä¸‰æ¬¡æ¡æ‰‹æˆåŠŸä¹‹åå°±å¯ä»¥å‘é€<code>HTTP</code>å†…å®¹äº†</p>
<h3 id="å››æ¬¡æŒ¥æ‰‹"><a href="#å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="å››æ¬¡æŒ¥æ‰‹"></a>å››æ¬¡æŒ¥æ‰‹</h3><p>ä¹Ÿå¯èƒ½<code>B</code>å…ˆå‘<code>FIN(x)</code>ç»™<code>A</code></p>
<p>Round1: <code>A</code>å‘é€<code>FIN(x)</code>ç»™<code>B</code></p>
<p>Round2: <code>B</code>å‘é€<code>ACK(x+1)</code>ç»™<code>A</code></p>
<p>è¿™ä¸¤æ¬¡æŒ¥æ‰‹ç»“æŸ<code>B</code>å°±çŸ¥é“äº†<code>A</code>è¯´å®Œäº†</p>
<p><code>Round3</code>ä¹‹å‰<code>B</code>è¿˜æœ‰å¯èƒ½ä¼šç»§ç»­è¯´è¯ï¼Œå› ä¸º<code>B</code>çŸ¥é“<code>A</code>è¯´å®Œäº†ï¼Œä½†æ˜¯<code>B</code>å¯èƒ½è¿˜æ²¡æœ‰è¯´å®Œ</p>
<p>Round3: <code>B</code>å‘é€<code>FIN(y)</code>ç»™<code>A</code></p>
<p>Round4: <code>A</code>å‘é€<code>ACK(y+1)</code>ç»™<code>B</code></p>
<p><code>Round4</code>ä¹‹å<code>A</code>ä¹ŸçŸ¥é“<code>B</code>è¯´å®Œäº†</p>
<p>ä¸ºä»€ä¹ˆå››æ¬¡æŒ¥æ‰‹ä¸­é—´ä¸¤æ¬¡ä¸èƒ½åˆå¹¶ï¼Ÿ å› ä¸º<code>Round2</code>å’Œ<code>Round3</code>ä¹‹é—´<code>B</code>è¿˜å¯èƒ½æœ‰è¯è¦è¯´</p>
<h3 id="HTTP-è¯·æ±‚å’Œå“åº”"><a href="#HTTP-è¯·æ±‚å’Œå“åº”" class="headerlink" title="HTTP è¯·æ±‚å’Œå“åº”"></a>HTTP è¯·æ±‚å’Œå“åº”</h3><p>å¯ä»¥ä½¿ç”¨<code>WireShark</code>æŠ“åŒ…æŸ¥çœ‹è¯·æ±‚</p>
<h3 id="æµè§ˆå™¨åŸºæœ¬åŸç†"><a href="#æµè§ˆå™¨åŸºæœ¬åŸç†" class="headerlink" title="æµè§ˆå™¨åŸºæœ¬åŸç†"></a>æµè§ˆå™¨åŸºæœ¬åŸç†</h3><ol>
<li><code>JS</code>çš„ä¸‹è½½å’Œæ‰§è¡Œä¼šé˜»å¡<code>HTML</code>çš„è§£æ</li>
</ol>
<ul>
<li><p><code>JS</code>çš„ä¸‹è½½ä¼šé˜»å¡<code>HTML</code>çš„è§£æï¼Œ å› ä¸º<code>JS</code>æ˜¯ä¸€è¡Œä¸€è¡Œè§£æçš„ï¼Œè§£æåˆ°<code>&lt;script&gt;</code>æ ‡ç­¾å°±å¿…é¡»ç­‰åˆ°<code>JS</code>ä¸‹è½½å®Œæ¯•</p>
</li>
<li><p><code>JS</code>çš„æ‰§è¡Œä¼šé˜»å¡<code>HTML</code>çš„è§£æï¼Œ å› ä¸º<code>JS</code>å¯èƒ½ä¼šæ”¹å˜<code>DOM</code>çš„ç»“æ„ï¼ˆä½¿ç”¨è¯¸å¦‚ <code>document.write(&lt;p&gt;ä½ å¥½&lt;/p&gt;)</code>ç­‰<code>API</code>ï¼‰</p>
</li>
</ul>
<ol start="2">
<li><code>async</code>å’Œ<code>defer</code>çš„åŒºåˆ«</li>
</ol>
<ul>
<li><p><code>defer</code>ä¸‹è½½<code>JS</code>ä¸ä¼šå½±å“<code>HTML</code>è§£æï¼Œå¹¶ä¸”ä¿è¯<code>JS</code>æ‰§è¡Œåœ¨<code>HTML</code>è§£æä¹‹åï¼Œ<code>DOM ready</code>ä¹‹å‰</p>
</li>
<li><p>å¤šä¸ª<code>defer</code>æ‰§è¡Œé¡ºåºæŒ‰ç…§ä»£ç ä¹¦å†™é¡ºåºæ¥</p>
</li>
<li><p><code>async</code>ä¸‹è½½<code>JS</code>å®Œå…¨å’Œ<code>HTML</code>è§£ææ²¡å…³ç³»ï¼Œæ‰§è¡Œé¡ºåºåœ¨<code>DOM ready</code>ä¹‹å‰è¿˜æ˜¯ä¹‹åæ˜¯ä¸ç¡®å®šçš„</p>
</li>
<li><p>å¤šä¸ª<code>async</code>æ‰§è¡Œé¡ºåºä¹Ÿæ˜¯ä¸ç¡®å®šçš„</p>
</li>
</ul>
<ol start="3">
<li><code>CSS</code>çš„è§£æä¼šé˜»å¡<code>JS</code>çš„æ‰§è¡Œ</li>
</ol>
<ul>
<li><p><code>CSS</code>çš„è§£æä¼šä¸å½±å“<code>JS</code>çš„ä¸‹è½½</p>
</li>
<li><p><code>JS</code>çš„æ‰§è¡Œéœ€è¦è¯»å–<code>CSS</code>è§£æç»“æœï¼Œæ‰€ä»¥å¾—ç­‰åˆ°<code>CSS</code>çš„è§£æå®Œæ¯•æ‰èƒ½æ‰§è¡Œ<code>JS</code></p>
</li>
<li><p><code>JS</code>æ‰§è¡Œå‰è¦ç¡®ä¿<code>CSS</code>çš„ä¸‹è½½å’Œè§£æéƒ½å®Œæ¯•</p>
</li>
</ul>
<ol start="4">
<li>å¸ƒå±€ã€ç»˜åˆ¶ã€åˆæˆ(Layout, Paint, Composite)</li>
</ol>
<ul>
<li><p>å¸ƒå±€è§£å†³å¤§å°å°ºå¯¸ç­‰é—®é¢˜(ä½ç½®)</p>
</li>
<li><p>ç»˜åˆ¶è§£å†³é¢œè‰²é˜´å½±é—®é¢˜(å¤–è§‚)</p>
</li>
<li><p>åˆæˆè§£å†³å±‚æ¬¡é—®é¢˜(å›¾å±‚)</p>
</li>
<li><p>æ›´æ–°é˜¶æ®µï¼šLayout ==&gt; reflow Paint ==&gt; repaint</p>
</li>
<li><p>é‚£äº›å±æ€§æ“ä½œä¼šè§¦å‘<code>reflow</code>å’Œ<code>repaint</code> å¯ä»¥æŸ¥çœ‹<a href="https://csstriggers.com/">CSS Triggers</a></p>
</li>
</ul>
<h3 id="Chrome-æµè§ˆå™¨å·¥å…·"><a href="#Chrome-æµè§ˆå™¨å·¥å…·" class="headerlink" title="Chrome æµè§ˆå™¨å·¥å…·"></a>Chrome æµè§ˆå™¨å·¥å…·</h3><ul>
<li><p><code>Network</code>é¢æ¿ï¼šæŸ¥çœ‹é¡µé¢æ—¶é—´çº¿</p>
</li>
<li><p><code>Performance</code>é¢æ¿ï¼šæŸ¥çœ‹<code>JS</code>æ€§èƒ½</p>
</li>
<li><p><code>Rendering</code>é¢æ¿ï¼šæŸ¥çœ‹é¡µé¢æ¸²æŸ“</p>
</li>
<li><p><code>Coverage</code>é¢æ¿ï¼šæŸ¥çœ‹ä»£ç ä½¿ç”¨ç‡</p>
</li>
<li><p><code>Lighthouse</code>é¢æ¿ï¼šæŸ¥çœ‹ä¼˜åŒ–å»ºè®®</p>
</li>
</ul>
<p><code>Network</code>é¢æ¿å•ä¸ªè¯·æ±‚<code>Waterfall</code>çš„<code>Waiting(TTFB)</code>æ—¶é—´å¾ˆé•¿å°±å’Œæµè§ˆå™¨æ²¡ä»€ä¹ˆå…³ç³»ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨å¤ªæ…¢ï¼Œè¦ä¹ˆæ˜¯ç”¨æˆ·å¸¦å®½ä¸å¤Ÿ</p>
<h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><ul>
<li><code>Web</code><br>æ€§èƒ½æŒ‡æ ‡ï¼Œ<a href="https://matthrews.github.io/bloger/2021/05/04/%E4%BB%A5%E7%94%A8%E6%88%B7%E4%B8%BA%E4%B8%AD%E5%BF%83%E7%9A%84%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/">å‚è€ƒ</a></li>
</ul>
<h3 id="è¿æ¥çš„å¤ç”¨ä¸å¹¶è¡ŒåŒ–"><a href="#è¿æ¥çš„å¤ç”¨ä¸å¹¶è¡ŒåŒ–" class="headerlink" title="è¿æ¥çš„å¤ç”¨ä¸å¹¶è¡ŒåŒ–"></a>è¿æ¥çš„å¤ç”¨ä¸å¹¶è¡ŒåŒ–</h3><ul>
<li><code>DNS prefetch</code></li>
</ul>
<p>å‡è®¾<code>index.html</code>çš„éƒ¨åˆ†ä»£ç ä¸º</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://a.com/1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://b.com/2.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°æƒ…å†µï¼Œæµè§ˆå™¨ä¼šæŒ‰é¡ºåºåšå¦‚ä¸‹äº‹æƒ…:</p>
<ol>
<li><p><code>DNS</code>è§£æ<code>a.com</code></p>
</li>
<li><p>ä¸‹è½½å¹¶æ‰§è¡Œ<code>1.js</code></p>
</li>
<li><p><code>DNS</code>è§£æ<code>b.com</code></p>
</li>
<li><p>ä¸‹è½½å¹¶æ‰§è¡Œ<code>2.js</code></p>
</li>
</ol>
<p>ä½¿ç”¨<code>prefetch</code>å¯ä»¥å°†<code>æ­¥éª¤1å’Œæ­¥éª¤2</code>åˆå¹¶</p>
<p>ä½¿ç”¨<code>prefetch</code>ä¿®æ”¹å¦‚ä¸‹</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- åœ¨index.htmlçš„headé‡Œå†™ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;dns-prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://a.com/&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;dns-prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://b.com/&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- åœ¨index.htmlçš„å“åº”å¤´é‡Œå†™ --&gt;</span></span><br><span class="line"></span><br><span class="line">Link:</span><br><span class="line">&lt;http://a.com/&gt;; rel=dns-prefetch Link:</span><br><span class="line">&lt;http://b.com/&gt;; rel=dns-prefetch</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TCP</code>è¿æ¥å¤ç”¨</li>
</ul>
<p><code>HTTP</code>è¯·æ±‚å¤´åŠ <code>Connection: keep-alive</code>ï¼Œå“åº”å¤´ä¼šè¿”å›ç›¸åŒå­—æ®µå†…å®¹</p>
<p><code>HTTP</code>è¯·æ±‚å¤´åŠ <code>KeepAlive: timeout=5, max=100</code> è¡¨ç¤ºå¦‚æœä½ <code>5s</code>è¿˜ä¸å‘èµ·è¯·æ±‚æˆ‘å°±å…³é—­<code>TCP</code>è¿æ¥ï¼Œå¹¶ä¸”æœ€å¤šæœç”¨<code>100</code>æ¬¡ï¼Œå†æ¥æˆ‘å°±å…³é—­<code>TCP</code>è¿æ¥ï¼Œé‡æ–°<code>TCP</code><br>æµç¨‹ï¼Œï¼Œå“åº”å¤´å¯èƒ½ä¼šè¿”å›ä¸åŒå­—æ®µå†…å®¹ï¼Œæ­¤æ—¶è¦ä»¥æœåŠ¡å™¨è¿”å›ä¸ºå‡†</p>
<p><code>HTTP/1.1</code>ä¸éœ€è¦è‡ªåŠ¨æœ‰çš„</p>
<ul>
<li>å¹¶è¡ŒåŒ–è¿æ¥</li>
</ul>
<p>å’Œ<code>TCP</code>è¿æ¥å¤ç”¨ç±»ä¼¼ï¼Œ<code>TCP</code>è¿æ¥å¤ç”¨æ˜¯ä¸²è¡Œçš„ï¼Œè€Œå¹¶è¡ŒåŒ–è¿æ¥æ˜¯å¹¶è¡Œçš„</p>
<p>å¹¶è¡Œè¿æ¥ä¸ªæ•°ä¼šå—åˆ°æµè§ˆå™¨é™åˆ¶ï¼Œä¸åŒæµè§ˆå™¨ä¸Šçº¿ä¸åŒ,<code>Chrome</code>æœ€æ–°æµè§ˆå™¨å…è®¸åŒæ—¶å¹¶è¡Œ<code>6</code>ä¸ªè¯·æ±‚</p>
<p>æ­¤æ—¶è¿˜å¯ä»¥é€šè¿‡å°†<code>12</code>ä¸ªèµ„æºåˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªåŸŸåä¸‹åŒæ—¶è¯·æ±‚ï¼Œå°†ä¼šä¸€æ¬¡è¯·æ±‚å¾—åˆ°<code>12</code>ä¸ªç»“æœï¼Œæµè§ˆå™¨å¹¶æ²¡æœ‰é™åˆ¶ä¸åŒåŸŸåçš„ä¸ªæ•°</p>
<p>å¤ç”¨å’Œå¹¶è¡Œæ˜¯ä¸å†²çªçš„</p>
<ul>
<li><code>HTTP</code>ç®¡é“åŒ–</li>
</ul>
<h3 id="HTTP-2çš„å¤šè·¯å¤ç”¨ä¸ServerPush"><a href="#HTTP-2çš„å¤šè·¯å¤ç”¨ä¸ServerPush" class="headerlink" title="HTTP/2çš„å¤šè·¯å¤ç”¨ä¸ServerPush"></a><code>HTTP/2</code>çš„å¤šè·¯å¤ç”¨ä¸<code>ServerPush</code></h3><ul>
<li><p><code>HTTP/1.1</code>æ˜¯åŸºäºå­—ç¬¦ä¸²çš„ï¼Œ<code>HTPP/2</code>æ˜¯åŸºäºå¸§<code>Frame(äºŒè¿›åˆ¶)</code>çš„</p>
</li>
<li><p>å¸§<code>Frame</code>ç”±<code>9</code>ä¸ªå›ºå®šå­—èŠ‚(Lenght+Type+Flags+StreamID)åŠ ä¸Šæœ€å¤§<code>16M</code>å­—èŠ‚çš„<code>æ•°æ®payload</code>æ„æˆçš„</p>
</li>
<li><p>è¯·æ±‚å¤´å’Œå“åº”å¤´ä¼šè¢«å‘é€æ–¹è¿›è¡Œå‹ç¼©ï¼Œåˆ†æˆå‡ ä¸ªè¿ç»­çš„å¸§ä¼ è¾“</p>
</li>
<li><p><code>HTTP/2</code>çš„å¤šè·¯å¤ç”¨ä¸­çš„è·¯å®é™…æ˜¯æµçš„æ¦‚å¿µï¼Œé€šè¿‡æµæ‰¿è½½çš„æ˜¯å¸§</p>
</li>
<li><p><code>HTTP/2</code>çš„å¤šè·¯å¤ç”¨ä¸­çš„æ¯æ¡è·¯ä¸Šåªèƒ½æœ‰ä¸€æ¬¡è¯·æ±‚å’Œå“åº”ï¼Œæ¯æ¡è·¯äº’ä¸å½±å“ï¼Œå“åº”å’Œè¯·æ±‚é€šè¿‡<code>StreamID</code>ä¸€ä¸€å¯¹åº”</p>
</li>
<li><p>æµä¹Ÿæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œä½†æ˜¯å¤šè·¯æ˜¯æ›´å¹¿é˜”çš„èŒƒç•´ï¼Œç›¸å½“äºä»¥å‰åœ¨ä¸€æ¡è·¯ä¸Šè¿›è¡Œå¹¶è¡Œæˆ–è€…å¤ç”¨ï¼Œç°åœ¨ç›´æ¥å¤šäº†å¾ˆå¤šæ¡è·¯</p>
</li>
<li><p>æ¡ˆä¾‹åˆ†æ <a href="https://www.qq.com/">https://www.qq.com/</a></p>
</li>
</ul>
<h3 id="æœåŠ¡ç«¯æ¨é€ServerPush"><a href="#æœåŠ¡ç«¯æ¨é€ServerPush" class="headerlink" title="æœåŠ¡ç«¯æ¨é€ServerPush"></a>æœåŠ¡ç«¯æ¨é€<code>ServerPush</code></h3><p>éœ€è¦<code>åç«¯</code>é…ç½®ï¼Œæ¯”å¦‚<code>nginx</code>é…ç½®çš„<code>location</code>é…ç½®<code>http2_push</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root /usr/share/nginx/html</span><br><span class="line">    index index.html index.html</span><br><span class="line">    http2_push /style.css</span><br><span class="line">    http2_push /logo.png</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">location / &#123;</span><br><span class="line">    root /usr/share/nginx/html</span><br><span class="line">    index index.html index.html</span><br><span class="line">    http2_push_preload on</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç„¶ä¼šåœ¨index.htmlæ–‡ä»¶çš„å“åº”å¤´åŠ </span></span><br><span class="line">Link: &lt;/style.css&gt;; rel=preload; as=style</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Cookie-Free-amp-CDN"><a href="#Cookie-Free-amp-CDN" class="headerlink" title="Cookie Free &amp; CDN"></a>Cookie Free &amp; CDN</h3><ul>
<li><p>èµ„æºåˆå¹¶ï¼šCSS Spritesã€Icon Fontã€SVG Symbols</p>
<p><code>Webpack</code>æä¾›æœ‰<code>CSS Sprites</code>å·¥å…·</p>
</li>
<li><p>èµ„æºå†…è”ï¼šInline Resource</p>
<p>å°å›¾ç‰‡é€šè¿‡<code>data URL</code>å†…è”</p>
<p>å°<code>CSS</code>æ–‡ä»¶åµŒå…¥<code>&lt;style&gt;</code>æ ‡ç­¾</p>
<p>å°<code>JS</code>æ–‡ä»¶<code>&lt;script&gt;</code>æ ‡ç­¾</p>
<p><code>Webpack</code>æä¾›æœ‰<code>url-loader</code>, <code>html-webpack-plugin</code>ç­‰å·¥å…·</p>
</li>
<li><p>èµ„æºå‹ç¼©ï¼š<code>gzipã€nginx</code></p>
<p>Nginx, Apache, NodeJS</p>
<p><a href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html">Nginx</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gzip            on;</span><br><span class="line">gzip_min_length 1000;</span><br><span class="line">gzip_proxied    expired no-cache no-store private auth;</span><br><span class="line">gzip_types      text/plain application/xml;</span><br></pre></td></tr></table></figure>

<p><a href="https://ubiq.co/tech-blog/enable-gzip-compression-apache/">Apache</a></p>
<p><a href="https://nodejs.org/api/zlib.html">NodeJS</a></p>
</li>
<li><p>ä»£ç ç²¾ç®€</p>
<p>HTML ==&gt; åˆ ç©ºæ ¼,åˆ é—­åˆ</p>
<p>CSS ==&gt; åˆ æœªç”¨</p>
<p>JSS ==&gt; æ”¹åï¼Œtree shaking</p>
<p>SVG ==&gt; åˆ æ— ç”¨æ ‡ç­¾å±æ€§</p>
<p>Image ==&gt; å‡å°ä½“ç§¯(æœ‰æŸ/æ— æŸ)</p>
<p>ä½¿ç”¨<code>Webpack</code>ç›¸å…³æ’ä»¶éƒ½å¯ä»¥å®ç°</p>
</li>
<li><p>å‡å°<code>Cookie</code>ä½“ç§¯</p>
<p><code>Cookie</code>ä½“ç§¯ä¸Šé™ï¼š4Kb</p>
<p>å¦‚ä½•å®ç°<code>cookie-free</code>? å°½é‡ä¸è¦ç”¨<code>cookie</code>, å¯ç”¨æ–°åŸŸå</p>
</li>
<li><p>CDN çš„åŸç†å’Œå®æ–½</p>
<p><code>CDN</code>: å†…å®¹åˆ†å‘ç½‘ç»œï¼Œä»ç‰©ç†æ„ä¹‰ä¸Šç¼©çŸ­è·ç¦»ï¼ŒåŠ å¿«é€Ÿåº¦</p>
<p><code>DNS</code>è´Ÿè½½å‡è¡¡: <code>DNS</code>è§£æåŸŸåçš„æ—¶å€™ä¼šè¿”å›ä¸åŒçš„<code>IP</code></p>
<p>å¦‚ä½•å°†æ–‡ä»¶å‘é€åˆ°<code>CDN</code>? ä½¿ç”¨å‘½ä»¤è¡Œå°†æ–‡ä»¶ä¸Šä¼ åˆ°<code>CDN</code>æœåŠ¡å™¨</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li><p>cookie-free</p>
</li>
<li><p>å¹¶è¡Œè¯·æ±‚/å¤šè·¯å¤ç”¨</p>
</li>
<li><p>ä¸‹è½½é€Ÿåº¦å¿«(åªå¤„ç†é™æ€æ–‡ä»¶)</p>
</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>ä»˜è´¹</p>
</li>
<li><p>éƒ¨ç½²å¤æ‚</p>
</li>
<li><p>å¯æ§æ€§å·®</p>
</li>
<li><p>è·¨åŸŸ CORS</p>
</li>
</ul>
</li>
</ul>
<p>CDN ä¼šå‡ºç°ä»€ä¹ˆæ ·çš„è·¨åŸŸé—®é¢˜ï¼Ÿ</p>
<ul>
<li><p><code>Canvas</code>è™½ç„¶å¯ä»¥åŠ è½½è·¨åŸŸå›¾ç‰‡ï¼Œä½†æ˜¯åœ¨è°ƒç”¨ <code>getImageData()</code>, <code>toBlob()</code>, <code>toDataURL()</code>æ—¶ä¼šäº§ç”ŸæŠ¥é”™ï¼Œè§£å†³åŠæ³•æ˜¯å¯<code>CORS</code>å¤´ï¼Œå¹¶ç»™å›¾ç‰‡æ·»åŠ <code>crossorigin=anonymous</code><br>å±æ€§ã€‚<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/CORS_enabled_image">è¯¦è§ MDN</a></p>
</li>
<li><p><code>window.addEventListener(&#39;error&#39;, ...)</code>æ— æ³•æ•è·è·¨åŸŸ<code>JS</code>çš„é”™è¯¯è¯¦æƒ…ã€‚è§£å†³åŠæ³•æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯å¯ç”¨<code>CORS</code>å¤´å¹¶ç»™<code>script</code>æ ‡ç­¾æ·»åŠ <code>crossorigin=anonymous</code><br>å±æ€§ï¼Œå¦ä¸€ä¸ªæ¯”è¾ƒå¼€è„‘æ´ï¼Œæ˜¯é‡å†™<code>addEventListener</code>ï¼Œ<a href="https://juejin.cn/post/6844903727820718094">è¯¦è§ã€Šè§£å†³ â€œScript Errorâ€ çš„å¦ç±»æ€è·¯ã€‹</a></p>
</li>
</ul>
<p><code>gzip</code>å’Œ<code>gzip_static</code>æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<ul>
<li><p><code>Nginx</code>å®é™…ä¸Šæä¾›äº†ä¸¤ç§ <code>gzip</code> æ¨¡å¼<code>gzip on;</code>å’Œ<code>gzip_static on;</code></p>
</li>
<li><p>å‰è€…ä¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶å‹ç¼©æ–‡ä»¶ï¼Œæœ‰ä¸€ç‚¹æµªè´¹ <code>CPU</code><br>è€Œåè€…ä¼šåœ¨é‡åˆ°<code>/path/to/file</code>è¯·æ±‚æ—¶ï¼Œä¸»åŠ¨å¯»æ‰¾<code>/path/to/file.gz</code>ä½œä¸ºå‹ç¼©ç‰ˆæœ¬ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å›æœªå‹ç¼©çš„ç‰ˆæœ¬</p>
</li>
</ul>
<h3 id="ç¼“å­˜å’Œå†…å®¹åå•†"><a href="#ç¼“å­˜å’Œå†…å®¹åå•†" class="headerlink" title="ç¼“å­˜å’Œå†…å®¹åå•†"></a>ç¼“å­˜å’Œå†…å®¹åå•†</h3><ul>
<li><p>Cache-Control</p>
<p><code>HTTP</code>å“åº”å¯ä»¥è¦æ±‚æµè§ˆå™¨å°†æ–‡ä»¶ç¼“å­˜ä¸€æ®µæ—¶é—´ï¼Œå…·ä½“å†™æ³•ä¸ºï¼š<code>Cache-Control: public, max-age=3600, must-revalidate</code></p>
<p>å…¶ä¸­<code>max-age: 3600</code>è¡¨ç¤ºæœ€é•¿ç¼“å­˜æ—¶é—´ä¸º<code>3600</code>ç§’ï¼Œ<code>public</code>è¡¨ç¤ºç½‘ç»œä¸­çš„ä¸­é—´è®¾å¤‡ï¼ˆå¦‚ä»£ç†ï¼‰ä¹Ÿå¯ä»¥ç¼“å­˜æ­¤å†…å®¹ï¼Œ<code>must-revalidate</code>è¡¨ç¤ºç¼“å­˜è¿‡æœŸåä¸èƒ½å†ä½¿ç”¨ï¼Œå¿…é¡»é‡æ–°æ ¡éªŒ(é‡æ–°æ ¡éªŒè¿‡ç¨‹ä¹Ÿå«å†…å®¹åå•†)ã€‚<br>åœ¨æœªæ¥çš„<code>3600</code>ç§’å†…ï¼Œæµè§ˆå™¨å¯¹äºç›¸åŒ<code>URL</code>çš„è¯·æ±‚ï¼Œä¸€å¾‹ä¸å‘å‡ºï¼Œä¸”ç›´æ¥ä½¿ç”¨ç¼“å­˜ä½œä¸ºå…¶å“åº”</p>
</li>
<li><p>å†…å®¹åå•†</p>
<p>ä¸»è¦æ˜¯åå•†è¿‡æœŸä¹‹åèƒ½é‡ç”¨å—ï¼Ÿ</p>
<p>å†…å®¹åå•†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æµè§ˆå™¨ç¬¬ä¸€æ¬¡è®¿é—®èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨é™¤äº†æ·»åŠ ç¼“å­˜ä¹‹å¤–ï¼Œè¿˜ä¼šè®¡ç®—å‡ºèµ„æºçš„å“ˆå¸Œå€¼ï¼Œé™„åŠ åœ¨å“åº”å¤´é‡Œï¼Œå†™æ³•ä¸º<code>ETag: W/&quot;7f9239ce726764aa22093884902e018d&quot;</code>(<code>ETag</code>æ˜¯å®ä½“æ ‡ç­¾)</li>
<li>åœ¨æœ‰æ•ˆæœŸå†…ï¼Œæµè§ˆå™¨ä¸ä¼šå†å¯¹ç›¸åŒçš„URLå‘å‡ºè¯·æ±‚</li>
<li>ç­‰å¾…æœ‰æ•ˆæœŸç»“æŸåï¼Œæµè§ˆå™¨å†æ¬¡è¯·æ±‚åŒä¸€èµ„æºï¼Œä½†æ˜¯ä¼šåœ¨è¯·æ±‚å¤´é™„ä¸Š: <code>If-None-Match: W/&quot;7f9239ce726764aa22093884902e018d&quot;</code></li>
<li>æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œå‘ç°åŒä¸€èµ„æºçš„å“ˆå¸Œå€¼å’Œæµè§ˆå™¨é™„å¸¦çš„å“ˆå¸Œå€¼ä¸€æ ·ï¼Œè¯´æ˜èµ„æºæ²¡å˜ï¼Œå°±ä¼šè¿”å›<code>304(Not Modified)</code></li>
<li>å¦‚æœå‘ç°èµ„æºå“ˆå¸Œå€¼ä¸åŒï¼Œè¯´æ˜æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šè¿”å›<code>200</code>ï¼Œå¹¶å°†æœ€æ–°æ–‡ä»¶å†…å®¹è¿”å›</li>
</ol>
</li>
<li><p>æ–°æ—§ä¸¤å¥—æ–¹æ¡ˆ</p>
<table>
<thead>
<tr>
<th>httpç‰ˆæœ¬</th>
<th>ç¼“å­˜</th>
<th>å†…å®¹åå•†</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP 1.1</td>
<td>Cache-Control:  public, max-age=3600, must-revalidate <br />   ETag: W/â€œ7f9239ce726764aa22093884902e018dâ€</td>
<td>è¯·æ±‚å¤´ï¼šIf-None-Match: W/â€œ7f9239ce726764aa22093884902e018dâ€  <br /> å“åº”ï¼š 304+ç©º/200+æ–°å†…å®¹</td>
</tr>
<tr>
<td>HTTP 1.0</td>
<td>Expire: ç”¨æˆ·PCæ—¶é—´ç‚¹A <br /> Last-Modified: æœåŠ¡å™¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´ç‚¹B</td>
<td>è¯·æ±‚å¤´ï¼šIf-Modified-Since: æœåŠ¡å™¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´ç‚¹B  <br /> å“åº”ï¼š 304+ç©º/200+æ–°å†…å®¹</td>
</tr>
</tbody></table>
<p><code>HTTP 1.0</code>çš„<code>Expire</code>æ˜¯ç”¨æˆ·<code>PC</code>æ—¶é—´ï¼Œæœ‰å¯èƒ½æ˜¯é”™çš„ï¼Œ<code>Last-Modified</code>æ˜¯æœåŠ¡å™¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´ç‚¹ï¼Œç²¾ç¡®åˆ°ç§’ï¼Œæ‰€ä»¥å¦‚æœ<code>1s</code>ä¹‹å†…æ–‡ä»¶è¢«ä¿®æ”¹Næ¬¡ï¼ŒæœåŠ¡å™¨æ˜¯è¯†åˆ«ä¸å‡ºæ¥å˜åŒ–çš„</p>
</li>
<li><p>æœåŠ¡å™¨ç¦ç”¨ç¼“å­˜</p>
<p>ä¸åŠ <code>Cache-Control</code>ï¼Œæµè§ˆå™¨ä¹Ÿå‡ºç¼“å­˜é™æ€èµ„æºï¼Œæ¯”å¦‚<code>GET</code>è¯·æ±‚ï¼Œæˆ–è€…ä½ çš„çŠ¶æ€ç ä¸º<code>200, 203, 206, 300, 301, 400ç­‰</code><br>æ‰‹åŠ¨ç¦ç”¨ç¼“å­˜ï¼š<code>Cache-Control: max-age=0, must-revalidate</code> æˆ–è€… <code>Cache-Control: no-cache</code><br><code>Cache-Control: no-cache</code>æ„æ€æ—¶ä¸ç¼“å­˜å¯ä»¥åå•†ï¼Œ<code>Cache-Control: no-store</code>æ„æ€æ˜¯ä¸ç¼“å­˜ä¸åå•†</p>
</li>
<li><p>æµè§ˆå™¨ç¦ç”¨ç¼“å­˜</p>
<p>è¯·æ±‚åœ°å€ä¸ŠåŠ éšæœºæ•°<br>è¯·æ±‚å¤´åŠ <code>Cache-Control: no-cache, no-store, max-age=0</code></p>
</li>
<li><p><code>Pragma</code> æ˜¯ä»€ä¹ˆ</p>
<p>å®ƒç”¨æ¥å‘åå…¼å®¹åªæ”¯æŒ <code>HTTP/1.0</code> åè®®çš„ç¼“å­˜æœåŠ¡å™¨ï¼Œé‚£æ—¶å€™ <code>HTTP/1.1</code> åè®®ä¸­çš„ <code>Cache-Control</code> è¿˜æ²¡æœ‰å‡ºæ¥<br>è¯·æ±‚å¤´ä¸ºï¼š<code>Pragma: no-cache</code>, å…¶è¡Œä¸ºä¸ <code>Cache-Control: no-cache</code> ä¸€è‡´</p>
</li>
</ul>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li><p>ä¼˜åŒ–å·¥å…·</p>
<p>Network, Performance, Rendering, FPS, Coverage</p>
</li>
<li><p>DNS</p>
<p>Prefetch</p>
</li>
<li><p>TCP</p>
<p>è¿æ¥å¤ç”¨ï¼Œå¹¶è¡Œï¼Œç®¡é“ï¼Œå¤šè·¯å¤ç”¨ï¼ŒæœåŠ¡ç«¯æ¨é€</p>
</li>
<li><p>HTTP</p>
<p>åˆå¹¶ï¼Œå†…è”ï¼Œå‹ç¼©ï¼Œç²¾ç®€(Tree Shaking)ï¼ŒCookie Free, CDN, ç¼“å­˜ï¼Œå†…å®¹åå•†</p>
</li>
<li><p>ä»£ç ä¼˜åŒ–</p>
<p>CSSåœ¨å…ˆï¼ŒJSåœ¨åï¼Œä»£ç æ‹†åˆ†ï¼ŒåŠ¨æ€å¯¼å…¥ï¼Œæ‡’åŠ è½½ï¼Œé¢„åŠ è½½ï¼ŒCSSä¼˜åŒ–ï¼ŒJSä¼˜åŒ–</p>
</li>
</ul>
]]></content>
      <categories>
        <category>æ€§èƒ½ä¼˜åŒ–</category>
      </categories>
      <tags>
        <tag>Webæ€§èƒ½</tag>
      </tags>
  </entry>
  <entry>
    <title>å‰ç«¯æ€§èƒ½ä¼˜åŒ–----é›…è™35æ¡å†›è§„</title>
    <url>/bloger/2021/02/05/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96----%E9%9B%85%E8%99%8E35%E6%9D%A1%E5%86%9B%E8%A7%84/</url>
    <content><![CDATA[<h4 id="å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-é›…è™-35-æ¡å†›è§„"><a href="#å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-é›…è™-35-æ¡å†›è§„" class="headerlink" title="å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-é›…è™ 35 æ¡å†›è§„"></a>å‰ç«¯æ€§èƒ½ä¼˜åŒ–â€”-é›…è™ 35 æ¡å†›è§„</h4><ol>
<li><p>å‡å°‘ HTTP è¯·æ±‚</p>
<p>80%çš„ç»ˆç«¯å“åº”æ—¶é—´ä¸»è¦èŠ±è´¹åœ¨å‰ç«¯ï¼Œè€Œè¿™éƒ¨åˆ†æ—¶é—´ä¸»è¦åœ¨ä¸‹è½½ç½‘é¡µä¸­çš„å›¾ç‰‡ï¼Œæ ·å¼æ–‡ä»¶ï¼Œè„šæœ¬æ–‡ä»¶ï¼Œflash ç­‰èµ„æºã€‚å‡å°‘è¿™äº›èµ„æºçš„æ•°é‡å°±ç›¸åº”åœ°å‡å°‘äº†ç”¨äºæ¸²æŸ“é¡µé¢çš„ HTT è¯·æ±‚æ•°é‡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…·ä½“çš„æ–¹æ³•</p>
</li>
</ol>
<ul>
<li><p>ç®€åŒ–è®¾è®¡</p>
</li>
<li><p>æ‰“åŒ…æ–‡ä»¶ï¼Œå°†å¤šä¸ª JS æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª JS æ–‡ä»¶ï¼ŒåŒæ ·åœ°ï¼Œå°†å¤šä¸ª CSS æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª CSS æ–‡ä»¶</p>
</li>
<li><p>ä½¿ç”¨ CSS Spritesï¼Œå°†é¡µé¢ä¸­ç”¨åˆ°çš„èƒŒæ™¯å°å›¾æ ‡å¹¶åˆæˆä¸€å¼ å›¾ç‰‡ï¼Œå†ä½¿ç”¨ CSS ä¸­çš„<code>bakground-image</code>å’Œ<code>background-position</code>æ¥æ˜¾ç¤ºæ‰€éœ€å›¾åƒéƒ¨åˆ†</p>
</li>
<li><p>å›¾åƒæ˜ å°„ï¼Œhtml æ ‡ç­¾<map>ï¼Œå¯ä»¥åˆ›å»ºå¯ç‚¹å‡»çš„å›¾åƒåŒºåŸŸï¼Œå…·ä½“å‚è€ƒ<code>w3school</code>æˆ–è€… W3C æ–‡æ¡£</p>
</li>
<li><p>å†…åµŒå›¾ç‰‡ï¼Œé€šè¿‡<code>data:URL scheme</code>å†…åµŒ</p>
</li>
</ul>
<ol start="2">
<li><p>ä½¿ç”¨ CDN</p>
<p>åœ¨ç°æœ‰çš„ç½‘ç»œä¸­å¢åŠ ä¸€å±‚æ–°çš„ç½‘ç»œæ¶æ„ï¼Œå°†ç½‘ç«™çš„å†…å®¹å‘å¸ƒåˆ°æœ€æ¥è¿‘ç”¨æˆ·çš„ Cache æœåŠ¡å™¨å†…ï¼Œé€šè¿‡ DNS è´Ÿè´£å‡è¡¡æŠ€æœ¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ¥æºå°±è¿‘è®¿é—® Cache æœåŠ¡å™¨ä¸Šæ‰€éœ€çš„å†…å®¹ã€‚å¦‚æ­¤ä¾¿å¯ä»¥å‡å°‘æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„æ—¶é—´ï¼Œæé«˜é€Ÿåº¦</p>
</li>
<li><p>è®¾ç½®å¤´æ–‡ä»¶è¿‡æœŸæ—¶é—´æˆ–è€…ç¼“å­˜ç­–ç•¥</p>
<ul>
<li>é™æ€å†…å®¹ï¼šå°† Expires å“åº”å¤´è®¾ç½®ä¸ºå°†æ¥å¾ˆè¿œçš„æ—¶é—´ï¼Œå®ç°ã€Œæ°¸ä¸è¿‡æœŸã€ç­–ç•¥ï¼›</li>
<li>åŠ¨æ€å†…å®¹ï¼šè®¾ç½®åˆé€‚çš„ Cache-Control å“åº”å¤´ï¼Œè®©æµè§ˆå™¨æœ‰æ¡ä»¶åœ°å‘èµ·è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><p><code>Gzip</code>å‹ç¼©</p>
<ul>
<li><p><code>Gzip</code>å‹ç¼©é€šå¸¸å¯ä»¥å‡å°‘ 70%çš„å“åº”å¤§å°ï¼Œå¯¹æŸäº›æ–‡ä»¶æ›´å¯èƒ½é«˜è¾¾ 90%ï¼Œæ¯”<code>Deflate</code>æ›´é«˜æ•ˆ</p>
</li>
<li><p>ä¸»æµ Web æœåŠ¡å™¨éƒ½æœ‰ç›¸åº”æ¨¡å—ï¼Œè€Œä¸”ç»å¤§å¤šæ•°æµè§ˆå™¨æ”¯æŒ<code>gzip</code>è§£ç </p>
</li>
<li><p>å›¾ç‰‡å’Œ PDF æ–‡ä»¶ä¸è¦ä½¿ç”¨ <code>gzip</code>ï¼Œå®ƒä»¬æœ¬èº«å·²ç»å‹ç¼©è¿‡ï¼Œå†ä½¿ç”¨<code>gzip</code> å‹ç¼©ä¸ä»…æµªè´¹ CPU èµ„æºï¼Œè€Œä¸”è¿˜å¯èƒ½å¢åŠ æ–‡ä»¶ä½“ç§¯</p>
</li>
<li><p>ä» HTTP/1.1 å¼€å§‹ï¼Œweb å®¢æˆ·ç«¯å°±æœ‰äº†æ”¯æŒå‹ç¼©çš„ Accept-Encoding HTTP è¯·æ±‚å¤´</p>
</li>
</ul>
</li>
<li><p>æŠŠ CSS æ–‡ä»¶æ”¾åœ¨é¡¶éƒ¨</p>
<p>æŠŠæ ·å¼è¡¨æ”¾åœ¨<code>&lt;head&gt;</code>ä¸­å¯ä»¥è®©é¡µé¢æ¸è¿›æ¸²æŸ“ï¼Œå°½æ—©å‘ˆç°è§†è§‰åé¦ˆï¼Œç»™ç”¨æˆ·åŠ è½½é€Ÿåº¦å¾ˆå¿«çš„æ„Ÿè§‰ã€‚</p>
</li>
<li><p>æŠŠ JS æ–‡ä»¶æ”¾åœ¨åº•éƒ¨</p>
<ul>
<li><p>æµè§ˆå™¨ä¸‹è½½è„šæœ¬æ—¶ï¼Œä¼šé˜»å¡å…¶ä»–èµ„æºå¹¶è¡Œä¸‹è½½ï¼Œå³ä½¿æ˜¯æ¥è‡ªä¸åŒåŸŸåçš„èµ„æºã€‚å› æ­¤ï¼Œæœ€å¥½å°†è„šæœ¬æ”¾åœ¨åº•éƒ¨ï¼Œä»¥æé«˜é¡µé¢åŠ è½½é€Ÿåº¦ã€‚</p>
</li>
<li><p>ä¸€äº›ç‰¹æ®Šåœºæ™¯æ— æ³•å°†è„šæœ¬æ”¾åˆ°é¡µé¢åº•éƒ¨çš„ï¼Œå¯ä»¥è€ƒè™‘<code>&lt;script&gt;</code>çš„ä»¥ä¸‹å±æ€§ï¼š</p>
</li>
<li><p>defer å±æ€§ï¼›</p>
</li>
<li><p>HTML5 æ–°å¢çš„<code>async</code>å±æ€§ã€‚</p>
</li>
</ul>
</li>
<li><p>é¿å… CSS è¡¨è¾¾å¼</p>
<p>CSS è¡¨è¾¾å¼å¯ä»¥åœ¨ CSS é‡Œæ‰§è¡Œ JavaScriptï¼Œä»… IE5-IE7 æ”¯æŒï¼ŒIE8 æ ‡å‡†æ¨¡å¼å·²ç»åºŸå¼ƒã€‚ CSS è¡¨è¾¾å¼è¶…å‡ºé¢„æœŸçš„é¢‘ç¹æ‰§è¡Œï¼Œé¡µé¢æ»šåŠ¨ã€é¼ æ ‡ç§»åŠ¨æ—¶éƒ½ä¼šä¸æ–­æ‰§è¡Œï¼Œå¸¦æ¥å¾ˆå¤§çš„æ€§èƒ½æŸè€—ã€‚</p>
</li>
<li><p>å°† JS å’Œ CSS å¤–é“¾</p>
<p>å¤–éƒ¨ JavaScript å’Œ CSS æ–‡ä»¶å¯ä»¥è¢«æµè§ˆå™¨ç¼“å­˜ï¼Œåœ¨ä¸åŒé¡µé¢é—´é‡ç”¨ï¼Œä¹Ÿèƒ½é™ä½é¡µé¢å¤§å°ã€‚</p>
</li>
<li><p>å‡å°‘ DNS æŸ¥è¯¢</p>
<ul>
<li>ç”¨æˆ·è¾“å…¥ URL ä»¥åï¼Œæµè§ˆå™¨é¦–å…ˆè¦æŸ¥è¯¢åŸŸåï¼ˆhostnameï¼‰å¯¹åº”æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œä¸€èˆ¬éœ€è¦è€—è´¹ 20-120 æ¯«ç§’æ—¶é—´ã€‚DNS æŸ¥è¯¢å®Œæˆä¹‹å‰ï¼Œæµè§ˆå™¨æ— æ³•ä»æœåŠ¡å™¨ä¸‹è½½ä»»ä½•æ•°æ®ã€‚</li>
<li>åŸºäºæ€§èƒ½è€ƒè™‘ï¼ŒISPã€å±€åŸŸç½‘ã€æ“ä½œç³»ç»Ÿã€æµè§ˆå™¨éƒ½ä¼šæœ‰ç›¸åº”çš„ DNS ç¼“å­˜æœºåˆ¶ã€‚ IE ç¼“å­˜ 30 åˆ†é’Ÿï¼Œå¯ä»¥é€šè¿‡æ³¨å†Œè¡¨ä¸­ DnsCacheTimeout é¡¹è®¾ç½®ï¼›<br>Firefox ç¼“å­˜ 1 åˆ†é’Ÿï¼Œé€šè¿‡ network.dnsCacheExpiration é…ç½®ï¼›</li>
</ul>
</li>
<li><p>å‡å° JSS å’Œ CSS ä½“ç§¯</p>
<ul>
<li><p>å‹ç¼©ä»£ç å¯ä»¥ç§»é™¤éåŠŸèƒ½æ€§çš„å­—ç¬¦ï¼ˆæ³¨é‡Šã€ç©ºæ ¼ã€ç©ºè¡Œç­‰ï¼‰ï¼Œå‡å°‘æ–‡ä»¶å¤§å°ï¼Œæé«˜è½½å…¥é€Ÿåº¦</p>
</li>
<li><p>å¼€æºç¤¾åŒºæœ‰å¾ˆå¤šå‰ç«¯ä¼˜åŒ–å·¥å…·ï¼Œæ¯”å¦‚ï¼š<a href="https://cssnano.co/">cssnano</a> , <a href="https://www.crockford.com/jsmin.html">JSMin</a><br>, <a href="https://skalman.github.io/UglifyJS-online/">UglifyJS</a></p>
</li>
<li><p><a href="https://gulpjs.com/">Gulp</a>, <a href="https://webpack.js.org/">Webpack</a>ç­‰æµè¡Œæ„å»ºå·¥å…·éƒ½æœ‰ç›¸åº”çš„æ”¯æŒ</p>
</li>
</ul>
</li>
<li><p>é¿å…é‡å®šå‘</p>
<ul>
<li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„é‡å®šå‘å“åº”åï¼Œä¼šæ ¹æ®å“åº”å¤´ä¸­ Location çš„åœ°å€å†æ¬¡å‘é€è¯·æ±‚ã€‚é‡å®šå‘ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œå°¤å…¶æ˜¯å¤šæ¬¡é‡å®šå‘æ—¶ï¼Œç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…çœ‹ä¸åˆ°ä»»ä½•å†…å®¹ï¼Œåªçœ‹åˆ°æµè§ˆå™¨è¿›åº¦æ¡ä¸€ç›´åœ¨åˆ·æ–°ã€‚</li>
<li>æœ€æµªè´¹çš„é‡å®šå‘ç»å¸¸å‘ç”Ÿã€è€Œä¸”å¾ˆå®¹æ˜“è¢«å¿½ç•¥ï¼šURL æœ«å°¾åº”è¯¥æ·»åŠ <code>/</code><br>ä½†æœªæ·»åŠ ã€‚æ¯”å¦‚ï¼Œè®¿é—®<code>http://astrology.yahoo.com/astrology</code>å°†è¢«<code>301</code>é‡å®šå‘åˆ° <code>http://astrology.yahoo.com/astrology/</code>ï¼ˆæ³¨æ„æœ«å°¾çš„ /ï¼‰ã€‚å¦‚æœä½¿ç”¨<br>Apacheï¼Œå¯ä»¥é€šè¿‡<code>Alias</code>æˆ–<code>mod_rewrite</code>æˆ–<code>DirectorySlash</code>è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li>
<li>ç½‘ç«™åŸŸåå˜æ›´ï¼š<code>CNAME</code>ç»“åˆ<code>Alias</code>æˆ–<code>mod_rewrite</code>æˆ–è€…å…¶ä»–æœåŠ¡å™¨ç±»ä¼¼åŠŸèƒ½å®ç°è·³è½¬ã€‚</li>
</ul>
</li>
<li><p>ç§»é™¤é‡å¤è„šæœ¬</p>
<p>é‡å¤çš„è„šæœ¬ä¸ä»…äº§ç”Ÿä¸å¿…è¦çš„ HTTP è¯·æ±‚ï¼Œè€Œä¸”é‡å¤è§£ææ‰§è¡Œæµªè´¹æ—¶é—´å’Œè®¡ç®—èµ„æºã€‚</p>
</li>
<li><p>é…ç½®<code>ETags</code></p>
<p><code>ETags</code>é€šè¿‡æ–‡ä»¶ç‰ˆæœ¬æ ‡è¯†ï¼Œæ–¹ä¾¿æœåŠ¡å™¨åˆ¤æ–­è¯·æ±‚çš„å†…å®¹æ˜¯å¦æœ‰æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰å°±å“åº” 304ï¼Œé¿å…é‡æ–°ä¸‹è½½</p>
</li>
<li><p>ç¼“å­˜ Ajax</p>
<p>æœ‰å°šæœªè¿‡æœŸçš„ Expires æˆ–è€… Cache-Control HTTP å¤´ï¼Œé‚£ä¹ˆä¹‹å‰çš„èµ„æºå°±å¯ä»¥ä»ç¼“å­˜ä¸­è¯»å‡ºã€‚å¿…é¡»é€šçŸ¥æµè§ˆå™¨ï¼Œåº”è¯¥ç»§ç»­ä½¿ç”¨ä¹‹å‰ç¼“å­˜çš„èµ„æºå“åº”ï¼Œè¿˜æ˜¯å»è¯·æ±‚ä¸€ä¸ªæ–°çš„ã€‚å¯ä»¥é€šè¿‡ç»™èµ„æºçš„ Ajax<br>URL é‡Œæ·»åŠ ä¸€ä¸ªè¡¨æ˜ç”¨æˆ·èµ„æºæœ€åä¿®æ”¹æ—¶é—´çš„æ—¶é—´æˆ³æ¥å®ç°ã€‚å¦‚æœèµ„æºä»ä¸Šä¸€æ¬¡ä¸‹è½½ä¹‹åå†æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œæ—¶é—´æˆ³ä¸å˜ï¼Œèµ„æºå°±å°†ä»æµè§ˆå™¨ç¼“å­˜ä¸­ç›´æ¥è¯»å‡ºï¼Œä»è€Œé¿å…ä¸€æ¬¡é¢å¤–çš„ HTTP å¾€è¿”æ¶ˆè€—ã€‚å…·ä½“å‚è€ƒ[3. è®¾ç½®å¤´æ–‡ä»¶è¿‡æœŸæ—¶é—´æˆ–è€…ç¼“å­˜ç­–ç•¥](#3.<br>è®¾ç½®å¤´æ–‡ä»¶è¿‡æœŸæ—¶é—´æˆ–è€…ç¼“å­˜ç­–ç•¥)</p>
</li>
<li><p>å°½æ—©é‡Šæ”¾ç¼“å†²</p>
<p>ç”¨æˆ·è¯·æ±‚é¡µé¢æ—¶ï¼ŒæœåŠ¡å™¨é€šå¸¸éœ€è¦èŠ±è´¹ 200 ~ 500 æ¯«ç§’æ¥ç»„åˆ HTML é¡µé¢ã€‚åœ¨æ­¤æœŸé—´ï¼Œæµè§ˆå™¨å¤„äºç©ºé—²ã€ç­‰å¾…æ•°æ®çŠ¶æ€ã€‚ä½¿ç”¨ PHP ä¸­çš„ flush()å‡½æ•°ï¼Œå¯ä»¥å‘é€éƒ¨åˆ†å·²ç»å‡†å¤‡å¥½çš„<br>HTML åˆ°æµè§ˆå™¨ï¼Œä»¥ä¾¿æœåŠ¡å™¨è¿˜åœ¨å¿™äºå¤„ç†å‰©ä½™é¡µé¢æ—¶ï¼Œæµè§ˆå™¨å¯ä»¥æå‰å¼€å§‹è·å–èµ„æºã€‚</p>
</li>
<li><p>ç”¨ GET æ–¹å¼è¿›è¡Œ Ajax è¯·æ±‚</p>
<p>æµè§ˆå™¨æ‰§è¡Œ POST è¯·æ±‚æ—¶åˆ†æˆä¸¤æ­¥ï¼Œå…ˆå‘é€ Http Headerï¼Œå†å‘é€ dataã€‚è€Œ GET åªä½¿ç”¨ä¸€ä¸ª TCP æ•°æ®åŒ…ï¼ˆHttp Header ä¸ dataï¼‰å‘é€æ•°æ®ï¼Œæ‰€ä»¥é¦–é€‰ GET æ–¹æ³•ã€‚</p>
<p>æ ¹æ® HTTP è§„èŒƒï¼ŒGET ç”¨äºè·å–æ•°æ®ï¼ŒPOST åˆ™ç”¨äºå‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œæ‰€ä»¥ Ajax è¯·æ±‚æ•°æ®æ—¶ä½¿ç”¨ GET æ›´ç¬¦åˆè§„èŒƒã€‚</p>
</li>
<li><p>é¢„åŠ è½½ç»„ä»¶</p>
<p>é¢„å…ˆåŠ è½½åˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´è¯·æ±‚å°†æ¥è¦ä½¿ç”¨çš„èµ„æºï¼Œä»¥ä¾¿ç”¨æˆ·è®¿é—®ä¸‹ä¸€é¡µé¢æ—¶æ›´å¿«åœ°å“åº”</p>
</li>
<li><p>å»¶è¿ŸåŠ è½½ç»„ä»¶</p>
<p>é¡µé¢åˆå§‹åŠ è½½æ—¶å“ªäº›å†…å®¹æ˜¯ç»å¯¹å¿…éœ€çš„ï¼Ÿä¸åœ¨ç­”æ¡ˆä¹‹åˆ—çš„èµ„æºéƒ½å¯ä»¥å»¶è¿ŸåŠ è½½ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li>éé¦–å±ä½¿ç”¨çš„æ•°æ®ã€æ ·å¼ã€è„šæœ¬ã€å›¾ç‰‡ç­‰</li>
<li>ç”¨æˆ·äº¤äº’æ—¶æ‰ä¼šæ˜¾ç¤ºçš„å†…å®¹</li>
</ul>
</li>
<li><p>å‡å°‘ DOM å…ƒç´ æ•°é‡</p>
<p>ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦è€ƒè™‘ç§»é™¤ä¸å¿…è¦çš„æ ‡è®°ï¼š</p>
<ul>
<li>æ˜¯å¦è¿˜åœ¨ä½¿ç”¨è¡¨æ ¼å¸ƒå±€ï¼Ÿ</li>
<li>å¡è¿›å»æ›´å¤šçš„<div>ä»…ä¸ºäº†å¤„ç†å¸ƒå±€é—®é¢˜ï¼Ÿä¹Ÿè®¸æœ‰æ›´å¥½ã€æ›´è¯­ä¹‰åŒ–çš„æ ‡è®°ã€‚</li>
<li>èƒ½é€šè¿‡ä¼ªå…ƒç´ å®ç°çš„åŠŸèƒ½ï¼Œå°±æ²¡å¿…è¦æ·»åŠ é¢å¤–å…ƒç´ ï¼Œå¦‚æ¸…é™¤æµ®åŠ¨ã€‚ æµè§ˆå™¨æ§åˆ¶å°ä¸­è¾“å…¥ä»¥ä¸‹ä»£ç å¯ä»¥è®¡ç®—å‡ºé¡µé¢ä¸­æœ‰å¤šå°‘ DOM å…ƒç´ ï¼š</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;*&quot;</span>).length;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨è¡¨æ ¼å¸ƒå±€ï¼Ÿ<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">+ æ›´å¤šçš„æ ‡ç­¾ï¼Œå¢åŠ æ–‡ä»¶å¤§å°ï¼›</span><br><span class="line">+ ä¸æ˜“ç»´æŠ¤ï¼Œæ— æ³•é€‚åº”å“åº”å¼è®¾è®¡ï¼›</span><br><span class="line">+ æ€§èƒ½è€ƒé‡ï¼Œé»˜è®¤çš„è¡¨æ ¼å¸ƒå±€ç®—æ³•ä¼šäº§ç”Ÿå¤§é‡é‡ç»˜</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>è·¨åŸŸåˆ†ç¦»ç»„ä»¶</p>
<p>æµè§ˆå™¨ä¸€èˆ¬ä¼šé™åˆ¶æ¯ä¸ªåŸŸçš„å¹¶è¡Œçº¿ç¨‹ï¼ˆä¸€èˆ¬ä¸º 6 ä¸ªï¼Œç”šè‡³æ›´å°‘ï¼‰ï¼Œä½¿ç”¨ä¸åŒçš„åŸŸåå¯ä»¥æœ€å¤§åŒ–ä¸‹è½½çº¿ç¨‹ï¼Œä½†æ³¨æ„ä¿æŒåœ¨ 2-4 ä¸ªåŸŸåå†…ï¼Œä»¥é¿å… DNS æŸ¥è¯¢æŸè€—ã€‚</p>
</li>
<li><p>å‡å°‘<code>iframe</code>æ•°é‡</p>
<ul>
<li>ç”¨<code>iframe</code>å¯ä»¥æŠŠä¸€ä¸ª HTML æ–‡æ¡£æ’å…¥åˆ°çˆ¶æ–‡æ¡£é‡Œï¼Œé‡è¦çš„æ˜¯æ˜ç™½<code>iframe</code>æ˜¯å¦‚ä½•å·¥ä½œçš„å¹¶é«˜æ•ˆåœ°ä½¿ç”¨å®ƒã€‚</li>
<li><code>iframe</code>çš„ä¼˜ç‚¹ï¼š<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">+ å¯ä»¥ç”¨æ¥åŠ è½½é€Ÿåº¦è¾ƒæ…¢çš„ç¬¬ä¸‰æ–¹èµ„æºï¼Œå¦‚å¹¿å‘Šã€å¾½ç« ï¼›</span><br><span class="line">+ å¯ç”¨ä½œå®‰å…¨æ²™ç®±ï¼›</span><br><span class="line">+ å¯ä»¥å¹¶è¡Œä¸‹è½½è„šæœ¬ã€‚</span><br></pre></td></tr></table></figure></li>
<li><code>iframe</code>çš„ç¼ºç‚¹ï¼š<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">+ åŠ è½½ä»£ä»·æ˜‚è´µï¼Œå³ä½¿æ˜¯ç©ºçš„é¡µé¢ï¼›</span><br><span class="line">+ é˜»å¡é¡µé¢ load äº‹ä»¶è§¦å‘ï¼›</span><br><span class="line">+ <span class="string">`iframe`</span> å®Œå…¨åŠ è½½ä»¥åï¼Œçˆ¶é¡µé¢æ‰ä¼šè§¦å‘ load äº‹ä»¶ã€‚ Safariã€Chrome ä¸­é€šè¿‡ JavaScript åŠ¨æ€è®¾ç½® iframe src å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚</span><br><span class="line">+ ç¼ºä¹è¯­ä¹‰ã€‚</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>ä¸è¦å‡ºç° 404 é¡µé¢</p>
<p>HTTP è¯·æ±‚å¾ˆæ˜‚è´µï¼Œè¿”å›æ— æ•ˆçš„å“åº”ï¼ˆå¦‚ 404 æœªæ‰¾åˆ°ï¼‰å®Œå…¨æ²¡å¿…è¦ï¼Œé™ä½ç”¨æˆ·ä½“éªŒè€Œä¸”æ¯«æ— ç›Šå¤„</p>
</li>
<li><p>å‡å° Cookie</p>
<p>Cookie è¢«ç”¨äºèº«ä»½è®¤è¯ã€ä¸ªæ€§åŒ–è®¾ç½®ç­‰è¯¸å¤šç”¨é€”ã€‚Cookie é€šè¿‡ HTTP å¤´åœ¨æœåŠ¡å™¨å’Œæµè§ˆå™¨é—´æ¥å›ä¼ é€ï¼Œå‡å°‘ Cookie å¤§å°å¯ä»¥é™ä½å…¶å¯¹å“åº”é€Ÿåº¦çš„å½±å“ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">- å»é™¤ä¸å¿…è¦çš„ Cookieï¼›</span><br><span class="line">- å°½é‡å‹ç¼© Cookie å¤§å°ï¼›</span><br><span class="line">- æ³¨æ„è®¾ç½® Cookie çš„ domain çº§åˆ«ï¼Œå¦‚æ— å¿…è¦ï¼Œä¸è¦å½±å“åˆ° sub-domainï¼›</span><br><span class="line">- è®¾ç½®åˆé€‚çš„è¿‡æœŸæ—¶é—´ã€‚</span><br></pre></td></tr></table></figure></li>
<li><p>å¯¹é™æ€èµ„æºä½¿ç”¨æ—  Cookie çš„åŸŸå</p>
<p>é™æ€èµ„æºä¸€èˆ¬æ— éœ€ä½¿ç”¨ Cookieï¼Œå¯ä»¥æŠŠå®ƒä»¬æ”¾åœ¨ä½¿ç”¨äºŒçº§åŸŸåæˆ–è€…ä¸“é—¨åŸŸåçš„æ—  Cookie æœåŠ¡å™¨ä¸Šï¼Œé™ä½ Cookie ä¼ é€çš„é€ æˆçš„æµé‡æµªè´¹ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚</p>
</li>
<li><p>è¾ƒå°‘ DOM è®¿é—®æ¬¡æ•°</p>
<ul>
<li><p>JavaScript æ“ä½œæ“ä½œ DOM å¾ˆæ…¢ï¼Œå°¤å…¶æ˜¯ DOM èŠ‚ç‚¹å¾ˆå¤šæ—¶ã€‚</p>
</li>
<li><p>ä½¿ç”¨æ—¶åº”è¯¥æ³¨æ„ï¼š</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">- ç¼“å­˜å·²ç»è®¿é—®è¿‡çš„å…ƒç´ ï¼›</span><br><span class="line">- ä½¿ç”¨DocumentFragmentæš‚å­˜DOMï¼Œæ•´ç†å¥½ä»¥åå†æ’å…¥DOMæ ‘ï¼›</span><br><span class="line">- æ“ä½œclassNameï¼Œè€Œä¸æ˜¯å¤šæ¬¡è¯»å†™styleï¼›</span><br><span class="line">- é¿å…ä½¿ç”¨JavaScriptä¿®å¤å¸ƒå±€ã€‚</span><br></pre></td></tr></table></figure></li>
<li><p>å¼€å‘é«˜æ•ˆçš„äº‹ä»¶å¤„ç†å¥æŸ„</p>
<ul>
<li>å‡å°‘ç»‘å®šäº‹ä»¶ç›‘å¬çš„èŠ‚ç‚¹ï¼Œå¦‚é€šè¿‡äº‹ä»¶å§”æ‰˜ï¼›</li>
<li>å°½æ—©å¤„ç†äº‹ä»¶ï¼Œåœ¨ DOMContentLoaded å³å¯è¿›è¡Œï¼Œä¸ç”¨ç­‰åˆ° load ä»¥åã€‚</li>
</ul>
</li>
<li><p>ä½¿ç”¨<code>&lt;link&gt;</code>è€Œé@import</p>
</li>
<li><p>é¿å…ä½¿ç”¨è¿‡æ»¤å™¨</p>
<p>é¿å…ä½¿ç”¨ AlphaImageLoaderï¼Œå¯ä»¥ä½¿ç”¨ PNG8 æ›¿ä»£</p>
</li>
<li><p>ä¼˜åŒ–å›¾ç‰‡</p>
<ul>
<li><a href="https://github.com/imagemin/imagemin">imagemin</a></li>
<li><a href="https://imageoptim.com/mac">imageoptim</a></li>
<li><a href="https://www.queness.com/post/2507/most-effective-method-to-reduce-and-optimize-png-images">PNG ä¼˜åŒ– 1</a></li>
<li><a href="https://www.smashingmagazine.com/2009/07/clever-png-optimization-techniques/">PNG ä¼˜åŒ– 2</a></li>
<li><a href="https://blog.csdn.net/whh181/article/details/94449493">Webp ç›¸å…³å†…å®¹</a></li>
<li><a href="https://segmentfault.com/a/1190000038521158">SVG ç›¸å…³å†…å®¹</a></li>
<li><a href="https://pmt.sourceforge.io/pngcrush/">Pngcrush</a></li>
</ul>
</li>
<li><p>ä¼˜åŒ– CSS Sprites</p>
</li>
</ol>
<ul>
<li>æ°´å¹³æ’åˆ—<code>Sprite</code>ä¸­çš„å›¾ç‰‡ï¼Œå‚ç›´æ’åˆ—ä¼šå¢åŠ å›¾ç‰‡å¤§å°ï¼›</li>
<li><code>Sprite</code>ä¸­æŠŠé¢œè‰²è¾ƒè¿‘çš„ç»„åˆåœ¨ä¸€èµ·å¯ä»¥é™ä½é¢œè‰²æ•°ï¼Œç†æƒ³çŠ¶å†µæ˜¯ä½äº 256 è‰²ä»¥é€‚ç”¨ PNG8 æ ¼å¼ï¼›</li>
<li>ä¸è¦åœ¨<code>Sprite</code>çš„å›¾åƒä¸­é—´ç•™æœ‰è¾ƒå¤§ç©ºéš™ã€‚å‡å°‘ç©ºéš™è™½ç„¶ä¸å¤ªå½±å“æ–‡ä»¶å¤§å°ï¼Œä½†å¯ä»¥é™ä½ç”¨æˆ·ä»£ç†æŠŠå›¾ç‰‡è§£å‹ä¸ºåƒç´ å›¾çš„å†…å­˜æ¶ˆè€—ï¼Œå¯¹ç§»åŠ¨è®¾å¤‡æ›´å‹å¥½ã€‚</li>
</ul>
<ol start="31">
<li><p>ä¸è¦å† HTML ä¸­ä¼¸ç¼©å›¾ç‰‡</p>
<p>ä¸è¦ä½¿ç”¨<img>çš„ widthã€height ç¼©æ”¾å›¾ç‰‡ï¼Œå¦‚æœç”¨åˆ°å°å›¾ç‰‡ï¼Œå°±ä½¿ç”¨ç›¸åº”å¤§å°çš„å›¾ç‰‡</p>
</li>
<li><p>ç¼©å°<code>favicon.ico</code>çš„å¤§å°å¹¶ä½¿ç”¨ç¼“å­˜</p>
<p>Favicon.ico ä¸€èˆ¬å­˜æ”¾åœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹ï¼Œæ— è®ºæ˜¯å¦åœ¨é¡µé¢ä¸­è®¾ç½®ï¼Œæµè§ˆå™¨éƒ½ä¼šå°è¯•è¯·æ±‚è¿™ä¸ªæ–‡ä»¶ã€‚æ‰€ä»¥ç¡®ä¿è¿™ä¸ªå›¾æ ‡ï¼š</p>
<ul>
<li>å­˜åœ¨ï¼ˆé¿å… 404ï¼‰ï¼›</li>
<li>å°½é‡å°ï¼Œæœ€å¥½å°äº 1Kï¼›</li>
<li>è®¾ç½®è¾ƒé•¿çš„è¿‡æœŸæ—¶é—´ã€‚</li>
<li>å¯¹äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ PNG æ ¼å¼çš„ faviconã€‚</li>
</ul>
</li>
<li><p>ä¿è¯ç»„ä»¶åœ¨ 25K ä»¥ä¸‹</p>
<p>è¿™ä¸ªé™åˆ¶æ˜¯å› ä¸º iPhone ä¸èƒ½ç¼“å­˜å¤§äº 25K(å‹ç¼©å‰)çš„ç»„ä»¶</p>
</li>
<li><p>å°†ç»„ä»¶æ‰“åŒ…è¿›ä¸€ä¸ªå¤šéƒ¨åˆ†çš„æ–‡æ¡£ä¸­</p>
</li>
</ol>
<p>æŠŠå„ä¸ªç»„ä»¶æ‰“åŒ…æˆä¸€ä¸ªåƒæœ‰é™„ä»¶çš„ç”µå­é‚®ä»¶ä¸€æ ·çš„å¤åˆæ–‡æ¡£é‡Œï¼Œå¯ä»¥ç”¨ä¸€ä¸ª HTTP è¯·æ±‚è·å–å¤šä¸ªç»„ä»¶ï¼ˆè®°ä½ä¸€ç‚¹ï¼šHTTP è¯·æ±‚æ˜¯ä»£ä»·é«˜æ˜‚çš„ï¼‰ã€‚ç”¨è¿™ç§æ–¹å¼çš„æ—¶å€™ï¼Œè¦å…ˆæ£€æŸ¥ç”¨æˆ·ä»£ç†æ˜¯å¦æ”¯æŒï¼ˆiPhone å°±ä¸æ”¯æŒï¼‰</p>
<ol start="35">
<li><p>é¿å…ç©ºçš„å›¾åƒ<code>src</code>å±æ€§</p>
<ul>
<li>è™½ç„¶ src å±æ€§ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä½†æµè§ˆå™¨ä»ç„¶ä¼šå‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚</li>
<li>ç©ºçš„ href å±æ€§ä¹Ÿå­˜åœ¨ç±»ä¼¼é—®é¢˜</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>æ€§èƒ½ä¼˜åŒ–</category>
      </categories>
      <tags>
        <tag>Webæ€§èƒ½</tag>
      </tags>
  </entry>
  <entry>
    <title>å‰ç«¯æ€§èƒ½ç›‘æ§</title>
    <url>/bloger/2021/06/05/%E5%89%8D%E7%AB%AF%E7%9B%91%E6%8E%A7/%E5%89%8D%E7%AB%AF%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<h1 id="å‰ç«¯æ€§èƒ½ç›‘æ§"><a href="#å‰ç«¯æ€§èƒ½ç›‘æ§" class="headerlink" title="å‰ç«¯æ€§èƒ½ç›‘æ§"></a>å‰ç«¯æ€§èƒ½ç›‘æ§</h1><h2 id="1-ä¸ºä»€ä¹ˆè¦åšå‰ç«¯æ€§èƒ½ç›‘æ§ï¼Ÿ"><a href="#1-ä¸ºä»€ä¹ˆè¦åšå‰ç«¯æ€§èƒ½ç›‘æ§ï¼Ÿ" class="headerlink" title="1. ä¸ºä»€ä¹ˆè¦åšå‰ç«¯æ€§èƒ½ç›‘æ§ï¼Ÿ"></a>1. ä¸ºä»€ä¹ˆè¦åšå‰ç«¯æ€§èƒ½ç›‘æ§ï¼Ÿ</h2><ul>
<li>æ›´å¿«å‘ç°é—®é¢˜å’Œè§£å†³é—®é¢˜</li>
<li>åšäº§å“çš„å†³ç­–ä¾æ®</li>
<li>æå‡å‰ç«¯å·¥ç¨‹å¸ˆçš„æŠ€æœ¯å¹¿åº¦å’Œæ‰“é€ ç®€å†äº®ç‚¹</li>
<li>ä¸ºä¸šåŠ¡æ‰©å±•æä¾›æ›´å¤šå¯èƒ½æ€§</li>
</ul>
<h2 id="2-å‰ç«¯ç›‘æ§ç›®æ ‡"><a href="#2-å‰ç«¯ç›‘æ§ç›®æ ‡" class="headerlink" title="2. å‰ç«¯ç›‘æ§ç›®æ ‡"></a>2. å‰ç«¯ç›‘æ§ç›®æ ‡</h2><h3 id="2-1-ç¨³å®šæ€§"><a href="#2-1-ç¨³å®šæ€§" class="headerlink" title="2.1 ç¨³å®šæ€§"></a>2.1 ç¨³å®šæ€§</h3><ul>
<li>JS é”™è¯¯ JS æ‰§è¡Œé”™è¯¯æˆ– Promise å¼‚å¸¸</li>
<li>èµ„æºå¼‚å¸¸ script, link ç­‰èµ„æºåŠ è½½å¼‚å¸¸</li>
<li>æ¥å£é”™è¯¯ ç½‘ç»œè¯·æ±‚å¼‚å¸¸</li>
<li>ç™½å± é¡µé¢ç©ºç™½</li>
</ul>
<h3 id="2-2-ç”¨æˆ·ä½“éªŒ"><a href="#2-2-ç”¨æˆ·ä½“éªŒ" class="headerlink" title="2.2 ç”¨æˆ·ä½“éªŒ"></a>2.2 ç”¨æˆ·ä½“éªŒ</h3><ul>
<li>åŠ è½½æ—¶é—´ å„é˜¶æ®µåŠ è½½æ—¶é—´</li>
<li>TTFB</li>
<li>FP</li>
<li>FCP</li>
<li>FMP</li>
<li>FID</li>
<li>å¡é¡¿ è¶…è¿‡ 50ms çš„é•¿ä»»åŠ¡</li>
</ul>
<h3 id="2-3-ä¸šåŠ¡"><a href="#2-3-ä¸šåŠ¡" class="headerlink" title="2.3 ä¸šåŠ¡"></a>2.3 ä¸šåŠ¡</h3><ul>
<li>PV</li>
<li>UV</li>
<li>TP</li>
</ul>
<h2 id="3-å‰ç«¯ç›‘æ§æµç¨‹"><a href="#3-å‰ç«¯ç›‘æ§æµç¨‹" class="headerlink" title="3. å‰ç«¯ç›‘æ§æµç¨‹"></a>3. å‰ç«¯ç›‘æ§æµç¨‹</h2><p>åŸ‹ç‚¹ ==&gt; æ•°æ®é‡‡é›† ==&gt; æ•°æ®å»ºæ¨¡å­˜å‚¨ ==&gt; æ•°æ®ä¼ è¾“ï¼ˆå®æ—¶/æ‰¹é‡ï¼‰ ==&gt; æ•°æ®ç»Ÿè®¡ï¼ˆåˆ†æ/æŒ–æ˜ï¼‰==&gt; æ•°æ®å¯è§†åŒ–æˆ–è€…é¢„è­¦</p>
<h3 id="3-1-å¸¸è§åŸ‹ç‚¹æ–¹æ¡ˆ"><a href="#3-1-å¸¸è§åŸ‹ç‚¹æ–¹æ¡ˆ" class="headerlink" title="3.1 å¸¸è§åŸ‹ç‚¹æ–¹æ¡ˆ"></a>3.1 å¸¸è§åŸ‹ç‚¹æ–¹æ¡ˆ</h3><h4 id="3-1-1-ä»£ç åŸ‹ç‚¹"><a href="#3-1-1-ä»£ç åŸ‹ç‚¹" class="headerlink" title="3.1.1 ä»£ç åŸ‹ç‚¹"></a>3.1.1 ä»£ç åŸ‹ç‚¹</h4><ul>
<li>åµŒå…¥ä»£ç çš„å½¢å¼è¿›è¡Œä»£ç åŸ‹ç‚¹ï¼Œæ¯”å¦‚ç‚¹å‡»äº‹ä»¶æ—¶ä¿å­˜ç”¨æˆ·è¡Œä¸ºå‘é€è‡³æœåŠ¡ç«¯</li>
<li>ä¼˜ç‚¹æ˜¯å¯ä»¥ä»»æ„æ—¶åˆ»ç²¾å‡†å‘é€æˆ–ä¿å­˜æ•°æ®</li>
<li>ç¼ºç‚¹æ˜¯å·¥ä½œé‡è¾ƒå¤§</li>
</ul>
<h4 id="3-1-2-å¯è§†åŒ–åŸ‹ç‚¹"><a href="#3-1-2-å¯è§†åŒ–åŸ‹ç‚¹" class="headerlink" title="3.1.2 å¯è§†åŒ–åŸ‹ç‚¹"></a>3.1.2 å¯è§†åŒ–åŸ‹ç‚¹</h4><ul>
<li>ä¸éœ€è¦å¼€å‘äººå‘˜å‚ä¸ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ä¸‰æ–¹å®ç°ï¼Œå®è´¨æ—¶ä½¿ç”¨ç³»ç»Ÿä»£æ›¿äººå·¥ä»£ç åŸ‹ç‚¹</li>
</ul>
<h4 id="3-1-3-æ— ç—•åŸ‹ç‚¹"><a href="#3-1-3-æ— ç—•åŸ‹ç‚¹" class="headerlink" title="3.1.3 æ— ç—•åŸ‹ç‚¹"></a>3.1.3 æ— ç—•åŸ‹ç‚¹</h4><ul>
<li>å‰ç«¯ä»»æ„ä¸€ä¸ªäº‹ä»¶éƒ½è¢«ç»‘å®šä¸€ä¸ªæ ‡è¯†ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½è®°å½•ä¸‹æ¥</li>
<li>é€šè¿‡å®šæœŸä¸Šä¼ æ–‡ä»¶ï¼Œé…åˆæ–‡ä»¶è§£æï¼Œè§£æå‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œå¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š</li>
<li>ä¼˜ç‚¹æ˜¯é‡‡é›†å…¨é¢ï¼Œä¸ä¼šå‡ºç°æ¼åŸ‹å’Œè¯¯åŸ‹ç°è±¡</li>
<li>ç¼ºç‚¹æ˜¯ç»™æ•°æ®ä¼ è¾“å’ŒæœåŠ¡å™¨å¢åŠ å‹åŠ›ï¼Œä¹Ÿæ— æ³•çµæ´»å®šåˆ¶æ•°æ®ç»“æ„</li>
</ul>
<h2 id="4-è„šæœ¬ç¼–å†™"><a href="#4-è„šæœ¬ç¼–å†™" class="headerlink" title="4. è„šæœ¬ç¼–å†™"></a>4. è„šæœ¬ç¼–å†™</h2><h3 id="4-1-å¼€é€šæ—¥å¿—æœåŠ¡"><a href="#4-1-å¼€é€šæ—¥å¿—æœåŠ¡" class="headerlink" title="4.1 å¼€é€šæ—¥å¿—æœåŠ¡"></a>4.1 å¼€é€šæ—¥å¿—æœåŠ¡</h3><p>å‚è€ƒ<a href="https://help.aliyun.com/document_detail/31752.htm?spm=a2c4g.11186623.2.24.19542e93WSQKIL#t13028.html">Web Tracking æ–‡æ¡£</a></p>
<h3 id="4-2-ç›‘æ§é”™è¯¯"><a href="#4-2-ç›‘æ§é”™è¯¯" class="headerlink" title="4.2 ç›‘æ§é”™è¯¯"></a>4.2 ç›‘æ§é”™è¯¯</h3><ul>
<li>jsError</li>
<li>promiseError</li>
<li>resourceError</li>
</ul>
<h3 id="4-3-æ¥å£å¼‚å¸¸é‡‡é›†è„šæœ¬"><a href="#4-3-æ¥å£å¼‚å¸¸é‡‡é›†è„šæœ¬" class="headerlink" title="4.3 æ¥å£å¼‚å¸¸é‡‡é›†è„šæœ¬"></a>4.3 æ¥å£å¼‚å¸¸é‡‡é›†è„šæœ¬</h3><h3 id="4-4-ç™½å±"><a href="#4-4-ç™½å±" class="headerlink" title="4.4 ç™½å±"></a>4.4 ç™½å±</h3><h3 id="4-5-åŠ è½½æ—¶é—´"><a href="#4-5-åŠ è½½æ—¶é—´" class="headerlink" title="4.5 åŠ è½½æ—¶é—´"></a>4.5 åŠ è½½æ—¶é—´</h3><h3 id="4-6-æ€§èƒ½æŒ‡æ ‡"><a href="#4-6-æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="4.6 æ€§èƒ½æŒ‡æ ‡"></a>4.6 æ€§èƒ½æŒ‡æ ‡</h3><blockquote>
<p>å‚è€ƒï¼š<a href="https://cloud.tencent.com/developer/article/1650831">https://cloud.tencent.com/developer/article/1650831</a></p>
</blockquote>
<blockquote>
<p>æºç å‚è€ƒï¼š<a href="https://github.com/Matthrews/web-monitor">https://github.com/Matthrews/web-monitor</a></p>
</blockquote>
<h2 id="æ›´å¤š"><a href="#æ›´å¤š" class="headerlink" title="æ›´å¤š"></a>æ›´å¤š</h2><ul>
<li><a href="https://www.fundebug.com/">ä¸€è¡Œä»£ç æå®š BUG ç›‘æ§ï¼</a></li>
</ul>
]]></content>
      <categories>
        <category>å‰ç«¯æ€§èƒ½ç›‘æ§</category>
      </categories>
      <tags>
        <tag>å‰ç«¯æ€§èƒ½ç›‘æ§</tag>
      </tags>
  </entry>
  <entry>
    <title>SUMMARY</title>
    <url>/bloger/2021/05/08/%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96/SUMMARY/</url>
    <content><![CDATA[<h1 id="SUMMARY"><a href="#SUMMARY" class="headerlink" title="SUMMARY"></a>SUMMARY</h1><ul>
<li><p>[] <a href="%E5%8C%BA%E5%9D%97%E9%93%BE.md">åŒºå—é“¾</a></p>
</li>
<li><p>[] <a href="%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6.md">æ™ºèƒ½åˆçº¦</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>å»ä¸­å¿ƒåŒ–</category>
      </categories>
  </entry>
  <entry>
    <title>åŒºå—é“¾</title>
    <url>/bloger/2021/08/02/%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96/%E5%8C%BA%E5%9D%97%E9%93%BE/</url>
    <content><![CDATA[<h1 id="æ•¬è¯·æœŸå¾…"><a href="#æ•¬è¯·æœŸå¾…" class="headerlink" title="æ•¬è¯·æœŸå¾…!!!"></a>æ•¬è¯·æœŸå¾…!!!</h1>]]></content>
      <tags>
        <tag>æ— æœåŠ¡åº”ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title>æ™ºèƒ½åˆçº¦</title>
    <url>/bloger/2021/08/02/%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/</url>
    <content><![CDATA[<h1 id="æ•¬è¯·æœŸå¾…"><a href="#æ•¬è¯·æœŸå¾…" class="headerlink" title="æ•¬è¯·æœŸå¾…!!!"></a>æ•¬è¯·æœŸå¾…!!!</h1>]]></content>
      <tags>
        <tag>æ— æœåŠ¡åº”ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title>SUMMARY</title>
    <url>/bloger/2021/05/08/%E5%9B%BE%E8%A7%A3Google%20V8/SUMMARY/</url>
    <content><![CDATA[<h1 id="SUMMARY"><a href="#SUMMARY" class="headerlink" title="SUMMARY"></a>SUMMARY</h1><h2 id="JavaScript-è®¾è®¡æ€æƒ³"><a href="#JavaScript-è®¾è®¡æ€æƒ³" class="headerlink" title="JavaScript è®¾è®¡æ€æƒ³"></a>JavaScript è®¾è®¡æ€æƒ³</h2><ul>
<li><p><a href="%E4%B8%BA%E4%BB%80%E4%B9%88%E5%87%BD%E6%95%B0%E6%98%AF%E4%B8%80%E7%AD%89%E5%85%AC%E6%B0%91%EF%BC%9F.md">ä¸ºä»€ä¹ˆå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Ÿ</a></p>
</li>
<li><p>[] <a href="DNS%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84.md">dns æ˜¯å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡çš„</a></p>
</li>
<li><p>[] <a href="Nginx%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.md">nginx å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†</a></p>
</li>
</ul>
<h2 id="V8-ç¼–è¯‘æµæ°´çº¿"><a href="#V8-ç¼–è¯‘æµæ°´çº¿" class="headerlink" title="V8 ç¼–è¯‘æµæ°´çº¿"></a>V8 ç¼–è¯‘æµæ°´çº¿</h2><h2 id="äº‹ä»¶å¾ªç¯å’Œåƒåœ¾å›æ”¶"><a href="#äº‹ä»¶å¾ªç¯å’Œåƒåœ¾å›æ”¶" class="headerlink" title="äº‹ä»¶å¾ªç¯å’Œåƒåœ¾å›æ”¶"></a>äº‹ä»¶å¾ªç¯å’Œåƒåœ¾å›æ”¶</h2>]]></content>
      <categories>
        <category>V8</category>
      </categories>
  </entry>
  <entry>
    <title>ä½ å¿…é¡»è¦çŸ¥é“çš„30ä¸ª Linux å‘½ä»¤</title>
    <url>/bloger/2021/04/16/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E4%BD%A0%E5%BF%85%E9%A1%BB%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%8430%E4%B8%AA%20Linux%20%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="ä½ å¿…é¡»è¦çŸ¥é“çš„-30-ä¸ª-Linux-å‘½ä»¤"><a href="#ä½ å¿…é¡»è¦çŸ¥é“çš„-30-ä¸ª-Linux-å‘½ä»¤" class="headerlink" title="ä½ å¿…é¡»è¦çŸ¥é“çš„ 30 ä¸ª Linux å‘½ä»¤"></a>ä½ å¿…é¡»è¦çŸ¥é“çš„ 30 ä¸ª Linux å‘½ä»¤</h2><ol>
<li>pwd</li>
</ol>
<blockquote>
<p>åˆ—å‡ºå½“å‰æ‰€åœ¨ç›®å½•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/mnt/c/Users/Matthew/Desktop</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="2">
<li>cd</li>
</ol>
<blockquote>
<p>æ–‡ä»¶å¤¹åˆ‡æ¢</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew$ <span class="built_in">cd</span> Downloads/</span><br><span class="line">root@matthew:/mnt/c/Users/Matthew/Downloads$</span><br></pre></td></tr></table></figure>

<p>å¿«æ·æ–¹å¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ..   <span class="comment"># è¿”å›ä¸Šä¸€å±‚</span></span><br><span class="line"><span class="built_in">cd</span>      <span class="comment"># ç›´æ¥åˆ°homeç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> -    <span class="comment"># é€€å›åˆ°ä¸Šä¸€æ¬¡ç›®å½•</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="3">
<li>ls</li>
</ol>
<blockquote>
<p>åˆ—å‡ºå½“å‰æ–‡ä»¶å¤¹å†…å®¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Videos$ ls</span><br><span class="line">Captures  desktop.ini</span><br></pre></td></tr></table></figure>

<p>å¿«æ·æ–¹å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ls -R  <span class="comment"># åˆ—å‡ºå½“å‰æ–‡ä»¶å¤¹ä»¥åŠå½“å‰æ–‡ä»¶å¤¹å­æ–‡ä»¶å¤¹å†…å®¹</span></span><br><span class="line">ls -a  <span class="comment"># åˆ—å‡ºéšè—æ–‡ä»¶</span></span><br><span class="line">ls -al <span class="comment"># åˆ—å‡ºå½“å‰æ–‡ä»¶å¤¹å†…å®¹ä»¥åŠè¯¦æƒ…ï¼ŒåŒ…æ‹¬æ–‡ä»¶æƒé™ï¼Œå¤§å°ï¼Œæ‹¥æœ‰è€…ç­‰ç­‰</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="4">
<li>cat</li>
</ol>
<blockquote>
<p>é€šè¿‡æ ‡å‡†è¾“å‡ºæŸ¥çœ‹æ–‡ä»¶å†…å®¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ cat 1.txt</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>å¦‚ä½•ä½¿ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt;4.txt   				<span class="comment"># åˆ›å»ºæ–°æ–‡ä»¶4.txt</span></span><br><span class="line">cat 1.txt 2.txt&gt;3.txt 	<span class="comment"># æŠŠ1.txtå’Œ2.txtæ–‡ä»¶å†…å®¹æ‹¼æ¥èµ·æ¥è¾“å‡ºåˆ°æ–°æ–‡ä»¶3.txt</span></span><br><span class="line">cat 1.txt | tr a-z A-Z &gt;3.txt <span class="comment"># å°†1.txtæ–‡ä»¶å†…å®¹å°å†™è½¬å¤§å†™ï¼Œç„¶åè¾“å‡ºåˆ°3.txt</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="5">
<li>cp</li>
</ol>
<blockquote>
<p>æŠŠå½“å‰æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶å¤åˆ¶åˆ°å…¶ä»–æ–‡ä»¶å¤¹ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ cp 2.txt .. <span class="comment"># æŠŠå½“å‰æ–‡ä»¶å¤¹ä¸‹2.txtå¤åˆ¶åˆ°ä¸Šä¸€å±‚ç›®å½•ä¸‹</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="6">
<li>mv</li>
</ol>
<blockquote>
<p>ä¸»è¦ç”¨äºç§»åŠ¨æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥é‡å‘½åæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ mv 2.txt .. <span class="comment"># æŠŠå½“å‰æ–‡ä»¶å¤¹ä¸‹2.txtç§»åŠ¨åˆ°ä¸Šä¸€å±‚ç›®å½•ä¸‹</span></span><br><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ mv 1.txt out.txt <span class="comment"># å°†å½“å‰æ–‡ä»¶å¤¹ä¸‹1.txtæ–‡ä»¶åæ”¹ä¸ºout.txt</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="7">
<li>mkdir</li>
</ol>
<blockquote>
<p>åˆ›å»ºæ–‡ä»¶å¤¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ mkdir dir1</span><br></pre></td></tr></table></figure>

<p>å¿«æ·æ–¹å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir p1/p2  <span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹p1çš„å­æ–‡ä»¶å¤¹p2</span></span><br><span class="line">mkdir -p p1/parentDir/p2 <span class="comment"># åœ¨å·²ç»åˆ›å»ºçš„æ–‡ä»¶å¤¹p1å’Œp2ä¹‹é—´åˆ›å»ºæ–°æ–‡ä»¶å¤¹parentDir, p2æˆä¸ºparentDirçš„å­æ–‡ä»¶å¤¹</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="8">
<li>rmdir</li>
</ol>
<blockquote>
<p>åˆ é™¤æ–‡ä»¶å¤¹ï¼Œä½†æ˜¯åªå…è®¸ä½ åˆ é™¤ç©ºæ–‡ä»¶å¤¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ rmdir dir1</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="9">
<li>rm</li>
</ol>
<blockquote>
<p>åˆ é™¤æ–‡ä»¶å¤¹ä»¥åŠæ–‡ä»¶å¤¹å†…å®¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ rm 2.txt</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rm -r dir2  <span class="comment">## åˆ é™¤æ–‡ä»¶å¤¹dir2ä»¥åŠå†…å®¹</span></span><br><span class="line">rm -rf dir2 <span class="comment">## å¼ºåˆ¶åˆ é™¤æ–‡ä»¶å¤¹dir2ä»¥åŠå†…å®¹</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="10">
<li>touch</li>
</ol>
<blockquote>
<p>åˆ›å»ºæ–°æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ touch index.js</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="11">
<li>locate</li>
</ol>
<blockquote>
<p>æœç´¢æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ locate -i <span class="keyword">in</span>*x.html</span><br><span class="line">/usr/lib/python3/dist-packages/twisted/python/_pydoctortemplates/index.html</span><br><span class="line">/usr/share/doc/adduser/examples/adduser.local.conf.examples/skel.other/index.html /usr/share/doc/gdisk/index.html</span><br><span class="line">/usr/share/doc/python3/python-policy.html/index.html</span><br><span class="line">/usr/share/doc/shared-mime-info/shared-mime-info-spec.html/index.html</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„<br>locate ä¸ find ä¸åŒ: find æ˜¯å»ç¡¬ç›˜æ‰¾ï¼Œlocate åªåœ¨ /var/lib/slocate èµ„æ–™åº“ä¸­æ‰¾<br>locate çš„é€Ÿåº¦æ¯” find å¿«ï¼Œå®ƒå¹¶ä¸æ˜¯çœŸçš„æŸ¥æ‰¾ï¼Œè€Œæ˜¯æŸ¥æ•°æ®åº“</p>
</blockquote>
<ol start="11">
<li>find</li>
</ol>
<blockquote>
<p>åœ¨ç»™å®šçš„æ–‡ä»¶å¤¹å†…æœç´¢æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ find . -name 3.txt</span><br><span class="line">./3.txt</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . -name tran.txt     <span class="comment"># åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹å¯»æ‰¾tran.txtæ–‡ä»¶</span></span><br><span class="line">find . -iname tran.txt     <span class="comment"># åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹å¯»æ‰¾tran.txtæ–‡ä»¶ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™</span></span><br><span class="line">find . -<span class="built_in">type</span> d -name dir  <span class="comment"># åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹æ‰¾diræ–‡ä»¶å¤¹</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="12">
<li>grep</li>
</ol>
<blockquote>
<p>æ–‡ä»¶å†…å®¹æœç´¢</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ grep 123 index.js 123 123 123</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep -i -w <span class="string">&#x27;hello&#x27;</span> index.js        <span class="comment"># index.jsæ–‡ä»¶é‡Œæœç´¢helloï¼ŒåŒºåˆ†å¤§å°å†™</span></span><br><span class="line">grep -E -i -w <span class="string">&#x27;123|hello&#x27;</span> index.js <span class="comment"># index.jsæ–‡ä»¶é‡Œæœç´¢123æˆ–è€…helloï¼ŒåŒºåˆ†å¤§å°å†™ï¼Œå¹¶ä¸”ä½¿ç”¨æ­£åˆ™åŒ¹é…</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="13">
<li>sudo</li>
</ol>
<blockquote>
<p>ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ</p>
</blockquote>
<ol start="14">
<li>df</li>
</ol>
<blockquote>
<p>æŸ¥çœ‹ç³»ç»Ÿç£ç›˜ä½¿ç”¨æƒ…å†µï¼Œå±•ç¤ºå•ä½ä¸º%æˆ–è€… KBï¼Œä½¿ç”¨<code>df -m</code>ä»¥ MB å±•ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ</p>
</blockquote>
<ol start="15">
<li>du</li>
</ol>
<blockquote>
<p>æŸ¥çœ‹æ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„ç£ç›˜å ç”¨æƒ…å†µ<br>æ³¨æ„ï¼šç£ç›˜å ç”¨æƒ…å†µä¸ç­‰äºæ–‡ä»¶å¤§å°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop$ du jquery-ui-table</span><br><span class="line">16      jquery-ui-table/.git/hooks</span><br><span class="line">0       jquery-ui-table/.git/inf</span><br><span class="line">108     jquery-ui-table/.git/objects/pack</span><br><span class="line">108     jquery-ui-table/.git/objects</span><br><span class="line">124     jquery-ui-table/.git</span><br><span class="line">40      jquery-ui-table/src</span><br><span class="line">40      jquery-ui-table/<span class="built_in">test</span></span><br><span class="line">204     jquery-ui-table</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">du -sh babel  <span class="comment"># ç»Ÿè®¡babelæ–‡ä»¶å¤¹ç£ç›˜å ç”¨æƒ…å†µï¼Œå¹¶ä»¥åˆé€‚çš„å•ä½æ˜¾ç¤º</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="16">
<li>head</li>
</ol>
<blockquote>
<p>å±•ç¤ºæ–‡ä»¶å‰å‡ è¡Œå†…å®¹ï¼Œé»˜è®¤å‰ 10 è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ head index.js</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">head -n 5 index.js        <span class="comment"># æŸ¥çœ‹index.jsæ–‡ä»¶å‰5è¡Œå†…å®¹</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="17">
<li>tail</li>
</ol>
<blockquote>
<p>å’Œ head ç±»ä¼¼ï¼Œå±•ç¤ºåé¢å‡ è¡Œ</p>
</blockquote>
<ol start="18">
<li>diff</li>
</ol>
<blockquote>
<p>æ–‡ä»¶å†…å®¹é€è¡Œå¯¹æ¯”</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ diff 2.txt 3.txt</span><br><span class="line">5d4</span><br><span class="line">&lt; world</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="19">
<li>chmod</li>
</ol>
<blockquote>
<p>ä¿®æ”¹æ–‡ä»¶çš„è¯»å†™å¯æ‰§è¡Œæƒé™</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod +x deploy.sh  <span class="comment"># è®©deploy.shè„šæœ¬æœ‰å¯æ‰§è¡Œæƒé™</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="20">
<li>chown</li>
</ol>
<blockquote>
<p>ä¿®æ”¹æ–‡ä»¶çš„æ‰€æœ‰æƒ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chown anotheruser deploy.sh  <span class="comment"># å°†deploy.shæ–‡ä»¶æ‰€æœ‰æƒèµ‹äºˆéanotheruser</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="21">
<li>kill</li>
</ol>
<blockquote>
<p>ç»ˆæ­¢è¿›ç¨‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> -KILL 123456 <span class="comment"># æ€æ­»è¿›ç¨‹å·PIDä¸º123456çš„è¿›ç¨‹</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="22">
<li>ping</li>
</ol>
<blockquote>
<p>æµ‹è¯•ä¸æœåŠ¡å™¨è¿æ¥çŠ¶å†µ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew$ ping baidu.com</span><br><span class="line">PING baidu.com (39.156.69.79) 56(84) bytes of data. 64 bytes from 39.156.69.79 (39.156.69.79): icmp_seq=1 ttl=52</span><br><span class="line">time=28.0ms 64 bytes from 39.156.69.79 (39.156.69.79): icmp_seq=2 ttl=52 time=30.9ms 64 bytes from 39.156.69.79 (</span><br><span class="line">39.156.69.79): icmp_seq=3 ttl=52 time=123 ms ... --- baidu.com ping statistics --- 34 packets transmitted, 34 received,</span><br><span class="line">0% packet loss, time 33235ms rtt min/avg/max/mdev = 27.417/39.384/123.661/22.443 ms</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="23">
<li>wget</li>
</ol>
<blockquote>
<p>ä¸‹è½½æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew$ wget https://baidu.com.cn</span><br><span class="line">--2021-04-16 18:27:05--  https://baidu.com.cn/</span><br><span class="line">Resolving baidu.com.cn (baidu.com.cn)... 39.156.69.79, 220.181.38.148</span><br><span class="line">Connecting to baidu.com.cn (baidu.com.cn)|39.156.69.79|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Moved Temporarily</span><br><span class="line">Location: http://www.baidu.com/ [following]</span><br><span class="line">--2021-04-16 18:27:06--  http://www.baidu.com/</span><br><span class="line">Resolving www.baidu.com (www.baidu.com)... 36.152.44.95, 36.152.44.96</span><br><span class="line">Connecting to www.baidu.com (www.baidu.com)|36.152.44.95|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 2381 (2.3K) [text/html]</span><br><span class="line">Saving to: â€˜index.htmlâ€™</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="24">
<li>uname</li>
</ol>
<blockquote>
<p>æ‰“å° Unix ç³»ç»Ÿåç§°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew$ uname</span><br><span class="line">Linux</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="25">
<li>top</li>
</ol>
<blockquote>
<p>æŒç»­ç›‘å¬è¿›ç¨‹è¿è¡ŒçŠ¶æ€</p>
</blockquote>
<ol start="26">
<li>history</li>
</ol>
<blockquote>
<p>æŸ¥è¯¢è¾“å…¥è®°å½•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew$ <span class="built_in">history</span> | grep baidu <span class="comment"># æŸ¥è¯¢è¾“å…¥baiduç›¸å…³å†å²å‘½ä»¤</span></span><br><span class="line">268 ping baidu.com 269 wget htts://baidu.com.cn 270 wget https://baidu.com.cn</span><br><span class="line">279 <span class="built_in">history</span> | grep baidu</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="27">
<li>man</li>
</ol>
<blockquote>
<p>æŸ¥çœ‹ Linux ä¸­çš„æŒ‡ä»¤å¸®åŠ©ã€é…ç½®æ–‡ä»¶å¸®åŠ©å’Œç¼–ç¨‹å¸®åŠ©ç­‰ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">man vim <span class="comment"># æŸ¥è¯¢vimä½¿ç”¨è¯´æ˜</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="28">
<li>echo</li>
</ol>
<blockquote>
<p>è¾“å‡ºæŒ‡å®šçš„å­—ç¬¦ä¸²</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> hello</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ <span class="built_in">echo</span> Hello, my name is John &gt;&gt; name.txt <span class="comment"># å°†ç»™å®šå­—ç¬¦ä¸²å†™å…¥name.txtæ–‡ä»¶</span></span><br><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ cat name.txt</span><br><span class="line">Hello, my name is John</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="29">
<li>zip, unzip</li>
</ol>
<blockquote>
<p>å‹ç¼©ï¼Œè§£å‹æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰“åŒ…ä¸ºå½“å‰ç›®å½•ä¸‹çš„out.zipï¼ŒåŠ -qè¡¨ç¤ºä¸æ˜¾ç¤ºè¿‡ç¨‹</span></span><br><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ zip  -r out.zip .</span><br><span class="line">adding: 2.txt (deflated 4%)</span><br><span class="line">adding: 3.txt (deflated 6%)</span><br><span class="line">adding: dir/ (stored 0%)</span><br><span class="line">adding: dir/index.html (stored 0%)</span><br><span class="line">adding: dir/index.js (deflated 41%)</span><br><span class="line">adding: dir/name.txt (stored 0%)</span><br><span class="line">adding: dir/ss.tex (stored 0%)</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="30">
<li>hostname</li>
</ol>
<blockquote>
<p>æŸ¥çœ‹ä¸»æœºå</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@matthew:/mnt/c/Users/Matthew/Desktop/<span class="built_in">test</span>$ hostname</span><br><span class="line">matthew</span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <tags>
        <tag>linux command</tag>
      </tags>
  </entry>
  <entry>
    <title>æ•°æ®ç»“æ„ä¸ç®—æ³•</title>
    <url>/bloger/2021/05/08/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/SUMMARY/</url>
    <content><![CDATA[<h1 id="SUMMARY"><a href="#SUMMARY" class="headerlink" title="SUMMARY"></a>SUMMARY</h1><p><a href="https://matthrew.gitbook.io/oliver/">GitBook</a></p>
<!-- - [] [åŒºå—é“¾](åŒºå—é“¾.md)

- [] [æ™ºèƒ½åˆçº¦](æ™ºèƒ½åˆçº¦.md) -->

<!-- <a class="jsbin-embed" href="//jsbin.com/zegawep/embed">JS Bin on jsbin.com</a><script src="//static.jsbin.com/js/embed.min.js?4.1.8"></script> -->
<!-- <script src="https://gist.github.com/Matthrews/994e0100cc1107ee2775f1e700c81e94.js"></script> -->
]]></content>
      <categories>
        <category>æ•°æ®ç»“æ„ä¸ç®—æ³•</category>
      </categories>
  </entry>
  <entry>
    <title>çœ‹æºç çš„ä¸€ç‚¹æ–¹æ³•è®º</title>
    <url>/bloger/2020/12/08/%E6%96%B9%E6%B3%95%E8%AE%BA/%E7%9C%8B%E6%BA%90%E7%A0%81%E7%9A%84%E4%B8%80%E7%82%B9%E6%96%B9%E6%B3%95%E8%AE%BA/</url>
    <content><![CDATA[<h1 id="çœ‹-webpack-æºç æ€»ç»“çš„ä¸€ç‚¹æ–¹æ³•è®º"><a href="#çœ‹-webpack-æºç æ€»ç»“çš„ä¸€ç‚¹æ–¹æ³•è®º" class="headerlink" title="çœ‹ webpack æºç æ€»ç»“çš„ä¸€ç‚¹æ–¹æ³•è®º"></a>çœ‹ webpack æºç æ€»ç»“çš„ä¸€ç‚¹æ–¹æ³•è®º</h1><h2 id="ç”¨åˆ°çš„å·¥å…·"><a href="#ç”¨åˆ°çš„å·¥å…·" class="headerlink" title="ç”¨åˆ°çš„å·¥å…·"></a>ç”¨åˆ°çš„å·¥å…·</h2><ol>
<li>WebStorm</li>
</ol>
<ul>
<li>Collapse All åŠŸèƒ½</li>
<li>Go To Declaration or Usages åŠŸèƒ½</li>
<li>Back åŠŸèƒ½</li>
<li>Forward åŠŸèƒ½</li>
<li>æŒ‰ä¸¤ä¸‹ Shift æœç´¢åŠŸèƒ½å</li>
<li>å¯è·æ‚‰å¿«æ·é”®</li>
</ul>
<ol start="2">
<li>VSCode</li>
</ol>
<ul>
<li>Fold All åŠŸèƒ½</li>
<li>Go To Definition åŠŸèƒ½</li>
<li>Go Back åŠŸèƒ½</li>
<li>Go Forward åŠŸèƒ½</li>
<li>æŒ‰ Ctrl+Shift+P æœç´¢åŠŸèƒ½å</li>
<li>å¯è·æ‚‰å¿«æ·é”®</li>
</ul>
<h2 id="å‡†å¤‡ä»£ç "><a href="#å‡†å¤‡ä»£ç " class="headerlink" title="å‡†å¤‡ä»£ç "></a>å‡†å¤‡ä»£ç </h2><ol>
<li>ä½¿ç”¨ webpack</li>
</ol>
<ul>
<li>åˆ›å»ºä¸€ä¸ª demo é¡¹ç›®ï¼Œç”¨æ¥è°ƒè¯• webpack å’Œ webpack-cli</li>
<li>è¿è¡Œ webpack-cli å°† src/index.js æ‰“åŒ…ä¸º dist/main.js</li>
</ul>
<ol start="2">
<li>ä¸‹è½½ webpack</li>
</ol>
<ul>
<li>ä» GitHub ä¸‹è½½ webpack çš„æºç ï¼Œåˆ‡æ¢è‡³ v5.10.1</li>
<li>ä» GitHub ä¸‹è½½ webpack-cli çš„æºç ï¼Œåˆ‡æ¢è‡³ <a href="mailto:&#x77;&#x65;&#x62;&#112;&#97;&#99;&#x6b;&#45;&#x63;&#x6c;&#105;&#x40;&#52;&#x2e;&#x32;&#x2e;&#x30;">&#x77;&#x65;&#x62;&#112;&#97;&#99;&#x6b;&#45;&#x63;&#x6c;&#105;&#x40;&#52;&#x2e;&#x32;&#x2e;&#x30;</a></li>
<li>ç”¨ IDE çš„ 3 ä¸ªçª—å£åˆ†åˆ«æ‰“å¼€è¿™ 3 ä¸ªé¡¹ç›®</li>
</ul>
<h2 id="å¦‚ä½•è°ƒè¯•"><a href="#å¦‚ä½•è°ƒè¯•" class="headerlink" title="å¦‚ä½•è°ƒè¯•"></a>å¦‚ä½•è°ƒè¯•</h2><ol>
<li>æ€è·¯</li>
</ol>
<ul>
<li>webpack-cli é»˜è®¤ä¼šæ‰§è¡Œ node_modules é‡Œçš„ JS ä»£ç </li>
<li>æˆ‘ä»¬å¯ä»¥ç¯¡æ”¹ node_modules é‡Œçš„æºç </li>
<li>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ npm link æ›¿æ¢ node_modules é‡Œçš„ç›®å½•</li>
</ul>
<ol start="2">
<li>æ­¥éª¤</li>
</ol>
<ul>
<li>åœ¨ webpack é¡¹ç›®æ ¹ç›®å½•é‡Œè¿è¡Œ npm link</li>
<li>åœ¨ webpack-cli é¡¹ç›®å­ç›®å½•é‡Œè¿è¡Œ npm link</li>
<li>åœ¨ demo é¡¹ç›®æ ¹ç›®å½•é‡Œè¿è¡Œ npm link webpack webpack-cli</li>
</ul>
<h2 id="å¼€å§‹é˜…è¯»æºä»£ç "><a href="#å¼€å§‹é˜…è¯»æºä»£ç " class="headerlink" title="å¼€å§‹é˜…è¯»æºä»£ç "></a>å¼€å§‹é˜…è¯»æºä»£ç </h2><ul>
<li><p>ä¸€å®šè¦å¸¦ç€é—®é¢˜å»çœ‹æºç ï¼Œä¸ç„¶ä½ ä¼šè·‘åæœ€ç»ˆæ”¾å¼ƒ</p>
</li>
<li><p>ä¸­é—´è¿‡ç¨‹é‡åˆ°æ–°çš„é—®é¢˜è®°å½•ä¸‹æ¥ä¸‹æ­¤å†æ¥çœ‹</p>
</li>
<li><p>åªçœ‹æ ¸å¿ƒä»£ç ï¼Œæ¯”å¦‚<code>if</code>å—ï¼Œ<code>require</code>å—ï¼Œå£°æ˜å—ï¼Œç›´æ¥<code>return</code>çš„ä»£ç éƒ½å¯ä»¥ä¸çœ‹</p>
</li>
<li><p>æµç¨‹ä»£ç æ¯”è¾ƒå†—é•¿çš„å¯ä»¥æŠŠå…³é”®æ­¥éª¤è®°å½•ä¸‹æ¥ï¼Œåˆ°åé¢å°±å¯ä»¥ä¸²èµ·æ¥</p>
</li>
</ul>
]]></content>
      <categories>
        <category>æ–¹æ³•è®º</category>
      </categories>
      <tags>
        <tag>webpack æºç è§£æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginxå¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†</title>
    <url>/bloger/2021/08/02/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3/Nginx%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h1 id="æ•¬è¯·æœŸå¾…"><a href="#æ•¬è¯·æœŸå¾…" class="headerlink" title="æ•¬è¯·æœŸå¾…!!!"></a>æ•¬è¯·æœŸå¾…!!!</h1>]]></content>
      <tags>
        <tag>æ— æœåŠ¡åº”ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title>DNSæ˜¯å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡çš„</title>
    <url>/bloger/2021/08/02/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3/DNS%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84/</url>
    <content><![CDATA[<h1 id="æ•¬è¯·æœŸå¾…"><a href="#æ•¬è¯·æœŸå¾…" class="headerlink" title="æ•¬è¯·æœŸå¾…!!!"></a>æ•¬è¯·æœŸå¾…!!!</h1>]]></content>
      <tags>
        <tag>æ— æœåŠ¡åº”ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title>SUMMARY</title>
    <url>/bloger/2021/05/08/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3/SUMMARY/</url>
    <content><![CDATA[<h1 id="SUMMARY"><a href="#SUMMARY" class="headerlink" title="SUMMARY"></a>SUMMARY</h1><ul>
<li><p><a href="%E5%8E%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8C%96%E6%8E%A2%E7%B4%A2.md">å»æœåŠ¡å™¨åŒ–æ¢ç´¢</a></p>
</li>
<li><p>[] <a href="DNS%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84.md">dns æ˜¯å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡çš„</a></p>
</li>
<li><p>[] <a href="Nginx%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.md">nginx å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>æœåŠ¡å™¨ç›¸å…³</category>
      </categories>
  </entry>
  <entry>
    <title>å»æœåŠ¡åŒ–æ¢ç´¢</title>
    <url>/bloger/2021/08/02/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3/%E5%8E%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8C%96%E6%8E%A2%E7%B4%A2/</url>
    <content><![CDATA[<h1 id="ç³»åˆ—æ–‡ç« "><a href="#ç³»åˆ—æ–‡ç« " class="headerlink" title="ç³»åˆ—æ–‡ç« "></a>ç³»åˆ—æ–‡ç« </h1><ul>
<li><p><a href="https://blog.csdn.net/cunjie3951/article/details/106906118">å¦‚ä½•ä½¿ç”¨ React å’Œ AWS Amplify æ„å»ºæ— æœåŠ¡å™¨ Web åº”ç”¨ç¨‹åº</a></p>
</li>
<li><p><a href="https://docs.amplify.aws/start/q/integration/react">Amplify Docs</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>æ— æœåŠ¡åº”ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title>FiddleræŠ“åŒ…</title>
    <url>/bloger/2021/08/02/%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3/Fiddler%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<h1 id="æ•¬è¯·æœŸå¾…"><a href="#æ•¬è¯·æœŸå¾…" class="headerlink" title="æ•¬è¯·æœŸå¾…!!!"></a>æ•¬è¯·æœŸå¾…!!!</h1>]]></content>
  </entry>
  <entry>
    <title>WiresharkæŠ“åŒ…</title>
    <url>/bloger/2021/08/02/%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3/Wireshark%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<h1 id="æ•¬è¯·æœŸå¾…"><a href="#æ•¬è¯·æœŸå¾…" class="headerlink" title="æ•¬è¯·æœŸå¾…!!!"></a>æ•¬è¯·æœŸå¾…!!!</h1>]]></content>
  </entry>
  <entry>
    <title>è‡ªåŠ¨åŒ–æµ‹è¯•</title>
    <url>/bloger/2020/12/08/%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95Cypress/</url>
    <content><![CDATA[<h4 id="ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–æµ‹è¯•"><a href="#ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–æµ‹è¯•" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–æµ‹è¯•"></a>ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–æµ‹è¯•</h4><h4 id="ä¸ºä»€ä¹ˆé€‰æ‹©-Cypress"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©-Cypress" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹© Cypress"></a>ä¸ºä»€ä¹ˆé€‰æ‹© Cypress</h4><h5 id="Pupper"><a href="#Pupper" class="headerlink" title="Pupper"></a>Pupper</h5><h5 id="Seleniuum"><a href="#Seleniuum" class="headerlink" title="Seleniuum"></a>Seleniuum</h5><h5 id="Cypress-ç‰¹ç‚¹"><a href="#Cypress-ç‰¹ç‚¹" class="headerlink" title="Cypress ç‰¹ç‚¹"></a>Cypress ç‰¹ç‚¹</h5><ul>
<li>Proï¼šç•Œé¢ç¾è§‚å‹å¥½</li>
<li>Proï¼šæ”¯æŒæ¨¡æ‹Ÿæ‰‹æœº</li>
<li>Proï¼šæ¯ä¸€æ­¥æ“ä½œæˆªå›¾</li>
<li>Proï¼šå…¨ç¨‹å½•å±</li>
<li>Proï¼šæ”¯æŒ debugï¼Œéšæ—¶æš‚åœ</li>
<li>Proï¼šè‡ªåŠ¨ç­‰å¾… UI æ›´æ–°ï¼Œå‡å°‘å¼‚æ­¥ä»£ç </li>
</ul>
<h4 id="Cypress-æ€ä¹ˆåš"><a href="#Cypress-æ€ä¹ˆåš" class="headerlink" title="Cypress æ€ä¹ˆåš"></a>Cypress æ€ä¹ˆåš</h4><ul>
<li>å…³é”®åœ¨å¿«é€Ÿå®‰è£… cypress</li>
<li>vscode<ul>
<li>æ‰“å¼€ cypress æµ‹è¯•çª—å£ï¼š<code>node_modules\.bin\cypress open</code></li>
</ul>
</li>
<li>webstorm<ul>
<li>å®‰è£… cypress æ’ä»¶ï¼Œç„¶åä¼šè¯†åˆ«æµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥å•ä¸ªæˆ–è€…å¤šä¸ªæµ‹è¯•</li>
<li>å®‰è£… reporterï¼š<code>npm install -D cypress-intellij-reporter</code></li>
<li>å‘½ä»¤è¡Œæ‰“å¼€æµè§ˆå™¨çª—å£æµ‹è¯•ï¼š<code>cypress run --no-exit --headed --spec &quot;**/*.spec.js&quot;</code></li>
<li>å…¨å±€å®‰è£…äº†çš„è¯ç›´æ¥ï¼š<code>cypress open</code></li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>æµ‹è¯•æ¡†æ¶</tag>
        <tag>Cypress</tag>
      </tags>
  </entry>
  <entry>
    <title>Webpackæºç æµ…æ</title>
    <url>/bloger/2020/12/20/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/Webpack%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/</url>
    <content><![CDATA[<h1 id="Webpack-æºç æµ…æ"><a href="#Webpack-æºç æµ…æ" class="headerlink" title="Webpack æºç æµ…æ"></a>Webpack æºç æµ…æ</h1><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><p><a href="https://segmentfault.com/a/1190000021585435">https://segmentfault.com/a/1190000021585435</a></p>
</li>
<li><p><a href="https://juejin.cn/post/6844903987129352206">https://juejin.cn/post/6844903987129352206</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
      </categories>
      <tags>
        <tag>Webpack æºç æµ…æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Webpack5æ–°ç‰¹æ€§</title>
    <url>/bloger/2021/04/05/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/Webpack5%E6%96%B0%E7%89%B9%E6%80%A7/</url>
    <content><![CDATA[<h2 id="Webpack5-æ–°ç‰¹æ€§"><a href="#Webpack5-æ–°ç‰¹æ€§" class="headerlink" title="Webpack5 æ–°ç‰¹æ€§"></a>Webpack5 æ–°ç‰¹æ€§</h2><h3 id="æ•´ä½“æ–¹å‘"><a href="#æ•´ä½“æ–¹å‘" class="headerlink" title="æ•´ä½“æ–¹å‘"></a>æ•´ä½“æ–¹å‘</h3><ul>
<li>å°è¯•ä½¿ç”¨æŒä¹…æ€§ç¼“å­˜æ¥æé«˜æ„å»ºæ€§èƒ½</li>
<li>å°è¯•ä½¿ç”¨æ›´å¥½çš„ç®—æ³•å’Œé»˜è®¤å€¼æ¥æ”¹è¿›é•¿æœŸç¼“å­˜</li>
<li>å°è¯•ä½¿ç”¨æ›´å¥½çš„ Tree Shaking å’Œä»£ç ç”Ÿæˆæ¥æ”¹å–„åŒ…å¤§å°</li>
<li>å°è¯•æ”¹å–„ä¸ç½‘ç»œå¹³å°çš„å…¼å®¹æ€§</li>
<li>å°è¯•åœ¨ä¸å¼•å…¥ä»»ä½•ç ´åæ€§å˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæ”¹å–„ v4 çš„å†…éƒ¨ç»“æ„</li>
<li>å°è¯•å¼•å…¥ä¸€äº›çªç ´æ€§å˜åŒ–ä¸ºæœªæ¥åšå‡†å¤‡</li>
</ul>
<h3 id="ä¸å†ä¸º-Node-js-æ¨¡å—è‡ªåŠ¨å¼•ç”¨-Polyfills"><a href="#ä¸å†ä¸º-Node-js-æ¨¡å—è‡ªåŠ¨å¼•ç”¨-Polyfills" class="headerlink" title="ä¸å†ä¸º Node.js æ¨¡å—è‡ªåŠ¨å¼•ç”¨ Polyfills"></a>ä¸å†ä¸º Node.js æ¨¡å—è‡ªåŠ¨å¼•ç”¨ <code>Polyfills</code></h3><ol>
<li><code>webpack4</code>æµè§ˆå™¨ä¸‹<code>node:crypto</code>å¯ç”¨,æ˜¯å› ä¸º<code>webpack4</code>ä½¿ç”¨äº†å®˜æ–¹<code>polyfill: crypto-browserify</code>ï¼Œä½†æ˜¯æ‰“åŒ…ä¸‹æ¥<code>bundle.js</code>æ–‡ä»¶<code>2.2MB</code><br>ï¼ˆæœªå‹ç¼©ï¼‰ï¼Œä¸åŒ…å«<code>node:crypto</code>æ‰“åŒ…ä¸‹æ¥<code>bundle.js</code>ä¹Ÿå°±<code>1020KiB</code></li>
<li><code>webpack5</code>æµè§ˆå™¨ä¸‹<code>node:crypto</code>ä¸å¯ç”¨<br><img src="https://raw.githubusercontent.com/Matthrews/rfzhu_blogs/main/%E5%9B%BE%E7%89%87/webpack5-nopolyfill.png?token=AHD3VNX677UO5DF4B6SAD4LAQAVEO" alt="webpack5"></li>
<li>å»ºè®®</li>
</ol>
<ul>
<li>å°½é‡ä½¿ç”¨å‰ç«¯å…¼å®¹æ¨¡å—ï¼Œæ¯”å¦‚ä½¿ç”¨<code>crypto-js</code>ä»£æ›¿<code>crypto</code></li>
<li>æ‰‹åŠ¨æ·»åŠ  <code>polyfill</code>ï¼Œå‚è€ƒä¸Šå›¾æç¤º</li>
<li>åœ¨<code> package.json</code> ä¸­æ·»åŠ  <code>browser</code> å­—æ®µï¼Œä½¿<code>package</code> ä¸å‰ç«¯å…¼å®¹</li>
</ul>
<ol start="4">
<li><a href="https://github.com/Matthrews/webpack5.vs.webpack4/tree/main/demo2">æºç </a></li>
</ol>
<h3 id="é•¿æœŸç¼“å­˜"><a href="#é•¿æœŸç¼“å­˜" class="headerlink" title="é•¿æœŸç¼“å­˜"></a>é•¿æœŸç¼“å­˜</h3><ol>
<li>ç¡®å®šçš„ Chunkã€æ¨¡å— ID å’Œå¯¼å‡ºåç§° æ–°å¢é•¿æœŸç¼“å­˜ç®—æ³•ï¼Œç”Ÿäº§ç¯å¢ƒé»˜è®¤å¯ç”¨<br><code>chunkIds: &quot;deterministic&quot; moduleIds: &quot;deterministic&quot; mangleExports: &quot;deterministic&quot;</code></li>
<li>çœŸæ­£çš„å†…å®¹å“ˆå¸Œ å½“ä½¿ç”¨<code>[contenthash]</code>æ—¶ï¼ŒWebpack 5 å°†ä½¿ç”¨çœŸæ­£çš„æ–‡ä»¶å†…å®¹å“ˆå¸Œå€¼ã€‚ä¹‹å‰å®ƒ â€œåªâ€ ä½¿ç”¨å†…éƒ¨ç»“æ„çš„å“ˆå¸Œå€¼ã€‚ å½“åªæœ‰æ³¨é‡Šè¢«ä¿®æ”¹æˆ–å˜é‡è¢«é‡å‘½åæ—¶ï¼Œè¿™å¯¹é•¿æœŸç¼“å­˜ä¼šæœ‰ç§¯æå½±å“ã€‚è¿™äº›å˜åŒ–åœ¨å‹ç¼©åæ˜¯ä¸å¯è§çš„</li>
</ol>
<h3 id="å¼€å‘æ”¯æŒ"><a href="#å¼€å‘æ”¯æŒ" class="headerlink" title="å¼€å‘æ”¯æŒ"></a>å¼€å‘æ”¯æŒ</h3><ol>
<li><p>å‘½åä»£ç å— ID é»˜è®¤å¯ç”¨ä»£ç å— ID ç®—æ³•ï¼Œå¼€å‘æ¨¡å¼ä¸‹ç”Ÿæˆçš„æ¨¡å—åç§°å¯è¯»ï¼Œä¾¿äºè°ƒè¯•ï¼Œå°±ä¸éœ€è¦<code>import(/* webpackChunkName: &quot;name&quot; */ &quot;module&quot;)</code>æ¥è°ƒè¯•äº†<br>æ­¤å¤–ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨<code>chunkIds: &quot;named&quot;</code></p>
</li>
<li><p>æ¨¡å—è”é‚¦ Webpack å¯ä»¥é€šè¿‡ DLL æˆ–è€… Externals å¯ä»¥åœ¨åŒä¸€ä¸ªåº”ç”¨é‡Œåšä»£ç å…±äº« Common Chunkï¼Œè€Œæ¨¡å—è”é‚¦å¯ä»¥ä½¿å¾—è·¨åº”ç”¨é—´çœŸæ­£åšåˆ°æ¨¡å—å…±äº«</p>
</li>
</ol>
<h3 id="æ”¯æŒå´­æ–°çš„-Web-å¹³å°ç‰¹æ€§"><a href="#æ”¯æŒå´­æ–°çš„-Web-å¹³å°ç‰¹æ€§" class="headerlink" title="æ”¯æŒå´­æ–°çš„ Web å¹³å°ç‰¹æ€§"></a>æ”¯æŒå´­æ–°çš„ Web å¹³å°ç‰¹æ€§</h3><ol>
<li>æ”¯æŒå´­æ–°çš„ Web å¹³å°ç‰¹æ€§ å†…ç½®èµ„æºæ¨¡å—æ”¯æŒï¼Œæ”¯æŒ<code>import</code>å’Œ<code>URL</code>æ–¹å¼ï¼Œåè€…æ˜¯æ–°æ–¹å¼ï¼Œä¸¾ä¸ªä¾‹å­</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old</span></span><br><span class="line"><span class="keyword">import</span> url <span class="keyword">from</span> <span class="string">&quot;./image.png&quot;</span>;</span><br><span class="line"><span class="comment">// new opts</span></span><br><span class="line"><span class="keyword">new</span> URL(<span class="string">&quot;./image.png&quot;</span>, <span class="keyword">import</span>.meta.url);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>åŸç”Ÿ Worker æ”¯æŒ<br><code>new Worker(new URL(&quot;./worker.js&quot;, import.meta.url))</code></p>
</li>
<li><p>URI Webpack 5 æ”¯æŒåœ¨è¯·æ±‚ä¸­å¤„ç†åè®®</p>
</li>
</ol>
<ul>
<li>æ”¯æŒ<code>data</code></li>
<li>æ”¯æŒ<code>file</code>ï¼šéœ€è¦é€šè¿‡<code>new webpack.experiments.s schemesHttp(s)UriPlugin()</code>é€‰æ‹©åŠ å…¥</li>
<li>æ”¯æŒ<code>https</code></li>
</ul>
<ol start="4">
<li><p>å¼‚æ­¥æ¨¡å— æ”¯æŒå¼‚æ­¥æ¨¡å—â€”â€”åŸºäºå¼‚æ­¥å’Œ Promise çš„æ¨¡å—ï¼Œæ¯”å¦‚<code>import(&quot;lodash&quot;)</code></p>
</li>
<li><p>å¤–éƒ¨èµ„æº å¢åŠ äº†ä¸€äº›å¤–éƒ¨èµ„æºç±»å‹ï¼Œæ¯”å¦‚ promiseã€importã€module å’Œ script</p>
</li>
</ol>
<h3 id="æ”¯æŒå…¨æ–°çš„-Node-js-ç”Ÿæ€ç‰¹æ€§"><a href="#æ”¯æŒå…¨æ–°çš„-Node-js-ç”Ÿæ€ç‰¹æ€§" class="headerlink" title="æ”¯æŒå…¨æ–°çš„ Node.js ç”Ÿæ€ç‰¹æ€§"></a>æ”¯æŒå…¨æ–°çš„ Node.js ç”Ÿæ€ç‰¹æ€§</h3><ol>
<li><p>ç°åœ¨æ”¯æŒ package.json ä¸­çš„ exports å’Œ imports å­—æ®µ</p>
</li>
<li><p>åŸç”Ÿæ”¯æŒ Yarn PnP</p>
</li>
</ol>
<h3 id="å¼€å‘ä½“éªŒ"><a href="#å¼€å‘ä½“éªŒ" class="headerlink" title="å¼€å‘ä½“éªŒ"></a>å¼€å‘ä½“éªŒ</h3><ol>
<li><p>ç»è¿‡ä¼˜åŒ–çš„æ„å»ºç›®æ ‡ Webpack 5 å…è®¸ä¼ é€’ä¸€ä¸ªç›®æ ‡åˆ—è¡¨ï¼Œå¹¶ä¸”æ”¯æŒç›®æ ‡çš„ç‰ˆæœ¬ã€‚ä¸º webpack æä¾›å®ƒéœ€è¦ç¡®å®šçš„æ‰€æœ‰ä¿¡æ¯ï¼šä»£ç åŠ è½½æœºåˆ¶ä»¥åŠæ”¯æŒçš„è¯­æ³•</p>
</li>
<li><p>Stats æ”¹è¿›äº†ç»Ÿè®¡æµ‹è¯•æ ¼å¼çš„å¯è¯»æ€§å’Œå†—ä½™æ€§</p>
</li>
<li><p>è¿›åº¦ å¯¹ ProgressPlugin åšäº†ä¸€äº›æ”¹è¿›ï¼Œå®ƒè¢« CLI åœ¨å‚æ•° â€“progress å¼€å¯æ—¶ä½¿ç”¨ï¼Œä½†ä¹Ÿå¯ä»¥ä½œä¸ºæ’ä»¶æ‰‹åŠ¨ä½¿ç”¨</p>
</li>
<li><p>è‡ªåŠ¨æ·»åŠ å”¯ä¸€å‘½å åœ¨ webpack 4 ä¸­ï¼Œå¤šä¸ª webpack è¿è¡Œæ—¶å¯èƒ½ä¼šåœ¨åŒä¸€ä¸ª HTML é¡µé¢ä¸Šå‘ç”Ÿå†²çªï¼Œå› ä¸ºå®ƒä»¬ä½¿ç”¨åŒä¸€ä¸ªå…¨å±€å˜é‡è¿›è¡Œä»£ç å—åŠ è½½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¸º output.jsonpFunction<br>é…ç½®æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„åç§°</p>
</li>
<li><p>è‡ªåŠ¨æ·»åŠ å…¬å…±è·¯å¾„ Webpack 5 ä¼šåœ¨å¯èƒ½çš„æƒ…å†µä¸‹è‡ªåŠ¨ç¡®å®š output.publicPathã€‚</p>
</li>
<li><p>Typescript ç±»å‹ Webpack 5 ä»æºç ä¸­ç”Ÿæˆ typescript ç±»å‹ï¼Œå¹¶é€šè¿‡ npm åŒ…æš´éœ²å®ƒä»¬</p>
</li>
</ol>
<h3 id="æ„å»ºä¼˜åŒ–"><a href="#æ„å»ºä¼˜åŒ–" class="headerlink" title="æ„å»ºä¼˜åŒ–"></a>æ„å»ºä¼˜åŒ–</h3><ol>
<li><p>åµŒå¥—çš„ tree-shaking webpack ç°åœ¨èƒ½å¤Ÿè·Ÿè¸ªå¯¹å¯¼å‡ºçš„åµŒå¥—å±æ€§çš„è®¿é—®ã€‚è¿™å¯ä»¥æ”¹å–„é‡æ–°å¯¼å‡ºå‘½åç©ºé—´å¯¹è±¡æ—¶çš„ Tree Shaking</p>
</li>
<li><p>å†…éƒ¨æ¨¡å— tree-shaking webpack 5 æœ‰ä¸€ä¸ªæ–°çš„é€‰é¡¹ optimization.innerGraphï¼Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹æ˜¯é»˜è®¤å¯ç”¨çš„ï¼Œå®ƒå¯ä»¥å¯¹æ¨¡å—ä¸­çš„æ ‡å¿—è¿›è¡Œåˆ†æï¼Œæ‰¾å‡ºå¯¼å‡ºå’Œå¼•ç”¨ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
</li>
<li><p>CommonJs Tree Shaking å¯¹ CommonJs å¯¼å‡ºå’Œ require() è°ƒç”¨æ—¶çš„å¯¼å‡ºä½¿ç”¨åˆ†æ</p>
</li>
<li><p>å‰¯ä½œç”¨åˆ†æ åœ¨ package.json ä¸­çš„ â€œsideEffectsâ€ æ ‡å¿—å…è®¸æ‰‹åŠ¨å°†æ¨¡å—æ ‡è®°ä¸ºæ— å‰¯ä½œç”¨ï¼Œè¿™å°±å…è®¸åœ¨ä¸ä½¿ç”¨æ—¶æ”¾å¼ƒå®ƒä»¬ã€‚</p>
</li>
</ol>
<p>webpack 5 ä¹Ÿå¯ä»¥æ ¹æ®å¯¹æºä»£ç çš„é™æ€åˆ†æï¼Œè‡ªåŠ¨å°†æ¨¡å—æ ‡è®°ä¸ºæ— å‰¯ä½œç”¨</p>
<ol start="5">
<li><p>æ¨¡å—åˆå¹¶ æ¨¡å—åˆå¹¶ä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªè¿è¡Œæ—¶å·¥ä½œï¼Œå…è®¸æ¯ä¸ªè¿è¡Œæ—¶è¿›è¡Œä¸åŒçš„åˆå¹¶</p>
</li>
<li><p>æ”¹è¿›ä»£ç ç”Ÿæˆ</p>
</li>
<li><p>æ”¹è¿› target é…ç½®</p>
</li>
<li><p>ä»£ç å—æ‹†åˆ†ä¸æ¨¡å—å¤§å°</p>
</li>
</ol>
<h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><ol>
<li>æŒä¹…ç¼“å­˜ æ”¯æŒæ–‡ä»¶ç³»ç»Ÿç¼“å­˜ã€‚å®ƒæ˜¯å¯é€‰çš„ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®å¯ç”¨ï¼š</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  cache: &#123;</span><br><span class="line">    <span class="comment">// 1. å°†ç¼“å­˜ç±»å‹è®¾ç½®ä¸ºæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">    type: <span class="string">&quot;filesystem&quot;</span>,</span><br><span class="line"></span><br><span class="line">    buildDependencies: &#123;</span><br><span class="line">      <span class="comment">// 2. å°†ä½ çš„ config æ·»åŠ ä¸º buildDependencyï¼Œä»¥ä¾¿åœ¨æ”¹å˜ config æ—¶è·å¾—ç¼“å­˜æ— æ•ˆ</span></span><br><span class="line">      config: [__filename],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3. å¦‚æœä½ æœ‰å…¶ä»–çš„ä¸œè¥¿è¢«æ„å»ºä¾èµ–ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®ƒä»¬</span></span><br><span class="line">      <span class="comment">// æ³¨æ„ï¼Œwebpackã€åŠ è½½å™¨å’Œæ‰€æœ‰ä»ä½ çš„é…ç½®ä¸­å¼•ç”¨çš„æ¨¡å—éƒ½ä¼šè¢«è‡ªåŠ¨æ·»åŠ </span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–è¯‘å™¨é—²ç½®å’Œå…³é—­ ç¼–è¯‘å™¨ç°åœ¨éœ€è¦åœ¨ä½¿ç”¨åå…³é—­ã€‚ç¼–è¯‘å™¨ç°åœ¨ä¼šè¿›å…¥å’Œç¦»å¼€ç©ºé—²çŠ¶æ€ï¼Œå¹¶ä¸”æœ‰è¿™äº›çŠ¶æ€çš„é’©å­ã€‚æ’ä»¶å¯èƒ½ä¼šä½¿ç”¨è¿™äº›é’©å­æ¥åšä¸é‡è¦çš„å·¥ä½œ</li>
</ol>
<p>åœ¨ä½¿ç”¨ Node.js API æ—¶ï¼Œä¸€å®šè¦åœ¨å®Œæˆå·¥ä½œåè°ƒç”¨ Compiler.closeã€‚</p>
<ol start="3">
<li>æ–‡ä»¶ç”Ÿæˆ æ‰€ä»¥ webpack ç°åœ¨ä¼šæ£€æŸ¥è¾“å‡ºç›®å½•ä¸­ç°æœ‰çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶å†…å®¹ä¸å†…å­˜ä¸­çš„è¾“å‡ºæ–‡ä»¶è¿›è¡Œæ¯”è¾ƒã€‚åªæœ‰å½“æ–‡ä»¶è¢«æ”¹å˜æ—¶ï¼Œå®ƒæ‰ä¼šå†™å…¥æ–‡ä»¶ã€‚ è¿™åªåœ¨ç¬¬ä¸€æ¬¡æ„å»ºæ—¶è¿›è¡Œã€‚ä»»ä½•å¢é‡æ„å»ºéƒ½ä¼šåœ¨è¿è¡Œä¸­çš„ webpack<br>è¿›ç¨‹ä¸­ç”Ÿæˆæ–°çš„èµ„äº§æ—¶å†™å…¥æ–‡ä»¶</li>
</ol>
<h3 id="é•¿æœŸæœªè§£å†³çš„é—®é¢˜"><a href="#é•¿æœŸæœªè§£å†³çš„é—®é¢˜" class="headerlink" title="é•¿æœŸæœªè§£å†³çš„é—®é¢˜"></a>é•¿æœŸæœªè§£å†³çš„é—®é¢˜</h3><ol>
<li>å•ä¸€æ–‡ä»¶ç›®æ ‡çš„ä»£ç åˆ†å‰² åªå…è®¸å¯åŠ¨å•ä¸ªæ–‡ä»¶çš„ç›®æ ‡ï¼ˆå¦‚ nodeã€WebWorkerã€electron mainï¼‰ç°åœ¨æ”¯æŒè¿è¡Œæ—¶è‡ªåŠ¨åŠ è½½å¼•å¯¼æ‰€éœ€çš„ä¾èµ–ä»£ç ç‰‡æ®µ</li>
</ol>
<p>è¿™å…è®¸å¯¹è¿™äº›ç›®æ ‡ä½¿ç”¨ <code>chunks: &quot;all&quot;</code> å’Œ <code>optimization.runtimeChunk</code></p>
<ol start="2">
<li>è§£æå™¨æ›´æ–°</li>
</ol>
<h3 id="æœªæ¥è®¡åˆ’"><a href="#æœªæ¥è®¡åˆ’" class="headerlink" title="æœªæ¥è®¡åˆ’"></a>æœªæ¥è®¡åˆ’</h3><ol>
<li>å®éªŒç‰¹æ€§</li>
</ol>
<ul>
<li>å¼‚æ­¥ WebAssembly</li>
<li>é¡¶å±‚çš„ Await</li>
</ul>
<ol start="2">
<li>æœ€å° Node.js ç‰ˆæœ¬ æœ€ä½æ”¯æŒçš„ Node.js ç‰ˆæœ¬ä» 6 å¢åŠ åˆ° 10.13.0(LTS)</li>
</ol>
<h3 id="é…ç½®å˜æ›´"><a href="#é…ç½®å˜æ›´" class="headerlink" title="é…ç½®å˜æ›´"></a>é…ç½®å˜æ›´</h3><h3 id="é‡å¤§å†…éƒ¨å˜æ›´"><a href="#é‡å¤§å†…éƒ¨å˜æ›´" class="headerlink" title="é‡å¤§å†…éƒ¨å˜æ›´"></a>é‡å¤§å†…éƒ¨å˜æ›´</h3><ol>
<li><p>ç¼“å­˜æ’ä»¶æ›´æ–° å¢åŠ äº†ä¸€ä¸ªå¸¦æœ‰æ’ä»¶æ¥å£çš„ Cache ç±»ã€‚è¯¥ç±»å¯ç”¨äºå†™å…¥å’Œè¯»å–ç¼“å­˜ã€‚æ ¹æ®é…ç½®çš„ä¸åŒï¼Œä¸åŒçš„æ’ä»¶å¯ä»¥ä¸ºç¼“å­˜æ·»åŠ åŠŸèƒ½ã€‚MemoryCachePlugin å¢åŠ äº†å†…å­˜ç¼“å­˜åŠŸèƒ½ã€‚FileCachePlugin<br>å¢åŠ äº†æŒä¹…æ€§ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰ç¼“å­˜</p>
</li>
<li><p>ä»æ•°ç»„åˆ°é›†åˆ(Set)</p>
</li>
<li><p>æ¨¡å—çƒ­æ›¿æ¢</p>
</li>
<li><p>å…¨æ–°çš„ç›‘å¬ å®ƒä¹‹å‰ä½¿ç”¨çš„æ˜¯ chokidar å’ŒåŸç”Ÿä¾èµ– fseventsï¼ˆä»…åœ¨ macOS ä¸Šï¼‰ã€‚ç°åœ¨å®ƒåœ¨åªåŸºäºåŸç”Ÿçš„ Node.js ä¸­çš„ fs</p>
</li>
</ol>
<h2 id="é‡ç‚¹"><a href="#é‡ç‚¹" class="headerlink" title="é‡ç‚¹"></a>é‡ç‚¹</h2><ul>
<li>ç¼“å­˜</li>
<li>Tree Shaking</li>
<li>æ‹¥æŠ± Node.js</li>
</ul>
]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
      </categories>
      <tags>
        <tag>Webpack</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥æµ…å‡º Webpack é˜…è¯»ç¬”è®°</title>
    <url>/bloger/2021/02/01/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/%5B%E5%90%B4%E6%B5%A9%E9%BA%9F%5D%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Webpack/</url>
    <content><![CDATA[<h2 id="æ·±å…¥æµ…å‡º-Webpack"><a href="#æ·±å…¥æµ…å‡º-Webpack" class="headerlink" title="æ·±å…¥æµ…å‡º Webpack"></a>æ·±å…¥æµ…å‡º Webpack</h2><p>[TOC]</p>
<h3 id="å…¥é—¨ç³»åˆ—"><a href="#å…¥é—¨ç³»åˆ—" class="headerlink" title="å…¥é—¨ç³»åˆ—"></a>å…¥é—¨ç³»åˆ—</h3><h4 id="æ¨¡å—åŒ–"><a href="#æ¨¡å—åŒ–" class="headerlink" title="æ¨¡å—åŒ–"></a>æ¨¡å—åŒ–</h4><ul>
<li><p>ä»€ä¹ˆæ˜¯æ¨¡å—åŒ–ï¼Ÿ å¤æ‚çš„ç³»ç»Ÿåˆ†è§£åˆ°å¤šä¸ªæ¨¡å—ä»¥æ–¹ä¾¿ç¼–ç </p>
</li>
<li><p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ¨¡å—åŒ–æ€æƒ³ç»„ç»‡ä»£ç ï¼Ÿ ä»¥å‰ä½¿ç”¨çš„æ˜¯å‘½åæ§ä»¶æ–¹å¼ç»„ç»‡ä»£ç ï¼Œæ¯”å¦‚ jQuery åº“æŠŠå®ƒçš„ API éƒ½æ”¾åœ¨äº† window.$ï¼Œè¿™æ ·ä¼šå¸¦æ¥å‘½åç©ºé—´å†²çªã€æ— æ³•åˆç†çš„ç®¡ç†é¡¹ç›®çš„ä¾èµ–å’Œç‰ˆæœ¬å’Œæ— æ³•æœ‰æ•ˆæ§åˆ¶ä¾èµ–åŠ è½½é¡ºåºç­‰é—®é¢˜</p>
</li>
<li><p>ä¸¤ç§æ¨¡å—åŒ–è§„èŒƒï¼šCmmonJS(CJS),AMD å’Œ ESM</p>
</li>
<li><p>CommonJS çš„ä¼˜ç‚¹ï¼š ä»£ç å¯å¤ç”¨äº Node.js ç¯å¢ƒä¸‹å¹¶è¿è¡Œï¼Œä¾‹å¦‚åšåŒæ„åº”ç”¨ï¼› é€šè¿‡ NPM å‘å¸ƒçš„å¾ˆå¤šç¬¬ä¸‰æ–¹æ¨¡å—éƒ½é‡‡ç”¨äº† CommonJS è§„èŒƒã€‚</p>
</li>
<li><p>CommonJS çš„ç¼ºç‚¹: ä»£ç æ— æ³•ç›´æ¥è¿è¡Œåœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹ï¼Œå¿…é¡»é€šè¿‡å·¥å…·è½¬æ¢æˆæ ‡å‡†çš„ ES5</p>
</li>
<li><p>AMD çš„ä¼˜ç‚¹åœ¨äºï¼š å¯åœ¨ä¸è½¬æ¢ä»£ç çš„æƒ…å†µä¸‹ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼› å¯å¼‚æ­¥åŠ è½½ä¾èµ–ï¼› å¯å¹¶è¡ŒåŠ è½½å¤šä¸ªä¾èµ–ï¼› ä»£ç å¯è¿è¡Œåœ¨æµè§ˆå™¨ç¯å¢ƒå’Œ Node.js ç¯å¢ƒä¸‹ã€‚</p>
</li>
<li><p>AMD çš„ç¼ºç‚¹: JavaScript è¿è¡Œç¯å¢ƒæ²¡æœ‰åŸç”Ÿæ”¯æŒ AMDï¼Œéœ€è¦å…ˆå¯¼å…¥å®ç°äº† AMD çš„åº“åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚</p>
</li>
<li><p>ES6 æ¨¡å—åŒ– ES6 æ¨¡å—åŒ–æ˜¯æ¬§æ´²è®¡ç®—æœºåˆ¶é€ è”åˆä¼š ECMA æå‡ºçš„ JavaScript æ¨¡å—åŒ–è§„èŒƒï¼Œå®ƒåœ¨è¯­è¨€çš„å±‚é¢ä¸Šå®ç°äº†æ¨¡å—åŒ–</p>
<p>æµè§ˆå™¨å‚å•†å’Œ Node.js éƒ½å®£å¸ƒè¦åŸç”Ÿæ”¯æŒè¯¥è§„èŒƒã€‚å®ƒå°†é€æ¸å–ä»£ CommonJS å’Œ AMD è§„èŒƒï¼Œæˆä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨é€šç”¨çš„æ¨¡å—è§£å†³æ–¹æ¡ˆ</p>
<p>ç¼ºç‚¹åœ¨äºç›®å‰æ— æ³•ç›´æ¥è¿è¡Œåœ¨å¤§éƒ¨åˆ† JavaScript è¿è¡Œç¯å¢ƒä¸‹ï¼Œå¿…é¡»é€šè¿‡å·¥å…·è½¬æ¢æˆæ ‡å‡†çš„ ES5 åæ‰èƒ½æ­£å¸¸è¿è¡Œ<br><a href="https://www.ruanyifeng.com/blog/2020/08/how-nodejs-use-es6-module.html">Node.js å¦‚ä½•å¤„ç† ES6 æ¨¡å—</a></p>
</li>
</ul>
<h4 id="æ„å»ºå·¥å…·"><a href="#æ„å»ºå·¥å…·" class="headerlink" title="æ„å»ºå·¥å…·"></a>æ„å»ºå·¥å…·</h4><ul>
<li>æ„å»ºè¿‡ç¨‹åšäº†ä»€ä¹ˆï¼Ÿ</li>
</ul>
<ol>
<li>æŠŠæºä»£ç è½¬æ¢æˆå‘å¸ƒåˆ°çº¿ä¸Šçš„å¯æ‰§è¡Œ JavaScripã€CSSã€HTML ä»£ç ï¼ŒåŒ…æ‹¬å¦‚ä¸‹å†…å®¹ã€‚<ul>
<li>ä»£ç è½¬æ¢ï¼šTypeScript ç¼–è¯‘æˆ JavaScriptã€SCSS ç¼–è¯‘æˆ CSS ç­‰ã€‚</li>
<li>æ–‡ä»¶ä¼˜åŒ–ï¼šå‹ç¼© JavaScriptã€CSSã€HTML ä»£ç ï¼Œå‹ç¼©åˆå¹¶å›¾ç‰‡ç­‰ã€‚</li>
<li>ä»£ç åˆ†å‰²ï¼šæå–å¤šä¸ªé¡µé¢çš„å…¬å…±ä»£ç ã€æå–é¦–å±ä¸éœ€è¦æ‰§è¡Œéƒ¨åˆ†çš„ä»£ç è®©å…¶å¼‚æ­¥åŠ è½½ã€‚</li>
<li>æ¨¡å—åˆå¹¶ï¼šåœ¨é‡‡ç”¨æ¨¡å—åŒ–çš„é¡¹ç›®é‡Œä¼šæœ‰å¾ˆå¤šä¸ªæ¨¡å—å’Œæ–‡ä»¶ï¼Œéœ€è¦æ„å»ºåŠŸèƒ½æŠŠæ¨¡å—åˆ†ç±»åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ã€‚</li>
<li>è‡ªåŠ¨åˆ·æ–°ï¼šç›‘å¬æœ¬åœ°æºä»£ç çš„å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°æ„å»ºã€åˆ·æ–°æµè§ˆå™¨ã€‚</li>
<li>ä»£ç æ ¡éªŒï¼šåœ¨ä»£ç è¢«æäº¤åˆ°ä»“åº“å‰éœ€è¦æ ¡éªŒä»£ç æ˜¯å¦ç¬¦åˆè§„èŒƒï¼Œä»¥åŠå•å…ƒæµ‹è¯•æ˜¯å¦é€šè¿‡ã€‚</li>
<li>è‡ªåŠ¨å‘å¸ƒï¼šæ›´æ–°å®Œä»£ç åï¼Œè‡ªåŠ¨æ„å»ºå‡ºçº¿ä¸Šå‘å¸ƒä»£ç å¹¶ä¼ è¾“ç»™å‘å¸ƒç³»ç»Ÿã€‚</li>
</ul>
</li>
</ol>
<p>æ„å»ºå…¶å®æ˜¯å·¥ç¨‹åŒ–ã€è‡ªåŠ¨åŒ–æ€æƒ³åœ¨å‰ç«¯å¼€å‘ä¸­çš„ä½“ç°ï¼ŒæŠŠä¸€ç³»åˆ—æµç¨‹ç”¨ä»£ç å»å®ç°ï¼Œè®©ä»£ç è‡ªåŠ¨åŒ–åœ°æ‰§è¡Œè¿™ä¸€ç³»åˆ—å¤æ‚çš„æµç¨‹ã€‚</p>
<ul>
<li>å¸¸è§æ„å»ºå·¥å…·</li>
</ul>
<ol>
<li><p>npm</p>
<ul>
<li>å†…ç½®ä½†æ˜¯åŠŸèƒ½è¿‡äºç®€å•</li>
</ul>
</li>
<li><p>Grunt</p>
<ul>
<li>è¿›åŒ–ç‰ˆ npm ï¼Œå¯ä»¥çµæ´»å®šä¹‰æ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯é›†æˆåº¦ä¸é«˜ï¼Œæ— æ³•åšåˆ°å¼€ç®±å³ç”¨</li>
</ul>
</li>
<li><p>Gulp</p>
<ul>
<li>åŸºäºæµçš„è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·</li>
<li>æœ€å¤§ç‰¹ç‚¹æ˜¯å¼•å…¥äº†æµçš„æ¦‚å¿µï¼ŒåŒæ—¶æä¾›äº†ä¸€ç³»åˆ—å¸¸ç”¨çš„æ’ä»¶å»å¤„ç†æµï¼Œæµå¯ä»¥åœ¨æ’ä»¶ä¹‹é—´ä¼ é€’</li>
<li>ç®€å•ï¼Œé€šè¿‡ä»¥ä¸‹ 5 ä¸ªæ–¹æ³•å‡ ä¹å¯ä»¥è¦†ç›–æ‰€æœ‰æ—¥å¸¸</li>
</ul>
</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">é€šè¿‡ gulp.task æ³¨å†Œä»»åŠ¡ é€šè¿‡ gulp.run æ‰§è¡Œä»»åŠ¡ é€šè¿‡ gulp.watch ç›‘å¬æ–‡ä»¶å˜åŒ– é€šè¿‡ gulp.src è¯»æ–‡ä»¶ é€šè¿‡ gulp.dest å†™æ–‡ä»¶</span><br></pre></td></tr></table></figure>

<pre><code>- Grunt çš„åŠ å¼ºç‰ˆã€‚ç›¸å¯¹äº Gruntï¼ŒGulpå¢åŠ äº†ç›‘å¬æ–‡ä»¶ã€è¯»å†™æ–‡ä»¶ã€æµå¼å¤„ç†çš„åŠŸèƒ½ã€‚ä½†ä»ç„¶é›†æˆåº¦ä¸é«˜ï¼Œæ— æ³•åšåˆ°å¼€ç®±å³ç”¨
</code></pre>
<ol start="4">
<li><p>Fis3</p>
<ul>
<li>ç™¾åº¦åˆ›é€ </li>
<li>ç›¸å¯¹äº Gruntã€Gulp è¿™äº›åªæä¾›åŸºæœ¬åŠŸèƒ½çš„å·¥å…·ï¼ŒFis3 é›†æˆäº† Web å¼€å‘ä¸­çš„å¸¸ç”¨æ„å»ºåŠŸèƒ½ï¼Œå¼€å§‹æœ‰ç‚¹é›†æˆçš„æ„æ€</li>
<li>å¸¸è§æ„å»ºåŠŸèƒ½å¦‚ä¸‹</li>
</ul>
</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">è¯»å†™æ–‡ä»¶ï¼šé€šè¿‡ fis.match è¯»æ–‡ä»¶ï¼Œrelease é…ç½®æ–‡ä»¶è¾“å‡ºè·¯å¾„ã€‚ èµ„æºå®šä½ï¼šè§£ææ–‡ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œæ–‡ä»¶ä½ç½®ã€‚ æ–‡ä»¶æŒ‡çº¹ï¼šé€šè¿‡ useHash é…ç½®è¾“å‡ºæ–‡ä»¶æ—¶ç»™æ–‡ä»¶ URL åŠ ä¸Š md5 æˆ³æ¥ä¼˜åŒ–æµè§ˆå™¨ç¼“å­˜ã€‚</span><br><span class="line">æ–‡ä»¶ç¼–è¯‘ï¼šé€šè¿‡ parser é…ç½®æ–‡ä»¶è§£æå™¨åšæ–‡ä»¶è½¬æ¢ï¼Œä¾‹å¦‚æŠŠ ES6 ç¼–è¯‘æˆ ES5ã€‚ å‹ç¼©èµ„æºï¼šé€šè¿‡ optimizer é…ç½®ä»£ç å‹ç¼©æ–¹æ³•ã€‚ å›¾ç‰‡åˆå¹¶ï¼šé€šè¿‡ spriter é…ç½®åˆå¹¶ CSS é‡Œå¯¼å…¥çš„å›¾ç‰‡åˆ°ä¸€ä¸ªæ–‡ä»¶æ¥å‡å°‘ HTTP</span><br><span class="line">è¯·æ±‚æ•°ã€‚</span><br></pre></td></tr></table></figure>

<pre><code>- ä¼˜ç‚¹ï¼šé›†æˆäº†å„ç§ Web å¼€å‘æ‰€éœ€çš„æ„å»ºåŠŸèƒ½ï¼Œé…ç½®ç®€å•å¼€ç®±å³ç”¨
- ç¼ºç‚¹ï¼šç›®å‰å®˜æ–¹ä¸å†æ›´æ–°å’Œç»´æŠ¤ï¼Œä¸æ”¯æŒæœ€æ–°ç‰ˆæœ¬çš„ Node.js
</code></pre>
<ol start="5">
<li><p>Webpack</p>
<ul>
<li>æ‰“åŒ…æ¨¡å—åŒ– JavaScript çš„å·¥å…·ï¼Œåœ¨ Webpack é‡Œä¸€åˆ‡æ–‡ä»¶çš†æ¨¡å—ï¼Œé€šè¿‡ Loader è½¬æ¢æ–‡ä»¶ï¼Œé€šè¿‡ Plugin æ³¨å…¥é’©å­ï¼Œæœ€åè¾“å‡ºç”±å¤šä¸ªæ¨¡å—ç»„åˆæˆçš„æ–‡ä»¶</li>
<li>ä¼˜ç‚¹</li>
</ul>
</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">ä¸“æ³¨æ¨¡å—åŒ–æ‰“åŒ…ï¼Œå¼€ç®±å³ç”¨ä¸€æ­¥åˆ°ä½ é€šè¿‡ Plugin æ‰©å±•ï¼Œå®Œæ•´å¥½ç”¨åˆä¸å¤±çµæ´» ä½¿ç”¨åœºæ™¯ä¸ä»…é™äº Web å¼€å‘ ç¤¾åŒºæ´»è·ƒ å¼€å‘ä½“éªŒè¾ƒå¥½</span><br></pre></td></tr></table></figure>

<pre><code>- ç¼ºç‚¹ï¼šåªèƒ½ç”¨äºé‡‡ç”¨æ¨¡å—åŒ–å¼€å‘çš„é¡¹ç›®
</code></pre>
<ol start="6">
<li><p>Rollup</p>
<ul>
<li>å’Œ Webpack å·®ä¸å¤šï¼Œä½†æ˜¯æ‰“åŒ…å‡ºæ¥çš„ä»£ç æ›´å°æ›´å¿«</li>
<li>å‡ºç°åœ¨ Webpack ä¹‹å</li>
<li>ç”Ÿæ€é“¾ä¸å¤ªå®Œå–„</li>
<li>åŠŸèƒ½ä¸å¤ªå®Œå–„</li>
<li>ä¸æ”¯æŒä»£ç åˆ†å‰²</li>
</ul>
</li>
</ol>
<ul>
<li>webpack-dev-server å¯ä»¥åšä»€ä¹ˆ</li>
</ul>
<ol>
<li>æä¾› HTTP æœåŠ¡</li>
<li>ç›‘å¬æ–‡ä»¶çš„å˜åŒ–å¹¶è‡ªåŠ¨åˆ·æ–°ç½‘é¡µï¼Œåšåˆ°å®æ—¶é¢„è§ˆï¼›</li>
<li>æ”¯æŒ Source Mapï¼Œä»¥æ–¹ä¾¿è°ƒè¯•ã€‚</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Webpack åŸç”Ÿæ”¯æŒä¸Šè¿°ç¬¬ 2ã€3 ç‚¹å†…å®¹ï¼Œå†ç»“åˆå®˜æ–¹æä¾›çš„å¼€å‘å·¥å…· DevServer ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åšåˆ°ç¬¬ 1 ç‚¹ã€‚ DevServer ä¼šå¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ç”¨äºæœåŠ¡ç½‘é¡µè¯·æ±‚ï¼ŒåŒæ—¶ä¼šå¸®åŠ©å¯åŠ¨ Webpack ï¼Œå¹¶æ¥æ”¶</span><br><span class="line">Webpack å‘å‡ºçš„æ–‡ä»¶æ›´å˜ä¿¡å·ï¼Œé€šè¿‡ WebSocket åè®®è‡ªåŠ¨åˆ·æ–°ç½‘é¡µåšåˆ°å®æ—¶é¢„è§ˆã€‚ æ¨¡å—çƒ­æ›¿æ¢:ä¸é‡æ–°åŠ è½½æ•´ä¸ªç½‘é¡µçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å°†è¢«æ›´æ–°è¿‡çš„æ¨¡å—æ›¿æ¢è€çš„æ¨¡å—ï¼Œå†é‡æ–°æ‰§è¡Œä¸€æ¬¡æ¥å®ç°å®æ—¶é¢„è§ˆ</span><br></pre></td></tr></table></figure>

<ul>
<li>æ ¸å¿ƒæœ¯è¯­<ol>
<li>Entryï¼š è¾“å…¥</li>
<li>Moduleï¼š æ¨¡å—</li>
<li>Chunkï¼šä»£ç å—</li>
<li>Loaderï¼šæ¨¡å—è½¬æ¢å™¨</li>
<li>Pluginï¼šæ‰©å±•æ’ä»¶</li>
<li>Outputï¼šè¾“å‡º</li>
</ol>
</li>
</ul>
<h3 id="é…ç½®ç³»åˆ—"><a href="#é…ç½®ç³»åˆ—" class="headerlink" title="é…ç½®ç³»åˆ—"></a>é…ç½®ç³»åˆ—</h3><ul>
<li>Entry</li>
</ul>
<ol>
<li>entry å¿…å¡«</li>
<li>ç±»å‹ï¼šstring | array | object</li>
</ol>
<ul>
<li>Output</li>
</ul>
<ol>
<li><p>filename</p>
<p>é…ç½®è¾“å‡ºæ–‡ä»¶çš„åç§°ï¼Œæ¯”å¦‚<code>static/js/[name].[contenthash:8].js</code><br>å…¶ä¸­[name]ä¸ºå†…ç½®å‡½æ•°ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰</p>
</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">id Chunk çš„å”¯ä¸€æ ‡è¯†ï¼Œä» 0 å¼€å§‹ name Chunk çš„åç§° hash Chunk çš„å”¯ä¸€æ ‡è¯†çš„ Hash å€¼ chunkhash Chunk å†…å®¹çš„ Hash å€¼</span><br></pre></td></tr></table></figure>

<pre><code>å…¶ä¸­ hash å’Œ chunkhash çš„é•¿åº¦æ˜¯å¯æŒ‡å®šçš„ï¼Œ[hash:8] ä»£è¡¨å–8ä½ Hash å€¼ï¼Œé»˜è®¤æ˜¯20ä½
</code></pre>
<ol start="2">
<li><p>publicPath</p>
<p>output.path å’Œ output.publicPath éƒ½æ”¯æŒå­—ç¬¦ä¸²æ¨¡ç‰ˆï¼Œå†…ç½®å˜é‡åªæœ‰ä¸€ä¸ªï¼šhash å¸¸ç”¨äº CDN åœºæ™¯</p>
</li>
</ol>
<ul>
<li>Module é…ç½®å¦‚ä½•å¤„ç†æ¨¡å—</li>
</ul>
<ol>
<li><p>rules</p>
<p>æœ‰ä¸‰ç§æ–¹å¼é…ç½® rules</p>
</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">æ¡ä»¶åŒ¹é…ï¼štestã€include ã€excludeã€loaderã€options åº”ç”¨è§„åˆ™ï¼šuse é‡ç½®é¡ºåºï¼šenforce: string &#x27;pre&#x27;|&#x27;post&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ€»ç»“ é…ç½®æ–‡ä»¶æ”¯æŒå¤šç§ç±»å‹ï¼Œå¯ä»¥å¯¼å‡ºä¸€ä¸ª Functionï¼Œå¯¼å‡ºä¸€ä¸ªè¿”å› Promise çš„å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å¯¼å‡ºæ•°ç»„ï¼Œæ•°ç»„ä¸­æœ‰å¤šä»½é…ç½® æ›´å¤šé…ç½®å¯ä»¥å‚è€ƒ<br><a href="https://github.com/Matthrews/webpack-demos">æˆ‘çš„ Github</a><br><a href="https://webpack.js.org/concepts/">Webpack å®˜ç½‘</a></li>
</ul>
<h3 id="å®æˆ˜ç³»åˆ—"><a href="#å®æˆ˜ç³»åˆ—" class="headerlink" title="å®æˆ˜ç³»åˆ—"></a>å®æˆ˜ç³»åˆ—</h3><p>æŒ‰ç…§ä¸åŒåœºæ™¯åˆ’åˆ†æˆä»¥ä¸‹å‡ ç±»ï¼š</p>
<h4 id="ä½¿ç”¨æ–°è¯­è¨€æ¥å¼€å‘é¡¹ç›®ï¼š"><a href="#ä½¿ç”¨æ–°è¯­è¨€æ¥å¼€å‘é¡¹ç›®ï¼š" class="headerlink" title="ä½¿ç”¨æ–°è¯­è¨€æ¥å¼€å‘é¡¹ç›®ï¼š"></a>ä½¿ç”¨æ–°è¯­è¨€æ¥å¼€å‘é¡¹ç›®ï¼š</h4><ol>
<li><p>ä½¿ç”¨ ES6 è¯­è¨€</p>
<p>é…ç½® Babel å®Œæˆ ES6 è½¬ ES5 å’Œ polyfill ä¸¤ä»¶äº‹ åœ¨ Webpack ä¸­é€šè¿‡ Loader å»æ¥å…¥ Babelï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœ¨æ ¹ç›®å½•é€šè¿‡ <code>.babelrc</code>æ–‡ä»¶é…ç½®ï¼Œè¿™ä¸¤è€…å¯ä»¥åŒæ—¶åšä½œç”¨</p>
</li>
<li><p>ä½¿ç”¨ TypeScript è¯­è¨€</p>
<p>é…ç½®<code>tsconfig.json</code>æ–‡ä»¶ é›†æˆ Webpack éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>é€šè¿‡ Loader æŠŠ TypeScript è½¬æ¢æˆ JavaScript â€”â€“æ¨è awesome-typescript-loader</li>
<li>Webpack åœ¨å¯»æ‰¾æ¨¡å—å¯¹åº”çš„æ–‡ä»¶æ—¶éœ€è¦å°è¯• ts åç¼€ â€”-ä¿®æ”¹é»˜è®¤çš„ resolve.extensions é…ç½®é¡¹</li>
</ul>
</li>
<li><p>ä½¿ç”¨ Flow æ£€æŸ¥å™¨</p>
<p>é›†æˆ Webpack éœ€è¦å®‰è£… babel-preset-flowï¼Œç„¶åä¿®æ”¹ <code>.babelrc</code> é…ç½®æ–‡ä»¶ï¼ŒåŠ å…¥<code>flow</code>é…ç½®é¡¹</p>
</li>
<li><p>ä½¿ç”¨ SCSS è¯­è¨€</p>
<p>ä½¿ç”¨<code>sass-loader</code>ï¼Œç›¸å…³é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// å¢åŠ å¯¹ SCSS æ–‡ä»¶çš„æ”¯æŒ</span></span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        <span class="comment">// SCSS æ–‡ä»¶çš„å¤„ç†é¡ºåºä¸ºå…ˆ sass-loader å† css-loader å†style-loader</span></span><br><span class="line">        use: [<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>, <span class="string">&#x27;sass-loader&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="string">``</span><span class="string">`javascript</span></span><br><span class="line"><span class="string">å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="string">1. sass-loaderæŠŠSCSSä»£ç è½¬æˆCSSåäº¤ç»™css-loader</span></span><br><span class="line"><span class="string">2. css-loaderä¼šæ‰¾å‡ºCSSä»£ç ä¸­çš„ @import å’Œ url() è¿™æ ·çš„å¯¼å…¥è¯­å¥ï¼Œå‘Šè¯‰ Webpack ä¾èµ–è¿™äº›èµ„æºã€‚åŒæ—¶è¿˜æ”¯æŒ CSS Modulesã€å‹ç¼© CSS ç­‰åŠŸèƒ½ã€‚å¤„ç†å®Œåå†æŠŠç»“æœäº¤ç»™ style-loader å»å¤„ç†ã€‚</span></span><br><span class="line"><span class="string">3. style-loader ä¼šæŠŠ CSS ä»£ç è½¬æ¢æˆå­—ç¬¦ä¸²åï¼Œæ³¨å…¥åˆ° JavaScript ä»£ç ä¸­å»ï¼Œé€šè¿‡ JavaScript å»ç»™ DOM å¢åŠ æ ·å¼</span></span><br><span class="line"><span class="string">4. å¦‚æœä½ æƒ³æŠŠ CSS ä»£ç æå–åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶è€Œä¸æ˜¯å’Œ JavaScript æ··åœ¨ä¸€èµ·ï¼Œå¯ä»¥ä½¿ç”¨ExtractTextPlugin</span></span><br><span class="line"><span class="string">5. éœ€è¦å®‰è£…sass-loader css-loader style-loader node-sass(sass-loaderä¾èµ–é¡¹)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure></li>
<li><p>ä½¿ç”¨ PostCSS</p>
<p>éœ€è¦å®‰è£… postcss-loader css-loader style-loader postcss-cssnext(postcss æ’ä»¶)</p>
</li>
</ol>
<h5 id="ä½¿ç”¨æ–°æ¡†æ¶æ¥å¼€å‘é¡¹ç›®ï¼š"><a href="#ä½¿ç”¨æ–°æ¡†æ¶æ¥å¼€å‘é¡¹ç›®ï¼š" class="headerlink" title="ä½¿ç”¨æ–°æ¡†æ¶æ¥å¼€å‘é¡¹ç›®ï¼š"></a>ä½¿ç”¨æ–°æ¡†æ¶æ¥å¼€å‘é¡¹ç›®ï¼š</h5><ol start="6">
<li><p>ä½¿ç”¨ React æ¡†æ¶</p>
<p>å®‰è£… babel-preset-react è½¬æ¢ JSX å’Œ Class ç­‰ React è¯­æ³• ä¿®æ”¹ <code>.babelrc</code> é…ç½®æ–‡ä»¶åŠ å…¥ <code>react</code> Presets</p>
</li>
<li><p>ä½¿ç”¨ Vue æ¡†æ¶</p>
</li>
<li><p>ä½¿ç”¨ Angular2 æ¡†æ¶</p>
</li>
</ol>
<h5 id="ç”¨-Webpack-æ„å»ºå•é¡µåº”ç”¨ï¼š"><a href="#ç”¨-Webpack-æ„å»ºå•é¡µåº”ç”¨ï¼š" class="headerlink" title="ç”¨ Webpack æ„å»ºå•é¡µåº”ç”¨ï¼š"></a>ç”¨ Webpack æ„å»ºå•é¡µåº”ç”¨ï¼š</h5><ol start="9">
<li>ä¸ºå•é¡µåº”ç”¨ç”Ÿæˆ HTML</li>
<li>ç®¡ç†å¤šä¸ªå•é¡µåº”ç”¨</li>
</ol>
<h5 id="ç”¨-Webpack-æ„å»ºä¸åŒè¿è¡Œç¯å¢ƒçš„é¡¹ç›®ï¼š"><a href="#ç”¨-Webpack-æ„å»ºä¸åŒè¿è¡Œç¯å¢ƒçš„é¡¹ç›®ï¼š" class="headerlink" title="ç”¨ Webpack æ„å»ºä¸åŒè¿è¡Œç¯å¢ƒçš„é¡¹ç›®ï¼š"></a>ç”¨ Webpack æ„å»ºä¸åŒè¿è¡Œç¯å¢ƒçš„é¡¹ç›®ï¼š</h5><ol start="11">
<li>æ„å»ºåŒæ„åº”ç”¨</li>
<li>æ„å»º Electron åº”ç”¨ 13 . æ„å»º Npm æ¨¡å—</li>
<li>æ„å»ºç¦»çº¿åº”ç”¨</li>
</ol>
<h5 id="Webpack-ç»“åˆå…¶å®ƒå·¥å…·æ­é…ä½¿ç”¨ï¼Œå„å–æ‰€é•¿ï¼š"><a href="#Webpack-ç»“åˆå…¶å®ƒå·¥å…·æ­é…ä½¿ç”¨ï¼Œå„å–æ‰€é•¿ï¼š" class="headerlink" title="Webpack ç»“åˆå…¶å®ƒå·¥å…·æ­é…ä½¿ç”¨ï¼Œå„å–æ‰€é•¿ï¼š"></a>Webpack ç»“åˆå…¶å®ƒå·¥å…·æ­é…ä½¿ç”¨ï¼Œå„å–æ‰€é•¿ï¼š</h5><ol start="15">
<li>æ­é… Npm Script</li>
<li>æ£€æŸ¥ä»£ç </li>
<li>é€šè¿‡ Node.js API å¯åŠ¨ Webpack</li>
<li>ä½¿ç”¨ Webpack Dev Middleware</li>
</ol>
<h5 id="ç”¨-Webpack-åŠ è½½ç‰¹æ®Šç±»å‹çš„èµ„æºï¼š"><a href="#ç”¨-Webpack-åŠ è½½ç‰¹æ®Šç±»å‹çš„èµ„æºï¼š" class="headerlink" title="ç”¨ Webpack åŠ è½½ç‰¹æ®Šç±»å‹çš„èµ„æºï¼š"></a>ç”¨ Webpack åŠ è½½ç‰¹æ®Šç±»å‹çš„èµ„æºï¼š</h5><ol start="19">
<li>åŠ è½½å›¾ç‰‡</li>
<li>åŠ è½½ SVG</li>
<li>åŠ è½½ Source Map</li>
<li>å®æˆ˜æ€»ç»“</li>
</ol>
<h3 id="ä¼˜åŒ–ç³»åˆ—"><a href="#ä¼˜åŒ–ç³»åˆ—" class="headerlink" title="ä¼˜åŒ–ç³»åˆ—"></a>ä¼˜åŒ–ç³»åˆ—</h3><h3 id="åŸç†ç³»åˆ—"><a href="#åŸç†ç³»åˆ—" class="headerlink" title="åŸç†ç³»åˆ—"></a>åŸç†ç³»åˆ—</h3>]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
      </categories>
      <tags>
        <tag>Webpack</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£æ webpack æ ¸å¿ƒâ€”â€”Loader åŸç†</title>
    <url>/bloger/2020/12/08/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/%E8%A7%A3%E6%9E%90%20webpack%20%E6%A0%B8%E5%BF%83%E2%80%94%E2%80%94Loader%20%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h1 id="è§£æ-webpack-æ ¸å¿ƒâ€”â€”Loader-åŸç†"><a href="#è§£æ-webpack-æ ¸å¿ƒâ€”â€”Loader-åŸç†" class="headerlink" title="è§£æ webpack æ ¸å¿ƒâ€”â€”Loader åŸç†"></a>è§£æ webpack æ ¸å¿ƒâ€”â€”Loader åŸç†</h1><blockquote>
<p>æˆ‘ä»¬å†ä¸Šä¸€æ¬¡çš„åˆ†äº«ä¸­å·²ç»åšå‡ºäº†ä¸€ä¸ªç®€æ˜“çš„æ‰“åŒ…å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½åŠ è½½ JS ä¸èƒ½åŠ è½½ CSS<br>æœ¬æ¬¡åˆ†äº«æˆ‘ä»¬ç»™å‡º css åŠ è½½æ€è·¯å¹¶å¯¹ css-loader å’Œ style-loader è¿›è¡Œè§£æ</p>
</blockquote>
<h2 id="å¦‚ä½•åŠ è½½-CSS"><a href="#å¦‚ä½•åŠ è½½-CSS" class="headerlink" title="å¦‚ä½•åŠ è½½ CSS"></a>å¦‚ä½•åŠ è½½ CSS</h2><ul>
<li>æ€è·¯ï¼šç›®å‰<code>bundler_1.ts</code>åªèƒ½åŠ è½½ JSï¼Œæƒ³è¦åŠ è½½ CSSï¼Œå°±éœ€è¦å°† CSS è½¬åŒ–ä¸º JS</li>
<li>ä»£ç ï¼š</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæ–‡ä»¶è·¯å¾„ä»¥.cssç»“å°¾ï¼Œå°±æŠŠCSSæ”¹ä¸ºJSï¼Œå¹¶è‡ªåŠ¨åŠ è½½åˆ°headé‡Œ</span></span><br><span class="line"><span class="keyword">if</span> (<span class="regexp">/\.css$/</span>.test(filepath)) &#123;</span><br><span class="line">  code = <span class="string">`</span></span><br><span class="line"><span class="string">         const str = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(code)&#125;</span></span></span><br><span class="line"><span class="string">         if (document) &#123;</span></span><br><span class="line"><span class="string">           const style = document.createElement(&#x27;style&#x27;)</span></span><br><span class="line"><span class="string">           style.innerHTML = str</span></span><br><span class="line"><span class="string">           style.type = &#x27;text/css&#x27;</span></span><br><span class="line"><span class="string">           document.head.appendChild(style)</span></span><br><span class="line"><span class="string">         &#125;</span></span><br><span class="line"><span class="string">         export default str</span></span><br><span class="line"><span class="string">       `</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ›å»ºä¸€ä¸ª-CSS-loader"><a href="#åˆ›å»ºä¸€ä¸ª-CSS-loader" class="headerlink" title="åˆ›å»ºä¸€ä¸ª CSS loader"></a>åˆ›å»ºä¸€ä¸ª CSS loader</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// bundler_1.ts</span></span><br><span class="line"><span class="comment">// è¯·ç¡®ä¿ä½ çš„ Node ç‰ˆæœ¬å¤§äºç­‰äº 14</span></span><br><span class="line"><span class="comment">// è¯·å…ˆè¿è¡Œ yarn æˆ– npm i æ¥å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ node -r ts-node/register æ–‡ä»¶è·¯å¾„ æ¥è¿è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥åŠ ä¸€ä¸ªé€‰é¡¹ --inspect-brkï¼Œå†æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡» Node å›¾æ ‡å³å¯è°ƒè¯•</span></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; writeFileSync, readFileSync &#125; <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; resolve, relative, dirname, join &#125; <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> babel <span class="keyword">from</span> <span class="string">&quot;@babel/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mkdir &#125; <span class="keyword">from</span> <span class="string">&quot;shelljs&quot;</span>;</span><br><span class="line"><span class="comment">// é¡¹ç›®åç§°</span></span><br><span class="line"><span class="keyword">const</span> projectName = <span class="string">&quot;project_css&quot;</span>;</span><br><span class="line"><span class="comment">// è®¾ç½®æ ¹ç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> projectRoot = resolve(__dirname, projectName);</span><br><span class="line"><span class="comment">// ç±»å‹å£°æ˜</span></span><br><span class="line">type DepRelation = &#123; <span class="attr">key</span>: string, <span class="attr">deps</span>: string[], <span class="attr">code</span>: string &#125;[];</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ depRelationï¼Œç”¨äºæ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> depRelation: DepRelation = []; <span class="comment">// æ•°ç»„ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¼ å…¥å‡½æ•°ï¼Œå¦‚ D:\demo\fixture_1\index.js</span></span><br><span class="line">collectCodeAndDeps(resolve(projectRoot, <span class="string">&quot;index.js&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Noteï¼šè¿™æ˜¯æœ¬æ¬¡æ–°å¢çš„ä»£ç </span></span><br><span class="line"><span class="comment">// åˆ›å»ºdistç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> dir = <span class="string">`./<span class="subst">$&#123;projectName&#125;</span>/dist`</span>;</span><br><span class="line">mkdir(<span class="string">&quot;-p&quot;</span>, dir);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Noteï¼šè¿™æ˜¯æœ¬æ¬¡æ–°å¢çš„ä»£ç </span></span><br><span class="line"><span class="comment">// å†åˆ›å»ºbundleæ–‡ä»¶</span></span><br><span class="line">writeFileSync(join(dir, <span class="string">&quot;bundle.js&quot;</span>), generateCode());</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;done&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateCode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  code +=</span><br><span class="line">    <span class="string">&quot;var depRelation = [&quot;</span> +</span><br><span class="line">    depRelation</span><br><span class="line">      .map(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; key, deps, code &#125; = item;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`&#123;</span></span><br><span class="line"><span class="string">      key: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(key)&#125;</span>,</span></span><br><span class="line"><span class="string">      deps: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(deps)&#125;</span>,</span></span><br><span class="line"><span class="string">      code: function(require, module, exports)&#123;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;code&#125;</span></span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;`</span>;</span><br><span class="line">      &#125;)</span><br><span class="line">      .join(<span class="string">&quot;,&quot;</span>) +</span><br><span class="line">    <span class="string">&quot;];\n&quot;</span>;</span><br><span class="line">  code += <span class="string">&quot;var modules = &#123;&#125;;\n&quot;</span>;</span><br><span class="line">  code += <span class="string">`execute(depRelation[0].key)\n`</span>;</span><br><span class="line">  code += <span class="string">`</span></span><br><span class="line"><span class="string">  function execute(key) &#123;</span></span><br><span class="line"><span class="string">    if (modules[key]) &#123; return modules[key] &#125;</span></span><br><span class="line"><span class="string">    var item = depRelation.find(i =&gt; i.key === key)</span></span><br><span class="line"><span class="string">    if (!item) &#123; throw new Error(\`\$&#123;item&#125; is not found\`) &#125;</span></span><br><span class="line"><span class="string">    var pathToKey = (path) =&gt; &#123;</span></span><br><span class="line"><span class="string">      var dirname = key.substring(0, key.lastIndexOf(&#x27;/&#x27;) + 1)</span></span><br><span class="line"><span class="string">      var projectPath = (dirname + path).replace(\/\\.\\\/\/g, &#x27;&#x27;).replace(\/\\\/\\\/\/, &#x27;/&#x27;)</span></span><br><span class="line"><span class="string">      return projectPath</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var require = (path) =&gt; &#123;</span></span><br><span class="line"><span class="string">      return execute(pathToKey(path))</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    modules[key] = &#123; __esModule: true &#125;</span></span><br><span class="line"><span class="string">    var module = &#123; exports: modules[key] &#125;</span></span><br><span class="line"><span class="string">    item.code(require, module, module.exports)</span></span><br><span class="line"><span class="string">    return modules[key]</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line">  <span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">collectCodeAndDeps</span>(<span class="params">filepath: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = getProjectPath(filepath); <span class="comment">// æ–‡ä»¶çš„é¡¹ç›®è·¯å¾„ï¼Œå¦‚ index.js</span></span><br><span class="line">  <span class="keyword">if</span> (depRelation.find(<span class="function">(<span class="params">i</span>) =&gt;</span> i.key === key)) &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œé‡å¤ä¾èµ–ä¸ä¸€å®šæ˜¯å¾ªç¯ä¾èµ–</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–æ–‡ä»¶å†…å®¹ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  <span class="keyword">let</span> code = readFileSync(filepath).toString();</span><br><span class="line">  <span class="comment">// Noteï¼šè¿™æ˜¯æœ¬æ¬¡æ–°å¢çš„ä»£ç </span></span><br><span class="line">  <span class="comment">// å¦‚æœæ–‡ä»¶è·¯å¾„ä»¥.cssç»“å°¾ï¼Œå°±æŠŠCSSæ”¹ä¸ºJSï¼Œå¹¶è‡ªåŠ¨åŠ è½½åˆ°headé‡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/\.css$/</span>.test(filepath)) &#123;</span><br><span class="line">    code = <span class="string">`</span></span><br><span class="line"><span class="string">      const str = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(code)&#125;</span></span></span><br><span class="line"><span class="string">      if (document) &#123;</span></span><br><span class="line"><span class="string">        const style = document.createElement(&#x27;style&#x27;)</span></span><br><span class="line"><span class="string">        style.innerHTML = str</span></span><br><span class="line"><span class="string">        style.type = &#x27;text/css&#x27;</span></span><br><span class="line"><span class="string">        document.head.appendChild(style)</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      export default str</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">code</span>: es5Code &#125; = babel.transform(code, &#123;</span><br><span class="line">    presets: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– depRelation[key]</span></span><br><span class="line">  <span class="keyword">const</span> item = &#123; key, <span class="attr">deps</span>: [], <span class="attr">code</span>: es5Code &#125;;</span><br><span class="line">  depRelation.push(item);</span><br><span class="line">  <span class="comment">// å°†ä»£ç è½¬ä¸º AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span> &#125;);</span><br><span class="line">  <span class="comment">// åˆ†ææ–‡ä»¶ä¾èµ–ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    enter: <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (path.node.type === <span class="string">&quot;ImportDeclaration&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// path.node.source.value å¾€å¾€æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œå¦‚ ./a.jsï¼Œéœ€è¦å…ˆæŠŠå®ƒè½¬ä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depAbsolutePath = resolve(</span><br><span class="line">          dirname(filepath),</span><br><span class="line">          path.node.source.value</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// ç„¶åè½¬ä¸ºé¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depProjectPath = getProjectPath(depAbsolutePath);</span><br><span class="line">        <span class="comment">// æŠŠä¾èµ–å†™è¿› depRelation</span></span><br><span class="line">        item.deps.push(depProjectPath);</span><br><span class="line">        collectCodeAndDeps(depAbsolutePath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ–‡ä»¶ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProjectPath</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> relative(projectRoot, path).replace(<span class="regexp">/\\/g</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_css/index.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a.getB())</span><br><span class="line"><span class="built_in">console</span>.log(b.getA())</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_css/a.js</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">  value: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">  getB: <span class="function">() =&gt;</span> b.value + <span class="string">&#x27; from a.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_css/b.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">  value: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">  getA: <span class="function">() =&gt;</span> a.value + <span class="string">&#x27; from b.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_css/style.css</span></span><br><span class="line">body &#123;</span><br><span class="line">    color: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ<code>node -r ts-node/register bundler_1.ts</code>æ‰“åŒ…æˆåŠŸå<code>project_css</code>ç›®å½•ä¸‹ä¼šæ–°å¢æ–‡ä»¶<code>bundle.js</code></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>CSS</code>éƒ¨åˆ†ä»£ç æˆåŠŸæ‰“åŒ…è¿›å»äº†</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// project_css/dist/bundle.js  éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = _default;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      key: <span class="string">&quot;style.css&quot;</span>,</span><br><span class="line">      deps: [],</span><br><span class="line">      code: <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">module</span>, <span class="built_in">exports</span></span>)</span>&#123;</span><br><span class="line"><span class="meta">        &quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">exports</span>, <span class="string">&quot;__esModule&quot;</span>, &#123;</span><br><span class="line">  value: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> str = <span class="string">&quot;body &#123;\r\n    color: red;\r\n&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">document</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> style = <span class="built_in">document</span>.createElement(<span class="string">&#x27;style&#x27;</span>);</span><br><span class="line">  style.innerHTML = str;</span><br><span class="line">  style.type = <span class="string">&#x27;text/css&#x27;</span>;</span><br><span class="line">  <span class="built_in">document</span>.head.appendChild(style);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _default = str;</span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = _default;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥å†<code>dist</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>index.html</code>å¼•å…¥æ‰“åŒ…åæ–‡ä»¶<code>bundle.js</code>æµè§ˆå™¨è¿è¡Œçœ‹çœ‹æ•ˆæœ<br><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/webpack-4.png" alt="index.html"></p>
<h2 id="Loader-é•¿ä»€ä¹ˆæ ·"><a href="#Loader-é•¿ä»€ä¹ˆæ ·" class="headerlink" title="Loader é•¿ä»€ä¹ˆæ ·"></a>Loader é•¿ä»€ä¹ˆæ ·</h2><blockquote>
<p>å‚è€ƒï¼š<a href="https://www.webpackjs.com/contribute/writing-a-loader/">å¦‚ä½•ç¼–å†™ä¸€ä¸ª loader</a></p>
</blockquote>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/102729238">å¦‚ä½•ç¼–å†™ä¸€ä¸ª loader</a></p>
</blockquote>
<ul>
<li><p>loader æœ¬è´¨ä¸Šæ˜¯å¯¼å‡ºä¸ºå‡½æ•°çš„ JavaScript æ¨¡å—</p>
</li>
<li><p>loader runner ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œç„¶åå°†ä¸Šä¸€ä¸ª loader äº§ç”Ÿçš„ç»“æœæˆ–è€…èµ„æºæ–‡ä»¶ä¼ å…¥è¿›å»</p>
</li>
<li><p>å‡½æ•°ä¸­çš„ this ä½œä¸ºä¸Šä¸‹æ–‡ä¼šè¢« webpack å¡«å……ï¼Œå¹¶ä¸” loader runner ä¸­åŒ…å«ä¸€äº›å®ç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚å¯ä»¥ä½¿ loader è°ƒç”¨æ–¹å¼å˜ä¸ºå¼‚æ­¥ï¼Œæˆ–è€…è·å– query å‚æ•°</p>
</li>
<li><p>åŒæ­¥ Loaders</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// sync-loader.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content, map, meta</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> someSyncOperation(content);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sync-loader-with-multiple-results.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content, map, meta</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.callback(<span class="literal">null</span>, someSyncOperation(content), map, meta);</span><br><span class="line">  <span class="keyword">return</span>; <span class="comment">// å½“è°ƒç”¨ callback() å‡½æ•°æ—¶ï¼Œæ€»æ˜¯è¿”å› undefined</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¼‚æ­¥ Loaders</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// async-loader.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content, map, meta</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> callback = <span class="built_in">this</span>.async();</span><br><span class="line">  someAsyncOperation(content, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">    callback(<span class="literal">null</span>, result, map, meta);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// async-loader-with-multiple-results.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content, map, meta</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> callback = <span class="built_in">this</span>.async();</span><br><span class="line">  someAsyncOperation(content, <span class="function"><span class="keyword">function</span> (<span class="params">err, result, sourceMaps, meta</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">    callback(<span class="literal">null</span>, result, sourceMaps, meta);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿”å› Buffer çš„ Loaders</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// raw-loader.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  assert(content <span class="keyword">instanceof</span> Buffer);</span><br><span class="line">  <span class="keyword">return</span> someSyncOperation(content);</span><br><span class="line">  <span class="comment">// è¿”å›å€¼ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª `Buffer`</span></span><br><span class="line">  <span class="comment">// å³ä½¿ä¸æ˜¯ &quot;raw&quot;ï¼Œloader ä¹Ÿæ²¡é—®é¢˜</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.raw = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>æå‰ç»“æŸçš„ Pitch Loaders</li>
</ul>
<p>å¯¹äºä»¥ä¸‹ use é…ç½®ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        use: [<span class="string">&quot;a-loader&quot;</span>, <span class="string">&quot;b-loader&quot;</span>, <span class="string">&quot;c-loader&quot;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å°†ä¼šå‘ç”Ÿè¿™äº›æ­¥éª¤ï¼š</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">|- a-loader `pitch`</span><br><span class="line">  |- b-loader `pitch`</span><br><span class="line">    |- c-loader `pitch`</span><br><span class="line">      |- requested module is picked up as a dependency</span><br><span class="line">    |- c-loader normal execution</span><br><span class="line">  |- b-loader normal execution</span><br><span class="line">|- a-loader normal execution</span><br></pre></td></tr></table></figure>

<p>ç®€å•æ¥è¯´ï¼Œpitch é’©å­å‡½æ•°åŒæ­¥ data æ•°æ®å’Œå…±äº«å‰é¢ä¿¡æ¯, å¦‚æœæŸä¸ª loader åœ¨ pitch æ–¹æ³•ä¸­ç»™å‡ºä¸€ä¸ªç»“æœï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹ä¼šå›è¿‡èº«æ¥ï¼Œå¹¶è·³è¿‡å‰©ä¸‹çš„ loader</p>
<p>å¦‚æœ b-loader çš„ pitch æ–¹æ³•è¿”å›äº†ä¸€äº›ä¸œè¥¿ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> someSyncOperation(content);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">remainingRequest, precedingRequest, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (someCondition()) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="string">&quot;module.exports = require(&quot;</span> +</span><br><span class="line">      <span class="built_in">JSON</span>.stringify(<span class="string">&quot;-!&quot;</span> + remainingRequest) +</span><br><span class="line">      <span class="string">&quot;);&quot;</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„æ­¥éª¤å°†è¢«ç¼©çŸ­ä¸ºï¼š</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">|- a-loader `pitch`</span><br><span class="line">  |- b-loader `pitch` returns a module</span><br><span class="line">|- a-loader normal execution</span><br></pre></td></tr></table></figure>

<h2 id="ç›®å‰-Loader-å­˜åœ¨çš„é—®é¢˜"><a href="#ç›®å‰-Loader-å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="ç›®å‰ Loader å­˜åœ¨çš„é—®é¢˜"></a>ç›®å‰ Loader å­˜åœ¨çš„é—®é¢˜</h2><ul>
<li>ä¸ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¼˜åŒ–åæ‰“åŒ…æ ¸å¿ƒä»£ç å¦‚ä¸‹</span></span><br><span class="line"><span class="comment">// bundler_css_loader.ts</span></span><br><span class="line"><span class="keyword">if</span> (<span class="regexp">/\.css$/</span>.test(filepath)) &#123;</span><br><span class="line">  code = <span class="built_in">require</span>(<span class="string">&quot;./loaders/css-loader&quot;</span>)(code);</span><br><span class="line">  code = <span class="built_in">require</span>(<span class="string">&quot;./loaders/style-loader&quot;</span>)(code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loaders/css-loader.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†CSSä»£ç å˜æ¢æˆJSä»£ç </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>code CSS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;string&#125;</span>  <span class="variable">JS</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> transform = <span class="function">(<span class="params">code</span>) =&gt;</span> <span class="string">`</span></span><br><span class="line"><span class="string">  const str = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(code)&#125;</span></span></span><br><span class="line"><span class="string">  export default str</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = transform;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loaders/style-loader.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†JSä»£ç æ’å…¥styleæ ‡ç­¾</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>code JS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;string&#125;</span>  <span class="variable">JS</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> transform = <span class="function">(<span class="params">code</span>) =&gt;</span> <span class="string">`</span></span><br><span class="line"><span class="string">  if (document) &#123;</span></span><br><span class="line"><span class="string">    const style = document.createElement(&#x27;style&#x27;)</span></span><br><span class="line"><span class="string">    style.innerHTML = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(code)&#125;</span></span></span><br><span class="line"><span class="string">    style.type = &#x27;text/css&#x27;</span></span><br><span class="line"><span class="string">    document.head.appendChild(style)</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  export default str</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = transform;</span><br></pre></td></tr></table></figure>

<h2 id="é˜…è¯»æºç å‰å¿…è¯»"><a href="#é˜…è¯»æºç å‰å¿…è¯»" class="headerlink" title="é˜…è¯»æºç å‰å¿…è¯»"></a>é˜…è¯»æºç å‰å¿…è¯»</h2><p><a href="https://matthrews.github.io/bloger/2020/12/08/%E7%9C%8B%E6%BA%90%E7%A0%81%E7%9A%84%E4%B8%80%E7%82%B9%E6%96%B9%E6%B3%95%E8%AE%BA/">çœ‹æºç çš„ä¸€ç‚¹æ–¹æ³•è®º</a></p>
<h2 id="raw-loader-å’Œ-file-loader-æºç é˜…è¯»"><a href="#raw-loader-å’Œ-file-loader-æºç é˜…è¯»" class="headerlink" title="raw-loader å’Œ file-loader æºç é˜…è¯»"></a>raw-loader å’Œ file-loader æºç é˜…è¯»</h2><blockquote>
<p><a href="mailto:&#x72;&#97;&#x77;&#x2d;&#108;&#111;&#97;&#x64;&#x65;&#114;&#64;&#48;&#46;&#x31;&#46;&#53;">&#x72;&#97;&#x77;&#x2d;&#108;&#111;&#97;&#x64;&#x65;&#114;&#64;&#48;&#46;&#x31;&#46;&#53;</a></p>
</blockquote>
<blockquote>
<p><a href="mailto:&#x66;&#105;&#108;&#101;&#x2d;&#x6c;&#x6f;&#97;&#x64;&#101;&#x72;&#64;&#48;&#x2e;&#x38;&#x2e;&#50;">&#x66;&#105;&#108;&#101;&#x2d;&#x6c;&#x6f;&#97;&#x64;&#101;&#x72;&#64;&#48;&#x2e;&#x38;&#x2e;&#50;</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// raw-loader</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">  args = args.join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="built_in">this</span>.values = [args];</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;module.exports = &quot;</span> + <span class="built_in">JSON</span>.stringify(args);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file-loader</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.cacheable &amp;&amp; <span class="built_in">this</span>.cacheable();</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">this</span>.emitFile)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;emitFile is required from module system&quot;</span>);</span><br><span class="line">  <span class="keyword">var</span> query = loaderUtils.parseQuery(<span class="built_in">this</span>.query);</span><br><span class="line">  <span class="keyword">var</span> url = loaderUtils.interpolateName(<span class="built_in">this</span>, query.name || <span class="string">&quot;[hash].[ext]&quot;</span>, &#123;</span><br><span class="line">    context: query.context || <span class="built_in">this</span>.options.context,</span><br><span class="line">    content: content,</span><br><span class="line">    regExp: query.regExp,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">this</span>.emitFile(url, content);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;module.exports = __webpack_public_path__ + &quot;</span> + <span class="built_in">JSON</span>.stringify(url);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.raw = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<h2 id="css-loader-å’Œ-style-loader-æºç é˜…è¯»"><a href="#css-loader-å’Œ-style-loader-æºç é˜…è¯»" class="headerlink" title="css-loader å’Œ style-loader æºç é˜…è¯»"></a>css-loader å’Œ style-loader æºç é˜…è¯»</h2><blockquote>
<p><a href="mailto:&#115;&#x74;&#x79;&#x6c;&#x65;&#x2d;&#x6c;&#x6f;&#97;&#x64;&#x65;&#114;&#x40;&#x30;&#x2e;&#49;&#x33;&#x2e;&#x30;">&#115;&#x74;&#x79;&#x6c;&#x65;&#x2d;&#x6c;&#x6f;&#97;&#x64;&#x65;&#114;&#x40;&#x30;&#x2e;&#49;&#x33;&#x2e;&#x30;</a></p>
</blockquote>
<blockquote>
<p><a href="mailto:&#x63;&#115;&#115;&#45;&#x6c;&#x6f;&#x61;&#x64;&#x65;&#114;&#x40;&#x30;&#46;&#x32;&#56;&#x2e;&#52;">&#x63;&#115;&#115;&#45;&#x6c;&#x6f;&#x61;&#x64;&#x65;&#114;&#x40;&#x30;&#46;&#x32;&#56;&#x2e;&#52;</a></p>
</blockquote>
<ul>
<li>css-loader å’Œ style-loader éƒ½åšäº†ä»€ä¹ˆï¼Œæ€ä¹ˆåšçš„ï¼Ÿ</li>
</ul>
<p>ä¸‹è½½ style-loader æºç åˆ‡æ¢åˆ°å°±ä¸€ç‚¹çš„ç‰ˆæœ¬ï¼Œè¿›å…¥æºç æ‰¾åˆ°å…¥å£æ–‡ä»¶<code>index.js</code>ï¼Œä»£ç æŠ˜å å</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çœç•¥ä¸é‡è¦ä»£ç </span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¿™æ˜¯ä¸€ä¸ªç©ºå‡½æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">remainingRequest</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å°±ç®€å•ä¸¤ä¸ªå‡½æ•°ï¼Œå¯¼å‡ºäº†ä¸€ä¸ªç©ºå‡½æ•°ï¼Œå¹¶ä¸”åœ¨ç©ºå‡½æ•°å¯¹è±¡ä¸ŠæŒ‚äº†ä¸€ä¸ª <code>pitch</code> å‡½æ•°, åœ¨ <code>pitch</code> é˜¶æ®µå®Œæˆ<code>&lt;style&gt;</code>æ ‡ç­¾æŒ‚è½½ DOMï¼Œå…³äº<code>pitch</code> å¯ä»¥çœ‹çœ‹ä¸Šæ–‡</p>
</blockquote>
<p><code>pitch</code> å‡½æ•°æ ¸å¿ƒä»£ç å¦‚ä¸‹, æºç æ³¨é‡Šä¹Ÿå¾ˆæ¸…æ¥š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çœç•¥ä¸é‡è¦ä»£ç </span></span><br><span class="line"><span class="keyword">var</span> query = loaderUtils.parseQuery(<span class="built_in">this</span>.query);</span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">  <span class="string">&quot;// style-loader: Adds some css to the DOM by adding a &lt;style&gt; tag&quot;</span>,</span><br><span class="line">  <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;// load the styles&quot;</span>,</span><br><span class="line">  <span class="string">&quot;var content = require(&quot;</span> +</span><br><span class="line">    loaderUtils.stringifyRequest(<span class="built_in">this</span>, <span class="string">&quot;!!&quot;</span> + remainingRequest) +</span><br><span class="line">    <span class="string">&quot;);&quot;</span>,</span><br><span class="line">  <span class="string">&quot;if(typeof content === &#x27;string&#x27;) content = [[module.id, content, &#x27;&#x27;]];&quot;</span>,</span><br><span class="line">  <span class="string">&quot;// add the styles to the DOM&quot;</span>,</span><br><span class="line">  <span class="string">&quot;var update = require(&quot;</span> +</span><br><span class="line">    loaderUtils.stringifyRequest(</span><br><span class="line">      <span class="built_in">this</span>,</span><br><span class="line">      <span class="string">&quot;!&quot;</span> + path.join(__dirname, <span class="string">&quot;addStyles.js&quot;</span>)</span><br><span class="line">    ) +</span><br><span class="line">    <span class="string">&quot;)(content, &quot;</span> +</span><br><span class="line">    <span class="built_in">JSON</span>.stringify(query) +</span><br><span class="line">    <span class="string">&quot;);&quot;</span>,</span><br><span class="line">].join(<span class="string">&quot;\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åŸç†å¼é€šè¿‡ JS å°†<code>&lt;style&gt;</code>æ ‡ç­¾æ’åˆ° DOM é‡Œï¼Œé¦–å…ˆåŠ è½½ style å†…å®¹ï¼Œç„¶åæ’å…¥ DOMï¼Œ æ’å…¥ DOM æ ¸å¿ƒå®ç°æ˜¯<code>addStyles.js</code>,å…¶æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çœç•¥ä¸é‡è¦ä»£ç </span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">list, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> styles = listToStyles(list);</span><br><span class="line">  addStylesToDom(styles, options);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">newList</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// update é€»è¾‘</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒå°±æ˜¯<code>addStylesToDom</code>å‡½æ•°ï¼Œå†è¿›å…¥å°±æ˜¯<code>addStyle</code>å‡½æ•°</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStyleElement</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> styleElement = <span class="built_in">document</span>.createElement(<span class="string">&quot;style&quot;</span>);</span><br><span class="line">  styleElement.type = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">  insertStyleElement(options, styleElement);</span><br><span class="line">  <span class="keyword">return</span> styleElement;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addStyle</span>(<span class="params">obj, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> styleElement, update, remove;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.singleton) &#123;</span><br><span class="line">    <span class="keyword">var</span> styleIndex = singletonCounter++;</span><br><span class="line">    styleElement =</span><br><span class="line">      singletonElement || (singletonElement = createStyleElement(options));</span><br><span class="line">    update = applyToSingletonTag.bind(<span class="literal">null</span>, styleElement, styleIndex, <span class="literal">false</span>);</span><br><span class="line">    remove = applyToSingletonTag.bind(<span class="literal">null</span>, styleElement, styleIndex, <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    obj.sourceMap &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> URL === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> URL.createObjectURL === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> URL.revokeObjectURL === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> Blob === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> btoa === <span class="string">&quot;function&quot;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    styleElement = createLinkElement(options);</span><br><span class="line">    update = updateLink.bind(<span class="literal">null</span>, styleElement);</span><br><span class="line">    remove = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      removeStyleElement(styleElement);</span><br><span class="line">      <span class="keyword">if</span> (styleElement.href) URL.revokeObjectURL(styleElement.href);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// çœ‹åˆ°è¿™é‡Œå°±å¤Ÿäº†ï¼Œç„¶åå†çœ‹åˆ°createStyleElementå°±å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€æ ·äº†</span></span><br><span class="line">    styleElement = createStyleElement(options);</span><br><span class="line">    update = applyToTag.bind(<span class="literal">null</span>, styleElement);</span><br><span class="line">    remove = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      removeStyleElement(styleElement);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update(obj);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">updateStyle</span>(<span class="params">newObj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newObj) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        newObj.css === obj.css &amp;&amp;</span><br><span class="line">        newObj.media === obj.media &amp;&amp;</span><br><span class="line">        newObj.sourceMap === obj.sourceMap</span><br><span class="line">      )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      update((obj = newObj));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>çœ‹åˆ°<code>createStyleElement</code>æˆ‘ä»¬å°±æ¸…æ¥šäº† style æ˜¯å¦‚ä½•è¢«æ’å…¥ DOM çš„</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ª demo è°ƒè¯•ä¸€ä¸‹æºç ï¼Œè¿›ä¸€æ­¥éªŒè¯</p>
<h2 id="loader-é¢è¯•é¢˜"><a href="#loader-é¢è¯•é¢˜" class="headerlink" title="loader é¢è¯•é¢˜"></a>loader é¢è¯•é¢˜</h2><ul>
<li>Webpack çš„ loader æ˜¯ä»€ä¹ˆï¼Ÿ<ol>
<li>webpack è‡ªå¸¦çš„æ‰“åŒ…å™¨åªèƒ½æ”¯æŒ JS æ–‡ä»¶</li>
<li>å½“æˆ‘ä»¬æƒ³è¦åŠ è½½ <code>css/less/scss/stylus/ts/md</code> æ–‡ä»¶æ—¶ï¼Œå°±éœ€è¦ç”¨ loader</li>
<li>loader çš„åŸç†å°±æ˜¯æŠŠæ–‡ä»¶å†…å®¹åŒ…è£…æˆèƒ½è¿è¡Œçš„ JS<br>æ¯”å¦‚: åŠ è½½ css éœ€è¦ç”¨åˆ° <code>style-loader</code> å’Œ <code>css-loader</code><br><code>css-loader</code> æŠŠä»£ç ä» CSS ä»£ç å˜æˆ export default str å½¢å¼çš„ JS ä»£ç <br><code>style-loader</code> æŠŠä»£ç æŒ‚è½½åˆ° head é‡Œçš„ style æ ‡ç­¾é‡Œ</li>
<li>å®åŠ›å…è®¸çš„è¯å¯ä»¥æ·±å…¥è®²ä¸€ä¸‹ <code>style-loader</code> ç”¨åˆ°äº† <code>pitch</code> é’©å­å’Œ <code>request</code> å¯¹è±¡</li>
<li>loader å’Œ plugin çš„åŒºåˆ«ï¼Œæ‰§è¡Œé¡ºåºç­‰</li>
<li>å†™è¿‡ loader å¯ä»¥è®²ä¸€ä¸‹æ€è·¯</li>
</ol>
</li>
</ul>
<blockquote>
<p>æºç å‚è€ƒï¼š<a href="https://github.com/Matthrews/webpack-core">https://github.com/Matthrews/webpack-core</a></p>
</blockquote>
]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
      </categories>
      <tags>
        <tag>Webpack loader</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£æ webpack æ ¸å¿ƒâ€”â€”Webpack åŸç†</title>
    <url>/bloger/2020/12/08/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/%E8%A7%A3%E6%9E%90%20webpack%20%E6%A0%B8%E5%BF%83%E2%80%94%E2%80%94Webpack%20%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h1 id="è§£æ-webpack-æ ¸å¿ƒâ€”â€”Webpack-åŸç†"><a href="#è§£æ-webpack-æ ¸å¿ƒâ€”â€”Webpack-åŸç†" class="headerlink" title="è§£æ webpack æ ¸å¿ƒâ€”â€”Webpack åŸç†"></a>è§£æ webpack æ ¸å¿ƒâ€”â€”Webpack åŸç†</h1><h2 id="Webpack-è¦è§£å†³çš„ä¸¤ä¸ªé—®é¢˜"><a href="#Webpack-è¦è§£å†³çš„ä¸¤ä¸ªé—®é¢˜" class="headerlink" title="Webpack è¦è§£å†³çš„ä¸¤ä¸ªé—®é¢˜"></a>Webpack è¦è§£å†³çš„ä¸¤ä¸ªé—®é¢˜</h2><ul>
<li><p>ç¼–è¯‘ import å’Œ export å…³é”®å­—</p>
</li>
<li><p>å°†å¤šä¸ªæ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª</p>
</li>
</ul>
<h3 id="å¦‚ä½•ç¼–è¯‘-import-å’Œ-export-å…³é”®å­—"><a href="#å¦‚ä½•ç¼–è¯‘-import-å’Œ-export-å…³é”®å­—" class="headerlink" title="å¦‚ä½•ç¼–è¯‘ import å’Œ export å…³é”®å­—"></a>å¦‚ä½•ç¼–è¯‘ import å’Œ export å…³é”®å­—</h3><ol>
<li>ä¸åŒæµè§ˆå™¨åŠŸèƒ½ä¸åŒ</li>
</ol>
<ul>
<li>ç°ä»£æµè§ˆå™¨å¯ä»¥é€šè¿‡<code>&lt;script type=&quot;module&quot;&gt;æ¥æ”¯æŒ import/export</code></li>
<li><code>IE 8~15</code>ä¸æ”¯æŒ <code>import/export</code></li>
</ul>
<ol start="2">
<li>å…¼å®¹ç­–ç•¥</li>
</ol>
<ul>
<li><p>æ¿€è¿›å…¼å®¹ç­–ç•¥ æŠŠä»£ç å…¨éƒ¨æ”¾åˆ°<code>&lt;script type=&quot;module&quot;&gt;</code>é‡Œé¢</p>
</li>
<li><p>ç¼ºç‚¹ ä¸è¢«<code>IE 8~15</code>æ”¯æŒï¼›è€Œä¸”ä¼šå¯¼è‡´æ–‡ä»¶è¯·æ±‚è¿‡å¤š</p>
</li>
<li><p>å¹³ç¨³å…¼å®¹ç­–ç•¥ æŠŠå…³é”®å­—è½¬è¯‘ä¸ºæ™®é€šä»£ç (é€šè¿‡è½¬è¯‘å‡½æ•°å®Œæˆ)ï¼Œå¹¶æŠŠæ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶</p>
</li>
<li><p>ç¼ºç‚¹ éœ€è¦å†™å¤æ‚ä»£ç æ¥å®Œæˆè¿™ä»¶äº‹æƒ…</p>
</li>
</ul>
<ol start="3">
<li>é‚£ä¹ˆæ€ä¹ˆå†™è¿™ä¸ªè½¬è¯‘å‡½æ•°ï¼Ÿ</li>
</ol>
<ul>
<li><p><code>@babel/core</code>å·²ç»å¸®æˆ‘ä»¬åšäº†</p>
</li>
<li><p>ç¤ºä¾‹</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// project_1/index.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a.getB())</span><br><span class="line"><span class="built_in">console</span>.log(b.getA())</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_1/a.js</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">  value: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">  getB: <span class="function">() =&gt;</span> b.value + <span class="string">&#x27; from a.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_1/b.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">  value: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">  getA: <span class="function">() =&gt;</span> a.value + <span class="string">&#x27; from b.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node -r ts-node/register bundler_1.ts</code>ç»“æœå¦‚ä¸‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">duplicated dependency: a.js</span><br><span class="line">duplicated dependency: b.js</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;index.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span>, <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&#x27;&quot;use strict&quot;;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var _a = _interopRequireDefault(require(&quot;./a.js&quot;));\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var _b = _interopRequireDefault(require(&quot;./b.js&quot;));\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;console.log(_a[&quot;default&quot;].getB());\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;console.log(_b[&quot;default&quot;].getA());&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;a.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&#x27;&quot;use strict&quot;;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;Object.defineProperty(exports, &quot;__esModule&quot;, &#123;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: true\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;);\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;exports[&quot;default&quot;] = void 0;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var _b = _interopRequireDefault(require(&quot;./b.js&quot;));\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var a = &#123;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;  value: &#x27;a&#x27;,\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;  getB: function getB() &#123;\n&#x27;</span> +</span><br><span class="line">      <span class="string">`    return _b[&quot;default&quot;].value + &#x27; from a.js&#x27;;\n`</span> +</span><br><span class="line">      <span class="string">&#x27;  &#125;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var _default = a;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;exports[&quot;default&quot;] = _default;&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;b.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&#x27;&quot;use strict&quot;;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;Object.defineProperty(exports, &quot;__esModule&quot;, &#123;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: true\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;);\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;exports[&quot;default&quot;] = void 0;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var _a = _interopRequireDefault(require(&quot;./a.js&quot;));\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var b = &#123;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;  value: &#x27;b&#x27;,\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;  getA: function getA() &#123;\n&#x27;</span> +</span><br><span class="line">      <span class="string">`    return _a[&quot;default&quot;].value + &#x27; from b.js&#x27;;\n`</span> +</span><br><span class="line">      <span class="string">&#x27;  &#125;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;var _default = b;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;exports[&quot;default&quot;] = _default;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ ¸å¿ƒä»£ç å¦‚ä¸‹</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">exports</span>, <span class="string">&quot;__esModule&quot;</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;); <span class="comment">// ç–‘æƒ‘1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = <span class="keyword">void</span> <span class="number">0</span>; <span class="comment">// ç–‘æƒ‘2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _b = _interopRequireDefault(<span class="built_in">require</span>(<span class="string">&quot;./b.js&quot;</span>)); <span class="comment">// ç»†èŠ‚1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç»†èŠ‚1</span></span><br><span class="line">  <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; <span class="comment">// ç»†èŠ‚1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = &#123;</span><br><span class="line">  value: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">  getB: <span class="function"><span class="keyword">function</span> <span class="title">getB</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _b[<span class="string">&quot;default&quot;</span>].value + <span class="string">&quot; from a.js&quot;</span>; <span class="comment">// ç»†èŠ‚1</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _default = a; <span class="comment">// ç»†èŠ‚2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = _default; <span class="comment">// ç»†èŠ‚2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç–‘æƒ‘1</span></span><br><span class="line"><span class="comment">// Object.defineProperty(exports, &quot;__esModule&quot;, &#123; value: true &#125;)ç­‰åŒäºexports.__esModule = true</span></span><br><span class="line"><span class="comment">// ESMä¸CJSåŒºåˆ†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç–‘æƒ‘2</span></span><br><span class="line"><span class="comment">// exports[&quot;default&quot;] = void 0;ç­‰åŒäºexports[&quot;default&quot;] = undefined</span></span><br><span class="line"><span class="comment">// æ¸…ç©ºexports[&quot;default&quot;]çš„å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»†èŠ‚1</span></span><br><span class="line"><span class="comment">// import b from &#x27;./b.js&#x27; å˜æˆäº†</span></span><br><span class="line"><span class="comment">// var _b = _interopRequireDefault(require(&quot;./b.js&quot;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// b.value å˜æˆäº†</span></span><br><span class="line"><span class="comment">// _b[&#x27;default&#x27;].value</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£é‡Š _interopRequireDefault(module)</span></span><br><span class="line"><span class="comment">// _ ä¸‹åˆ’çº¿å‰ç¼€æ˜¯ä¸ºäº†é¿å…ä¸å…¶ä»–å˜é‡é‡å</span></span><br><span class="line"><span class="comment">// è¯¥å‡½æ•°çš„æ„å›¾æ˜¯ç»™æ¨¡å—æ·»åŠ  &#x27;default&#x27;</span></span><br><span class="line"><span class="comment">// ä¸ºä»€ä¹ˆè¦åŠ  defaultï¼šCommonJS æ¨¡å—æ²¡æœ‰é»˜è®¤å¯¼å‡ºï¼ŒåŠ ä¸Šæ–¹ä¾¿å…¼å®¹</span></span><br><span class="line"><span class="comment">// å†…éƒ¨å®ç°ï¼šreturn m &amp;&amp; m.__esModule ? m : &#123; &quot;default&quot;: m &#125;</span></span><br><span class="line"><span class="comment">// å…¶ä»– _interop å¼€å¤´çš„å‡½æ•°å¤§å¤šéƒ½æ˜¯ä¸ºäº†å…¼å®¹æ—§ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»†èŠ‚2</span></span><br><span class="line"><span class="comment">// var _default = a; exports[&quot;default&quot;] = _default;</span></span><br><span class="line"><span class="comment">// ç›¸å½“äºexports[&quot;default&quot;] = a</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æ€»ç»“</li>
</ol>
<ul>
<li><p>import å…³é”®å­—ä¼šå˜æˆ require å‡½æ•°</p>
</li>
<li><p>export å…³é”®å­—ä¼šå˜æˆ exports å¯¹è±¡</p>
</li>
<li><p>æœ¬è´¨ï¼šESModule è¯­æ³•å˜æˆäº† CommonJS è§„åˆ™</p>
</li>
<li><p>ä½†æ˜¯ç›®å‰æˆ‘ä»¬ä¸çŸ¥é“ require å‡½æ•°æ€ä¹ˆå†™ï¼Œå…ˆä¸ç®¡ï¼Œå‡è®¾ require å·²ç»å†™å¥½äº†</p>
</li>
</ul>
<h3 id="å¦‚ä½•å°†å¤šä¸ªæ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª"><a href="#å¦‚ä½•å°†å¤šä¸ªæ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª" class="headerlink" title="å¦‚ä½•å°†å¤šä¸ªæ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª"></a>å¦‚ä½•å°†å¤šä¸ªæ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª</h3><ol>
<li>æ‰“åŒ…åçš„æ–‡ä»¶ä¼šæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</li>
</ol>
<ul>
<li><p>è‚¯å®šåŒ…å«æ‰€æœ‰æ¨¡å—ï¼Œå¹¶ä¸”èƒ½æ‰§è¡Œæ‰€æœ‰æ¨¡å—</p>
</li>
<li><p>é¢„æƒ³å¦‚ä¸‹</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> depRelation = [</span><br><span class="line">  &#123;<span class="attr">key</span>: <span class="string">&#x27;index.js&#x27;</span>, <span class="attr">deps</span>: [<span class="string">&#x27;a.js&#x27;</span>, <span class="string">&#x27;b.js&#x27;</span>], <span class="attr">code</span>: <span class="keyword">function</span>... &#125;,</span><br><span class="line">  &#123;<span class="attr">key</span>: <span class="string">&#x27;a.js&#x27;</span>, <span class="attr">deps</span>: [<span class="string">&#x27;b.js&#x27;</span>], <span class="attr">code</span>: <span class="keyword">function</span>... &#125;,</span><br><span class="line">  &#123;<span class="attr">key</span>: <span class="string">&#x27;b.js&#x27;</span>, <span class="attr">deps</span>: [<span class="string">&#x27;a.js&#x27;</span>], <span class="attr">code</span>: <span class="keyword">function</span>... &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">// ä¸ºä»€ä¹ˆæŠŠ depRelation ä»å¯¹è±¡æ”¹ä¸ºæ•°ç»„ï¼Ÿ</span></span><br><span class="line"><span class="comment">// å› ä¸ºæ•°ç»„çš„ç¬¬ä¸€é¡¹å°±æ˜¯å…¥å£ï¼Œè€Œå¯¹è±¡æ²¡æœ‰ç¬¬ä¸€é¡¹çš„æ¦‚å¿µ</span></span><br><span class="line">execute(depRelation[<span class="number">0</span>].key) <span class="comment">// æ‰§è¡Œå…¥å£æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">key</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> item = depRelation.find(<span class="function"><span class="params">i</span> =&gt;</span> i.key === key)</span><br><span class="line">  item.code(???) <span class="comment">// æ‰§è¡Œ item çš„ä»£ç ï¼Œå› æ­¤ code æœ€å¥½æ˜¯ä¸ªå‡½æ•°ï¼Œæ–¹ä¾¿æ‰§è¡Œ</span></span><br><span class="line">  <span class="comment">// ä½†æ˜¯ç›®å‰è¿˜ä¸çŸ¥é“è¦ä¼ ä»€ä¹ˆå‚æ•°ç»™ code</span></span><br><span class="line">  <span class="comment">// ä»£ç å¾…å®Œå–„......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç°åœ¨æœ‰ä¸‰ä¸ªé—®é¢˜å¾…è§£å†³</p>
<ul>
<li><p>depRelation æ˜¯å¯¹è±¡ï¼Œéœ€è¦å˜æˆä¸€ä¸ªæ•°ç»„</p>
</li>
<li><p>code æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦å˜æˆä¸€ä¸ªå‡½æ•°, å‡½æ•°éµå¾ª CJS2 è§„èŒƒ</p>
</li>
<li><p>execute å‡½æ•°å¾…å®Œå–„</p>
</li>
</ul>
</li>
<li><p>è§£å†³ä¸Šè¿°ç¬¬ä¸€ä¸ªé—®é¢˜</p>
<p>å°†</p>
<p><code>depRelation[key] = &#123; deps: [], code: es5Code &#125;</code></p>
<p>æ”¹ä¸ºäº†</p>
<p><code>const item = &#123; key, deps: [], code: es5Code &#125; depRelation.push(item)</code></p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// bundler_2.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯·ç¡®ä¿ä½ çš„ Node ç‰ˆæœ¬å¤§äºç­‰äº 14</span></span><br><span class="line"><span class="comment">// è¯·å…ˆè¿è¡Œ yarn æˆ– npm i æ¥å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ node -r ts-node/register æ–‡ä»¶è·¯å¾„ æ¥è¿è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥åŠ ä¸€ä¸ªé€‰é¡¹ --inspect-brkï¼Œå†æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡» Node å›¾æ ‡å³å¯è°ƒè¯•</span></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; readFileSync &#125; <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; resolve, relative, dirname &#125; <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> babel <span class="keyword">from</span> <span class="string">&quot;@babel/core&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ ¹ç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> projectRoot = resolve(__dirname, <span class="string">&quot;project_1&quot;</span>);</span><br><span class="line"><span class="comment">// ç±»å‹å£°æ˜</span></span><br><span class="line">type DepRelation = &#123; <span class="attr">key</span>: string, <span class="attr">deps</span>: string[], <span class="attr">code</span>: string &#125;[];</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ depRelationï¼Œç”¨äºæ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> depRelation: DepRelation = []; <span class="comment">// æ•°ç»„ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¼ å…¥å‡½æ•°ï¼Œå¦‚ D:\demo\fixture_1\index.js</span></span><br><span class="line">collectCodeAndDeps(resolve(projectRoot, <span class="string">&quot;index.js&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(depRelation);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;done&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">collectCodeAndDeps</span>(<span class="params">filepath: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = getProjectPath(filepath); <span class="comment">// æ–‡ä»¶çš„é¡¹ç›®è·¯å¾„ï¼Œå¦‚ index.js</span></span><br><span class="line">  <span class="keyword">if</span> (depRelation.find(<span class="function">(<span class="params">i</span>) =&gt;</span> i.key === key)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">`duplicated dependency: <span class="subst">$&#123;key&#125;</span>`</span>); <span class="comment">// æ³¨æ„ï¼Œé‡å¤ä¾èµ–ä¸ä¸€å®šæ˜¯å¾ªç¯ä¾èµ–</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–æ–‡ä»¶å†…å®¹ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  <span class="keyword">const</span> code = readFileSync(filepath).toString();</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">code</span>: es5Code &#125; = babel.transform(code, &#123;</span><br><span class="line">    presets: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– depRelation[key]</span></span><br><span class="line">  <span class="keyword">const</span> item = &#123; key, <span class="attr">deps</span>: [], <span class="attr">code</span>: es5Code &#125;;</span><br><span class="line">  depRelation.push(item);</span><br><span class="line">  <span class="comment">// å°†ä»£ç è½¬ä¸º AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span> &#125;);</span><br><span class="line">  <span class="comment">// åˆ†ææ–‡ä»¶ä¾èµ–ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    enter: <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (path.node.type === <span class="string">&quot;ImportDeclaration&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// path.node.source.value å¾€å¾€æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œå¦‚ ./a.jsï¼Œéœ€è¦å…ˆæŠŠå®ƒè½¬ä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depAbsolutePath = resolve(</span><br><span class="line">          dirname(filepath),</span><br><span class="line">          path.node.source.value</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// ç„¶åè½¬ä¸ºé¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depProjectPath = getProjectPath(depAbsolutePath);</span><br><span class="line">        <span class="comment">// æŠŠä¾èµ–å†™è¿› depRelation</span></span><br><span class="line">        item.deps.push(depProjectPath);</span><br><span class="line">        collectCodeAndDeps(depAbsolutePath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ–‡ä»¶ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProjectPath</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> relative(projectRoot, path).replace(<span class="regexp">/\\/g</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ‰§è¡Œ<code>node -r ts-node/register bundler_2.ts</code>çœ‹çœ‹</p>
<ul>
<li><p>è§£å†³ä¸Šè¿°ç¬¬äºŒä¸ªé—®é¢˜</p>
<ul>
<li><p>æŠŠ code å­—ç¬¦ä¸²å¤–é¢åŒ…ä¸€ä¸ª <code>function(require, module, exports)&#123;...&#125;</code></p>
</li>
<li><p>æ‰§è¡Œ<code>node project_2/string_code_to_function.js</code>æŠŠ<code>&#123;code: $&#123;code2&#125;&#125;</code>å†™åˆ°æ–‡ä»¶<code>project_2/result_fun.json</code>é‡Œ</p>
</li>
<li><p>æœ€ç»ˆæ–‡ä»¶é‡Œé¢çš„ code å°±æ˜¯å‡½æ•°, ä»£ç å‚è§<code>project_2</code></p>
</li>
</ul>
</li>
<li><p>è§£å†³ä¸Šè¿°ç¬¬ä¸‰ä¸ªé—®é¢˜</p>
<ul>
<li><p>ä»£ç å‚è€ƒ<code>dist.js</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dist.js</span></span><br><span class="line"><span class="keyword">var</span> depRelation = [&#123;</span><br><span class="line">  key: <span class="string">&#x27;index.js&#x27;</span>,</span><br><span class="line">  deps: [<span class="string">&#x27;a.js&#x27;</span>, <span class="string">&#x27;b.js&#x27;</span>],</span><br><span class="line">  code: <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">module</span>, <span class="built_in">exports</span></span>) </span>&#123;</span><br><span class="line"><span class="meta">    &#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _a = _interopRequireDefault(<span class="built_in">require</span>(<span class="string">&#x27;./a.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _b = _interopRequireDefault(<span class="built_in">require</span>(<span class="string">&#x27;./b.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="string">&#x27;default&#x27;</span>: obj &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(_a[<span class="string">&#x27;default&#x27;</span>].getB())</span><br><span class="line">    <span class="built_in">console</span>.log(_b[<span class="string">&#x27;default&#x27;</span>].getA())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  key: <span class="string">&#x27;a.js&#x27;</span>,</span><br><span class="line">  deps: [<span class="string">&#x27;b.js&#x27;</span>],</span><br><span class="line">  code: <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">module</span>, <span class="built_in">exports</span></span>) </span>&#123;</span><br><span class="line"><span class="meta">    &#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(<span class="built_in">exports</span>, <span class="string">&#x27;__esModule&#x27;</span>, &#123;</span><br><span class="line">      value: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">exports</span>[<span class="string">&#x27;default&#x27;</span>] = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _b = _interopRequireDefault(<span class="built_in">require</span>(<span class="string">&#x27;./b.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="string">&#x27;default&#x27;</span>: obj &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> a = &#123;</span><br><span class="line">      value: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">      getB: <span class="function"><span class="keyword">function</span> <span class="title">getB</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _b[<span class="string">&#x27;default&#x27;</span>].value + <span class="string">&#x27; from a.js&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> _default = a</span><br><span class="line">    <span class="built_in">exports</span>[<span class="string">&#x27;default&#x27;</span>] = _default</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  key: <span class="string">&#x27;b.js&#x27;</span>,</span><br><span class="line">  deps: [<span class="string">&#x27;a.js&#x27;</span>],</span><br><span class="line">  code: <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">module</span>, <span class="built_in">exports</span></span>) </span>&#123;</span><br><span class="line"><span class="meta">    &#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(<span class="built_in">exports</span>, <span class="string">&#x27;__esModule&#x27;</span>, &#123;</span><br><span class="line">      value: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">exports</span>[<span class="string">&#x27;default&#x27;</span>] = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _a = _interopRequireDefault(<span class="built_in">require</span>(<span class="string">&#x27;./a.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="string">&#x27;default&#x27;</span>: obj &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> b = &#123;</span><br><span class="line">      value: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">      getA: <span class="function"><span class="keyword">function</span> <span class="title">getA</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _a[<span class="string">&#x27;default&#x27;</span>].value + <span class="string">&#x27; from b.js&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> _default = b</span><br><span class="line">    <span class="built_in">exports</span>[<span class="string">&#x27;default&#x27;</span>] = _default</span><br><span class="line">  &#125;</span><br><span class="line">&#125;]</span><br><span class="line"><span class="keyword">var</span> modules = &#123;&#125;</span><br><span class="line">execute(depRelation[<span class="number">0</span>].key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå·²ç» require è¿‡ï¼Œå°±ç›´æ¥è¿”å›ä¸Šæ¬¡çš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">if</span> (modules[key]) &#123;</span><br><span class="line">    <span class="keyword">return</span> modules[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ‰¾åˆ°è¦æ‰§è¡Œçš„é¡¹ç›®</span></span><br><span class="line">  <span class="keyword">var</span> item = depRelation.find(<span class="function"><span class="params">i</span> =&gt;</span> i.key === key)</span><br><span class="line">  <span class="comment">// æ‰¾ä¸åˆ°å°±æŠ¥é”™ï¼Œä¸­æ–­æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (!item) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`<span class="subst">$&#123;item&#125;</span> is not found`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æŠŠç›¸å¯¹è·¯å¾„å˜æˆé¡¹ç›®è·¯å¾„</span></span><br><span class="line">  <span class="keyword">var</span> pathToKey = <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> dirname = key.substring(<span class="number">0</span>, key.lastIndexOf(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">var</span> projectPath = (dirname + path).replace(<span class="regexp">/\.\//g</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="regexp">/\/\//</span>, <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> projectPath</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ›å»º require å‡½æ•°</span></span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">require</span> = <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> execute(pathToKey(path))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–å½“å‰æ¨¡å—</span></span><br><span class="line">  modules[key] = &#123; <span class="attr">__esModule</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– module æ–¹ä¾¿ code å¾€ module.exports ä¸Šæ·»åŠ å±æ€§</span></span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">module</span> = &#123; <span class="attr">exports</span>: modules[key] &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ code å‡½æ•°ï¼Œå¾€ module.exports ä¸Šæ·»åŠ å¯¼å‡ºå±æ€§</span></span><br><span class="line">  <span class="comment">// ç¬¬äºŒä¸ªå‚æ•° module å¤§éƒ¨åˆ†æ—¶å€™æ˜¯æ— ç”¨çš„ï¼Œä¸»è¦ç”¨äºå…¼å®¹æ—§ä»£ç </span></span><br><span class="line">  item.code(<span class="built_in">require</span>, <span class="built_in">module</span>, <span class="built_in">module</span>.exports)</span><br><span class="line">  <span class="comment">// è¿”å›å½“å‰æ¨¡å—</span></span><br><span class="line">  <span class="keyword">return</span> modules[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>æ‰§è¡Œ<code>node dist.js</code>å¾—åˆ°ç»“æœ</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">b <span class="keyword">from</span> a.js</span><br><span class="line">a <span class="keyword">from</span> b.js</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="2">
<li><p>å¦‚ä½•è‡ªåŠ¨ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶ï¼Ÿ</p>
<ul>
<li><p>æ¨¡æ¿æ‹¼æ¥â€”â€”<code>var dist = &quot;&quot;; dist += content; writeFileSync(&#39;dist.js&#39;, dist)</code></p>
</li>
<li><p>ä»£ç å‚è€ƒ<code>bundler_3.ts</code>, æœ€ç»ˆç”Ÿæˆæ–‡ä»¶<code>dist_auto.js</code>å’Œ<code>dist.js</code>ç›¸å·®æ— å‡ </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// bundler_3.ts</span></span><br><span class="line"><span class="comment">// è¯·ç¡®ä¿ä½ çš„ Node ç‰ˆæœ¬å¤§äºç­‰äº 14</span></span><br><span class="line"><span class="comment">// è¯·å…ˆè¿è¡Œ yarn æˆ– npm i æ¥å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ node -r ts-node/register æ–‡ä»¶è·¯å¾„ æ¥è¿è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥åŠ ä¸€ä¸ªé€‰é¡¹ --inspect-brkï¼Œå†æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡» Node å›¾æ ‡å³å¯è°ƒè¯•</span></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&#x27;@babel/parser&#x27;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&#x27;@babel/traverse&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; writeFileSync, readFileSync &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve, relative, dirname &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> babel <span class="keyword">from</span> <span class="string">&#x27;@babel/core&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ ¹ç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> projectRoot = resolve(__dirname, <span class="string">&#x27;project_1&#x27;</span>)</span><br><span class="line"><span class="comment">// ç±»å‹å£°æ˜</span></span><br><span class="line">type DepRelation = &#123; <span class="attr">key</span>: string, <span class="attr">deps</span>: string[], <span class="attr">code</span>: string &#125;[]</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ depRelationï¼Œç”¨äºæ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> depRelation: DepRelation = [] <span class="comment">// æ•°ç»„ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¼ å…¥å‡½æ•°ï¼Œå¦‚ D:\demo\fixture_1\index.js</span></span><br><span class="line">collectCodeAndDeps(resolve(projectRoot, <span class="string">&#x27;index.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line">writeFileSync(<span class="string">&#x27;dist_auto.js&#x27;</span>, generateCode())</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateCode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  code += <span class="string">&#x27;var depRelation = [&#x27;</span> + depRelation.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; key, deps, code &#125; = item</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&#123;</span></span><br><span class="line"><span class="string">      key: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(key)&#125;</span>, </span></span><br><span class="line"><span class="string">      deps: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(deps)&#125;</span>,</span></span><br><span class="line"><span class="string">      code: function(require, module, exports)&#123;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;code&#125;</span></span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;`</span></span><br><span class="line">  &#125;).join(<span class="string">&#x27;,&#x27;</span>) + <span class="string">&#x27;];\n&#x27;</span></span><br><span class="line">  code += <span class="string">&#x27;var modules = &#123;&#125;;\n&#x27;</span></span><br><span class="line">  code += <span class="string">`execute(depRelation[0].key)\n`</span></span><br><span class="line">  code += <span class="string">`</span></span><br><span class="line"><span class="string">  function execute(key) &#123;</span></span><br><span class="line"><span class="string">    if (modules[key]) &#123; return modules[key] &#125;</span></span><br><span class="line"><span class="string">    var item = depRelation.find(i =&gt; i.key === key)</span></span><br><span class="line"><span class="string">    if (!item) &#123; throw new Error(\`\$&#123;item&#125; is not found\`) &#125;</span></span><br><span class="line"><span class="string">    var pathToKey = (path) =&gt; &#123;</span></span><br><span class="line"><span class="string">      var dirname = key.substring(0, key.lastIndexOf(&#x27;/&#x27;) + 1)</span></span><br><span class="line"><span class="string">      var projectPath = (dirname + path).replace(\/\\.\\\/\/g, &#x27;&#x27;).replace(\/\\\/\\\/\/, &#x27;/&#x27;)</span></span><br><span class="line"><span class="string">      return projectPath</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var require = (path) =&gt; &#123;</span></span><br><span class="line"><span class="string">      return execute(pathToKey(path))</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    modules[key] = &#123; __esModule: true &#125;</span></span><br><span class="line"><span class="string">    var module = &#123; exports: modules[key] &#125;</span></span><br><span class="line"><span class="string">    item.code(require, module, module.exports)</span></span><br><span class="line"><span class="string">    return modules[key]</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">  <span class="keyword">return</span> code</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">collectCodeAndDeps</span>(<span class="params">filepath: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = getProjectPath(filepath) <span class="comment">// æ–‡ä»¶çš„é¡¹ç›®è·¯å¾„ï¼Œå¦‚ index.js</span></span><br><span class="line">  <span class="keyword">if</span> (depRelation.find(<span class="function"><span class="params">i</span> =&gt;</span> i.key === key)) &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œé‡å¤ä¾èµ–ä¸ä¸€å®šæ˜¯å¾ªç¯ä¾èµ–</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–æ–‡ä»¶å†…å®¹ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  <span class="keyword">const</span> code = readFileSync(filepath).toString()</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">code</span>: es5Code &#125; = babel.transform(code, &#123;</span><br><span class="line">    presets: [<span class="string">&#x27;@babel/preset-env&#x27;</span>]</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– depRelation[key]</span></span><br><span class="line">  <span class="keyword">const</span> item = &#123; key, <span class="attr">deps</span>: [], <span class="attr">code</span>: es5Code &#125;</span><br><span class="line">  depRelation.push(item)</span><br><span class="line">  <span class="comment">// å°†ä»£ç è½¬ä¸º AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span> &#125;)</span><br><span class="line">  <span class="comment">// åˆ†ææ–‡ä»¶ä¾èµ–ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    enter: <span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (path.node.type === <span class="string">&#x27;ImportDeclaration&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// path.node.source.value å¾€å¾€æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œå¦‚ ./a.jsï¼Œéœ€è¦å…ˆæŠŠå®ƒè½¬ä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depAbsolutePath = resolve(dirname(filepath), path.node.source.value)</span><br><span class="line">        <span class="comment">// ç„¶åè½¬ä¸ºé¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depProjectPath = getProjectPath(depAbsolutePath)</span><br><span class="line">        <span class="comment">// æŠŠä¾èµ–å†™è¿› depRelation</span></span><br><span class="line">        item.deps.push(depProjectPath)</span><br><span class="line">        collectCodeAndDeps(depAbsolutePath)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ–‡ä»¶ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProjectPath</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> relative(projectRoot, path).replace(<span class="regexp">/\\/g</span>, <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="ç®€æ˜“æ‰“åŒ…å™¨"><a href="#ç®€æ˜“æ‰“åŒ…å™¨" class="headerlink" title="ç®€æ˜“æ‰“åŒ…å™¨"></a>ç®€æ˜“æ‰“åŒ…å™¨</h3><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªç®€æ˜“æ‰“åŒ…å™¨ï¼Œä½†æ˜¯å­˜åœ¨å¦‚ä¸‹é—®é¢˜</p>
<ul>
<li><p>ç”Ÿæˆçš„ä»£ç ä¸­æœ‰å¤šä¸ªé‡å¤çš„<code>_interopXXX</code>å‡½æ•°</p>
</li>
<li><p>åªèƒ½å¼•å…¥å’Œè¿è¡Œ JS æ–‡ä»¶</p>
</li>
<li><p>åªèƒ½ç†è§£ importï¼Œæ— æ³•ç†è§£ require</p>
</li>
<li><p>ä¸æ”¯æŒæ’ä»¶</p>
</li>
<li><p>ä¸æ”¯æŒé…ç½®å…¥å£æ–‡ä»¶å’Œ dist æ–‡ä»¶å</p>
</li>
</ul>
<blockquote>
<p>æºç å‚è€ƒï¼š<a href="https://github.com/Matthrews/webpack-core">https://github.com/Matthrews/webpack-core</a></p>
</blockquote>
]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
      </categories>
      <tags>
        <tag>Webpack æ‰“åŒ…</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£æ webpack æ ¸å¿ƒâ€”â€”Plugin åŸç†</title>
    <url>/bloger/2020/12/08/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/%E8%A7%A3%E6%9E%90%20webpack%20%E6%A0%B8%E5%BF%83%E2%80%94%E2%80%94Plugin%20%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h1 id="è§£æ-webpack-æ ¸å¿ƒâ€”â€”Plugin-åŸç†"><a href="#è§£æ-webpack-æ ¸å¿ƒâ€”â€”Plugin-åŸç†" class="headerlink" title="è§£æ webpack æ ¸å¿ƒâ€”â€”Plugin åŸç†"></a>è§£æ webpack æ ¸å¿ƒâ€”â€”Plugin åŸç†</h1>]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
      </categories>
      <tags>
        <tag>Webpack plugin</tag>
      </tags>
  </entry>
  <entry>
    <title>æŠ½è±¡è¯­æ³•æ ‘(AST)æµ…æ</title>
    <url>/bloger/2021/07/26/%E7%BC%96%E8%AF%91%E7%9B%B8%E5%85%B3/%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91(AST)%E6%B5%85%E6%9E%90/</url>
    <content><![CDATA[<h1 id="æŠ½è±¡è¯­æ³•æ ‘-AST-æµ…æ"><a href="#æŠ½è±¡è¯­æ³•æ ‘-AST-æµ…æ" class="headerlink" title="æŠ½è±¡è¯­æ³•æ ‘(AST)æµ…æ"></a>æŠ½è±¡è¯­æ³•æ ‘(AST)æµ…æ</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>æˆ‘ä»¬ç†ŸçŸ¥çš„ Babel, ESlint å’Œ Prettier éƒ½æ˜¯åŸºäº AST çš„ï¼Œé‚£ä¹ˆ AST åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> answer = <span class="number">6</span> * <span class="number">7</span>;</span><br></pre></td></tr></table></figure>

<p>è½¬æ¢ä¸º AST åæ˜¯è¿™æ ·çš„<a href="https://esprima.org/demo/parse.html?code=var%20answer%20=%206%20*%207;">åœ¨çº¿æŸ¥çœ‹</a>:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;body&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;VariableDeclaration&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;declarations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;VariableDeclarator&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;answer&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;column&quot;</span>: <span class="number">4</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;column&quot;</span>: <span class="number">10</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;init&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;BinaryExpression&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;left&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Literal&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">6</span>,</span><br><span class="line">              <span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;6&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                  <span class="attr">&quot;column&quot;</span>: <span class="number">13</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                  <span class="attr">&quot;column&quot;</span>: <span class="number">14</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;right&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Literal&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">7</span>,</span><br><span class="line">              <span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                  <span class="attr">&quot;column&quot;</span>: <span class="number">17</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                  <span class="attr">&quot;column&quot;</span>: <span class="number">18</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;column&quot;</span>: <span class="number">13</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;column&quot;</span>: <span class="number">18</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;column&quot;</span>: <span class="number">4</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;column&quot;</span>: <span class="number">18</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;var&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;column&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;column&quot;</span>: <span class="number">19</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;script&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;column&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;column&quot;</span>: <span class="number">19</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹ä¸€ä¸ªï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è½¬æ¢ä¸º AST åæ˜¯è¿™æ ·çš„<a href="https://esprima.org/demo/parse.html?code=function%20add(a,%20b)%20%7B%0A%20%20%20%20return%20a%20+%20b%0A%7D">åœ¨çº¿æŸ¥çœ‹</a>:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;body&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;FunctionDeclaration&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;add&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;column&quot;</span>: <span class="number">9</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;column&quot;</span>: <span class="number">12</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;params&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;column&quot;</span>: <span class="number">13</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;column&quot;</span>: <span class="number">14</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;b&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;column&quot;</span>: <span class="number">16</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;column&quot;</span>: <span class="number">17</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;BlockStatement&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;body&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;ReturnStatement&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;argument&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;BinaryExpression&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;+&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;left&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="attr">&quot;column&quot;</span>: <span class="number">11</span></span><br><span class="line">                  &#125;,</span><br><span class="line">                  <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="attr">&quot;column&quot;</span>: <span class="number">12</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">&quot;right&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;b&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="attr">&quot;column&quot;</span>: <span class="number">15</span></span><br><span class="line">                  &#125;,</span><br><span class="line">                  <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="attr">&quot;column&quot;</span>: <span class="number">16</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                  <span class="attr">&quot;column&quot;</span>: <span class="number">11</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                  <span class="attr">&quot;column&quot;</span>: <span class="number">16</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">&quot;column&quot;</span>: <span class="number">4</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">&quot;column&quot;</span>: <span class="number">16</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;column&quot;</span>: <span class="number">19</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;line&quot;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">&quot;column&quot;</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;generator&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;expression&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;async&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;column&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;line&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;column&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;script&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;loc&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;start&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;line&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;column&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;end&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;line&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;column&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦‚æœæŠŠ JavsScript çœ‹ä½œä¸€å°æœºå™¨ï¼Œé‚£ä¹ˆ AST å°±æ˜¯æè¿°è¿™å°æœºå™¨æ„æˆçš„æœ€å°å•å…ƒé›†åˆï¼Œå°†è¿™äº›æœ€å°å•å…ƒé€šè¿‡ä¸€å®šçš„æ–¹å¼è¡”æ¥åœ¨ä¸€èµ·ï¼Œè¿™ä¸ªå°æœºå™¨å°±èƒ½è¿è½¬</p>
</blockquote>
<h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><p>åŸºäºä»¥ä¸Šçš„è±¡å½¢è§£é‡Šï¼Œä¸éš¾çœ‹åˆ° AST å°±æ˜¯ä¸€æ£µæ ‡å‡†çš„è¯­æ³•æ ‘ç»“æ„ï¼Œéå†æ ‘èŠ‚ç‚¹æˆ‘ä»¬å°±å¯ä»¥ä¿®å‰ªè¿™ä¸ªæ£µæ ‘, æœ€ç»ˆå°†ä¿®å‰ªåå¾—æ ‘äº¤ç»™ç¼–è¯‘å™¨ã€‚æ¯”å¦‚é€šè¿‡ <a href="https://www.npmjs.com/package/recast">recast</a> æˆ‘ä»¬å°±å¯ä»¥è½»æ¾æ“çºµ AST ä»¥è¾¾åˆ°æˆ‘ä»¬çš„æ„æ„¿</p>
<p>å¯ä»¥é¢„è§ï¼ŒåŸºäº AST æˆ‘ä»¬å¯ä»¥åšåˆ°ä»¥ä¸‹äº‹æƒ…ï¼š</p>
<ul>
<li><p>é™æ€åˆ†æå·¥å…·</p>
<p>æ¯”å¦‚ ESLintï¼Œå¯ä»¥æ ¼å¼åŒ–ï¼Œå¯ä»¥æ£€æŸ¥ä»£ç æ¼æ´</p>
</li>
<li><p>å…ƒèµ„äº§ï¼ŒåŸºäºå…ƒèµ„äº§å¯ä»¥åšæ–‡æ¡£è¾“å‡ºï¼Œåšå¯è§†åŒ–è¾“å‡ºï¼Œåšæ•°æ®åº“å­˜å‚¨å¹¶äºŒæ¬¡æ¶ˆè´¹ç­‰</p>
<p>æ¯”å¦‚<a href="https://www.npmjs.com/package/typescript-doc-gen">typescript-doc-gen</a>å¯ä»¥å¿«é€Ÿå°† TSX interface è½¬æˆ Markdownï¼Œ<br><a href="http://documentation.js.org/">documentation</a>ä½¿ç”¨ babel è¾“å‡ºæ¼‚äº®çš„å¤šæ ¼å¼æ–‡æ¡£ï¼Œ<a href="https://github.com/SBoudrias/AST-query">AST Query</a>è®©ä½ æƒ³æŸ¥è¯¢æ•°æ®åº“ä¸€æ ·æ“ä½œ AST</p>
</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://github.com/babel/babylon/blob/master/ast/spec.md#node-objects">Babylon AST node types</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/81764012">æ­ç§˜ Prettier</a></p>
<p><a href="https://segmentfault.com/a/1190000016231512">AST å®æˆ˜</a></p>
<p><a href="https://github.com/eslint/espree">Espreeâ€”â€”JavaScript è§£é‡Šå™¨</a></p>
<p><a href="https://github.com/acornjs/acorn">Acornâ€”â€”JavaScript è§£é‡Šå™¨</a></p>
<p><a href="https://esprima.org/demo/parse.html">åœ¨çº¿æŸ¥çœ‹ AST</a></p>
<p><a href="https://babeljs.io/docs/en/babel-core">babel-core</a></p>
<p><a href="https://www.npmjs.com/package/recast">recastâ€”AST æ‰‹æœ¯åˆ€</a></p>
<p><a href="https://github.com/jamiebuilds/the-super-tiny-compiler">The Super Tiny Compiler</a></p>
<p><a href="https://astexplorer.net/">AST Explorer</a></p>
<p><a href="https://m.zhipin.com/mpa/html/get/column?contentId=87995370b56b0ac0qxB70tu1&identity=undefined&userId=undefined">Babel ä½¿ç”¨å…¨æ™¯å›¾</a></p>
<p><a href="https://www.npmjs.com/package/typescript-doc-gen">typescript-doc-gen</a></p>
<p><a href="http://documentation.js.org/">documentation</a></p>
<p><a href="https://github.com/SBoudrias/AST-query">AST Query</a></p>
]]></content>
      <categories>
        <category>ç¼–è¯‘ç›¸å…³</category>
      </categories>
      <tags>
        <tag>AST</tag>
        <tag>babel</tag>
        <tag>parser</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP æƒå¨æŒ‡å— é˜…è¯»ç¬”è®°</title>
    <url>/bloger/2021/02/01/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3/HTTP%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<h1 id="HTTP-æƒå¨æŒ‡å—"><a href="#HTTP-æƒå¨æŒ‡å—" class="headerlink" title="HTTP æƒå¨æŒ‡å—"></a>HTTP æƒå¨æŒ‡å—</h1><h2 id="ç¬¬ä¸€éƒ¨åˆ†-HTTPï¼šWeb-çš„åŸºç¡€"><a href="#ç¬¬ä¸€éƒ¨åˆ†-HTTPï¼šWeb-çš„åŸºç¡€" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ† HTTPï¼šWeb çš„åŸºç¡€"></a>ç¬¬ä¸€éƒ¨åˆ† HTTPï¼šWeb çš„åŸºç¡€</h2><h3 id="ç¬¬-1-ç« -ä»€ä¹ˆæ˜¯-HTTP"><a href="#ç¬¬-1-ç« -ä»€ä¹ˆæ˜¯-HTTP" class="headerlink" title="ç¬¬ 1 ç«  ä»€ä¹ˆæ˜¯ HTTP"></a>ç¬¬ 1 ç«  ä»€ä¹ˆæ˜¯ HTTP</h3><h3 id="ç¬¬-2-ç« -ä»€ä¹ˆæ˜¯-URL"><a href="#ç¬¬-2-ç« -ä»€ä¹ˆæ˜¯-URL" class="headerlink" title="ç¬¬ 2 ç«  ä»€ä¹ˆæ˜¯ URL"></a>ç¬¬ 2 ç«  ä»€ä¹ˆæ˜¯ URL</h3><h3 id="ç¬¬-3-ç« -HTTP-æŠ¥æ–‡æ˜¯å¦‚ä½•ä¼ è¾“-Web-å†…å®¹çš„"><a href="#ç¬¬-3-ç« -HTTP-æŠ¥æ–‡æ˜¯å¦‚ä½•ä¼ è¾“-Web-å†…å®¹çš„" class="headerlink" title="ç¬¬ 3 ç«  HTTP æŠ¥æ–‡æ˜¯å¦‚ä½•ä¼ è¾“ Web å†…å®¹çš„"></a>ç¬¬ 3 ç«  HTTP æŠ¥æ–‡æ˜¯å¦‚ä½•ä¼ è¾“ Web å†…å®¹çš„</h3><h3 id="ç¬¬-4-ç« -HTTP-è¿æ¥ç®¡ç†è¿‡ç¨‹"><a href="#ç¬¬-4-ç« -HTTP-è¿æ¥ç®¡ç†è¿‡ç¨‹" class="headerlink" title="ç¬¬ 4 ç«  HTTP è¿æ¥ç®¡ç†è¿‡ç¨‹"></a>ç¬¬ 4 ç«  HTTP è¿æ¥ç®¡ç†è¿‡ç¨‹</h3><h2 id="ç¬¬äºŒéƒ¨åˆ†-HTTP-ç»“æ„"><a href="#ç¬¬äºŒéƒ¨åˆ†-HTTP-ç»“æ„" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ† HTTP ç»“æ„"></a>ç¬¬äºŒéƒ¨åˆ† HTTP ç»“æ„</h2><h3 id="ç¬¬-5-ç« -Web-æœåŠ¡å™¨ç»“æ„"><a href="#ç¬¬-5-ç« -Web-æœåŠ¡å™¨ç»“æ„" class="headerlink" title="ç¬¬ 5 ç«  Web æœåŠ¡å™¨ç»“æ„"></a>ç¬¬ 5 ç«  Web æœåŠ¡å™¨ç»“æ„</h3><h3 id="ç¬¬-6-ç« -HTTP-ä»£ç†æœåŠ¡å™¨"><a href="#ç¬¬-6-ç« -HTTP-ä»£ç†æœåŠ¡å™¨" class="headerlink" title="ç¬¬ 6 ç«  HTTP ä»£ç†æœåŠ¡å™¨"></a>ç¬¬ 6 ç«  HTTP ä»£ç†æœåŠ¡å™¨</h3><h3 id="ç¬¬-7-ç« -Web-ç¼“å­˜"><a href="#ç¬¬-7-ç« -Web-ç¼“å­˜" class="headerlink" title="ç¬¬ 7 ç«  Web ç¼“å­˜"></a>ç¬¬ 7 ç«  Web ç¼“å­˜</h3><h3 id="ç¬¬-8-ç« -ç½‘å…³å’Œåº”ç”¨æœåŠ¡å™¨çš„æ¦‚å¿µ"><a href="#ç¬¬-8-ç« -ç½‘å…³å’Œåº”ç”¨æœåŠ¡å™¨çš„æ¦‚å¿µ" class="headerlink" title="ç¬¬ 8 ç«  ç½‘å…³å’Œåº”ç”¨æœåŠ¡å™¨çš„æ¦‚å¿µ"></a>ç¬¬ 8 ç«  ç½‘å…³å’Œåº”ç”¨æœåŠ¡å™¨çš„æ¦‚å¿µ</h3><h3 id="ç¬¬-9-ç« -Web-ä¸Šçš„å„ç§å®¢æˆ·ç«¯ç±»å‹"><a href="#ç¬¬-9-ç« -Web-ä¸Šçš„å„ç§å®¢æˆ·ç«¯ç±»å‹" class="headerlink" title="ç¬¬ 9 ç«  Web ä¸Šçš„å„ç§å®¢æˆ·ç«¯ç±»å‹"></a>ç¬¬ 9 ç«  Web ä¸Šçš„å„ç§å®¢æˆ·ç«¯ç±»å‹</h3><h3 id="ç¬¬-10-ç« -ä»åœ¨ç ”ç©¶ä¹‹ä¸­çš„-HTTP-åè®®ï¼šHTTP-NG-åè®®"><a href="#ç¬¬-10-ç« -ä»åœ¨ç ”ç©¶ä¹‹ä¸­çš„-HTTP-åè®®ï¼šHTTP-NG-åè®®" class="headerlink" title="ç¬¬ 10 ç«  ä»åœ¨ç ”ç©¶ä¹‹ä¸­çš„ HTTP åè®®ï¼šHTTP-NG åè®®"></a>ç¬¬ 10 ç«  ä»åœ¨ç ”ç©¶ä¹‹ä¸­çš„ HTTP åè®®ï¼šHTTP-NG åè®®</h3><h2 id="ç¬¬ä¸‰éƒ¨åˆ†-è¯†åˆ«ã€è®¤è¯ä¸å®‰å…¨"><a href="#ç¬¬ä¸‰éƒ¨åˆ†-è¯†åˆ«ã€è®¤è¯ä¸å®‰å…¨" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ† è¯†åˆ«ã€è®¤è¯ä¸å®‰å…¨"></a>ç¬¬ä¸‰éƒ¨åˆ† è¯†åˆ«ã€è®¤è¯ä¸å®‰å…¨</h2><h3 id="ç¬¬-11-ç« -è¯†åˆ«ç”¨æˆ·çš„æŠ€æœ¯ï¼Œä»¥ä¾¿å‘ç”¨æˆ·æä¾›ç§äººåŒ–çš„å†…å®¹æœåŠ¡"><a href="#ç¬¬-11-ç« -è¯†åˆ«ç”¨æˆ·çš„æŠ€æœ¯ï¼Œä»¥ä¾¿å‘ç”¨æˆ·æä¾›ç§äººåŒ–çš„å†…å®¹æœåŠ¡" class="headerlink" title="ç¬¬ 11 ç«  è¯†åˆ«ç”¨æˆ·çš„æŠ€æœ¯ï¼Œä»¥ä¾¿å‘ç”¨æˆ·æä¾›ç§äººåŒ–çš„å†…å®¹æœåŠ¡"></a>ç¬¬ 11 ç«  è¯†åˆ«ç”¨æˆ·çš„æŠ€æœ¯ï¼Œä»¥ä¾¿å‘ç”¨æˆ·æä¾›ç§äººåŒ–çš„å†…å®¹æœåŠ¡</h3><h3 id="ç¬¬-12-ç« -éªŒè¯ç”¨æˆ·èº«ä»½çš„åŸºæœ¬æ–¹å¼"><a href="#ç¬¬-12-ç« -éªŒè¯ç”¨æˆ·èº«ä»½çš„åŸºæœ¬æ–¹å¼" class="headerlink" title="ç¬¬ 12 ç«  éªŒè¯ç”¨æˆ·èº«ä»½çš„åŸºæœ¬æ–¹å¼"></a>ç¬¬ 12 ç«  éªŒè¯ç”¨æˆ·èº«ä»½çš„åŸºæœ¬æ–¹å¼</h3><h3 id="ç¬¬-13-ç« -æ‘˜è¦è®¤è¯"><a href="#ç¬¬-13-ç« -æ‘˜è¦è®¤è¯" class="headerlink" title="ç¬¬ 13 ç«  æ‘˜è¦è®¤è¯"></a>ç¬¬ 13 ç«  æ‘˜è¦è®¤è¯</h3><h3 id="ç¬¬-14-ç« -å› ç‰¹ç½‘çš„å¯†ç ä½“ç³»ã€æ•°å­—è¯ä¹¦ä»¥åŠ-SSL"><a href="#ç¬¬-14-ç« -å› ç‰¹ç½‘çš„å¯†ç ä½“ç³»ã€æ•°å­—è¯ä¹¦ä»¥åŠ-SSL" class="headerlink" title="ç¬¬ 14 ç«  å› ç‰¹ç½‘çš„å¯†ç ä½“ç³»ã€æ•°å­—è¯ä¹¦ä»¥åŠ SSL"></a>ç¬¬ 14 ç«  å› ç‰¹ç½‘çš„å¯†ç ä½“ç³»ã€æ•°å­—è¯ä¹¦ä»¥åŠ SSL</h3><h2 id="ç¬¬å››éƒ¨åˆ†-å®ä½“ã€ç¼–ç å’Œå›½é™…åŒ–"><a href="#ç¬¬å››éƒ¨åˆ†-å®ä½“ã€ç¼–ç å’Œå›½é™…åŒ–" class="headerlink" title="ç¬¬å››éƒ¨åˆ† å®ä½“ã€ç¼–ç å’Œå›½é™…åŒ–"></a>ç¬¬å››éƒ¨åˆ† å®ä½“ã€ç¼–ç å’Œå›½é™…åŒ–</h2><h3 id="ç¬¬-15-ç« -HTTP-å†…å®¹çš„ç»“æ„"><a href="#ç¬¬-15-ç« -HTTP-å†…å®¹çš„ç»“æ„" class="headerlink" title="ç¬¬ 15 ç«  HTTP å†…å®¹çš„ç»“æ„"></a>ç¬¬ 15 ç«  HTTP å†…å®¹çš„ç»“æ„</h3><h3 id="ç¬¬-16-ç« -Web-æ ‡å‡†"><a href="#ç¬¬-16-ç« -Web-æ ‡å‡†" class="headerlink" title="ç¬¬ 16 ç«  Web æ ‡å‡†"></a>ç¬¬ 16 ç«  Web æ ‡å‡†</h3><h3 id="ç¬¬-17-ç« -ç”¨äºåå•†å¯æ¥å—å†…å®¹çš„æœºåˆ¶"><a href="#ç¬¬-17-ç« -ç”¨äºåå•†å¯æ¥å—å†…å®¹çš„æœºåˆ¶" class="headerlink" title="ç¬¬ 17 ç«  ç”¨äºåå•†å¯æ¥å—å†…å®¹çš„æœºåˆ¶"></a>ç¬¬ 17 ç«  ç”¨äºåå•†å¯æ¥å—å†…å®¹çš„æœºåˆ¶</h3><h2 id="ç¬¬äº”éƒ¨åˆ†-å†…å®¹å‘å¸ƒä¸åˆ†å‘"><a href="#ç¬¬äº”éƒ¨åˆ†-å†…å®¹å‘å¸ƒä¸åˆ†å‘" class="headerlink" title="ç¬¬äº”éƒ¨åˆ† å†…å®¹å‘å¸ƒä¸åˆ†å‘"></a>ç¬¬äº”éƒ¨åˆ† å†…å®¹å‘å¸ƒä¸åˆ†å‘</h2><h3 id="ç¬¬-18-ç« -åœ¨ç°ä»£çš„ç½‘ç«™æ‰˜ç®¡ç¯å¢ƒä¸­å¸ƒç½²æœåŠ¡å™¨çš„æ–¹å¼"><a href="#ç¬¬-18-ç« -åœ¨ç°ä»£çš„ç½‘ç«™æ‰˜ç®¡ç¯å¢ƒä¸­å¸ƒç½²æœåŠ¡å™¨çš„æ–¹å¼" class="headerlink" title="ç¬¬ 18 ç«  åœ¨ç°ä»£çš„ç½‘ç«™æ‰˜ç®¡ç¯å¢ƒä¸­å¸ƒç½²æœåŠ¡å™¨çš„æ–¹å¼"></a>ç¬¬ 18 ç«  åœ¨ç°ä»£çš„ç½‘ç«™æ‰˜ç®¡ç¯å¢ƒä¸­å¸ƒç½²æœåŠ¡å™¨çš„æ–¹å¼</h3><h3 id="ç¬¬-19-ç« -åˆ›å»º-Web-å†…å®¹ï¼Œå¹¶å°†å…¶è£…è½½åˆ°-Web-æœåŠ¡å™¨ä¸­å»çš„æŠ€æœ¯"><a href="#ç¬¬-19-ç« -åˆ›å»º-Web-å†…å®¹ï¼Œå¹¶å°†å…¶è£…è½½åˆ°-Web-æœåŠ¡å™¨ä¸­å»çš„æŠ€æœ¯" class="headerlink" title="ç¬¬ 19 ç«  åˆ›å»º Web å†…å®¹ï¼Œå¹¶å°†å…¶è£…è½½åˆ° Web æœåŠ¡å™¨ä¸­å»çš„æŠ€æœ¯"></a>ç¬¬ 19 ç«  åˆ›å»º Web å†…å®¹ï¼Œå¹¶å°†å…¶è£…è½½åˆ° Web æœåŠ¡å™¨ä¸­å»çš„æŠ€æœ¯</h3><h3 id="ç¬¬-20-ç« -Web-æµé‡åˆ†æ•£åˆ°ä¸€ç»„æœåŠ¡å™¨ä¸Šå»çš„ä¸€äº›å·¥å…·å’ŒæŠ€æœ¯"><a href="#ç¬¬-20-ç« -Web-æµé‡åˆ†æ•£åˆ°ä¸€ç»„æœåŠ¡å™¨ä¸Šå»çš„ä¸€äº›å·¥å…·å’ŒæŠ€æœ¯" class="headerlink" title="ç¬¬ 20 ç«  Web æµé‡åˆ†æ•£åˆ°ä¸€ç»„æœåŠ¡å™¨ä¸Šå»çš„ä¸€äº›å·¥å…·å’ŒæŠ€æœ¯"></a>ç¬¬ 20 ç«  Web æµé‡åˆ†æ•£åˆ°ä¸€ç»„æœåŠ¡å™¨ä¸Šå»çš„ä¸€äº›å·¥å…·å’ŒæŠ€æœ¯</h3><h3 id="ç¬¬-21-ç« -æ—¥å¿—æ ¼å¼å’Œå¸¸è§é—®é¢˜"><a href="#ç¬¬-21-ç« -æ—¥å¿—æ ¼å¼å’Œå¸¸è§é—®é¢˜" class="headerlink" title="ç¬¬ 21 ç«  æ—¥å¿—æ ¼å¼å’Œå¸¸è§é—®é¢˜"></a>ç¬¬ 21 ç«  æ—¥å¿—æ ¼å¼å’Œå¸¸è§é—®é¢˜</h3><h2 id="ç¬¬å…­éƒ¨åˆ†-é™„å½•"><a href="#ç¬¬å…­éƒ¨åˆ†-é™„å½•" class="headerlink" title="ç¬¬å…­éƒ¨åˆ† é™„å½•"></a>ç¬¬å…­éƒ¨åˆ† é™„å½•</h2>]]></content>
      <categories>
        <category>HTTP</category>
      </categories>
      <tags>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title>Go è¯­è¨€å­¦ä¹ ç¬”è®°</title>
    <url>/bloger/2022/02/14/%E5%88%86%E5%B8%83%E5%BC%8F%E9%A2%86%E5%9F%9F/go/go/</url>
    <content><![CDATA[<h1 id="Go-è¯­è¨€å­¦ä¹ ç¬”è®°"><a href="#Go-è¯­è¨€å­¦ä¹ ç¬”è®°" class="headerlink" title="Go è¯­è¨€å­¦ä¹ ç¬”è®°"></a>Go è¯­è¨€å­¦ä¹ ç¬”è®°</h1><h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><ul>
<li>è‡ªåŠ¨åƒåœ¾å›æ”¶</li>
<li>æ›´ä¸°å¯Œçš„å†…ç½®ç±»å‹</li>
<li>å‡½æ•°å¤šè¿”å›å€¼</li>
<li>é”™è¯¯å¤„ç†</li>
<li>åŒ¿åå‡½æ•°å’Œé—­åŒ…</li>
<li>ç±»å‹å’Œæ¥å£</li>
<li>å¹¶å‘ç¼–ç¨‹</li>
<li>åå°„</li>
<li>è¯­è¨€äº¤äº’æ€§</li>
</ul>
<h2 id="ç”¨é€”"><a href="#ç”¨é€”" class="headerlink" title="ç”¨é€”"></a>ç”¨é€”</h2><ul>
<li>æ­è½½ Web æœåŠ¡å™¨</li>
<li>å­˜å‚¨é›†ç¾¤åº”ç”¨</li>
<li>æµ·é‡å¹¶è¡Œçš„æ”¯æŒ</li>
</ul>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>è¿è¡Œ go ä»£ç ï¼š<code>go run hello.go</code></p>
<p>å°†æºä»£ç ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼š<code>go build hello.go</code></p>
<h2 id="Go-è¯­è¨€ç»“æ„"><a href="#Go-è¯­è¨€ç»“æ„" class="headerlink" title="Go è¯­è¨€ç»“æ„"></a>Go è¯­è¨€ç»“æ„</h2><p>ç”±åŒ…å£°æ˜ï¼Œå‡½æ•°ï¼Œå˜é‡ï¼Œè¯­å¥&amp;è¡¨è¾¾å¼å’Œæ³¨é‡Šç»„æˆ</p>
<h2 id="Go-è¯­è¨€è¯­æ³•"><a href="#Go-è¯­è¨€è¯­æ³•" class="headerlink" title="Go è¯­è¨€è¯­æ³•"></a>Go è¯­è¨€è¯­æ³•</h2><ol>
<li><p>æ ‡è¯†ç¬¦å‘½åå¿…é¡»æ˜¯ç”±å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ç»„æˆï¼Œå¹¶ä¸”é¦–ä½ä¸èƒ½ä¸ºæ•°å­—</p>
</li>
<li><p>å­—ç¬¦ä¸²æ‹¼æ¥é€šè¿‡+å®ç°</p>
</li>
<li><p>25 ä¸ªå…³é”®å­—å’Œ 36 ä¸ªé¢„å®šä¹‰æ ‡è¯†ç¬¦</p>
</li>
<li><p>ä½¿ç”¨ <code>fmt.Sprintf</code> æ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶èµ‹å€¼ç»™æ–°ä¸²</p>
</li>
</ol>
<h2 id="Go-è¯­è¨€æ•°æ®ç±»å‹"><a href="#Go-è¯­è¨€æ•°æ®ç±»å‹" class="headerlink" title="Go è¯­è¨€æ•°æ®ç±»å‹"></a>Go è¯­è¨€æ•°æ®ç±»å‹</h2><p>å¸ƒå°”å‹ï¼Œæ•°å­—å‹ï¼Œå­—ç¬¦ä¸²å‹ï¼Œæ´¾ç”Ÿç±»å‹ï¼ˆPinter, Array, Struct, Channel, Func, Slice, Map, Interfaceï¼‰</p>
<p>æ•°å­—å‹åˆ†ä¸ºï¼šæ•´æ•°å‹å’Œæµ®ç‚¹å‹ï¼Œå€¼å¾—ä¸€æçš„æ˜¯æµ®ç‚¹å‹ä¸ä»…æ”¯æŒ float32 å’Œ float64 è¿˜æ”¯æŒ complex64 å’Œ complex128ï¼Œè¿™å°†ä½¿å¾— go è¯­è¨€æˆä¸ºç§‘å­¦è®¡ç®—é€‰æ‹©çš„å¯èƒ½</p>
<h2 id="Go-è¯­è¨€å˜é‡"><a href="#Go-è¯­è¨€å˜é‡" class="headerlink" title="Go è¯­è¨€å˜é‡"></a>Go è¯­è¨€å˜é‡</h2><ol>
<li>å˜é‡å£°æ˜åˆ†ä¸º 3 ç§æƒ…å†µ</li>
</ol>
<ul>
<li><p>æŒ‡å®šå˜é‡ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™å˜é‡é»˜è®¤ä¸ºé›¶å€¼ã€‚</p>
</li>
<li><p>æ ¹æ®å€¼è‡ªè¡Œåˆ¤å®šå˜é‡ç±»å‹</p>
<!-- go 1.9ç‰ˆæœ¬å¯¹äºæ•°å­—ç±»å‹ï¼Œæ— éœ€å®šä¹‰intåŠfloat32ã€float64ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ« --></li>
<li><p>å¦‚æœå˜é‡å·²ç»ä½¿ç”¨ <code>var</code> å£°æ˜è¿‡äº†ï¼Œå†ä½¿ç”¨ <code>:=</code> å£°æ˜å˜é‡ï¼Œå°±äº§ç”Ÿç¼–è¯‘é”™è¯¯</p>
</li>
</ul>
<h2 id="ç‰¹æ®Šå¸¸é‡-iota"><a href="#ç‰¹æ®Šå¸¸é‡-iota" class="headerlink" title="ç‰¹æ®Šå¸¸é‡ iota"></a>ç‰¹æ®Šå¸¸é‡ iota</h2><h2 id="Go-è¯­è¨€è¿ç®—ç¬¦"><a href="#Go-è¯­è¨€è¿ç®—ç¬¦" class="headerlink" title="Go è¯­è¨€è¿ç®—ç¬¦"></a>Go è¯­è¨€è¿ç®—ç¬¦</h2><ul>
<li><p>&amp; è¿”å›å˜é‡å­˜å‚¨åœ°å€ <code>&amp;a;</code> å°†ç»™å‡ºå˜é‡çš„å®é™…åœ°å€ã€‚</p>
</li>
<li><ul>
<li>æŒ‡é’ˆå˜é‡ã€‚ <code>\*a;</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡</li>
</ul>
</li>
<li><p>go æ²¡æœ‰ä¸‰ç›®è¿ç®—ç¬¦</p>
</li>
</ul>
<h2 id="Go-è¯­è¨€æ¡ä»¶è¯­å¥"><a href="#Go-è¯­è¨€æ¡ä»¶è¯­å¥" class="headerlink" title="Go è¯­è¨€æ¡ä»¶è¯­å¥"></a>Go è¯­è¨€æ¡ä»¶è¯­å¥</h2><p>å€¼å¾—æ³¨æ„çš„æ˜¯ select è¯­å¥ï¼Œç±»ä¼¼äº switch è¯­å¥ï¼Œä½†æ˜¯ select ä¼šéšæœºæ‰§è¡Œä¸€ä¸ªå¯è¿è¡Œçš„ caseã€‚å¦‚æœæ²¡æœ‰ case å¯è¿è¡Œï¼Œå®ƒå°†é˜»å¡ï¼Œç›´åˆ°æœ‰ case å¯è¿è¡Œã€‚</p>
<p>ä½†æ˜¯åªèƒ½ç”¨äº channel çš„æ“ä½œ(å†™å…¥/è¯»å‡º)</p>
<p>å…³äº selectï¼š <a href="https://zhuanlan.zhihu.com/p/256950290">https://zhuanlan.zhihu.com/p/256950290</a></p>
<h2 id="Go-è¯­è¨€å¾ªç¯æ§åˆ¶"><a href="#Go-è¯­è¨€å¾ªç¯æ§åˆ¶" class="headerlink" title="Go è¯­è¨€å¾ªç¯æ§åˆ¶"></a>Go è¯­è¨€å¾ªç¯æ§åˆ¶</h2><p>break, continue, goto</p>
]]></content>
      <categories>
        <category>Go</category>
      </categories>
  </entry>
  <entry>
    <title>é—­åŒ…æ˜¯ä»€ä¹ˆï¼Ÿ</title>
    <url>/bloger/2021/08/24/JavaScript/%E9%97%AD%E5%8C%85%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/</url>
    <content><![CDATA[<h1 id="è°ˆè°ˆä½ å¯¹é—­åŒ…çš„ç†è§£"><a href="#è°ˆè°ˆä½ å¯¹é—­åŒ…çš„ç†è§£" class="headerlink" title="è°ˆè°ˆä½ å¯¹é—­åŒ…çš„ç†è§£"></a>è°ˆè°ˆä½ å¯¹é—­åŒ…çš„ç†è§£</h1><h2 id="å˜é‡çš„ä½œç”¨åŸŸ"><a href="#å˜é‡çš„ä½œç”¨åŸŸ" class="headerlink" title="å˜é‡çš„ä½œç”¨åŸŸ"></a>å˜é‡çš„ä½œç”¨åŸŸ</h2><p>JavaScript ä¸­ï¼Œå˜é‡çš„ä½œç”¨åŸŸæœ‰ä¸¤ç§ï¼šå…¨å±€ä½œç”¨åŸŸå’Œå±€éƒ¨ä½œç”¨åŸŸ</p>
<p>JavaScript è¯­è¨€ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œå‡½æ•°å†…éƒ¨å¯ä»¥ç›´æ¥è¯»å–å…¨å±€å˜é‡</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="number">999</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f1(); <span class="comment">// 999</span></span><br></pre></td></tr></table></figure>

<p>å¦ä¸€æ–¹é¢ï¼Œåœ¨å‡½æ•°å¤–éƒ¨è‡ªç„¶æ— æ³•è¯»å–å‡½æ•°å†…éƒ¨å±€éƒ¨å˜é‡</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ³¨æ„æ­¤å¤„å¿…é¡»ä½¿ç”¨varå£°æ˜ç¬¦ï¼Œå¦åˆ™å°±æ˜¯å…¨å±€å£°æ˜</span></span><br><span class="line">  <span class="keyword">var</span> n = <span class="number">999</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">alert(n); <span class="comment">// error</span></span><br></pre></td></tr></table></figure>

<h2 id="å¦‚ä½•ä»å‡½æ•°å¤–éƒ¨è¯»å–å‡½æ•°å†…å±€éƒ¨å˜é‡"><a href="#å¦‚ä½•ä»å‡½æ•°å¤–éƒ¨è¯»å–å‡½æ•°å†…å±€éƒ¨å˜é‡" class="headerlink" title="å¦‚ä½•ä»å‡½æ•°å¤–éƒ¨è¯»å–å‡½æ•°å†…å±€éƒ¨å˜é‡"></a>å¦‚ä½•ä»å‡½æ•°å¤–éƒ¨è¯»å–å‡½æ•°å†…å±€éƒ¨å˜é‡</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> n = <span class="number">999</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. JavaScript è¯­è¨€å…è®¸åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰æ–°çš„å‡½æ•°</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(n); <span class="comment">// 2. å¯ä»¥åœ¨å†…éƒ¨å‡½æ•°ä¸­è®¿é—®çˆ¶å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> f2; <span class="comment">// 3. å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œæ‰€ä»¥å‡½æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = f1();</span><br><span class="line"></span><br><span class="line">result(); <span class="comment">// 999  å¦‚æ­¤ä¾¿å®ç°äº†åœ¨å‡½æ•°å¤–éƒ¨è®¿é—®å‡½æ•°å†…éƒ¨å±€éƒ¨å˜é‡</span></span><br></pre></td></tr></table></figure>

<h2 id="é—­åŒ…æ˜¯ä»€ä¹ˆ"><a href="#é—­åŒ…æ˜¯ä»€ä¹ˆ" class="headerlink" title="é—­åŒ…æ˜¯ä»€ä¹ˆ"></a>é—­åŒ…æ˜¯ä»€ä¹ˆ</h2><p>ä¸Šè¿°ä»£ç ä¸­çš„ f2 å‡½æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…, é—­åŒ…å°±æ˜¯èƒ½å¤Ÿ<em>è¯»å–å…¶ä»–å‡½æ•°å†…éƒ¨å˜é‡</em>çš„<em>å‡½æ•°</em></p>
<p>æœ¬è´¨ä¸Šï¼Œé—­åŒ…å°±æ˜¯å°†å‡½æ•°å†…éƒ¨å’Œå‡½æ•°å¤–éƒ¨è¿æ¥èµ·æ¥çš„ä¸€åº§æ¡¥æ¢</p>
<h2 id="é—­åŒ…çš„ä½œç”¨"><a href="#é—­åŒ…çš„ä½œç”¨" class="headerlink" title="é—­åŒ…çš„ä½œç”¨"></a>é—­åŒ…çš„ä½œç”¨</h2><ul>
<li><p>è¯»å–å‡½æ•°å†…éƒ¨å˜é‡</p>
</li>
<li><p>è®©å‡½æ•°å†…éƒ¨è¢«é—­åŒ…å¼•ç”¨çš„å˜é‡å§‹ç»ˆä¿æŒåœ¨å†…å­˜ä¸­</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> n = <span class="number">999</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…¨å±€å˜é‡+åŒ¿åå‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªé—­åŒ…</span></span><br><span class="line">  <span class="comment">// é€šè¿‡æ­¤å‡½æ•°ï¼Œä¸ä»…å¯ä»¥è®¿é—®å‡½æ•°å†…éƒ¨å˜é‡ï¼Œè¿˜å¯ä»¥ä¿®æ”¹å‡½æ•°å†…éƒ¨å˜é‡</span></span><br><span class="line">  add = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    n += <span class="number">1</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> f2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = f1();</span><br><span class="line"></span><br><span class="line">result(); <span class="comment">// 999</span></span><br><span class="line"></span><br><span class="line">add();</span><br><span class="line"></span><br><span class="line">result(); <span class="comment">// 1000</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œresult å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•° f2ã€‚ç¬¬ä¸€æ¬¡è¿è¡Œçš„å€¼æ˜¯ 999ï¼Œç¬¬äºŒæ¬¡è¿è¡Œçš„å€¼æ˜¯ 1000ã€‚è¿™è¯´æ˜äº†ï¼Œå‡½æ•° f1 ä¸­çš„å±€éƒ¨å˜é‡ n ä¸€ç›´ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œå¹¶æ²¡æœ‰åœ¨å‡½æ•° f1 è°ƒç”¨åè¢«è‡ªåŠ¨æ¸…é™¤</p>
<p>ç”±äºé—­åŒ…ä¼šä½¿å¾—å‡½æ•°å†…å˜é‡è¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜æ¶ˆè€—å¾ˆå¤§ï¼Œæ‰€ä»¥ä¸èƒ½æ»¥ç”¨é—­åŒ…ï¼Œå¦åˆ™ä¼šé€ æˆç½‘é¡µæ€§èƒ½é—®é¢˜</p>
<p>é—­åŒ…ä¼šåœ¨çˆ¶å‡½æ•°å¤–éƒ¨ï¼Œæ”¹å˜çˆ¶å‡½æ•°å†…éƒ¨å˜é‡çš„å€¼ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ æŠŠçˆ¶å‡½æ•°å½“ä½œå¯¹è±¡ï¼ˆobjectï¼‰ä½¿ç”¨ï¼ŒæŠŠé—­åŒ…å½“ä½œå®ƒçš„å…¬ç”¨æ–¹æ³•ï¼ˆpublic methodï¼‰ï¼ŒæŠŠå†…éƒ¨å˜é‡å½“ä½œå®ƒçš„ç§æœ‰å±æ€§ï¼ˆprivate valueï¼‰ï¼Œè¿™æ—¶ä¸€å®šè¦å°å¿ƒï¼Œä¸è¦éšä¾¿æ”¹å˜çˆ¶å‡½æ•°å†…éƒ¨å˜é‡çš„å€¼</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨é—­åŒ…æ¥å®šä¹‰å…¬å…±å‡½æ•°ï¼Œå¹¶ä»¤å…¶å¯ä»¥è®¿é—®ç§æœ‰å‡½æ•°å’Œå˜é‡</span></span><br><span class="line"><span class="keyword">var</span> Counter = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> privateCounter = <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeBy</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    privateCounter += val;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    increment: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      changeBy(<span class="number">1</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    decrement: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      changeBy(-<span class="number">1</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    value: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> privateCounter;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(Counter.value()); <span class="comment">/* logs 0 */</span></span><br><span class="line">Counter.increment();</span><br><span class="line">Counter.increment();</span><br><span class="line"><span class="built_in">console</span>.log(Counter.value()); <span class="comment">/* logs 2 */</span></span><br><span class="line">Counter.decrement();</span><br><span class="line"><span class="built_in">console</span>.log(Counter.value()); <span class="comment">/* logs 1 */</span></span><br></pre></td></tr></table></figure>

<p>ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨é—­åŒ…ï¼Œæä¾›äº†è®¸å¤šä¸é¢å‘å¯¹è±¡ç¼–ç¨‹ç›¸å…³çš„å¥½å¤„ â€”â€” ç‰¹åˆ«æ˜¯æ•°æ®éšè—å’Œå°è£…</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> addFun1 = add(<span class="number">4</span>);</span><br><span class="line"><span class="keyword">let</span> addFun2 = add(<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(addFun1(<span class="number">2</span>)); <span class="comment">// 6</span></span><br><span class="line"><span class="built_in">console</span>.log(addFun2(<span class="number">2</span>)); <span class="comment">// 11</span></span><br></pre></td></tr></table></figure>

<p>å‡½æ•°æŸ¯é‡ŒåŒ–ä½¿ç”¨äº†é—­åŒ…</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åŸç”Ÿçš„setTimeoutä¼ é€’çš„ç¬¬ä¸€ä¸ªå‡½æ•°ä¸èƒ½å¸¦å‚æ•°</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</span><br><span class="line">  alert(params);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡é—­åŒ…å¯ä»¥å®ç°ä¼ å‚æ•ˆæœ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(params);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> f1 = func(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(f1, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>setTimeout ä¼ å‚ä½¿ç”¨äº†é—­åŒ…</p>
<p>debounce/throttle éƒ½æ˜¯ç”¨åˆ°äº†é—­åŒ…</p>
<p>é€šè¿‡é—­åŒ…åˆ›å»ºä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥åšæ¨¡å—åŒ–ï¼Œæ¯”å¦‚ jQuery, å†æ¯”å¦‚ Webpack æ‰“åŒ…åçš„ bundle</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">global</span>, factory</span>) </span>&#123;</span><br><span class="line"><span class="meta">  &quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span>.exports === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = <span class="built_in">global</span>.document</span><br><span class="line">      ? factory(<span class="built_in">global</span>, <span class="literal">true</span>)</span><br><span class="line">      : <span class="function"><span class="keyword">function</span> (<span class="params">w</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (!w.document) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;jQuery requires a window with a document&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> factory(w);</span><br><span class="line">        &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    factory(<span class="built_in">global</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Pass this if window is not defined yet</span></span><br><span class="line">&#125;)(<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">&quot;undefined&quot;</span> ? <span class="built_in">window</span> : <span class="built_in">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">window</span>, noGlobal</span>) </span>&#123;</span><br><span class="line"><span class="meta">  &quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// @CODE</span></span><br><span class="line">  <span class="comment">// build.js inserts compiled jQuery here</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> jQuery;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyObject</span>(<span class="params">name, message</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.name = name.toString();</span><br><span class="line">  <span class="built_in">this</span>.message = message.toString();</span><br><span class="line">  <span class="built_in">this</span>.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.getMessage = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.message;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé—­åŒ…ï¼Œä½†æ˜¯å®Œå…¨æ˜¯æ²¡æœ‰å¿…è¦çš„é—­åŒ…ï¼Œå¯ä»¥ä½¿ç”¨åŸå‹æ›¿ä»£</p>
<h2 id="é—­åŒ…é¢è¯•é¢˜"><a href="#é—­åŒ…é¢è¯•é¢˜" class="headerlink" title="é—­åŒ…é¢è¯•é¢˜"></a>é—­åŒ…é¢è¯•é¢˜</h2><p>ä»£ç ç‰‡æ®µ 1</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;The Window&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  name: <span class="string">&quot;My Object&quot;</span>,</span><br><span class="line"></span><br><span class="line">  getNameFunc: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// thisæŒ‡å‘obj</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// thisæŒ‡å‘window</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">alert(obj.getNameFunc()()); <span class="comment">// &quot;The Window&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç ç‰‡æ®µ 2</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;The Window&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  name: <span class="string">&quot;My Object&quot;</span>,</span><br><span class="line"></span><br><span class="line">  getNameFunc: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// thatæ˜¯ä¸Šä¸€å±‚å‡½æ•°çš„thisï¼Œç›¸å½“äºæŠŠobjä¼ é€’ä¸‹æ¥äº†</span></span><br><span class="line">      <span class="keyword">return</span> that.name;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">alert(obj.getNameFunc()()); <span class="comment">// &quot;My Object&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç ç‰‡æ®µ 3</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  data[i] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">data[<span class="number">0</span>](); <span class="comment">// 3</span></span><br><span class="line">data[<span class="number">1</span>](); <span class="comment">// 3</span></span><br><span class="line">data[<span class="number">2</span>](); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç ç‰‡æ®µ 4</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  (<span class="function"><span class="keyword">function</span> (<span class="params">j</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(</span><br><span class="line">      (data[j] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(j);</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="number">0</span></span><br><span class="line">    );</span><br><span class="line">  &#125;)(i); <span class="comment">// ç«‹å³è°ƒç”¨å‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ç”¨è°ƒç”¨å°±ä¼šä¾æ¬¡æ‰“å°0ï¼Œ1, 2</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç ç‰‡æ®µ 5</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  data[i] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">data[<span class="number">0</span>](); <span class="comment">// 0</span></span><br><span class="line">data[<span class="number">1</span>](); <span class="comment">// 1</span></span><br><span class="line">data[<span class="number">2</span>](); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<h2 id="V8-å¦‚ä½•å¤„ç†é—­åŒ…"><a href="#V8-å¦‚ä½•å¤„ç†é—­åŒ…" class="headerlink" title="V8 å¦‚ä½•å¤„ç†é—­åŒ…"></a>V8 å¦‚ä½•å¤„ç†é—­åŒ…</h2><h3 id="æƒ°æ€§è§£æ"><a href="#æƒ°æ€§è§£æ" class="headerlink" title="æƒ°æ€§è§£æ"></a>æƒ°æ€§è§£æ</h3><p>V8 æ‰§è¡Œ JavaScript ä»£ç ï¼Œéœ€è¦ç»è¿‡ç¼–è¯‘å’Œæ‰§è¡Œä¸¤ä¸ªé˜¶æ®µï¼Œå…¶ä¸­ç¼–è¯‘è¿‡ç¨‹æ˜¯æŒ‡ V8 å°† JavaScript ä»£ç è½¬æ¢ä¸ºå­—èŠ‚ç æˆ–è€…äºŒè¿›åˆ¶æœºå™¨ä»£ç çš„é˜¶æ®µï¼Œè€Œæ‰§è¡Œé˜¶æ®µåˆ™æ˜¯æŒ‡è§£é‡Šå™¨è§£é‡Šæ‰§è¡Œå­—èŠ‚ç ï¼Œæˆ–è€…æ˜¯ CPU ç›´æ¥æ‰§è¡ŒäºŒè¿›åˆ¶æœºå™¨ä»£ç çš„é˜¶æ®µ</p>
<p><img src="https://static001.geekbang.org/resource/image/fe/db/fe3d39715d28a833883df6702930a0db.jpg"></p>
<p>åœ¨ç¼–è¯‘ JavaScript ä»£ç çš„è¿‡ç¨‹ä¸­ï¼ŒV8 å¹¶ä¸ä¼šä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„ JavaScript è§£æä¸ºä¸­é—´ä»£ç ï¼Œè¿™ä¸»è¦æ˜¯åŸºäºä»¥ä¸‹ä¸¤ç‚¹ï¼šé¦–å…ˆï¼Œå¦‚æœä¸€æ¬¡è§£æå’Œç¼–è¯‘æ‰€æœ‰çš„ JavaScript ä»£ç ï¼Œè¿‡å¤šçš„ä»£ç ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´ï¼Œè¿™ä¼šä¸¥é‡å½±å“åˆ°é¦–æ¬¡æ‰§è¡Œ JavaScript ä»£ç çš„é€Ÿåº¦ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰åˆ°å¡é¡¿ã€‚å› ä¸ºæœ‰æ—¶å€™ä¸€ä¸ªé¡µé¢çš„ JavaScript ä»£ç éƒ½æœ‰ 10 å¤šå…†ï¼Œå¦‚æœè¦å°†æ‰€æœ‰çš„ä»£ç ä¸€æ¬¡æ€§è§£æç¼–è¯‘å®Œæˆï¼Œé‚£ä¹ˆä¼šå¤§å¤§å¢åŠ ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´ï¼›å…¶æ¬¡ï¼Œè§£æå®Œæˆçš„å­—èŠ‚ç å’Œç¼–è¯‘ä¹‹åçš„æœºå™¨ä»£ç éƒ½ä¼šå­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœä¸€æ¬¡æ€§è§£æå’Œç¼–è¯‘æ‰€æœ‰ JavaScript ä»£ç ï¼Œé‚£ä¹ˆè¿™äº›ä¸­é—´ä»£ç å’Œæœºå™¨ä»£ç å°†ä¼šä¸€ç›´å ç”¨å†…å­˜ï¼Œç‰¹åˆ«æ˜¯åœ¨æ‰‹æœºæ™®åŠçš„å¹´ä»£ï¼Œå†…å­˜æ˜¯éå¸¸å®è´µçš„èµ„æºã€‚</p>
<p>åŸºäºä»¥ä¸Šçš„åŸå› ï¼Œæ‰€æœ‰ä¸»æµçš„ JavaScript è™šæ‹Ÿæœºéƒ½å®ç°äº†<em>æƒ°æ€§è§£æ</em>ã€‚æ‰€è°“æƒ°æ€§è§£ææ˜¯æŒ‡è§£æå™¨åœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°å‡½æ•°å£°æ˜ï¼Œé‚£ä¹ˆä¼šè·³è¿‡å‡½æ•°å†…éƒ¨çš„ä»£ç ï¼Œå¹¶ä¸ä¼šä¸ºå…¶ç”Ÿæˆ AST å’Œå­—èŠ‚ç ï¼Œè€Œä»…ä»…ç”Ÿæˆé¡¶å±‚ä»£ç çš„ AST å’Œå­—èŠ‚ç ã€‚</p>
<p>å…³äºæƒ°æ€§è§£æï¼Œå¯ä»¥ç»“åˆä¸‹é¢è¿™ä¸ªä¾‹å­æ¥åˆ†æä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> d = <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">var</span> f = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">return</span> d + f + a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> c = <span class="number">4</span>;</span><br><span class="line">foo(<span class="number">1</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<p>å½“æŠŠè¿™æ®µä»£ç äº¤ç»™ V8 å¤„ç†æ—¶ï¼ŒV8 ä¼šè‡³ä¸Šè€Œä¸‹è§£æè¿™æ®µä»£ç ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­é¦–å…ˆä¼šé‡åˆ° foo å‡½æ•°ï¼Œç”±äºè¿™åªæ˜¯ä¸€ä¸ªå‡½æ•°å£°æ˜è¯­å¥ï¼ŒV8 åœ¨è¿™ä¸ªé˜¶æ®µåªéœ€è¦å°†è¯¥å‡½æ•°è½¬æ¢ä¸ºå‡½æ•°å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/35/4a/35ce3f6469a7024ca14d81b6c804044a.jpg"></p>
<p>æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯å°†è¯¥å‡½æ•°å£°æ˜è½¬æ¢ä¸ºå‡½æ•°å¯¹è±¡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§£æå’Œç¼–è¯‘å‡½æ•°å†…éƒ¨çš„ä»£ç ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šä¸º foo å‡½æ•°çš„å†…éƒ¨ä»£ç ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ã€‚</p>
<p>ç„¶åç»§ç»­å¾€ä¸‹è§£æï¼Œç”±äºåç»­çš„ä»£ç éƒ½æ˜¯é¡¶å±‚ä»£ç ï¼Œæ‰€ä»¥ V8 ä¼šä¸ºå®ƒä»¬ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œæœ€ç»ˆç”Ÿæˆçš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/e5/62/e52476efb6ef924e74f470ead4970262.jpg"></p>
<p>ä»£ç è§£æå®Œæˆä¹‹åï¼ŒV8 ä¾¿ä¼šæŒ‰ç…§é¡ºåºè‡ªä¸Šè€Œä¸‹æ‰§è¡Œä»£ç ï¼Œé¦–å…ˆä¼šå…ˆæ‰§è¡Œâ€œa=1â€å’Œâ€œc=4â€è¿™ä¸¤ä¸ªèµ‹å€¼è¡¨è¾¾å¼ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ foo å‡½æ•°çš„è°ƒç”¨ï¼Œè¿‡ç¨‹æ˜¯ä» foo å‡½æ•°å¯¹è±¡ä¸­å–å‡ºå‡½æ•°ä»£ç ï¼Œç„¶åå’Œç¼–è¯‘é¡¶å±‚ä»£ç ä¸€æ ·ï¼ŒV8 ä¼šå…ˆç¼–è¯‘ foo å‡½æ•°çš„ä»£ç ï¼Œç¼–è¯‘æ—¶åŒæ ·éœ€è¦å…ˆå°†å…¶ç¼–è¯‘ä¸ºæŠ½è±¡è¯­æ³•æ ‘å’Œå­—èŠ‚ç ï¼Œç„¶åå†è§£é‡Šæ‰§è¡Œã€‚</p>
<p>å¥½äº†ï¼Œä¸Šé¢å°±æ˜¯æƒ°æ€§è§£æçš„ä¸€ä¸ªå¤§è‡´è¿‡ç¨‹ï¼Œçœ‹ä¸Šå»æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œä¸è¿‡åœ¨ V8 å®ç°æƒ°æ€§è§£æçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ”¯æŒ JavaScript ä¸­çš„é—­åŒ…ç‰¹æ€§ï¼Œè¿™ä¼šä½¿å¾— V8 çš„è§£æè¿‡ç¨‹å˜å¾—å¼‚å¸¸å¤æ‚ã€‚</p>
<p>ä¸ºä»€ä¹ˆé—­åŒ…ä¼šè®© V8 è§£æä»£ç çš„è¿‡ç¨‹å˜å¾—å¤æ‚å‘¢ï¼Ÿè¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥æ‹†è§£é—­åŒ…çš„ç‰¹æ€§ï¼Œç„¶åå†æ¥åˆ†æä¸ºä»€ä¹ˆé—­åŒ…å½±å“åˆ°äº† V8 çš„è§£ææµç¨‹ã€‚</p>
<h3 id="æ‹†è§£é—­åŒ…â€”â€”JavaScript-çš„ä¸‰ä¸ªç‰¹æ€§"><a href="#æ‹†è§£é—­åŒ…â€”â€”JavaScript-çš„ä¸‰ä¸ªç‰¹æ€§" class="headerlink" title="æ‹†è§£é—­åŒ…â€”â€”JavaScript çš„ä¸‰ä¸ªç‰¹æ€§"></a>æ‹†è§£é—­åŒ…â€”â€”JavaScript çš„ä¸‰ä¸ªç‰¹æ€§</h3><p>JavaScript ä¸­çš„é—­åŒ…æœ‰ä¸‰ä¸ªåŸºç¡€ç‰¹æ€§ã€‚</p>
<p>ç¬¬ä¸€ï¼ŒJavaScript è¯­è¨€å…è®¸åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰æ–°çš„å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  inner();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å’Œå…¶ä»–çš„æµè¡Œè¯­è¨€æœ‰ç‚¹å·®å¼‚ï¼Œåœ¨å…¶ä»–çš„å¤§éƒ¨åˆ†è¯­è¨€ä¸­ï¼Œå‡½æ•°åªèƒ½å£°æ˜åœ¨é¡¶å±‚ä»£ç ä¸­ï¼Œè€Œ JavaScript ä¸­ä¹‹æ‰€ä»¥å¯ä»¥åœ¨å‡½æ•°ä¸­å£°æ˜å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œä¸»è¦æ˜¯å› ä¸º JavaScript ä¸­çš„å‡½æ•°å³å¯¹è±¡ï¼Œä½ å¯ä»¥åœ¨å‡½æ•°ä¸­å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨å‡½æ•°ä¸­å£°æ˜ä¸€ä¸ªå‡½æ•°ã€‚</p>
<p>ç¬¬äºŒï¼Œå¯ä»¥åœ¨å†…éƒ¨å‡½æ•°ä¸­è®¿é—®çˆ¶å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="number">20</span>;</span><br><span class="line"><span class="comment">//innerå‡½æ•°çš„çˆ¶å‡½æ•°ï¼Œè¯æ³•ä½œç”¨åŸŸ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> d = <span class="number">55</span>;</span><br><span class="line">  <span class="comment">//fooçš„å†…éƒ¨å‡½æ•°</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> d + <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  inner();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºå¯ä»¥åœ¨å‡½æ•°ä¸­å®šä¹‰æ–°çš„å‡½æ•°ï¼Œæ‰€ä»¥å¾ˆè‡ªç„¶çš„ï¼Œå†…éƒ¨çš„å‡½æ•°å¯ä»¥ä½¿ç”¨å¤–éƒ¨å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ï¼Œæ³¨æ„ä¸Šé¢ä»£ç ä¸­çš„ inner å‡½æ•°å’Œ foo å‡½æ•°ï¼Œinner æ˜¯åœ¨ foo å‡½æ•°å†…éƒ¨å®šä¹‰çš„ï¼Œæˆ‘ä»¬å°±ç§° inner å‡½æ•°æ˜¯ foo å‡½æ•°çš„å­å‡½æ•°ï¼Œfoo å‡½æ•°æ˜¯ inner å‡½æ•°çš„çˆ¶å‡½æ•°ã€‚è¿™é‡Œçš„çˆ¶å­å…³ç³»æ˜¯é’ˆå¯¹è¯æ³•ä½œç”¨åŸŸè€Œè¨€çš„ï¼Œå› ä¸ºè¯æ³•ä½œç”¨åŸŸåœ¨å‡½æ•°å£°æ˜æ—¶å°±å†³å®šäº†ï¼Œæ¯”å¦‚ inner å‡½æ•°æ˜¯åœ¨ foo å‡½æ•°å†…éƒ¨å£°æ˜çš„ï¼Œæ‰€ä»¥ inner å‡½æ•°å¯ä»¥è®¿é—® foo å‡½æ•°å†…éƒ¨çš„å˜é‡ï¼Œæ¯”å¦‚ inner å°±å¯ä»¥è®¿é—® foo å‡½æ•°ä¸­çš„å˜é‡ dã€‚</p>
<p>ä½†æ˜¯å¦‚æœåœ¨ foo å‡½æ•°å¤–éƒ¨ï¼Œä¹Ÿå®šä¹‰äº†ä¸€ä¸ªå˜é‡ dï¼Œé‚£ä¹ˆå½“ inner å‡½æ•°è®¿é—®è¯¥å˜é‡æ—¶ï¼Œåˆ°åº•æ˜¯è¯¥è®¿é—®å“ªä¸ªå˜é‡å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸ªå‡½æ•°æœ‰è‡ªå·±çš„è¯æ³•ä½œç”¨åŸŸï¼Œè¯¥å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡éƒ½å­˜åœ¨äºè¯¥ä½œç”¨åŸŸä¸­ï¼Œç„¶å V8 ä¼šå°†è¿™äº›ä½œç”¨åŸŸæŒ‰ç…§è¯æ³•çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ä»£ç ä½ç½®å…³ç³»ï¼Œå°†è¿™äº›ä½œç”¨åŸŸä¸²æˆä¸€ä¸ªé“¾ï¼Œè¿™å°±æ˜¯è¯æ³•ä½œç”¨åŸŸé“¾ï¼ŒæŸ¥æ‰¾å˜é‡çš„æ—¶å€™ä¼šæ²¿ç€è¯æ³•ä½œç”¨åŸŸé“¾çš„é€”å¾„æ¥æŸ¥æ‰¾ã€‚</p>
<p>æ‰€ä»¥ï¼Œinner å‡½æ•°åœ¨è‡ªå·±çš„ä½œç”¨åŸŸä¸­æ²¡æœ‰æŸ¥æ‰¾åˆ°å˜é‡ dï¼Œå°±æ¥ç€åœ¨ foo å‡½æ•°çš„ä½œç”¨åŸŸä¸­æŸ¥æ‰¾ï¼Œå†æŸ¥æ‰¾ä¸åˆ°æ‰ä¼šæŸ¥æ‰¾é¡¶å±‚ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚æ‰€ä»¥ inner å‡½æ•°ä¸­ä½¿ç”¨çš„å˜é‡ d å°±æ˜¯ foo å‡½æ•°ä¸­çš„å˜é‡ dã€‚</p>
<p>ç¬¬ä¸‰ï¼Œå› ä¸ºå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œæ‰€ä»¥å‡½æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é¢è¿™æ®µä»£ç :</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> c = a + b;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> f = foo();</span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿä¸Šé¢è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å°† inner å‡½æ•°ä½œä¸ºäº† foo å‡½æ•°çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è°ƒç”¨ foo å‡½æ•°æ—¶ï¼Œæœ€ç»ˆä¼šè¿”å› inner å‡½æ•°ç»™è°ƒç”¨è€…ï¼Œæ¯”å¦‚ä¸Šé¢æˆ‘ä»¬å°† inner å‡½æ•°è¿”å›ç»™äº†å…¨å±€å˜é‡ fï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥åœ¨å¤–éƒ¨åƒè°ƒç”¨ inner å‡½æ•°ä¸€æ ·è°ƒç”¨ f äº†ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯å’Œ JavaScript é—­åŒ…ç›¸å…³çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§ï¼š</p>
<ul>
<li>å¯ä»¥åœ¨ JavaScript å‡½æ•°å†…éƒ¨å®šä¹‰æ–°çš„å‡½æ•°ï¼›</li>
<li>å†…éƒ¨å‡½æ•°ä¸­è®¿é—®çˆ¶å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ï¼›</li>
<li>å› ä¸º JavaScript ä¸­çš„å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œæ‰€ä»¥å‡½æ•°å¯ä»¥ä½œä¸ºå¦å¤–ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ã€‚</li>
</ul>
<p>è¿™ä¹Ÿæ˜¯ JavaScript è¿‡äºçµæ´»çš„ä¸€ä¸ªåŸå› ï¼Œæ¯”å¦‚åœ¨ C/C++ ä¸­ï¼Œä½ å°±ä¸å¯ä»¥åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å®šä¹‰å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡äº†å†…éƒ¨å‡½æ•°è®¿é—®å¤–éƒ¨å‡½æ•°ä¸­å˜é‡çš„é—®é¢˜äº†ã€‚</p>
<h3 id="é—­åŒ…ç»™æƒ°æ€§è§£æå¸¦æ¥çš„é—®é¢˜"><a href="#é—­åŒ…ç»™æƒ°æ€§è§£æå¸¦æ¥çš„é—®é¢˜" class="headerlink" title="é—­åŒ…ç»™æƒ°æ€§è§£æå¸¦æ¥çš„é—®é¢˜"></a>é—­åŒ…ç»™æƒ°æ€§è§£æå¸¦æ¥çš„é—®é¢˜</h3><p>ä¸Šé¢æˆ‘ä»¬äº†è§£äº† JavaScript çš„è¿™ä¸‰ä¸ªç‰¹æ€§ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥ä½¿ç”¨è¿™ä¸‰ä¸ªç‰¹æ€§ç»„è£…çš„ä¸€æ®µç»å…¸çš„é—­åŒ…ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> d = <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> c = a + b + d;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> f = foo();</span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿä¸Šé¢ä¸Šé¢è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬åœ¨ foo å‡½æ•°ä¸­å®šä¹‰äº† inner å‡½æ•°ï¼Œå¹¶è¿”å› inner å‡½æ•°ï¼ŒåŒæ—¶åœ¨ inner å‡½æ•°ä¸­è®¿é—®äº† foo å‡½æ•°ä¸­çš„å˜é‡ dã€‚</p>
<ul>
<li>å½“è°ƒç”¨ foo å‡½æ•°æ—¶ï¼Œfoo å‡½æ•°ä¼šå°†å®ƒçš„å†…éƒ¨å‡½æ•° inner è¿”å›ç»™å…¨å±€å˜é‡ fï¼›</li>
<li>ç„¶å foo å‡½æ•°æ‰§è¡Œç»“æŸï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡è¢« V8 é”€æ¯ï¼›</li>
<li>è™½ç„¶ foo å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡è¢«é”€æ¯äº†ï¼Œä½†æ˜¯ä¾ç„¶å­˜æ´»çš„ inner å‡½æ•°å¼•ç”¨äº† foo å‡½æ•°ä½œç”¨åŸŸä¸­çš„å˜é‡ dã€‚</li>
</ul>
<p>æŒ‰ç…§é€šç”¨çš„åšæ³•ï¼Œd å·²ç»è¢« v8 é”€æ¯äº†ï¼Œä½†æ˜¯ç”±äºå­˜æ´»çš„å‡½æ•° inner ä¾ç„¶å¼•ç”¨äº† foo å‡½æ•°ä¸­çš„å˜é‡ dï¼Œè¿™æ ·å°±ä¼šå¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li><p>å½“ foo æ‰§è¡Œç»“æŸæ—¶ï¼Œå˜é‡ d è¯¥ä¸è¯¥è¢«é”€æ¯ï¼Ÿå¦‚æœä¸åº”è¯¥è¢«é”€æ¯ï¼Œé‚£ä¹ˆåº”è¯¥é‡‡ç”¨ä»€ä¹ˆç­–ç•¥ï¼Ÿ</p>
</li>
<li><p>å¦‚æœé‡‡ç”¨äº†æƒ°æ€§è§£æï¼Œé‚£ä¹ˆå½“æ‰§è¡Œåˆ° foo å‡½æ•°æ—¶ï¼ŒV8 åªä¼šè§£æ foo å‡½æ•°ï¼Œå¹¶ä¸ä¼šè§£æå†…éƒ¨çš„ inner å‡½æ•°ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ V8 å°±ä¸çŸ¥é“ inner å‡½æ•°ä¸­æ˜¯å¦å¼•ç”¨äº† foo å‡½æ•°çš„å˜é‡ dã€‚</p>
</li>
</ul>
<p>è¿™ä¹ˆè®²å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹ä¸Šé¢è¿™æ®µä»£ç çš„æ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬ä¸ŠèŠ‚åˆ†æè¿‡äº†ï¼ŒJavaScript æ˜¯ä¸€é—¨åŸºäºå †å’Œæ ˆçš„è¯­è¨€ï¼Œå½“æ‰§è¡Œ foo å‡½æ•°çš„æ—¶å€™ï¼Œå †æ ˆçš„å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/de/10/deaa69d414571516a1debd9712860110.jpg"></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨æ‰§è¡Œå…¨å±€ä»£ç æ—¶ï¼ŒV8 ä¼šå°†å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å‹å…¥åˆ°è°ƒç”¨æ ˆä¸­ï¼Œç„¶åè¿›å…¥æ‰§è¡Œ foo å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œè¿™æ—¶å€™ V8 ä¼šä¸º foo å‡½æ•°åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­åŒ…æ‹¬äº†å˜é‡ dï¼Œç„¶åå°† foo å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡å‹å…¥æ ˆä¸­ï¼Œfoo å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åï¼Œfoo å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä»æ ˆä¸­å¼¹å‡ºï¼Œè¿™æ—¶å€™ foo æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„å˜é‡ d ä¹Ÿéšä¹‹è¢«é”€æ¯ã€‚</p>
<p>ä½†æ˜¯è¿™æ—¶å€™ï¼Œç”±äº inner å‡½æ•°è¢«ä¿å­˜åˆ°å…¨å±€å˜é‡ä¸­äº†ï¼Œæ‰€ä»¥ inner å‡½æ•°ä¾ç„¶å­˜åœ¨ï¼Œæœ€å…³é”®çš„åœ°æ–¹åœ¨äº inner å‡½æ•°ä½¿ç”¨äº† foo å‡½æ•°ä¸­çš„å˜é‡ dï¼ŒæŒ‰ç…§æ­£å¸¸æ‰§è¡Œæµç¨‹ï¼Œå˜é‡ d åœ¨ foo å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åå°±è¢«é”€æ¯äº†ã€‚</p>
<p>æ‰€ä»¥æ­£å¸¸çš„å¤„ç†æ–¹å¼åº”è¯¥æ˜¯ foo å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡è™½ç„¶è¢«é”€æ¯äº†ï¼Œä½†æ˜¯ inner å‡½æ•°å¼•ç”¨çš„ foo å‡½æ•°ä¸­çš„å˜é‡å´ä¸èƒ½è¢«é”€æ¯ï¼Œé‚£ä¹ˆ V8 å°±éœ€è¦ä¸ºè¿™ç§æƒ…å†µåšç‰¹æ®Šå¤„ç†ï¼Œéœ€è¦ä¿è¯å³ä¾¿ foo å‡½æ•°æ‰§è¡Œç»“æŸï¼Œä½†æ˜¯ foo å‡½æ•°ä¸­çš„ d å˜é‡ä¾ç„¶ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œä¸èƒ½éšç€ foo å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡è¢«é”€æ¯æ‰ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>
<p>åœ¨æ‰§è¡Œ foo å‡½æ•°çš„é˜¶æ®µï¼Œè™½ç„¶é‡‡å–äº†æƒ°æ€§è§£æï¼Œä¸ä¼šè§£æå’Œæ‰§è¡Œ foo å‡½æ•°ä¸­çš„ inner å‡½æ•°ï¼Œä½†æ˜¯ V8 è¿˜æ˜¯éœ€è¦åˆ¤æ–­ inner å‡½æ•°æ˜¯å¦å¼•ç”¨äº† foo å‡½æ•°ä¸­çš„å˜é‡ï¼Œè´Ÿè´£å¤„ç†è¿™ä¸ªä»»åŠ¡çš„æ¨¡å—å«åšé¢„è§£æå™¨ã€‚</p>
<h3 id="é¢„è§£æå™¨å¦‚ä½•è§£å†³é—­åŒ…æ‰€å¸¦æ¥çš„é—®é¢˜ï¼Ÿ"><a href="#é¢„è§£æå™¨å¦‚ä½•è§£å†³é—­åŒ…æ‰€å¸¦æ¥çš„é—®é¢˜ï¼Ÿ" class="headerlink" title="é¢„è§£æå™¨å¦‚ä½•è§£å†³é—­åŒ…æ‰€å¸¦æ¥çš„é—®é¢˜ï¼Ÿ"></a>é¢„è§£æå™¨å¦‚ä½•è§£å†³é—­åŒ…æ‰€å¸¦æ¥çš„é—®é¢˜ï¼Ÿ</h3><p>V8 å¼•å…¥é¢„è§£æå™¨ï¼Œæ¯”å¦‚å½“è§£æé¡¶å±‚ä»£ç çš„æ—¶å€™ï¼Œé‡åˆ°äº†ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆé¢„è§£æå™¨å¹¶ä¸ä¼šç›´æ¥è·³è¿‡è¯¥å‡½æ•°ï¼Œè€Œæ˜¯å¯¹è¯¥å‡½æ•°åšä¸€æ¬¡å¿«é€Ÿçš„é¢„è§£æï¼Œå…¶ä¸»è¦ç›®çš„æœ‰ä¸¤ä¸ªã€‚</p>
<p>ç¬¬ä¸€ï¼Œæ˜¯åˆ¤æ–­å½“å‰å‡½æ•°æ˜¯ä¸æ˜¯å­˜åœ¨ä¸€äº›è¯­æ³•ä¸Šçš„é”™è¯¯ï¼Œå¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  &#123;<span class="regexp">/&#125; /</span><span class="regexp">/è¯­æ³•é”™è¯¯</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">var a = 1</span></span><br><span class="line"><span class="regexp">var c = 4</span></span><br><span class="line"><span class="regexp">foo(1, 5)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨é¢„è§£æè¿‡ç¨‹ä¸­ï¼Œé¢„è§£æå™¨å‘ç°äº†è¯­æ³•é”™è¯¯ï¼Œé‚£ä¹ˆå°±ä¼šå‘ V8 æŠ›å‡ºè¯­æ³•é”™è¯¯ï¼Œæ¯”å¦‚ä¸Šé¢è¿™æ®µä»£ç çš„è¯­æ³•é”™è¯¯æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Uncaught <span class="built_in">SyntaxError</span>: Invalid regular expression: missing /</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒï¼Œé™¤äº†æ£€æŸ¥è¯­æ³•é”™è¯¯ä¹‹å¤–ï¼Œé¢„è§£æå™¨å¦å¤–çš„ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½å°±æ˜¯æ£€æŸ¥å‡½æ•°å†…éƒ¨æ˜¯å¦å¼•ç”¨äº†å¤–éƒ¨å˜é‡ï¼Œå¦‚æœå¼•ç”¨äº†å¤–éƒ¨çš„å˜é‡ï¼Œé¢„è§£æå™¨ä¼šå°†æ ˆä¸­çš„å˜é‡å¤åˆ¶åˆ°å †ä¸­ï¼Œåœ¨ä¸‹æ¬¡æ‰§è¡Œåˆ°è¯¥å‡½æ•°çš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨å †ä¸­çš„å¼•ç”¨ï¼Œè¿™æ ·å°±è§£å†³äº†é—­åŒ…æ‰€å¸¦æ¥çš„é—®é¢˜ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ‰€è°“æƒ°æ€§è§£ææ˜¯æŒ‡è§£æå™¨åœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°å‡½æ•°å£°æ˜ï¼Œé‚£ä¹ˆä¼šè·³è¿‡å‡½æ•°å†…éƒ¨çš„ä»£ç ï¼Œå¹¶ä¸ä¼šä¸ºå…¶ç”Ÿæˆ AST å’Œå­—èŠ‚ç ï¼Œè€Œä»…ä»…ç”Ÿæˆé¡¶å±‚ä»£ç çš„ AST å’Œå­—èŠ‚ç ã€‚</p>
<p>åˆ©ç”¨æƒ°æ€§è§£æå¯ä»¥åŠ é€Ÿ JavaScript ä»£ç çš„å¯åŠ¨é€Ÿåº¦ï¼Œå¦‚æœè¦å°†æ‰€æœ‰çš„ä»£ç ä¸€æ¬¡æ€§è§£æç¼–è¯‘å®Œæˆï¼Œé‚£ä¹ˆä¼šå¤§å¤§å¢åŠ ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´ã€‚</p>
<p>ç”±äº JavaScript æ˜¯ä¸€é—¨å¤©ç”Ÿæ”¯æŒé—­åŒ…çš„è¯­è¨€ï¼Œç”±äºé—­åŒ…ä¼šå¼•ç”¨å½“å‰å‡½æ•°ä½œç”¨åŸŸä¹‹å¤–çš„å˜é‡ï¼Œæ‰€ä»¥å½“ V8 è§£æä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œè¿˜éœ€è¦åˆ¤æ–­è¯¥å‡½æ•°çš„å†…éƒ¨å‡½æ•°æ˜¯å¦å¼•ç”¨äº†å½“å‰å‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡ï¼Œå¦‚æœå¼•ç”¨äº†ï¼Œé‚£ä¹ˆéœ€è¦å°†è¯¥å˜é‡å­˜æ”¾åˆ°å †ä¸­ï¼Œå³ä¾¿å½“å‰å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åï¼Œä¹Ÿä¸ä¼šé‡Šæ”¾è¯¥å˜é‡ã€‚</p>
<h3 id="æ€è€ƒé¢˜"><a href="#æ€è€ƒé¢˜" class="headerlink" title="æ€è€ƒé¢˜"></a>æ€è€ƒé¢˜</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œfooå‡½æ•°æ—¶ï¼Œå‡½æ•°fooçš„ä¸Šä¸‹æ–‡å’Œå˜é‡aä¼šå­˜æ”¾åˆ°æ ˆä¸Šï¼Œéšç€å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¼šè¢«é”€æ¯</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a++;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ fooå‡½æ•°ä¹‹åå…ˆè§£æï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­å‘ç°æœ‰å†…éƒ¨å‡½æ•°ï¼Œå› æ­¤ä¼šå‘ç”Ÿé¢„è§£æ</span></span><br><span class="line"><span class="comment">// å‘ç°å†…éƒ¨å‡½æ•°ä¼šå¼•ç”¨å¤–éƒ¨å‡½æ•°ä¸­çš„å˜é‡ aï¼Œå› æ­¤å°†è¿™ä¸ª a å†™åˆ°å†…å­˜å †ä¸Šã€‚</span></span><br><span class="line"><span class="comment">// æœ€ç»ˆ foo å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œa å˜é‡ä¸ä¼šéšä¹‹é”€æ¯</span></span><br></pre></td></tr></table></figure>

<p>é—®é¢˜ï¼šå½“è°ƒç”¨ foo å‡½æ•°æ—¶ï¼Œfoo å‡½æ•°å†…éƒ¨çš„å˜é‡ a ä¼šåˆ†åˆ«åˆ†é…åˆ°æ ˆä¸Šï¼Ÿè¿˜æ˜¯å †ä¸Šï¼Ÿ</p>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
  </entry>
  <entry>
    <title>React ä¸­çš„é«˜é˜¶ç»„ä»¶åŠå…¶åº”ç”¨åœºæ™¯</title>
    <url>/bloger/2021/04/10/UI%E6%A1%86%E6%9E%B6/React%E4%B8%AD%E7%9A%84%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/</url>
    <content><![CDATA[<h2 id="React-ä¸­çš„é«˜é˜¶ç»„ä»¶åŠå…¶åº”ç”¨åœºæ™¯"><a href="#React-ä¸­çš„é«˜é˜¶ç»„ä»¶åŠå…¶åº”ç”¨åœºæ™¯" class="headerlink" title="React ä¸­çš„é«˜é˜¶ç»„ä»¶åŠå…¶åº”ç”¨åœºæ™¯"></a>React ä¸­çš„é«˜é˜¶ç»„ä»¶åŠå…¶åº”ç”¨åœºæ™¯</h2><h3 id="ä»€ä¹ˆæ˜¯é«˜é˜¶ç»„ä»¶"><a href="#ä»€ä¹ˆæ˜¯é«˜é˜¶ç»„ä»¶" class="headerlink" title="ä»€ä¹ˆæ˜¯é«˜é˜¶ç»„ä»¶"></a>ä»€ä¹ˆæ˜¯é«˜é˜¶ç»„ä»¶</h3><p>å¦‚æœä¸€ä¸ªå‡½æ•° æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªç»„ä»¶ä½œä¸ºå‚æ•°å¹¶ä¸”è¿”å›ä¸€ä¸ªç»„ä»¶ å°±å¯ç§°ä¹‹ä¸º é«˜é˜¶ç»„ä»¶ ä¸‹é¢å°±æ˜¯ä¸€ä¸ªç®€å•çš„é«˜é˜¶ç»„ä»¶ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HigherOrderComponent = <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> /&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="React-ä¸­çš„é«˜é˜¶ç»„ä»¶"><a href="#React-ä¸­çš„é«˜é˜¶ç»„ä»¶" class="headerlink" title="React ä¸­çš„é«˜é˜¶ç»„ä»¶"></a>React ä¸­çš„é«˜é˜¶ç»„ä»¶</h3><p>React ä¸­çš„é«˜é˜¶ç»„ä»¶ä¸»è¦æœ‰ä¸¤ç§å½¢å¼ï¼šå±æ€§ä»£ç† å’Œ åå‘ç»§æ‰¿</p>
<h4 id="å±æ€§ä»£ç†ï¼ˆProps-Proxyï¼‰"><a href="#å±æ€§ä»£ç†ï¼ˆProps-Proxyï¼‰" class="headerlink" title="å±æ€§ä»£ç†ï¼ˆProps Proxyï¼‰"></a>å±æ€§ä»£ç†ï¼ˆProps Proxyï¼‰</h4><p>æœ€ç®€å•çš„å±æ€§ä»£ç†å®ç°ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ— çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HigherOrderComponent</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">props</span>) =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ‰çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HigherOrderComponent</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œå±æ€§ä»£ç†å…¶å®å°±æ˜¯ ä¸€ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ª<code>WrappedComponent </code>ç»„ä»¶ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªç»§æ‰¿äº†<code>React.Component</code>ç»„ä»¶çš„ç±»ï¼Œä¸”åœ¨è¯¥ç±»çš„ render()<br>æ–¹æ³•ä¸­è¿”å›è¢«ä¼ å…¥çš„<code>WrappedComponent </code>ç»„ä»¶ã€‚</p>
<p>é‚£æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å±æ€§ä»£ç†ç±»å‹çš„é«˜é˜¶ç»„ä»¶åšä¸€äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å› ä¸ºå±æ€§ä»£ç†ç±»å‹çš„é«˜é˜¶ç»„ä»¶è¿”å›è¿”å›ç»§æ‰¿è‡ª<code>React.Component</code>çš„æ ‡å‡†ç»„ä»¶ã€‚ å› æ­¤ï¼Œåœ¨ React æ ‡å‡†ç»„ä»¶ä¸­å¯ä»¥åšä»€ä¹ˆï¼Œé«˜é˜¶ç»„ä»¶ä¹Ÿå¯ä»¥åšï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æ“ä½œ props</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; userInfo &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">&quot;App&quot;</span>&gt;</span><br><span class="line">      &lt;h1&gt;Learn React&lt;/h1&gt;</span><br><span class="line">      &lt;p&gt;&#123;<span class="built_in">JSON</span>.stringify(userInfo, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨é«˜é˜¶ç»„ä»¶é‡Œæ“ä½œprops</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">WrappedComponent</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> HigherOrderComponent = <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(props);</span><br><span class="line">      <span class="built_in">this</span>.state = &#123;</span><br><span class="line">        userInfo: <span class="literal">null</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      fetch(<span class="string">&quot;https://jsonplaceholder.typicode.com/users/1&quot;</span>)</span><br><span class="line">        .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span><br><span class="line">        .then(<span class="function">(<span class="params">data</span>) =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">userInfo</span>: data &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; userInfo &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">      <span class="keyword">const</span> newProps = &#123;</span><br><span class="line">        ...this.props,</span><br><span class="line">        userInfo,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...newProps</span>&#125; /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> HigherOrderComponent(App);</span><br></pre></td></tr></table></figure>

<ul>
<li>æŠ½ç¦» state</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    name: &#123; value, onChange &#125;,</span><br><span class="line">  &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">&quot;App&quot;</span>&gt;</span><br><span class="line">      &lt;h1&gt;Learn React&lt;/h1&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        type=<span class="string">&quot;text&quot;</span></span><br><span class="line">        value=&#123;value&#125;</span><br><span class="line">        onChange=&#123;<span class="function">(<span class="params">e</span>) =&gt;</span> onChange(e.target.value)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨é«˜é˜¶ç»„ä»¶é‡ŒæŠ½ç¦» state</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">WrappedComponent</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> withOnChange = <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(props);</span><br><span class="line">      <span class="built_in">this</span>.state = &#123;</span><br><span class="line">        name: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onChange = <span class="function">(<span class="params">newName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;onChange&quot;</span>, newName);</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123; <span class="attr">name</span>: newName &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; name &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">      <span class="keyword">const</span> newProps = &#123;</span><br><span class="line">        name: &#123;</span><br><span class="line">          value: name,</span><br><span class="line">          onChange: <span class="built_in">this</span>.onChange,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...newProps</span>&#125; /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withOnChange(App);</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ ref è®¿é—®åˆ°ç»„ä»¶å®ä¾‹ æœ‰æ—¶ä¼šæœ‰éœ€è¦è®¿é—® DOM element ï¼ˆä½¿ç”¨ç¬¬ä¸‰æ–¹ DOM æ“ä½œåº“ï¼‰çš„æ—¶å€™å°±ä¼šç”¨åˆ°ç»„ä»¶çš„ ref å±æ€§ã€‚å®ƒåªèƒ½å£°æ˜åœ¨ Class ç±»å‹çš„ç»„ä»¶ä¸Šï¼Œè€Œæ— æ³•å£°æ˜åœ¨å‡½æ•°ï¼ˆæ— çŠ¶æ€ï¼‰ç±»å‹çš„ç»„ä»¶ä¸Šã€‚</li>
</ul>
<p>ref çš„å€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼ˆä¸æ¨èä½¿ç”¨ï¼‰ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¦‚æœæ˜¯å›è°ƒå‡½æ•°çš„è¯ï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºæ˜¯ï¼š</p>
<p>ç»„ä»¶è¢«æŒ‚è½½åï¼ˆ<code>componentDidMount</code>ï¼‰ï¼Œå›è°ƒå‡½æ•°ç«‹å³æ‰§è¡Œï¼Œå›è°ƒå‡½æ•°çš„å‚æ•°ä¸ºè¯¥ç»„ä»¶çš„å®ä¾‹ã€‚ ç»„ä»¶è¢«å¸è½½ï¼ˆ<code>componentDidUnmount</code>ï¼‰æˆ–è€…åŸæœ‰çš„ ref<br>å±æ€§æœ¬èº«å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ­¤æ—¶å›è°ƒå‡½æ•°ä¹Ÿä¼šç«‹å³æ‰§è¡Œï¼Œä¸”å›è°ƒå‡½æ•°çš„å‚æ•°ä¸º nullã€‚ å¦‚ä½•åœ¨ é«˜é˜¶ç»„ä»¶ ä¸­è·å–åˆ°<code>WrappedComponent </code>ç»„ä»¶çš„å®ä¾‹å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å¯ä»¥é€šè¿‡ <code>WrappedComponent </code>ç»„ä»¶çš„ ref<br>å±æ€§ï¼Œè¯¥å±æ€§ä¼šåœ¨ç»„ä»¶ <code>componentDidMount</code> çš„æ—¶å€™æ‰§è¡Œ ref çš„å›è°ƒå‡½æ•°å¹¶ä¼ å…¥è¯¥ç»„ä»¶çš„å®ä¾‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component, createRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      value: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onChange = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">value</span>: e.target.value &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;App3 componentDidMount&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; value &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;App&quot;</span>&gt;</span><br><span class="line">        &lt;h1&gt;Learn React&lt;/h1&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;text&quot;</span> value=&#123;value&#125; onChange=&#123;<span class="built_in">this</span>.onChange&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨é«˜é˜¶ç»„ä»¶é‡Œé€šè¿‡ ref è®¿é—®åˆ°ç»„ä»¶å®ä¾‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">WrappedComponent</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> HigherOrderComponent = <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">&quot;HigherOrderComponent componentDidMount&quot;</span>,</span><br><span class="line">        <span class="built_in">this</span>.instance.state,</span><br><span class="line">        <span class="built_in">this</span>.instance.onChange</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šä¸èƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸Šä½¿ç”¨ ref å±æ€§ï¼Œå› ä¸ºæ— çŠ¶æ€ç»„ä»¶æ²¡æœ‰å®ä¾‹ã€‚</span></span><br><span class="line">        &lt;WrappedComponent</span><br><span class="line">          &#123;...this.props&#125;</span><br><span class="line">          ref=&#123;<span class="function">(<span class="params">obj</span>) =&gt;</span> (<span class="built_in">this</span>.instance = obj)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> HigherOrderComponent(App);</span><br></pre></td></tr></table></figure>

<ul>
<li>ç”¨å…¶ä»–å…ƒç´ åŒ…è£¹ <code>WrappedComponent</code><br>ç»™ <code>WrappedComponent</code> ç»„ä»¶åŒ…ä¸€å±‚èƒŒæ™¯è‰²ä¸º<code>#f80</code>çš„ div å…ƒç´ ï¼š</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withBackgroundColor</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;div style=&#123;&#123; <span class="attr">backgroundColor</span>: <span class="string">&quot;#f80&quot;</span> &#125;&#125;&gt;</span><br><span class="line">          &lt;WrappedComponent &#123;...this.props&#125; /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="åå‘ç»§æ‰¿ï¼ˆInheritance-Inversionï¼‰"><a href="#åå‘ç»§æ‰¿ï¼ˆInheritance-Inversionï¼‰" class="headerlink" title="åå‘ç»§æ‰¿ï¼ˆInheritance Inversionï¼‰"></a>åå‘ç»§æ‰¿ï¼ˆInheritance Inversionï¼‰</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HigherOrderComponent</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">WrappedComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">super</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åå‘ç»§æ‰¿å…¶å®å°±æ˜¯ ä¸€ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ª <code>WrappedComponent</code> ç»„ä»¶ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªç»§æ‰¿äº†è¯¥ä¼ å…¥ <code>WrappedComponent</code> ç»„ä»¶çš„ç±»ï¼Œä¸”åœ¨è¯¥ç±»çš„<code>render()</code><br>æ–¹æ³•ä¸­è¿”å› <code>super.render() </code>æ–¹æ³•</p>
<p>ä¼šå‘ç°å…¶å±æ€§ä»£ç†å’Œåå‘ç»§æ‰¿çš„å®ç°æœ‰äº›ç±»ä¼¼çš„åœ°æ–¹ï¼Œéƒ½æ˜¯è¿”å›ä¸€ä¸ªç»§æ‰¿äº†æŸä¸ªçˆ¶ç±»çš„å­ç±»ï¼Œåªä¸è¿‡å±æ€§ä»£ç†ä¸­ç»§æ‰¿çš„æ˜¯<code>React.Component</code>ï¼Œåå‘ç»§æ‰¿ä¸­ç»§æ‰¿çš„æ˜¯ä¼ å…¥çš„ç»„ä»¶ <code>WrappedComponent</code></p>
<p>é‚£ä¹ˆï¼Œåå‘ç»§æ‰¿å¯ä»¥åšä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>æ“ä½œ state é«˜é˜¶ç»„ä»¶ä¸­å¯ä»¥è¯»å–ã€ç¼–è¾‘å’Œåˆ é™¤<code>WrappedComponent</code> ç»„ä»¶å®ä¾‹ä¸­çš„ stateã€‚ç”šè‡³å¯ä»¥å¢åŠ æ›´å¤šçš„ state é¡¹ï¼Œä½†æ˜¯è¿™ä¹ˆåšå¯èƒ½ä¼šå¯¼è‡´ state éš¾ä»¥ç»´æŠ¤åŠç®¡ç†</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withLogging</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">WrappedComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;h2&gt;Debugger Component&lt;/h2&gt;</span><br><span class="line">          &lt;p&gt;state:&lt;/p&gt;</span><br><span class="line">          &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.state, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">          &lt;p&gt;props:&lt;/p&gt;</span><br><span class="line">          &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.props, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">          &#123;<span class="built_in">super</span>.render()&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ¸²æŸ“åŠ«æŒï¼ˆ<code>Render Highjacking</code>ï¼‰ é€šè¿‡æ¸²æŸ“åŠ«æŒï¼Œæˆ‘ä»¬å¯ä»¥ï¼š<ul>
<li>æœ‰æ¡ä»¶åœ°å±•ç¤ºå…ƒç´ æ ‘ï¼ˆelement treeï¼‰</li>
<li>æ“ä½œç”± render() è¾“å‡ºçš„ React å…ƒç´ æ ‘</li>
<li>åœ¨ä»»ä½•ç”± render() è¾“å‡ºçš„ React å…ƒç´ ä¸­æ“ä½œ props</li>
<li>ç”¨å…¶ä»–å…ƒç´ åŒ…è£¹ä¼ å…¥çš„ç»„ä»¶<code>WrappedComponent</code>ï¼ˆåŒ<strong>å±æ€§ä»£ç†</strong>ï¼‰</li>
</ul>
</li>
</ul>
<h3 id="é«˜é˜¶ç»„ä»¶å­˜åœ¨çš„é—®é¢˜"><a href="#é«˜é˜¶ç»„ä»¶å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="é«˜é˜¶ç»„ä»¶å­˜åœ¨çš„é—®é¢˜"></a>é«˜é˜¶ç»„ä»¶å­˜åœ¨çš„é—®é¢˜</h3><h4 id="é™æ€æ–¹æ³•ä¸¢å¤±"><a href="#é™æ€æ–¹æ³•ä¸¢å¤±" class="headerlink" title="é™æ€æ–¹æ³•ä¸¢å¤±"></a>é™æ€æ–¹æ³•ä¸¢å¤±</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> å› ä¸ºåŸå§‹ç»„ä»¶è¢«åŒ…è£¹äºä¸€ä¸ªå®¹å™¨ç»„ä»¶å†…ï¼Œä¹Ÿå°±æ„å‘³ç€æ–°ç»„ä»¶ä¼šæ²¡æœ‰åŸå§‹ç»„ä»¶çš„ä»»ä½•é™æ€æ–¹æ³•ï¼š</span><br><span class="line"><span class="comment">// å®šä¹‰é™æ€æ–¹æ³•</span></span><br><span class="line">WrappedComponent.staticMethod = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨é«˜é˜¶ç»„ä»¶</span></span><br><span class="line"><span class="keyword">const</span> EnhancedComponent = HigherOrderComponent(WrappedComponent);</span><br><span class="line"><span class="comment">// å¢å¼ºå‹ç»„ä»¶æ²¡æœ‰é™æ€æ–¹æ³•</span></span><br><span class="line"><span class="keyword">typeof</span> EnhancedComponent.staticMethod === <span class="string">&#x27;undefined&#x27;</span> <span class="comment">// true</span></span><br><span class="line">æ‰€ä»¥å¿…é¡»å°†é™æ€æ–¹æ³•åšæ‹·è´ï¼š</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HigherOrderComponent</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Enhance</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿…é¡»å¾—çŸ¥é“è¦æ‹·è´çš„æ–¹æ³•</span></span><br><span class="line">    Enhance.staticMethod = WrappedComponent.staticMethod;</span><br><span class="line">    <span class="keyword">return</span> Enhance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä½†æ˜¯è¿™ä¹ˆåšçš„ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯å¿…é¡»çŸ¥é“è¦æ‹·è´çš„æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œä¸è¿‡</span><br><span class="line">React</span><br><span class="line">ç¤¾åŒºå®ç°äº†ä¸€ä¸ªåº“</span><br><span class="line">hoist - non - react - statics</span><br><span class="line">æ¥è‡ªåŠ¨å¤„ç†ï¼Œå®ƒä¼š</span><br><span class="line">è‡ªåŠ¨æ‹·è´æ‰€æœ‰é</span><br><span class="line">React</span><br><span class="line">çš„é™æ€æ–¹æ³•ï¼š</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hoistNonReactStatic <span class="keyword">from</span> <span class="string">&#x27;hoist-non-react-statics&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HigherOrderComponent</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Enhance</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hoistNonReactStatic(Enhance, WrappedComponent);</span><br><span class="line">    <span class="keyword">return</span> Enhance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="refs-å±æ€§ä¸èƒ½é€ä¼ "><a href="#refs-å±æ€§ä¸èƒ½é€ä¼ " class="headerlink" title="refs å±æ€§ä¸èƒ½é€ä¼ "></a>refs å±æ€§ä¸èƒ½é€ä¼ </h4><p>ä¸€èˆ¬æ¥è¯´é«˜é˜¶ç»„ä»¶å¯ä»¥ä¼ é€’æ‰€æœ‰çš„ props ç»™åŒ…è£¹çš„ç»„ä»¶<code>WrappedComponent</code>ï¼Œä½†æ˜¯æœ‰ä¸€ç§å±æ€§ä¸èƒ½ä¼ é€’ï¼Œå®ƒå°±æ˜¯ refã€‚ä¸å…¶ä»–å±æ€§ä¸åŒçš„åœ°æ–¹åœ¨äº React å¯¹å…¶è¿›è¡Œäº†ç‰¹æ®Šçš„å¤„ç†ã€‚</p>
<p>å¦‚æœä½ å‘ä¸€ä¸ªç”±é«˜é˜¶ç»„ä»¶åˆ›å»ºçš„ç»„ä»¶çš„å…ƒç´ æ·»åŠ  ref å¼•ç”¨ï¼Œé‚£ä¹ˆ ref æŒ‡å‘çš„æ˜¯æœ€å¤–å±‚å®¹å™¨ç»„ä»¶å®ä¾‹çš„ï¼Œè€Œä¸æ˜¯è¢«åŒ…è£¹çš„ <code>WrappedComponent</code>ç»„ä»¶ã€‚</p>
<p>ä¸è¿‡ï¼ŒReact ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåä¸º<code>React.forwardRef</code>çš„ API æ¥è§£å†³è¿™ä¸€é—®é¢˜ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      data: [],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;App&quot;</span>&gt;</span><br><span class="line">        &lt;h1&gt;Learn React&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">          &#123;<span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.state, <span class="literal">null</span>, <span class="number">2</span>)&#125;</span><br><span class="line">          &#123;<span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.props, <span class="literal">null</span>, <span class="number">2</span>)&#125;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withLogging</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Enhance</span> <span class="keyword">extends</span> <span class="title">WrappedComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">UNSAFE_componentWillReceiveProps</span>(<span class="params">nextProps</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Current props&quot;</span>, <span class="built_in">this</span>.props);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Next props&quot;</span>, nextProps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; forwardedRef, ...rest &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">      <span class="comment">// æŠŠ forwardedRef èµ‹å€¼ç»™ WrappedComponent çš„ ref</span></span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...rest</span>&#125; <span class="attr">ref</span>=<span class="string">&#123;forwardedRef&#125;</span> /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// React.forwardRef æ–¹æ³•ä¼šä¼ å…¥ props å’Œ ref ä¸¤ä¸ªå‚æ•°ç»™å…¶å›è°ƒå‡½æ•°</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥è¿™è¾¹çš„ ref æ˜¯ç”± React.forwardRef æä¾›çš„</span></span><br><span class="line">  <span class="keyword">return</span> React.forwardRef(<span class="function">(<span class="params">props, ref</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Enhance</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">data</span>=<span class="string">&#123;123&#125;</span> <span class="attr">forwardRef</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withLogging(App);</span><br></pre></td></tr></table></figure>

<h4 id="åå‘ç»§æ‰¿ä¸èƒ½ä¿è¯å®Œæ•´çš„å­ç»„ä»¶æ ‘è¢«è§£æ"><a href="#åå‘ç»§æ‰¿ä¸èƒ½ä¿è¯å®Œæ•´çš„å­ç»„ä»¶æ ‘è¢«è§£æ" class="headerlink" title="åå‘ç»§æ‰¿ä¸èƒ½ä¿è¯å®Œæ•´çš„å­ç»„ä»¶æ ‘è¢«è§£æ"></a>åå‘ç»§æ‰¿ä¸èƒ½ä¿è¯å®Œæ•´çš„å­ç»„ä»¶æ ‘è¢«è§£æ</h4><p>React ç»„ä»¶æœ‰ä¸¤ç§å½¢å¼ï¼Œåˆ†åˆ«æ˜¯ class ç±»å‹å’Œ function ç±»å‹</p>
<p>æˆ‘ä»¬çŸ¥é“åå‘ç»§æ‰¿çš„æ¸²æŸ“åŠ«æŒå¯ä»¥æ§åˆ¶<code>WrappedComponent </code>çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥å¯¹ elements treeã€stateã€props æˆ– render() çš„ç»“æœåšå„ç§æ“ä½œ</p>
<p>å¦‚æœæ¸²æŸ“ elements tree ä¸­åŒ…å«äº† function ç±»å‹çš„ç»„ä»¶çš„è¯ï¼Œè¿™æ—¶å€™å°±ä¸èƒ½æ“ä½œç»„ä»¶çš„å­ç»„ä»¶äº†</p>
<h3 id="é«˜é˜¶ç»„ä»¶çš„çº¦å®š"><a href="#é«˜é˜¶ç»„ä»¶çš„çº¦å®š" class="headerlink" title="é«˜é˜¶ç»„ä»¶çš„çº¦å®š"></a>é«˜é˜¶ç»„ä»¶çš„çº¦å®š</h3><p>é«˜é˜¶ç»„ä»¶å¸¦ç»™æˆ‘ä»¬æå¤§æ–¹ä¾¿çš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦éµå¾ªä¸€äº› çº¦å®šï¼š</p>
<h4 id="props-ä¿æŒä¸€è‡´"><a href="#props-ä¿æŒä¸€è‡´" class="headerlink" title="props ä¿æŒä¸€è‡´"></a>props ä¿æŒä¸€è‡´</h4><p>é«˜é˜¶ç»„ä»¶åœ¨ä¸ºå­ç»„ä»¶æ·»åŠ ç‰¹æ€§çš„åŒæ—¶ï¼Œè¦å°½é‡ä¿æŒåŸæœ‰ç»„ä»¶çš„ props ä¸å—å½±å“ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ å…¥çš„ç»„ä»¶å’Œè¿”å›çš„ç»„ä»¶åœ¨ props ä¸Šå°½é‡ä¿æŒä¸€è‡´ã€‚</p>
<p>ä¸è¦æ”¹å˜åŸå§‹ç»„ä»¶<code>WrappedComponent</code><br>ä¸è¦åœ¨é«˜é˜¶ç»„ä»¶å†…ä»¥ä»»ä½•æ–¹å¼ä¿®æ”¹ä¸€ä¸ªç»„ä»¶çš„åŸå‹ï¼Œæ€è€ƒä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withLogging</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  WrappedComponent.prototype.componentWillReceiveProps = <span class="function"><span class="keyword">function</span> (<span class="params">nextProps</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Current props&quot;</span>, <span class="built_in">this</span>.props);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Next props&quot;</span>, nextProps);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> WrappedComponent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EnhancedComponent = withLogging(SomeComponent);</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç°åœ¨é«˜é˜¶ç»„ä»¶çš„å†…éƒ¨å¯¹ <code>WrappedComponent</code>è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¸€æ—¦å¯¹åŸç»„ä»¶è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å¤±å»äº†ç»„ä»¶å¤ç”¨çš„æ„ä¹‰ï¼Œæ‰€ä»¥è¯·é€šè¿‡ çº¯å‡½æ•°ï¼ˆç›¸åŒçš„è¾“å…¥æ€»æœ‰ç›¸åŒçš„è¾“å‡ºï¼‰ è¿”å›æ–°çš„ç»„ä»¶ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withLogging</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">componentWillReceiveProps</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Current props&quot;</span>, <span class="built_in">this</span>.props);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Next props&quot;</span>, nextProps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="comment">// é€ä¼ å‚æ•°ï¼Œä¸è¦ä¿®æ”¹å®ƒ</span></span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä¼˜åŒ–ä¹‹åçš„<code>withLogging </code>æ˜¯ä¸€ä¸ª çº¯å‡½æ•°ï¼Œå¹¶ä¸ä¼šä¿®æ”¹ <code>WrappedComponent</code>ç»„ä»¶ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒæœ‰ä»€ä¹ˆå‰¯ä½œç”¨ï¼Œè¿›è€Œè¾¾åˆ°ç»„ä»¶å¤ç”¨çš„ç›®çš„ã€‚</p>
<h4 id="é€ä¼ ä¸ç›¸å…³-props-å±æ€§ç»™è¢«åŒ…è£¹çš„ç»„ä»¶-WrappedComponent"><a href="#é€ä¼ ä¸ç›¸å…³-props-å±æ€§ç»™è¢«åŒ…è£¹çš„ç»„ä»¶-WrappedComponent" class="headerlink" title="é€ä¼ ä¸ç›¸å…³ props å±æ€§ç»™è¢«åŒ…è£¹çš„ç»„ä»¶ WrappedComponent"></a>é€ä¼ ä¸ç›¸å…³ props å±æ€§ç»™è¢«åŒ…è£¹çš„ç»„ä»¶ <code>WrappedComponent</code></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HigherOrderComponent</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¸è¦åœ¨-render-æ–¹æ³•ä¸­ä½¿ç”¨é«˜é˜¶ç»„ä»¶"><a href="#ä¸è¦åœ¨-render-æ–¹æ³•ä¸­ä½¿ç”¨é«˜é˜¶ç»„ä»¶" class="headerlink" title="ä¸è¦åœ¨ render() æ–¹æ³•ä¸­ä½¿ç”¨é«˜é˜¶ç»„ä»¶"></a>ä¸è¦åœ¨ render() æ–¹æ³•ä¸­ä½¿ç”¨é«˜é˜¶ç»„ä»¶</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨é«˜é˜¶å‡½æ•°çš„æ—¶å€™æ¯æ¬¡éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">const</span> EnchancedComponent = enhance(WrappedComponent);</span><br><span class="line">    <span class="comment">// æ¯æ¬¡ render çš„æ—¶å€™ï¼Œéƒ½ä¼šä½¿å­å¯¹è±¡æ ‘å®Œå…¨è¢«å¸è½½å’Œé‡æ–°</span></span><br><span class="line">    <span class="comment">// é‡æ–°åŠ è½½ä¸€ä¸ªç»„ä»¶ä¼šå¼•èµ·åŸæœ‰ç»„ä»¶çš„çŠ¶æ€å’Œå®ƒçš„æ‰€æœ‰å­ç»„ä»¶ä¸¢å¤±</span></span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">EnchancedComponent</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä½¿ç”¨-compose-ç»„åˆé«˜é˜¶ç»„ä»¶"><a href="#ä½¿ç”¨-compose-ç»„åˆé«˜é˜¶ç»„ä»¶" class="headerlink" title="ä½¿ç”¨ compose ç»„åˆé«˜é˜¶ç»„ä»¶"></a>ä½¿ç”¨ compose ç»„åˆé«˜é˜¶ç»„ä»¶</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸è¦è¿™ä¹ˆä½¿ç”¨</span></span><br><span class="line"><span class="keyword">const</span> EnhancedComponent = withRouter(connect(commentSelector)(WrappedComponent))ï¼›</span><br><span class="line"><span class="comment">// å¯ä»¥ä½¿ç”¨ä¸€ä¸ª compose å‡½æ•°ç»„åˆè¿™äº›é«˜é˜¶ç»„ä»¶</span></span><br><span class="line"><span class="comment">// lodash, redux, ramda ç­‰ç¬¬ä¸‰æ–¹åº“éƒ½æä¾›äº†ç±»ä¼¼ `compose` åŠŸèƒ½çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> enhance = compose(withRouter, connect(commentSelector))ï¼›</span><br><span class="line"><span class="keyword">const</span> EnhancedComponent = enhance(WrappedComponent)ï¼›</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæŒ‰ç…§ çº¦å®š å®ç°çš„é«˜é˜¶ç»„ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œå¦‚æœå¤šä¸ªå‡½æ•°çš„å‚æ•°ä¸€æ ·ï¼Œæ‰€ä»¥å°±å¯ä»¥é€šè¿‡ compose æ–¹æ³•æ¥ç»„åˆè¿™äº›å‡½æ•°ã€‚</p>
<p>ä½¿ç”¨ compose ç»„åˆé«˜é˜¶ç»„ä»¶ä½¿ç”¨ï¼Œå¯ä»¥æ˜¾è‘—æé«˜ä»£ç çš„å¯è¯»æ€§å’Œé€»è¾‘çš„æ¸…æ™°åº¦ã€‚ åŒ…è£…æ˜¾ç¤ºåå­—ä»¥ä¾¿äºè°ƒè¯• é«˜é˜¶ç»„ä»¶åˆ›å»ºçš„å®¹å™¨ç»„ä»¶åœ¨ React Developer Tools ä¸­çš„è¡¨ç°å’Œå…¶å®ƒçš„æ™®é€šç»„ä»¶æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>ä¸ºäº†ä¾¿äºè°ƒè¯•ï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªæ˜¾ç¤ºåå­—ï¼Œä¼ è¾¾å®ƒæ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶çš„ç»“æœã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> getDisplayName = <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span></span><br><span class="line">  WrappedComponent.displayName || WrappedComponent.name || <span class="string">&quot;Component&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HigherOrderComponent</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">HigherOrderComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  HigherOrderComponent.displayName = <span class="string">`HigherOrderComponent(<span class="subst">$&#123;getDisplayName(</span></span></span><br><span class="line"><span class="string"><span class="subst">    WrappedComponent</span></span></span><br><span class="line"><span class="string"><span class="subst">  )&#125;</span>)`</span>;</span><br><span class="line">  <span class="keyword">return</span> HigherOrderComponent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é«˜é˜¶ç»„ä»¶çš„åº”ç”¨åœºæ™¯"><a href="#é«˜é˜¶ç»„ä»¶çš„åº”ç”¨åœºæ™¯" class="headerlink" title="é«˜é˜¶ç»„ä»¶çš„åº”ç”¨åœºæ™¯"></a>é«˜é˜¶ç»„ä»¶çš„åº”ç”¨åœºæ™¯</h3><h4 id="æƒé™æ§åˆ¶"><a href="#æƒé™æ§åˆ¶" class="headerlink" title="æƒé™æ§åˆ¶"></a>æƒé™æ§åˆ¶</h4><p>åˆ©ç”¨é«˜é˜¶ç»„ä»¶çš„<strong>æ¡ä»¶æ¸²æŸ“</strong> ç‰¹æ€§å¯ä»¥å¯¹é¡µé¢è¿›è¡Œæƒé™æ§åˆ¶ï¼Œæƒé™æ§åˆ¶ä¸€èˆ¬åˆ†ä¸ºä¸¤ä¸ªç»´åº¦ï¼š<strong>é¡µé¢çº§åˆ«</strong> å’Œ<strong>é¡µé¢å…ƒç´ çº§åˆ«</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// HOC.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultMessageMap = &#123;</span><br><span class="line">    <span class="string">&#x27;Admin&#x27;</span>: <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹è¯¥é¡µé¢ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>,</span><br><span class="line">    <span class="string">&#x27;VIP&#x27;</span>: <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>æ‚¨æœªè´­ä¹°è¯¥æ¨¡å—ï¼Œè¯·è”ç³»é”€å”®è¯•ç”¨ï¼<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>,</span><br><span class="line">    <span class="string">&#x27;&#x27;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æƒé™æ§åˆ¶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">role</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> withAuth = <span class="function"><span class="params">role</span> =&gt;</span> <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">        state = &#123;</span><br><span class="line">            auth: <span class="literal">false</span>,</span><br><span class="line">            role: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">async</span> <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> &#123;<span class="attr">role</span>: currentRole&#125; = <span class="keyword">await</span> fetch(<span class="string">&#x27;//localhost:9090/userInfo&#x27;</span>).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">                <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                    auth: currentRole === role,</span><br><span class="line">                    role: currentRole</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                    auth: <span class="literal">false</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.state.auth) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span></span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> defaultMessageMap[<span class="built_in">this</span>.state.role]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withAuth</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageA.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> withAuth <span class="keyword">from</span> <span class="string">&quot;../HOC&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡ç†å‘˜ä¸“ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageA</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;ç®¡ç†å‘˜ä¸“ç”¨&lt;/h2&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withAuth(<span class="string">&#x27;Admin&#x27;</span>)(PageA);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageB.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> withAuth <span class="keyword">from</span> <span class="string">&quot;../HOC&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VIPä¸“ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageB</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;VIPä¸“ç”¨&lt;/h2&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withAuth(<span class="string">&#x27;VIP&#x27;</span>)(PageB);</span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageC.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> withAuth <span class="keyword">from</span> <span class="string">&quot;../HOC&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ™®é€šç”¨æˆ·ä½¿ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageC</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;æ™®é€šç”¨æˆ·ä½¿ç”¨&lt;/h2&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PageC;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ç»„ä»¶æ¸²æŸ“æ€§èƒ½è¿½è¸ª"><a href="#ç»„ä»¶æ¸²æŸ“æ€§èƒ½è¿½è¸ª" class="headerlink" title="ç»„ä»¶æ¸²æŸ“æ€§èƒ½è¿½è¸ª"></a>ç»„ä»¶æ¸²æŸ“æ€§èƒ½è¿½è¸ª</h4><p>å€ŸåŠ©çˆ¶ç»„ä»¶å­ç»„ä»¶ç”Ÿå‘½å‘¨æœŸè§„åˆ™æ•è·å­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥æ–¹ä¾¿çš„å¯¹æŸä¸ªç»„ä»¶çš„æ¸²æŸ“æ—¶é—´è¿›è¡Œè®°å½•</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ©ç”¨ã€åå‘ç»§æ‰¿ã€‘å®ç°çš„ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼ŒåŠŸèƒ½æ˜¯è®¡ç®—è¢«åŒ…è£¹ç»„ä»¶çš„æ¸²æŸ“æ—¶é—´</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">WrappedComponent</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withTiming</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">WrappedComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(props);</span><br><span class="line">      <span class="built_in">this</span>.start = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">this</span>.end = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.UNSAFE_componentWillMount &amp;&amp; <span class="built_in">super</span>.UNSAFE_componentWillMount();</span><br><span class="line">      <span class="built_in">this</span>.start = <span class="built_in">Date</span>.now();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.componentDidMount &amp;&amp; <span class="built_in">super</span>.componentDidMount();</span><br><span class="line">      <span class="built_in">this</span>.end = <span class="built_in">Date</span>.now();</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;WrappedComponent.name&#125;</span> ç»„ä»¶æ¸²æŸ“æ—¶é—´ä¸º <span class="subst">$&#123;<span class="built_in">this</span>.end - <span class="built_in">this</span>.start&#125;</span> ms`</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">super</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;App&quot;</span>&gt;</span><br><span class="line">        &lt;h1&gt;Learn React&lt;/h1&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withTiming(App);</span><br></pre></td></tr></table></figure>

<h4 id="é¡µé¢å¤ç”¨"><a href="#é¡µé¢å¤ç”¨" class="headerlink" title="é¡µé¢å¤ç”¨"></a>é¡µé¢å¤ç”¨</h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªé¡µé¢ <code>pageA</code>ï¼Œ<code> pageB</code>ï¼Œ<code>pageC</code> åˆ†åˆ«æ¸²æŸ“<code>usersåˆ—è¡¨</code>ï¼Œ<code>postsåˆ—è¡¨</code>, <code>commentsåˆ—è¡¨</code>ï¼Œæ™®é€šå†™æ³•å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/PageA.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * usersåˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageA</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            data: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> fetch(<span class="string">&#x27;https://jsonplaceholder.typicode.com/users?id_lte=10&#x27;</span>).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;data&#125;)</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;<span class="attr">data</span>: []&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;data&#125; = <span class="built_in">this</span>.state;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;usersåˆ—è¡¨&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">                &lt;pre&gt; &#123;<span class="built_in">JSON</span>.stringify(data, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PageA;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageB.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * postsåˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageB</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            data: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> fetch(<span class="string">&#x27;https://jsonplaceholder.typicode.com/posts?id_lte=10&#x27;</span>).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;data&#125;)</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;<span class="attr">data</span>: []&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;data&#125; = <span class="built_in">this</span>.state;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;postsåˆ—è¡¨&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">                &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(data, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PageB;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageC</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * comments åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageC</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            data: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> fetch(<span class="string">&#x27;https://jsonplaceholder.typicode.com/comments?id_lte=10&#x27;</span>).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;data&#125;)</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;<span class="attr">data</span>: []&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;data&#125; = <span class="built_in">this</span>.state;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;commentsåˆ—è¡¨&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">                &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(data, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PageC;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é¡µé¢å°‘çš„æ—¶å€™å¯èƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å‡å¦‚éšç€ä¸šåŠ¡çš„è¿›å±•ï¼Œåœ¨è¿™ä¸ªé¡µé¢å±•ç¤ºæ›´å¤šç±»å‹çš„æ•°æ®ï¼Œå°±ä¼šå†™å¾ˆå¤šçš„é‡å¤ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡æ„ä¸€ä¸‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// HOC.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> withFetching = <span class="function"><span class="params">fetchingFunc</span> =&gt;</span> <span class="function"><span class="params">WrappedComponent</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">        state = &#123;</span><br><span class="line">            data: [],</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">async</span> <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> data = <span class="keyword">await</span> fetchingFunc();</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;data&#x27;</span>, data)</span><br><span class="line">                <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                    data,</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.setState(&#123;<span class="attr">data</span>: []&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> <span class="attr">data</span>=<span class="string">&#123;this.state.data&#125;</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withFetching</span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageA.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> withFetching <span class="keyword">from</span> <span class="string">&quot;../HOC&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * usersåˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageA</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// constructor(props) &#123;</span></span><br><span class="line">    <span class="comment">//     super(props);</span></span><br><span class="line">    <span class="comment">//     this.state = &#123;</span></span><br><span class="line">    <span class="comment">//         data: []</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// async componentDidMount() &#123;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         const data = await fetch(&#x27;https://jsonplaceholder.typicode.com/users?id_lte=10&#x27;).then(response =&gt; response.json())</span></span><br><span class="line">    <span class="comment">//         this.setState(&#123;data&#125;)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     &#125; catch &#123;</span></span><br><span class="line">    <span class="comment">//         this.setState(&#123;data: []&#125;)</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// const &#123;data&#125; = this.state;</span></span><br><span class="line">        <span class="keyword">const</span> &#123;data&#125; = <span class="built_in">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;usersåˆ—è¡¨&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">                &lt;pre&gt; &#123;<span class="built_in">JSON</span>.stringify(data, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export default PageA;</span></span><br><span class="line"><span class="keyword">const</span> fetchingFunc = <span class="function">() =&gt;</span> fetch(<span class="string">&#x27;https://jsonplaceholder.typicode.com/users?id_lte=10&#x27;</span>).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withFetching(fetchingFunc)(PageA);</span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageB.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> withFetching <span class="keyword">from</span> <span class="string">&quot;../HOC&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * postsåˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageB</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// const &#123;data&#125; = this.state;</span></span><br><span class="line">        <span class="keyword">const</span> &#123;data&#125; = <span class="built_in">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;postsåˆ—è¡¨&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">                &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(data, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export default PageB;</span></span><br><span class="line"><span class="keyword">const</span> fetchingFunc = <span class="function">() =&gt;</span> fetch(<span class="string">&#x27;https://jsonplaceholder.typicode.com/posts?id_lte=10&#x27;</span>).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withFetching(fetchingFunc)(PageB);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// pages/PageC.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> withFetching <span class="keyword">from</span> <span class="string">&quot;../HOC&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * comments åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageC</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// constructor(props) &#123;</span></span><br><span class="line">    <span class="comment">//     super(props);</span></span><br><span class="line">    <span class="comment">//     this.state = &#123;</span></span><br><span class="line">    <span class="comment">//         data: []</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// async componentDidMount() &#123;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         const data = await fetch(&#x27;https://jsonplaceholder.typicode.com/comments?id_lte=10&#x27;).then(response =&gt; response.json())</span></span><br><span class="line">    <span class="comment">//         this.setState(&#123;data&#125;)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     &#125; catch &#123;</span></span><br><span class="line">    <span class="comment">//         this.setState(&#123;data: []&#125;)</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// const &#123;data&#125; = this.state;</span></span><br><span class="line">        <span class="keyword">const</span> &#123;data&#125; = <span class="built_in">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h2&gt;commentsåˆ—è¡¨&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">                &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(data, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export default PageC;</span></span><br><span class="line"><span class="keyword">const</span> fetchingFunc = <span class="function">() =&gt;</span> fetch(<span class="string">&#x27;https://jsonplaceholder.typicode.com/comments?id_lte=10&#x27;</span>).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withFetching(fetchingFunc)(PageC);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="æ•°æ®æ ¡éªŒ"><a href="#æ•°æ®æ ¡éªŒ" class="headerlink" title="æ•°æ®æ ¡éªŒ"></a>æ•°æ®æ ¡éªŒ</h4><h4 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h4><h4 id="ç»Ÿè®¡ä¸ŠæŠ¥"><a href="#ç»Ÿè®¡ä¸ŠæŠ¥" class="headerlink" title="ç»Ÿè®¡ä¸ŠæŠ¥"></a>ç»Ÿè®¡ä¸ŠæŠ¥</h4><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li>é«˜é˜¶ç»„ä»¶ ä¸æ˜¯ç»„ä»¶ï¼Œæ˜¯ ä¸€ä¸ªæŠŠæŸä¸ªç»„ä»¶è½¬æ¢æˆå¦ä¸€ä¸ªç»„ä»¶çš„ å‡½æ•°</li>
<li>é«˜é˜¶ç»„ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯ ä»£ç å¤ç”¨</li>
<li>é«˜é˜¶ç»„ä»¶æ˜¯ è£…é¥°å™¨æ¨¡å¼åœ¨ React ä¸­çš„å®ç°</li>
</ol>
]]></content>
      <categories>
        <category>UIæ¡†æ¶</category>
      </categories>
  </entry>
  <entry>
    <title>è§£æ webpack æ ¸å¿ƒâ€”â€”Babel åŸç†</title>
    <url>/bloger/2020/12/07/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/%E8%A7%A3%E6%9E%90%20webpack%20%E6%A0%B8%E5%BF%83%E2%80%94%E2%80%94Babel%20%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h1 id="è§£æ-webpack-æ ¸å¿ƒâ€”â€”Babel-åŸç†"><a href="#è§£æ-webpack-æ ¸å¿ƒâ€”â€”Babel-åŸç†" class="headerlink" title="è§£æ webpack æ ¸å¿ƒâ€”â€”Babel åŸç†"></a>è§£æ webpack æ ¸å¿ƒâ€”â€”Babel åŸç†</h1><h2 id="Babel-åšäº†ä»€ä¹ˆï¼Œæ€ä¹ˆåšçš„ï¼Ÿ"><a href="#Babel-åšäº†ä»€ä¹ˆï¼Œæ€ä¹ˆåšçš„ï¼Ÿ" class="headerlink" title="Babel åšäº†ä»€ä¹ˆï¼Œæ€ä¹ˆåšçš„ï¼Ÿ"></a>Babel åšäº†ä»€ä¹ˆï¼Œæ€ä¹ˆåšçš„ï¼Ÿ</h2><ul>
<li><p>Babel å°† ESNextCode ä»£ç è½¬æ¢æˆäº†æµè§ˆå™¨å…¼å®¹çš„ ES5Code</p>
</li>
<li><p>å…¶è¿‡ç¨‹(code â€“(1)-&gt; ast â€“(2)-&gt; ast2 â€“(3)-&gt; code2)</p>
<ul>
<li><p>parse: æŠŠä»£ç  ESNextCode å˜æˆ AST</p>
</li>
<li><p>traverse: éå† AST è¿›è¡Œä¿®æ”¹å¾—åˆ° AST2</p>
</li>
<li><p>generate: æŠŠ AST2 å˜æˆä»£ç  ES5Code</p>
</li>
</ul>
</li>
<li><p>ç¤ºä¾‹<code>let_to_var.ts</code></p>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿è¡Œ node -r ts-node/register --inspect-brk let_to_var.ts æµè§ˆå™¨Nodeé‡Œé¢çœ‹ä¸‹æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`let a = &#x27;let&#x27;; let b = 2`</span>;</span><br><span class="line"><span class="comment">// Step1 parse  æŠŠä»£ç codeå˜æˆAST</span></span><br><span class="line"><span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// console.log(&#x27;ast&#x27;, ast)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step2 traverse  éå†ASTè¿›è¡Œä¿®æ”¹</span></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  enter: <span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item.node.type === <span class="string">&quot;VariableDeclaration&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (item.node.kind === <span class="string">&quot;let&quot;</span>) &#123;</span><br><span class="line">        item.node.kind = <span class="string">&quot;var&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step3 generate  æŠŠASTä»£ç å˜æˆcode2</span></span><br><span class="line"><span class="keyword">const</span> result = generate(ast, &#123;&#125;, code);</span><br><span class="line"><span class="comment">// console.log(result.code);</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ<code>node -r ts-node/register --inspect-brk let_to_var.ts</code><br><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/webpack-1.png" alt="bash"><br><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/webpack-2.png" alt="Node Debugger"><br>æœ€ç»ˆç»“æœï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// letè½¬ä¸ºäº†varï¼Œè¿˜ç»™ä»£ç åŠ äº†åˆ†å·</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&quot;let&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸ºä»€ä¹ˆéå¾—ä½¿ç”¨-AST"><a href="#ä¸ºä»€ä¹ˆéå¾—ä½¿ç”¨-AST" class="headerlink" title="ä¸ºä»€ä¹ˆéå¾—ä½¿ç”¨ AST"></a>ä¸ºä»€ä¹ˆéå¾—ä½¿ç”¨ AST</h2><ul>
<li><p>ä½ å¾ˆéš¾ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æ›¿æ¢ï¼Œæ­£åˆ™å¾ˆå®¹æ˜“æŠŠ let a = â€˜letâ€™ å˜æˆ var a = â€˜varâ€™</p>
</li>
<li><p>ä½ éœ€è¦è¯†åˆ«æ¯ä¸ªå•è¯çš„æ„æ€ï¼Œæ‰èƒ½åšåˆ°åªä¿®æ”¹ç”¨äºå£°æ˜å˜é‡çš„ letï¼Œè€Œ AST èƒ½æ˜ç¡®åœ°å‘Šè¯‰ä½ æ¯ä¸ª let çš„æ„æ€</p>
</li>
</ul>
<h2 id="èƒ½ä¸èƒ½è‡ªåŠ¨æŠŠä»£ç è½¬ä¸º-ES5Code-å¹¶å•ç‹¬æ–‡ä»¶è¾“å‡ºï¼Ÿ"><a href="#èƒ½ä¸èƒ½è‡ªåŠ¨æŠŠä»£ç è½¬ä¸º-ES5Code-å¹¶å•ç‹¬æ–‡ä»¶è¾“å‡ºï¼Ÿ" class="headerlink" title="èƒ½ä¸èƒ½è‡ªåŠ¨æŠŠä»£ç è½¬ä¸º ES5Code å¹¶å•ç‹¬æ–‡ä»¶è¾“å‡ºï¼Ÿ"></a>èƒ½ä¸èƒ½è‡ªåŠ¨æŠŠä»£ç è½¬ä¸º ES5Code å¹¶å•ç‹¬æ–‡ä»¶è¾“å‡ºï¼Ÿ</h2><ul>
<li><p>ä½¿ç”¨ <code>@babel/core</code> å’Œ <code>@babel/preset-env</code> å³å¯</p>
</li>
<li><p>ä»£ç å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="keyword">let</span> a = <span class="string">&quot;let&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> c = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">var</span> set = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(set);</span><br><span class="line"></span><br><span class="line"><span class="comment">// file_to_es5.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> babel <span class="keyword">from</span> <span class="string">&quot;@babel/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&quot;./test.js&quot;</span>).toString();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">babel</span><br><span class="line">  .transformFromAstAsync(ast, code, &#123;</span><br><span class="line">    presets: [</span><br><span class="line">      <span class="comment">// æ³¨æ„æ­¤å¤„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœæœ‰optionsçš„è¯</span></span><br><span class="line">      <span class="comment">// useBuiltInsæœ‰ä¸‰ç§é€‰é¡¹ï¼šusage entry false</span></span><br><span class="line">      <span class="comment">// å…·ä½“å‚è€ƒï¼šhttps://babel.docschina.org/docs/en/6.26.3/babel-polyfill/</span></span><br><span class="line">      [<span class="string">&quot;@babel/preset-env&quot;</span>, &#123; <span class="attr">useBuiltIns</span>: <span class="string">&quot;usage&quot;</span>, <span class="attr">corejs</span>: <span class="number">2</span> &#125;],</span><br><span class="line">    ],</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">&#123; code &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    fs.writeFileSync(<span class="string">&quot;./test.es5.js&quot;</span>, code);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node -r ts-node/register file_to_es5.ts</code>ç”Ÿæˆæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test.es5.js</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/web.dom.iterable&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es6.array.iterator&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es6.object.to-string&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es6.string.iterator&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es6.set&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&quot;let&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">var</span> set = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(set);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šBabel é»˜è®¤åªè½¬æ¢æ–°çš„ JavaScript è¯­æ³•ï¼Œè€Œä¸è½¬æ¢æ–°çš„ APIã€‚ ä¾‹å¦‚ï¼ŒIteratorã€Generatorã€Setã€Mapsã€Proxyã€Reflectã€Symbolã€Promise ç­‰å…¨å±€å¯¹è±¡ï¼Œä»¥åŠä¸€äº›å®šä¹‰åœ¨å…¨å±€å¯¹è±¡ä¸Šçš„æ–¹æ³•ï¼ˆæ¯”å¦‚ Object.assignï¼‰éƒ½ä¸ä¼šè½¬è¯‘ã€‚ å¦‚æœæƒ³ä½¿ç”¨è¿™äº›æ–°çš„å¯¹è±¡å’Œæ–¹æ³•ï¼Œåˆ™éœ€è¦ä¸ºå½“å‰ç¯å¢ƒæä¾›ä¸€ä¸ª polyfill<br>å…·ä½“ï¼š<code>yarn add babel-polyfill core-js@2</code></p>
</blockquote>
<h2 id="Babel-è¿˜åšäº†ä»€ä¹ˆ"><a href="#Babel-è¿˜åšäº†ä»€ä¹ˆ" class="headerlink" title="Babel è¿˜åšäº†ä»€ä¹ˆ?"></a>Babel è¿˜åšäº†ä»€ä¹ˆ?</h2><blockquote>
<p>åˆ†æ JS æ–‡ä»¶çš„ä¾èµ–å…³ç³»</p>
</blockquote>
<ul>
<li>ç®€å•ä¾èµ–<code>project_1</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// deps_1.ts</span></span><br><span class="line"><span class="comment">// è¯·ç¡®ä¿ä½ çš„ Node ç‰ˆæœ¬å¤§äºç­‰äº 14</span></span><br><span class="line"><span class="comment">// è¯·å…ˆè¿è¡Œ yarn æˆ– npm i æ¥å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ node -r ts-node/register æ–‡ä»¶è·¯å¾„ æ¥è¿è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥åŠ ä¸€ä¸ªé€‰é¡¹ --inspect-brkï¼Œå†æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡» Node å›¾æ ‡å³å¯è°ƒè¯•</span></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&#x27;@babel/parser&#x27;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&#x27;@babel/traverse&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; readFileSync &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve, relative, dirname &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ ¹ç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> projectRoot = resolve(__dirname, <span class="string">&#x27;project_1&#x27;</span>)</span><br><span class="line"><span class="comment">// ç±»å‹å£°æ˜</span></span><br><span class="line">type DepRelation = &#123; [key: string]: &#123; <span class="attr">deps</span>: string[], <span class="attr">code</span>: string &#125; &#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ depRelationï¼Œç”¨äºæ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> depRelation: DepRelation = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¼ å…¥å‡½æ•°ï¼Œå¦‚ D:\demo\fixture_1\index.js</span></span><br><span class="line">collectCodeAndDeps(resolve(projectRoot, <span class="string">&#x27;index.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(depRelation)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">collectCodeAndDeps</span>(<span class="params">filepath: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = getProjectPath(filepath) <span class="comment">// æ–‡ä»¶çš„é¡¹ç›®è·¯å¾„ï¼Œå¦‚ index.js</span></span><br><span class="line">  <span class="comment">// è·å–æ–‡ä»¶å†…å®¹ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  <span class="keyword">const</span> code = readFileSync(filepath).toString()</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– depRelation[key]</span></span><br><span class="line">  depRelation[key] = &#123; <span class="attr">deps</span>: [], <span class="attr">code</span>: code &#125;</span><br><span class="line">  <span class="comment">// å°†ä»£ç è½¬ä¸º AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span> &#125;)</span><br><span class="line">  <span class="comment">// åˆ†ææ–‡ä»¶ä¾èµ–ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    enter: <span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (path.node.type === <span class="string">&#x27;ImportDeclaration&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// path.node.source.value å¾€å¾€æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œå¦‚ ./a.jsï¼Œéœ€è¦å…ˆæŠŠå®ƒè½¬ä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depAbsolutePath = resolve(dirname(filepath), path.node.source.value)</span><br><span class="line">        <span class="comment">// ç„¶åè½¬ä¸ºé¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depProjectPath = getProjectPath(depAbsolutePath)</span><br><span class="line">        <span class="comment">// æŠŠä¾èµ–å†™è¿› depRelation</span></span><br><span class="line">        depRelation[key].deps.push(depProjectPath)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ–‡ä»¶ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProjectPath</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> relative(projectRoot, path).replace(<span class="regexp">/\\/g</span>, <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_1/a.js</span></span><br><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">  value: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_1/b.js</span></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">  value: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_1/index.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a.value + b.value)</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node -r ts-node/register deps_1.ts</code>ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;index.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span>, <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a from &#x27;./a.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&quot;import b from &#x27;./b.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;console.log(a.value + b.value)&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>åµŒå¥—ä¾èµ–<code>project_2</code><br>ç›®å½•ç»“æ„å¦‚å›¾ï¼š<br><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/webpack-3.png" alt="æ–‡ä»¶ç›®å½•"></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// deps_2.ts</span></span><br><span class="line"><span class="comment">// è¯·ç¡®ä¿ä½ çš„ Node ç‰ˆæœ¬å¤§äºç­‰äº 14</span></span><br><span class="line"><span class="comment">// è¯·å…ˆè¿è¡Œ yarn æˆ– npm i æ¥å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ node -r ts-node/register æ–‡ä»¶è·¯å¾„ æ¥è¿è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥åŠ ä¸€ä¸ªé€‰é¡¹ --inspect-brkï¼Œå†æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡» Node å›¾æ ‡å³å¯è°ƒè¯•</span></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&#x27;@babel/parser&#x27;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&#x27;@babel/traverse&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; readFileSync &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve, relative, dirname &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ ¹ç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> projectRoot = resolve(__dirname, <span class="string">&#x27;project_2&#x27;</span>)</span><br><span class="line"><span class="comment">// ç±»å‹å£°æ˜</span></span><br><span class="line">type DepRelation = &#123; [key: string]: &#123; <span class="attr">deps</span>: string[], <span class="attr">code</span>: string &#125; &#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ depRelationï¼Œç”¨äºæ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> depRelation: DepRelation = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¼ å…¥å‡½æ•°ï¼Œå¦‚ D:\demo\fixture_1\index.js</span></span><br><span class="line">collectCodeAndDeps(resolve(projectRoot, <span class="string">&#x27;index.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(depRelation)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">collectCodeAndDeps</span>(<span class="params">filepath: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = getProjectPath(filepath) <span class="comment">// æ–‡ä»¶çš„é¡¹ç›®è·¯å¾„ï¼Œå¦‚ index.js</span></span><br><span class="line">  <span class="comment">// è·å–æ–‡ä»¶å†…å®¹ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  <span class="keyword">const</span> code = readFileSync(filepath).toString()</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– depRelation[key]</span></span><br><span class="line">  depRelation[key] = &#123; <span class="attr">deps</span>: [], <span class="attr">code</span>: code &#125;</span><br><span class="line">  <span class="comment">// å°†ä»£ç è½¬ä¸º AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span> &#125;)</span><br><span class="line">  <span class="comment">// åˆ†ææ–‡ä»¶ä¾èµ–ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    enter: <span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (path.node.type === <span class="string">&#x27;ImportDeclaration&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// path.node.source.value å¾€å¾€æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œå¦‚ ./a.jsï¼Œéœ€è¦å…ˆæŠŠå®ƒè½¬ä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depAbsolutePath = resolve(dirname(filepath), path.node.source.value)</span><br><span class="line">        <span class="comment">// ç„¶åè½¬ä¸ºé¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depProjectPath = getProjectPath(depAbsolutePath)</span><br><span class="line">        <span class="comment">// æŠŠä¾èµ–å†™è¿› depRelation</span></span><br><span class="line">        depRelation[key].deps.push(depProjectPath)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note: ç›¸æ¯”äºdeps_1.tsåªåŠ äº†ä¸€è¡Œä»£ç   ç»§ç»­å¾€ä¸‹åˆ†æ  é€’å½’</span></span><br><span class="line">        collectCodeAndDeps(depAbsolutePath)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ–‡ä»¶ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProjectPath</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> relative(projectRoot, path).replace(<span class="regexp">/\\/g</span>, <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_2/index.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a.value + b.value)</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_2/a.js</span></span><br><span class="line"><span class="keyword">import</span> a2 <span class="keyword">from</span> <span class="string">&#x27;./dir/a2.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">  value: <span class="number">1</span>,</span><br><span class="line">  value2: a2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_2/b.js</span></span><br><span class="line"><span class="keyword">import</span> b2 <span class="keyword">from</span> <span class="string">&#x27;./dir/b2.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">  value: <span class="number">2</span>,</span><br><span class="line">  value2: b2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_2/dir/a2.js</span></span><br><span class="line"><span class="keyword">import</span> a3 <span class="keyword">from</span> <span class="string">&#x27;./dir_in_dir/a3.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> a2 = &#123;</span><br><span class="line">  value: <span class="number">12</span>,</span><br><span class="line">  value3: a3</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a2</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_2/dir/b2.js</span></span><br><span class="line"><span class="keyword">import</span> b3 <span class="keyword">from</span> <span class="string">&#x27;./dir_in_dir/b3.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b2 = &#123;</span><br><span class="line">  value: <span class="number">22</span>,</span><br><span class="line">  value3: b3</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b2</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_2/dir/dir_in_dir/a3.js</span></span><br><span class="line"><span class="keyword">const</span> a3 = &#123;</span><br><span class="line">  value: <span class="number">123</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a3</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_2/dir/dir_in_dir/b3.js</span></span><br><span class="line"><span class="keyword">const</span> b3 = &#123;</span><br><span class="line">  value: <span class="number">123</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node -r ts-node/register deps_2.ts</code>ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;index.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span>, <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a from &#x27;./a.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&quot;import b from &#x27;./b.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;console.log(a.value + b.value)&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;a.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;dir/a2.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a2 from &#x27;./dir/a2.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;const a = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: 1,\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value2: a2\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default a&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;dir/a2.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;dir/dir_in_dir/a3.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a3 from &#x27;./dir_in_dir/a3.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;const a2 = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: 12,\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value3: a3\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default a2&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;dir/dir_in_dir/a3.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [],</span><br><span class="line">    code: <span class="string">&#x27;const a3 = &#123;\r\n  value: 123\r\n&#125;\r\nexport default a3&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;b.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;dir/b2.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import b2 from &#x27;./dir/b2.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;const b = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: 2,\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value2: b2\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default b&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;dir/b2.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;dir/dir_in_dir/b3.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import b3 from &#x27;./dir_in_dir/b3.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;const b2 = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: 22,\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value3: b3\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default b2&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;dir/dir_in_dir/b3.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [],</span><br><span class="line">    code: <span class="string">&#x27;const b3 = &#123;\r\n  value: 123\r\n&#125;\r\nexport default b3&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>åµŒå¥—ä¾èµ–<code>project_3</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// project_3/index.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a.value + b.value)</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_3/a.js</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">  value: b.value + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_3/b.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">  value: a.value + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b</span><br><span class="line"></span><br><span class="line"><span class="comment">// deps_3.tsåŒdeps_2.ts</span></span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node -r ts-node/register deps_3.ts</code>æŠ¥é”™<code>RangeError: Maximum call stack size exceeded</code>è¯´æ˜å‡ºç°äº†å¾ªç¯åµŒå¥—</p>
<ul>
<li>åµŒå¥—ä¾èµ–è§£å†³<code>project_4</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// project_4æ–‡ä»¶åŒproject_3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// deps_4.ts</span></span><br><span class="line"><span class="comment">// è¯·ç¡®ä¿ä½ çš„ Node ç‰ˆæœ¬å¤§äºç­‰äº 14</span></span><br><span class="line"><span class="comment">// è¯·å…ˆè¿è¡Œ yarn æˆ– npm i æ¥å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ node -r ts-node/register æ–‡ä»¶è·¯å¾„ æ¥è¿è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥åŠ ä¸€ä¸ªé€‰é¡¹ --inspect-brkï¼Œå†æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡» Node å›¾æ ‡å³å¯è°ƒè¯•</span></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; readFileSync &#125; <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; resolve, relative, dirname &#125; <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ ¹ç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> projectRoot = resolve(__dirname, <span class="string">&quot;project_3&quot;</span>);</span><br><span class="line"><span class="comment">// ç±»å‹å£°æ˜</span></span><br><span class="line">type DepRelation = &#123; [key: string]: &#123; <span class="attr">deps</span>: string[], <span class="attr">code</span>: string &#125; &#125;;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ depRelationï¼Œç”¨äºæ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> depRelation: DepRelation = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¼ å…¥å‡½æ•°ï¼Œå¦‚ D:\demo\fixture_1\index.js</span></span><br><span class="line">collectCodeAndDeps(resolve(projectRoot, <span class="string">&quot;index.js&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(depRelation);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;done&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">collectCodeAndDeps</span>(<span class="params">filepath: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = getProjectPath(filepath); <span class="comment">// æ–‡ä»¶çš„é¡¹ç›®è·¯å¾„ï¼Œå¦‚ index.js</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: ç›¸æ¯”äºdeps_3.tsåªåŠ ä¸€è¡Œä»£ç   é¿å…å¾ªç¯ä¾èµ–</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.keys(depRelation).includes(key)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">`duplicated dependency: <span class="subst">$&#123;key&#125;</span>`</span>); <span class="comment">// æ³¨æ„ï¼Œé‡å¤ä¾èµ–ä¸ä¸€å®šæ˜¯å¾ªç¯ä¾èµ–</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–æ–‡ä»¶å†…å®¹ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  <span class="keyword">const</span> code = readFileSync(filepath).toString();</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– depRelation[key]</span></span><br><span class="line">  depRelation[key] = &#123; <span class="attr">deps</span>: [], <span class="attr">code</span>: code &#125;;</span><br><span class="line">  <span class="comment">// å°†ä»£ç è½¬ä¸º AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span> &#125;);</span><br><span class="line">  <span class="comment">// åˆ†ææ–‡ä»¶ä¾èµ–ï¼Œå°†å†…å®¹æ”¾è‡³ depRelation</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    enter: <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (path.node.type === <span class="string">&quot;ImportDeclaration&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// path.node.source.value å¾€å¾€æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œå¦‚ ./a.jsï¼Œéœ€è¦å…ˆæŠŠå®ƒè½¬ä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depAbsolutePath = resolve(</span><br><span class="line">          dirname(filepath),</span><br><span class="line">          path.node.source.value</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// ç„¶åè½¬ä¸ºé¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> depProjectPath = getProjectPath(depAbsolutePath);</span><br><span class="line">        <span class="comment">// æŠŠä¾èµ–å†™è¿› depRelation</span></span><br><span class="line">        depRelation[key].deps.push(depProjectPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note: ç›¸æ¯”äºdeps_1.tsåªåŠ äº†ä¸€è¡Œä»£ç   ç»§ç»­å¾€ä¸‹åˆ†æ  é€’å½’</span></span><br><span class="line">        collectCodeAndDeps(depAbsolutePath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ–‡ä»¶ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProjectPath</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> relative(projectRoot, path).replace(<span class="regexp">/\\/g</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node -r ts-node/register deps_4.ts</code>ç»“æœå¦‚ä¸‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">duplicated dependency: a.js</span><br><span class="line">duplicated dependency: b.js</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;index.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span>, <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a from &#x27;./a.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&quot;import b from &#x27;./b.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;console.log(a.value + b.value)&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;a.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import b from &#x27;./b.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;const a = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: b.value + 1\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default a&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;b.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a from &#x27;./a.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;const b = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  value: a.value + 1\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default b&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node project_4/index.js</code>ä¼šæŠ¥é”™</p>
<ul>
<li>å¾ªç¯ä¾èµ– æœ‰çš„å¾ªç¯ä¾èµ–å¯ä»¥æ­£å¸¸è¿è¡Œ<code>project_5</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// project_4/index.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a.getB())</span><br><span class="line"><span class="built_in">console</span>.log(b.getA())</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_4/a.js</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;./b.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">  value: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">  getB: <span class="function">() =&gt;</span> b.value + <span class="string">&#x27; from a.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">// project_4/b.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">  value: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">  getA: <span class="function">() =&gt;</span> a.value + <span class="string">&#x27; from b.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b</span><br><span class="line"></span><br><span class="line"><span class="comment">// deps_5.tsåŒdeps_4.ts</span></span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node -r ts-node/register deps_5.ts</code>ç»“æœå¦‚ä¸‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">duplicated dependency: a.js</span><br><span class="line">duplicated dependency: b.js</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;index.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span>, <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a from &#x27;./a.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&quot;import b from &#x27;./b.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;console.log(a.getB())\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;console.log(b.getA())&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;a.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;b.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import b from &#x27;./b.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;const a = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;  value: &#x27;a&#x27;,\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  getB: () =&gt; b.value + &#x27; from a.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default a&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;b.js&#x27;</span>: &#123;</span><br><span class="line">    deps: [ <span class="string">&#x27;a.js&#x27;</span> ],</span><br><span class="line">    code: <span class="string">&quot;import a from &#x27;./a.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;const b = &#123;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;  value: &#x27;b&#x27;,\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  getA: () =&gt; a.value + &#x27; from b.js&#x27;\r\n&quot;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;\r\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;export default b&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>node project_5/index.js</code>ä¸ä¼šæŠ¥é”™</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">b <span class="keyword">from</span> a.js</span><br><span class="line">a <span class="keyword">from</span> b.js</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="Babel-åŸç†-AST"><a href="#Babel-åŸç†-AST" class="headerlink" title="Babel åŸç†(AST)"></a>Babel åŸç†(AST)</h3><ul>
<li>parse æŠŠä»£ç  code å˜æˆ AST</li>
<li>traverse éå† AST è¿›è¡Œä¿®æ”¹</li>
<li>generate æŠŠ AST å˜æˆä»£ç  code2</li>
</ul>
<h3 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><ul>
<li><p>babel å¯ä»¥æŠŠé«˜çº§ä»£ç ç¿»è¯‘ä¸º ES5</p>
</li>
<li><p>@babel/parser</p>
</li>
<li><p>@babel/traverse</p>
</li>
<li><p>@babel/generator</p>
</li>
<li><p>@babel/core åŒ…å«å‰ä¸‰è€…</p>
</li>
<li><p>@babel/preset-env å†…ç½®å¾ˆå¤šè§„åˆ™</p>
</li>
</ul>
<h3 id="ä»£ç æŠ€å·§"><a href="#ä»£ç æŠ€å·§" class="headerlink" title="ä»£ç æŠ€å·§"></a>ä»£ç æŠ€å·§</h3><ul>
<li><p>é€šè¿‡å“ˆå¸Œè¡¨å­˜å‚¨æ•°æ®</p>
</li>
<li><p>é€šè¿‡æ£€æµ‹ key é¿å…é‡å¤</p>
</li>
</ul>
<h3 id="å¾ªç¯ä¾èµ–"><a href="#å¾ªç¯ä¾èµ–" class="headerlink" title="å¾ªç¯ä¾èµ–"></a>å¾ªç¯ä¾èµ–</h3><ul>
<li><p>æœ‰çš„å¾ªç¯ä¾èµ–å¯ä»¥æ­£å¸¸æ‰§è¡Œ</p>
</li>
<li><p>æœ‰çš„å¾ªç¯ä¾èµ–ä¸å¯ä»¥</p>
</li>
<li><p>ä½†éƒ½å¯ä»¥åšé™æ€åˆ†æ</p>
</li>
</ul>
<blockquote>
<p>æºç å‚è€ƒï¼š<a href="https://github.com/Matthrews/webpack-core">https://github.com/Matthrews/webpack-core</a></p>
</blockquote>
]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
      </categories>
      <tags>
        <tag>Webpack Babel</tag>
      </tags>
  </entry>
  <entry>
    <title>ChromeV8æ˜¯å¦‚ä½•å·¥ä½œçš„</title>
    <url>/bloger/2021/05/04/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9B%B8%E5%85%B3/ChromeV8%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/</url>
    <content><![CDATA[<h1 id="Chrome-V8-æ˜¯å¦‚ä½•å·¥ä½œçš„"><a href="#Chrome-V8-æ˜¯å¦‚ä½•å·¥ä½œçš„" class="headerlink" title="Chrome V8 æ˜¯å¦‚ä½•å·¥ä½œçš„"></a>Chrome V8 æ˜¯å¦‚ä½•å·¥ä½œçš„</h1><p>æˆ‘ä»¬çŸ¥é“ï¼ŒV8 æ˜¯ Google å¼€æºçš„ JavaScript å¼•æ“ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå„ç§ JavaScript æ‰§è¡Œç¯å¢ƒï¼Œæ¯”å¦‚ Chrome æµè§ˆå™¨ã€NodeJSã€Electron ä»¥åŠ Denoã€‚ä½†æ˜¯ï¼Œå¾ˆå¤šå‰ç«¯å¼€å‘äººå‘˜å¯¹ V8 çš„ç†è§£è¿˜åœç•™åœ¨è¡¨é¢ï¼Œåªæ˜¯å•çº¯åœ°ä½¿ç”¨ JavaScript å’Œè°ƒç”¨ Web API, å¹¶ä¸äº†è§£ V8 è¿™ä¸ªé»‘ç›’å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚æˆ‘ä»¬åªæœ‰ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæ‰èƒ½å†™å‡ºæ€§èƒ½æ›´å¥½ï¼Œæ›´ä¼˜é›…çš„ JavaScript ä»£ç ã€‚</p>
<p>åŒæ—¶ï¼Œäº†è§£ JavaScript çš„æ‰§è¡ŒåŸç†ï¼Œä¹Ÿèƒ½å¤Ÿè®©ä½ æ›´è½»æ¾çš„ç†è§£ Babel çš„è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æåŸç†ã€ESLint çš„åŸå‘æ£€æŸ¥æœºåˆ¶ã€React å’Œ Vue ç­‰å‰ç«¯æ¡†æ¶çš„åº•å±‚å®ç°ï¼Œä»¥åä½ åœ¨é¢å¯¹å…¶ä»–æ–°çš„æŠ€æœ¯å’Œæ–°æ¡†æ¶ï¼Œä¹Ÿèƒ½å¤Ÿä»¥ä¸å˜åº”ä¸‡å˜ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v8.jpg" alt="v8"></p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆä»å®è§‚ä¸Šå­¦ä¹  V8 æ¶æ„çš„æ¼”è¿›å†å²ï¼Œäº†è§£ V8 æ˜¯å¦‚ä½•æ¼”è¿›æˆå¦‚æ­¤æˆç†Ÿçš„æ¶æ„ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šæ·±å…¥å­¦ä¹  V8 æ‰§è¡Œ JavaScript è¿‡ç¨‹ä¸­çš„è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è§£é‡Šå™¨ã€ä¼˜åŒ–ç¼–è¯‘å™¨çš„å·¥ä½œæœºåˆ¶åŠåŸç†ï¼Œè®©æˆ‘ä»¬çŸ¥å…¶ç„¶å¹¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p>
<h2 id="V8-æ¶æ„æ¼”è¿›"><a href="#V8-æ¶æ„æ¼”è¿›" class="headerlink" title="V8 æ¶æ„æ¼”è¿›"></a>V8 æ¶æ„æ¼”è¿›</h2><p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v82.jpg" alt="v82"></p>
<p>2008 å¹´ï¼ŒV8 å‘å¸ƒäº†ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼ŒV8 åˆšä¸€å‘å¸ƒï¼Œå…¶æ€§èƒ½è¿œè¶…åŒæ—¶æœŸç«äº‰å¯¹æ‰‹ï¼Œæ¯”å¦‚ SpiderMonkeyã€JavaScriptCoreï¼Œå…³æ³¨åº¦éå¸¸é«˜ã€‚ä¸è¿‡ï¼Œå½“æ—¶ V8 æ¶æ„æ¯”è¾ƒæ¿€è¿›ï¼Œæ˜¯ç›´æ¥å°† JavaScript ä»£ç ç¼–è¯‘ä¸ºæœºå™¨ç å¹¶æ‰§è¡Œï¼Œæ‰€ä»¥æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v83.jpg" alt="v83"></p>
<p>ä½†åœ¨è¿™ä¸ªç»“æ„ä¸­ï¼ŒV8 åªæœ‰ Codegen ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå¯¹ä»£ç çš„ä¼˜åŒ–å¾ˆæœ‰é™ã€‚æ‰€ä»¥åœ¨ 2010 å¹´ V8 å‘å¸ƒäº† Crankshaft ç¼–è¯‘å™¨ï¼ŒJavaScript å‡½æ•°é€šå¸¸ä¼šå…ˆè¢« Full-Codegen ç¼–è¯‘å™¨ï¼Œå¦‚æœåç»­è¯¥å‡½æ•°ä¼šè¢«å¤šæ¬¡æ‰§è¡Œï¼Œé‚£ä¹ˆå°±æ˜¯ç”¨ Crankshaft å†é‡æ–°ç¼–è¯‘ï¼Œç”Ÿæˆæ›´ä¼˜åŒ–çš„ä»£ç ï¼Œä¹‹åå°±æ˜¯ç”¨ä¼˜åŒ–åçš„ä»£ç æ¥æ‰§è¡Œï¼Œè¿›è€Œæå‡æ€§èƒ½ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v84.jpg" alt="v84"></p>
<p>ä½†æ˜¯ Crankshaft å¯¹ä»£ç çš„ä¼˜åŒ–æœ‰é™, æ‰€ä»¥ 2015 å¹´ V8 ä¸­åŠ å…¥äº† TurboFanã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v85.jpg" alt="v85"></p>
<p>è¿™æ—¶çš„ V8 ä¾æ—§æ˜¯ç›´æ¥å°†æºç ç¼–è¯‘ä¸ºæœºå™¨ç çš„æ¶æ„ï¼Œè¿™ç§æ¶æ„å­˜åœ¨æ ¸å¿ƒé—®é¢˜æ˜¯å†…å­˜æ¶ˆè€—è¿‡å¤§ï¼Œå°¤å…¶æ˜¯åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œé€šè¿‡ Full-Codegen ç¼–è¯‘å‡ºæ¥çš„ä»£ç ï¼Œå‡ ä¹å æ•´ä¸ª Chrome æµè§ˆå™¨çš„ä¸‰åˆ†ä¹‹ä¸€çš„å†…å­˜ï¼Œè¿™æ ·ä¸ºä»£ç è¿è¡Œæ—¶ç•™ä¸‹çš„å†…å­˜å°±æ›´å°‘äº†ï¼Œäºæ˜¯ 2016 å¹´ V8 åŠ å…¥äº† Ignition è§£é‡Šå™¨ï¼Œé‡æ–°å¼•å…¥äº†å­—èŠ‚ç ï¼Œæ—¨åœ¨å‡å°‘å†…å­˜ä½¿ç”¨ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v86.jpg" alt="v86"></p>
<p>2017 å¹´ V8 æ­£å¼å‘å¸ƒå…¨æ–°ç¼–è¯‘ pipelineï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ Ignition å’Œ TurboFan çš„ç»„åˆæ¥ç¼–è¯‘æ‰§è¡Œä»£ç ã€‚ä» V85.9 ç‰ˆæœ¬å¼€å§‹ï¼Œæ—©æœŸçš„ Full-Codegen å’Œ Crankshaft ç¼–è¯‘å™¨å°±ä¸å†ç”¨æ¥æ‰§è¡Œ JavaScript ä»£ç ï¼Œåœ¨æœ€æ–°çš„æ¶æ„ä¸­ï¼Œæœ€æ ¸å¿ƒçš„å°±ä¸‰ä¸ªæ¨¡å—ï¼šè§£æå™¨(Parser)ã€è§£é‡Šå™¨(Ignition)ã€ä¼˜åŒ–ç¼–è¯‘å™¨(TurboFan)ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v87.jpg" alt="v87"></p>
<p>æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»è§£æã€è§£é‡Šã€ç¼–è¯‘ä¸‰ä¸ªéƒ¨åˆ†è§¦å‘ï¼Œæ·±å…¥å­¦ä¹  V8 ä¸­ JavaScript çš„ä»£ç æ‰§è¡Œé€»è¾‘ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v88.jpg" alt="v88"></p>
<p>å½“ V8 æ‰§è¡Œ JavaScript æºç æ—¶ï¼Œé¦–å…ˆè§£æå™¨ä¼šæŠŠæºç è§£æä¸ºæŠ½è±¡è¯­æ³•æ ‘(Abstract Sytntax Tree)ï¼Œç„¶åè§£é‡Šå™¨å†å°† AST ç¿»è¯‘ä¸ºå­—èŠ‚ç ï¼Œä¸€è¾¹è§£é‡Šä¸€è¾¹æ‰§è¡Œï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œè§£é‡Šå™¨ä¼šè®°å½•ç‰¹å®šä»£ç ç‰‡æ®µçš„è¿è¡Œæ¬¡æ•°ï¼Œå¦‚æœè¿è¡Œæ¬¡æ•°è¶…è¿‡æŸä¸ªé˜ˆå€¼ï¼Œé‚£ä¹ˆè¿™æ®µä»£ç å°±è¢«æ ‡è®°ä¸ºçƒ­ä»£ç (Hot Code)ï¼Œå¹¶å°†è¿è¡Œä¿¡æ¯åé¦ˆç»™ä¼˜åŒ–ç¼–è¯‘å™¨ï¼Œä¼˜åŒ–ç¼–è¯‘å™¨æ ¹æ®åé¦ˆä¿¡æ¯ä¼˜åŒ–å¹¶ç¼–è¯‘å­—èŠ‚ç ï¼Œæœ€ç»ˆç”Ÿæˆä¼˜åŒ–åçš„æœºå™¨ç ã€‚è¿™æ ·ï¼Œå½“è¯¥æ®µä»£ç å†æ¬¡æ‰§è¡Œæ—¶ï¼Œè§£é‡Šå™¨å°±ç›´æ¥ä½¿ç”¨ä¼˜åŒ–æœºå™¨ç æ‰§è¡Œï¼Œä¸ç”¨å†æ¬¡è§£é‡Šï¼Œä»è€Œå¤§å¤§æé«˜äº†ä»£ç è¿è¡Œæ•ˆç‡ï¼Œè¿™ç§åœ¨è¿è¡Œæ—¶ç¼–è¯‘ä»£ç çš„æŠ€æœ¯ä¹Ÿè¢«ç§°ä¸ºå³æ—¶ç¼–è¯‘(JIT)ï¼Œé€šè¿‡ JITï¼Œå¯ä»¥æå¤§æå‡ JavaScript ä»£ç çš„æ‰§è¡Œæ€§èƒ½ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/v89.jpg" alt="v89"></p>
<p>é‚£ä¹ˆè§£æå™¨æ˜¯å¦‚ä½•æŠŠæºç è½¬æ¢ä¸º AST å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬è¦æ¸…æ¥šï¼Œè¦è®© V8 æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æºç ï¼Œé‚£ä¹ˆå°±è¦å°†æºç è½¬æ¢ä¸º V8 èƒ½ç†è§£çš„æ ¼å¼ï¼ŒV8 é¦–å…ˆä¼šæŠŠæºç è§£æä¸ºä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘(AST)ï¼ŒæŠ½è±¡è¯­æ³•æ ‘æ˜¯ç”¨æ¥è¡¨ç°æºç æ ‘ç»“æ„çš„å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºè§£æ(Parsing)ï¼Œä¸»è¦ç”± V8 çš„ Parser æ¨¡å—å®ç°ï¼Œç„¶å V8 çš„è§£é‡Šå™¨ä¼šæŠŠ AST ç¼–è¯‘ä¸ºå­—èŠ‚ç </p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/parser.jpg" alt="parser"></p>
<p>è§£æå’Œç¼–è¯‘è¿‡ç¨‹çš„æ€§èƒ½éå¸¸é‡è¦ï¼Œå› ä¸º V8 åªæœ‰ç­‰ç¼–è¯‘å®Œæˆåæ‰èƒ½è¿è¡Œä»£ç ï¼Œæ•´ä¸ªè§£æçš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ†è¯æ³•åˆ†æ(Lexical Analysis)ï¼Œè¯æ³•åˆ†æå°±æ˜¯å°†å­—ç¬¦æµè½¬æ¢ä¸º tokensï¼Œå­—ç¬¦æµå°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„ä¸€è¡Œè¡Œä»£ç ï¼Œtoken æ˜¯æŒ‡è¯­æ³•ä¸Šä¸èƒ½å†åˆ†å‰²çš„æœ€å°å•ä½ï¼Œå¯èƒ½æ˜¯å•ä¸ªå­—ç¬¦ï¼Œä¹Ÿå¯èƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå›¾ä¸­çš„ Scanner å°±æ˜¯ V8 çš„è¯æ³•åˆ†æå™¨</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/parser2.jpg" alt="parser2"></p>
<ul>
<li>ç¬¬äºŒéƒ¨åˆ†è¯­æ³•åˆ†æ(Syntax Analysis), è¯­æ³•åˆ†ææ˜¯æ ¹æ®è¯­æ³•è§„åˆ™å°† tokens ç»„æˆä¸€ä¸ªæœ‰åµŒå¥—å±‚çº§çš„çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæºç ä¸ç¬¦åˆè¯­æ³•è§„èŒƒï¼Œè§£æè¿‡ç¨‹å°±ä¼šç»ˆæ­¢ï¼Œå¹¶æŠ›å‡ºè¯­æ³•é”™è¯¯ã€‚å›¾ä¸­çš„ Parser å’Œ Pre-Parser éƒ½æ˜¯ V8 çš„è¯­æ³•åˆ†æå™¨ã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/parser3.jpg" alt="parser3"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¯¦ç»†çœ‹ä¸€ä¸‹è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æ</p>
<p>é¦–å…ˆæ˜¯è¯æ³•åˆ†æï¼Œåœ¨ V8 ä¸­ï¼ŒScanner è´Ÿè´£æ¥æ”¶ Unicode å­—ç¬¦æµï¼Œå¹¶å°†å…¶è§£æä¸º tokensï¼Œæä¾›ç»™è§£æå™¨ä½¿ç”¨ã€‚æ¯”å¦‚<code>var a = 1;</code>è¿™è¡Œä»£ç è¯æ³•åˆ†æåå¾— tokens å¦‚ä¸‹</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Keyword&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;var&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;a&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Punctuator&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;=&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Numeric&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Punctuator&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™è¡Œä»£ç åŒ…æ‹¬ 5 ä¸ª tokensï¼š <code>å…³é”®å­—var</code>, <code>æ ‡è¯†ç¬¦a</code>ï¼Œ<code>èµ‹å€¼è¿ç®—ç¬¦=</code>ï¼Œ <code>æ•°å­—1</code>ä»¥åŠ<code>åˆ†éš”ç¬¦;</code></p>
<p>åŠ ä¸‹æ¥ï¼ŒV8 è§£æå™¨ä¼šé€šè¿‡è¯­æ³•åˆ†æï¼Œæ ¹æ® tokens ç”Ÿæˆ ASTï¼Œè¿™è¡Œä»£ç ç”Ÿæˆçš„ AST å¦‚ä¸‹</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;body&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;VariableDeclaration&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;declarations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;VariableDeclarator&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;a&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;init&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Literal&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;var&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;script&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½ ä¹Ÿå¯ä»¥åœ¨<a href="https://esprima.org/demo/parse.html?code=var%20a%20=%201;%0A">åœ¨çº¿å·¥å…·</a>ä¸Šä¿®æ”¹ä»£ç ï¼Œè§‚å¯Ÿ AST çš„ç»“æ„</p>
<p>ä½†æ˜¯ï¼Œå¯¹äºä¸€ä»½ JavaScript æºç ï¼Œå¦‚æœæ‰€æœ‰æºç åœ¨æ‰§è¡Œå‰éƒ½è¦å®Œå…¨ç»è¿‡è§£ææ‰èƒ½æ‰§è¡Œï¼Œé‚£å¿…ç„¶ä¼šé¢ä¸´ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li><p>ä»£ç æ‰§è¡Œæ—¶é—´å˜é•¿ï¼Œå› ä¸ºä¸€æ¬¡æ€§è§£ææ‰€æœ‰ä»£ç å¿…ç„¶ä¼šå¢åŠ ä»£ç çš„è¿è¡Œæ—¶é—´</p>
</li>
<li><p>æ¶ˆè€—æ›´å¤šå†…å­˜ï¼Œå› ä¸ºè§£æå®Œçš„ AST ä»¥åŠæ ¹æ® AST ç¼–è¯‘åçš„å­—èŠ‚ç éƒ½ä¼šæ”¾åœ¨å†…å­˜ä¸­ï¼Œè¿™æ ·å¿…ç„¶ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜</p>
</li>
<li><p>å ç”¨ç£ç›˜ç©ºé—´ï¼Œå› ä¸ºç¼–è¯‘åçš„ä»£ç è¿˜ä¼šç¼“å­˜åœ¨ç£ç›˜ä¸Šï¼Œæ‰€ä»¥ä¼šé‡ç”¨ç£ç›˜ç©ºé—´</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/p1.jpg" alt="p1"></p>
<p>å› æ­¤ï¼Œç°åœ¨ä¸»æµçš„ JavaScript å¼•æ“éƒ½å®ç°äº†<code>å»¶è¿Ÿè§£æ</code>, å»¶è¿Ÿè§£æçš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨è§£æè¿‡ç¨‹ä¸­ï¼Œå¯¹äºé‚£äº›ä¸æ˜¯ç«‹å³æ‰§è¡Œçš„å‡½æ•°ï¼Œåªè¿›è¡Œé¢„è§£æ(Pre-Parser)ï¼Œåªæœ‰å½“å‡½æ•°è°ƒç”¨æ—¶æ‰å¯¹å‡½æ•°è¿›è¡Œå…¨é‡è§£æã€‚è¿›è¡Œé¢„è§£ææ—¶ï¼ŒåªéªŒè¯å‡½æ•°çš„è¯­æ³•æ˜¯å¦æœ‰æ•ˆï¼Œè§£æå‡½æ•°å£°æ˜ä»¥åŠç¡®å®šå‡½æ•°ä½œç”¨åŸŸï¼Œä¸ç”Ÿæˆ ASTã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/p2.jpg" alt="p2"></p>
<p>å®ç°é¢„è§£æçš„å°±æ˜¯ Pre-Parser è§£æå™¨, ä»¥å¦‚ä¸‹ä»£ç ä¸ºä¾‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res = a + b;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line">foo(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>ç”±äº Scanner æ˜¯æŒ‰å­—èŠ‚æµä»ä¸Šå¾€ä¸‹ä¸€è¡Œè¡Œè¯»å–ä»£ç ï¼Œæ‰€ä»¥ V8 è§£æå™¨ä¹Ÿæ˜¯ä»ä¸Šå¾€ä¸‹è§£æä»£ç ï¼Œå½“ V8 è§£æå™¨è§£é‡Šåˆ°å‡½æ•°å£°æ˜æ—¶ï¼Œå‘ç°ä»–ä¸æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œä¼šä½¿ç”¨ Pre-Parser è§£é‡Šå™¨å¯¹å…¶é¢„è§£æï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªä¼šè§£æå‡½æ•°å£°æ˜ï¼Œä¸ä¼šè§£æå‡½æ•°å†…éƒ¨çš„ä»£ç ï¼Œä¸ä¼šä¸ºå‡½æ•°å†…éƒ¨çš„ä»£ç ç”Ÿæˆ ASTï¼Œç„¶å Ignition è§£é‡Šå™¨ä¼šæŠŠ AST ç¼–è¯‘ä¸ºå­—èŠ‚ç å¹¶æ‰§è¡Œï¼Œè§£é‡Šå™¨ä¹Ÿä¼šæŒ‰ç…§è‡ªä¸Šè€Œä¸‹çš„é¡ºåºæ‰§è¡Œä»£ç ï¼Œå…ˆæ‰§è¡Œ<code>var a = 1;</code>å’Œ<code>var b = 2;</code>ä¸¤ä¸ªèµ‹å€¼è¡¨è¾¾å¼ï¼Œç„¶åå†æ‰§è¡Œå‡½æ•°è°ƒç”¨<code>foo(1, 2);</code>, è¿™æ˜¯ Parser è§£æå™¨æ‰ä¼šç»§ç»­è§£æå‡½æ•°å†…çš„ä»£ç å¹¶ç”Ÿæˆ ASTï¼Œå†å°†è¯¥ AST äº¤ç»™ Ignition è§£é‡Šå™¨ç¼–è¯‘æ‰§è¡Œã€‚</p>
<p>é‚£ä¹ˆè§£é‡Šå™¨(Ignition)æ˜¯å¦‚ä½•å°† AST ç¿»è¯‘ä¸ºå­—èŠ‚ç å¹¶æ‰§è¡Œçš„å‘¢ï¼Ÿåœ¨ V8 æ¶æ„çš„æ¼”è¿›ä¸­ï¼ŒV8 ä¸ºäº†è§£å†³å†…å­˜å ç”¨é—®é¢˜å¼•å…¥äº†å­—èŠ‚ç ï¼Œå¦‚å›¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte.jpg" alt="byte"></p>
<p>é€šå¸¸ï¼Œä¸€ä¸ªå‡  KB çš„æ–‡ä»¶è½¬æ¢ä¸ºæœºå™¨ç å¯èƒ½å°±æ˜¯å‡ åå…†ï¼Œè¿™å›æ¶ˆè€—å·¨å¤§çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥ V8 å¼•å…¥äº†å­—èŠ‚ç ã€‚V8 çš„å­—èŠ‚ç æ˜¯å¯¹æœºå™¨ç çš„æŠ½è±¡ï¼Œå…¶è¯­æ³•ä¸æ±‡ç¼–æœ‰äº›ç±»ä¼¼ï¼Œä½ å¯ä»¥æŠŠ V8 å­—èŠ‚ç çœ‹æˆä¸€ä¸ªä¸ªæŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤ç»„åˆåœ¨ä¸€èµ·ï¼Œå°±å®ç°äº†æˆ‘ä»¬ç¼–å†™çš„åŠŸèƒ½ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte2.jpg" alt="byte2"></p>
<p>V8 ä¸€å…±å®šä¹‰äº†å‡ ç™¾ä¸ªå­—èŠ‚ç ï¼Œä½ å¯ä»¥åœ¨ V8 è§£é‡Šå™¨çš„å¤´æ–‡ä»¶ä¸­æŸ¥çœ‹æ‰€æœ‰çš„å­—èŠ‚ç ï¼ŒIgnition è§£é‡Šå™¨åœ¨æ‰§è¡Œå­—èŠ‚ç æ—¶, ä¸»è¦ä½¿ç”¨äº†é€šç”¨å¯„å­˜å™¨å’Œç´¯åŠ å¯„å­˜å™¨ï¼Œå…¶ä¸­ï¼Œå‡½æ•°å‚æ•°å’Œå±€éƒ¨å˜é‡éƒ½ä¿å­˜åœ¨é€šç”¨å¯„å­˜å™¨ä¸­ï¼Œè€Œç´¯åŠ å¯„å­˜å™¨ç”¨äºä¿å­˜ä¸­é—´ç»“æœï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç æ¥è¿›ä¸€æ­¥å­¦ä¹ å­—èŠ‚ç çš„æ‰§è¡Œæµç¨‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> d = c - <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">return</span> a + d * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="number">5</span>, <span class="number">2</span>, <span class="number">150</span>);</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå«æœ‰ä¸‰ä¸ªå‚æ•°çš„å‡½æ•° fï¼Œå‡½æ•°çš„åŠŸèƒ½å°±æ˜¯å¯¹å‚æ•°è¿›è¡Œè®¡ç®—ï¼Œå¹¶è¿”å›å€¼ã€‚<br>å‡è®¾æˆ‘ä»¬ä»¥å‚æ•° 5, 2, 150 è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆ Ignition è§£é‡Šå™¨é¦–å…ˆä¼šæŠŠå‡½æ•°ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œæ‰§è¡Œ<code>node --print-bytecode test/index.js &gt; bytecode.txt</code>æ¥æŸ¥çœ‹ JavaScript æ–‡ä»¶ç”Ÿæˆçš„å­—èŠ‚ç è¾“å‡ºåˆ°<code>bytecode.txt</code>æ–‡ä»¶ï¼Œæ‰“å¼€è¯¥æ–‡ä»¶ç›´æ¥æŸ¥çœ‹æ–‡ä»¶æœ«å°¾çš„å­—èŠ‚ç å¦‚ä¸‹</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line">[generated bytecode for function: f (0x00ece2c7ad59 &lt;SharedFunctionInfo f&gt;)]</span><br><span class="line">Parameter count 4</span><br><span class="line">Register count 1</span><br><span class="line">Frame size 8</span><br><span class="line">   33 S&gt; 000000ECE2C7B4D6 @    0 : 25 02             Ldar a2</span><br><span class="line">   35 E&gt; 000000ECE2C7B4D8 @    2 : 41 64 00          SubSmi [100], [0]</span><br><span class="line">         000000ECE2C7B4DB @    5 : 26 fb             Star r0</span><br><span class="line">   45 S&gt; 000000ECE2C7B4DD @    7 : 25 03             Ldar a1</span><br><span class="line">   58 E&gt; 000000ECE2C7B4DF @    9 : 36 fb 02          Mul r0, [2]</span><br><span class="line">   54 E&gt; 000000ECE2C7B4E2 @   12 : 34 04 01          Add a0, [1]</span><br><span class="line">   62 S&gt; 000000ECE2C7B4E5 @   15 : aa                Return</span><br><span class="line">Constant pool (size = 0)</span><br><span class="line">Handler Table (size = 0)</span><br><span class="line">Source Position Table (size = 14)</span><br><span class="line">0x00ece2c7b4e9 &lt;ByteArray[14]&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte3.jpg" alt="byte3"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“ Ignition è§£é‡Šå™¨æ‰§è¡Œä»£ç æ—¶ï¼Œé¦–å…ˆä¼šæŠŠå‚æ•°åˆ†åˆ«åŠ è½½åˆ° a0, a1, a2 å¯„å­˜å™¨ä¸Šï¼Œå›¾ä¸­çš„ accumulator è¡¨ç¤ºç´¯åŠ å¯„å­˜å™¨ï¼Œç„¶ååœ¨é€è¡Œæ‰§è¡Œå­—èŠ‚ç ã€‚<code>Ldar a2</code>è¡¨ç¤ºå°† a2 å¯„å­˜å™¨çš„å€¼åŠ è½½åˆ°ç´¯åŠ å¯„å­˜å™¨ä¸­ï¼ŒåŠ è½½åï¼Œç´¯åŠ å¯„å­˜å™¨çš„å€¼å°±å˜ä¸ºäº† 150<br><code>SubSmi [100]</code>è¡¨ç¤ºå°†ç´¯åŠ å¯„å­˜å™¨çš„å€¼å‡å°‘ 100ï¼Œè¿™æ—¶ç´¯åŠ å¯„å­˜å™¨çš„å€¼å°±å˜ä¸ºäº† 50ï¼Œ<code>[0]</code>è¡¨ç¤ºåé¦ˆå‘é‡(FeedBack Vector)çš„ç´¢å¼•ï¼Œåé¦ˆå‘é‡å°±è®°å½•äº†å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›å…³é”®æ•°æ®ã€‚<code>Star r0</code>è¡¨ç¤ºæŠŠç´¯åŠ å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨å¯„å­˜å™¨ r0 ä¸­ï¼Œè¿™æ—¶ r0 çš„å€¼å°±å˜ä¸ºäº† 50ï¼Œ<code>Ldar a1</code>è¡¨ç¤ºå°† a1 å¯„å­˜å™¨çš„å€¼åŠ è½½åˆ°ç´¯åŠ å¯„å­˜å™¨ä¸­ï¼Œè¿™æ—¶ç´¯åŠ å¯„å­˜å™¨çš„å€¼å°±å˜ä¸ºäº† 2ï¼Œ<br><code>Mul r0, [2]</code>è¡¨ç¤ºå°†ç´¯åŠ å¯„å­˜å™¨çš„å€¼ä¸ r0 å¯„å­˜å™¨çš„å€¼ç›¸ä¹˜ï¼Œå¹¶å°†ç»“æœå†æ¬¡æ”¾å…¥ç´¯åŠ å¯„å­˜å™¨ï¼Œå…¶ä¸­<code>[2]</code>åŒæ ·æ˜¯åé¦ˆå‘é‡ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œaccumulator çš„å€¼å°±å˜æˆäº† 100ï¼Œ<code>Add a0, [1]</code>è¡¨ç¤ºå°†ç´¯åŠ å¯„å­˜å™¨çš„å€¼ä¸ a0 å¯„å­˜å™¨çš„å€¼ç›¸åŠ ï¼Œå¹¶å°†ç»“æœå†æ¬¡æ”¾å…¥ç´¯åŠ å¯„å­˜å™¨ï¼Œè¿™æ˜¯ accumulator çš„å€¼å°±å˜æˆäº† 105ï¼ŒReturn è¡¨ç¤ºç»“æŸå½“å‰å‡½æ•°çš„æ‰§è¡Œå¹¶è¿”å›ç´¯åŠ å¯„å­˜å™¨ä¸­çš„å€¼ã€‚æ‰€ä»¥æœ€ç»ˆå‡½æ•°çš„æ‰§è¡Œç»“æœæ—¶ 105</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte9.jpg" alt="byte9"><br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒIgnition è§£é‡Šå™¨åœ¨æ‰§è¡Œå­—èŠ‚ç æ—¶ï¼Œä¾æ—§éœ€è¦å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç ï¼Œå› ä¸º CPU åªèƒ½è¯†åˆ«æœºå™¨ç ï¼Œè™½ç„¶å¤šäº†ä¸€å±‚å­—èŠ‚ç çš„è½¬æ¢ï¼Œçœ‹èµ·æ¥æ•ˆç‡ä½äº†ï¼Œä½†æ˜¯ç›¸æ¯”äºæœºå™¨ç ï¼ŒåŸºäºå­—èŠ‚ç å¯ä»¥æ›´æ–¹ä¾¿è¿›è¡Œè¡Œæ€§èƒ½ä¼˜åŒ–ã€‚<br><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte10.jpg" alt="byte10"><br>è€Œ V8 çš„ç¡®ä¹Ÿåšäº†å¾ˆå¤šæ€§èƒ½ä¼˜åŒ–çš„å·¥ä½œï¼Œå…¶ä¸­ï¼Œæœ€ä¸»è¦çš„å°±æ˜¯ä½¿ç”¨ TurboFan ç¼–è¯‘å™¨ç¼–è¯‘çƒ­ç‚¹ä»£ç ï¼Œè¿™äº›æ€§èƒ½ä¼˜åŒ–ï¼Œä½¿å¾—å¦‚ä»ŠåŸºäºå­—èŠ‚ç æ¶æ„çš„è¡Œå‘¢ä¸ªä¼˜åŒ–è¦è¿œè¶…å½“å¹´ç›´æ¥ç¼–è¯‘æœºå™¨ç æ¶æ„çš„æ€§èƒ½</p>
<p>Ignition è§£é‡Šå™¨åœ¨è§£é‡Šæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ ‡è®°é‡å¤æ‰§è¡Œçš„çƒ­ç‚¹ä»£ç ï¼Œè¿™äº›è¢«æ ‡è®°çš„ä»£ç ï¼Œä¼šè¢« TurboFan ç¼–è¯‘å™¨ç¼–è¯‘ç”Ÿæˆæ•ˆç‡æ›´é«˜çš„æœºå™¨ç ï¼Œé‚£ä¹ˆ TurboFan ç¼–è¯‘å™¨å…·ä½“æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Ÿ</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte11.jpg" alt="byte11"></p>
<p>å…¶ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªç®—æ³•ï¼Œä¸€ä¸ªæ˜¯å†…è”ï¼Œä¸€ä¸ªæ˜¯é€ƒé€¸åˆ†æï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å†…è”</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">three</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å¦‚æœæœªç»ä¼˜åŒ–ï¼Œç›´æ¥ç¼–è¯‘è¯¥æ®µä»£ç ï¼Œä¼šåˆ†åˆ«ç”Ÿæˆä¸¤ä¸ªå‡½æ•°çš„æœºå™¨ç </p>
<p>ä½†ä¸ºäº†è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼ŒTurboFan ç¼–è¯‘å™¨å°±ä¼šå¯¹ä»¥ä¸Šä¸¤ä¸ªå‡½æ•°è¿›è¡Œå†…è”ï¼Œç„¶åå†ç¼–è¯‘</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte12.jpg" alt="byte12"></p>
<p>ç”±äºå‡½æ•°å†…éƒ¨çš„è¡Œä¸ºå°±æ˜¯æ±‚ 1 å’Œ 2 çš„å’Œï¼Œæ‰€ä»¥è¿™æ®µä»£ç å°±æœ‰äº†æ”¹å˜</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">three_add_inlined</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> y = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">var</span> add_return_value = x + y;</span><br><span class="line">  <span class="keyword">return</span> add_return_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ›´è¿›ä¸€æ­¥ï¼Œç”±äºå‡½æ•° three_add_inlined ä¸­çš„ x å’Œ y çš„å€¼éƒ½æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥ three_add_inlined è¿˜å¯ä»¥ä¼˜åŒ–ï¼Œç›´æ¥è¿”å›ç»“æœ 3</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">three_add_const_folded</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆç¼–è¯‘ç”Ÿæˆçš„æœºå™¨ç ç›¸æ¯”ä¼˜åŒ–å‰å°±å°‘äº†éå¸¸ä¹‹å¤šï¼Œæ‰§è¡Œæ•ˆç‡è‡ªç„¶ä¹Ÿé«˜äº†å¾ˆå¤šã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/byte13.jpg" alt="byte13"></p>
<p>é€šè¿‡å†…è”ï¼Œå¯ä»¥é™ä½å¤æ‚åº¦ï¼Œæ¶ˆé™¤å†—ä½™ä»£ç ï¼Œåˆå¹¶å¸¸é‡ï¼Œå¹¶ä¸”å†…è”æŠ€æœ¯é€šå¸¸ä¹Ÿæ˜¯é€ƒé€¸åˆ†æçš„åŸºç¡€ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æå‘¢ï¼Ÿ</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/t1.jpg" alt="t1"></p>
<p>ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯æŒ‡åˆ†æå¯¹è±¡çš„çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯å¦ä»…å±€é™äºå½“å‰å‡½æ•°</p>
<p>è®©æˆ‘ä»¬åœ¨æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">x, y</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.x = x;</span><br><span class="line">    <span class="built_in">this</span>.y = y;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ±‚æ›¼å“ˆé¡¿è·ç¦»</span></span><br><span class="line">  <span class="function"><span class="title">distance</span>(<span class="params">that</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.abs(<span class="built_in">this</span>.x - that.x) + <span class="built_in">Math</span>.abs(<span class="built_in">this</span>.y - that.y);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">manhattan</span>(<span class="params">x1, y1, x2, y2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="keyword">new</span> Point(x1, y1);</span><br><span class="line">  <span class="keyword">const</span> b = <span class="keyword">new</span> Point(x2, y2;</span><br><span class="line">  <span class="keyword">return</span> a.distance(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TurboFan ç¼–è¯‘å™¨é¦–å…ˆä¼šé€šè¿‡å†…è”ï¼Œå°† manhattan å‡½æ•°è½¬æ¢ä¸ºå¦‚ä¸‹å‡½æ•°</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">manhattan_inlined</span>(<span class="params">x1, y1, x2, y2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> a = &#123; <span class="attr">x</span>: x1, <span class="attr">y</span>: y1 &#125;;</span><br><span class="line">  <span class="keyword">const</span> b = &#123; <span class="attr">x</span>: x2, <span class="attr">y</span>: y2 &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.abs(a.x - b.x) + <span class="built_in">Math</span>.abs(a.y - b.y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å‡½æ•°çœ‹èµ·æ¥å°±ç®€å•å¤šäº†ï¼Œå†æ¥ä¸‹æ¥ï¼Œå°±ä¼šå¯¹ manhattan_inlined ä¸­çš„å¯¹è±¡è¿›è¡Œé€ƒé€¸åˆ†æ</p>
<p>ä»€ä¹ˆæ ·çš„å¯¹è±¡ä¼šè¢«è®¤ä¸ºæ˜¯â€œæœªé€ƒé€¸â€çš„å‘¢ï¼Ÿä¸»è¦è¦æ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/t2.jpg" alt="t2"></p>
<p>é¦–å…ˆï¼Œå¯¹è±¡æ˜¯åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰ï¼›å…¶æ¬¡ï¼Œå¯¹è±¡åªä½œç”¨äºå‡½æ•°å†…éƒ¨ã€‚æ¯”å¦‚ï¼Œå‡½æ•°æ²¡æœ‰è¢«è¿”å›ï¼Œä¹Ÿæ²¡æœ‰ä¼ é€’æˆ–è€…ç»™å…¶ä»–å‡½æ•°è°ƒç”¨</p>
<p>åœ¨ manhattan_inlined å‡½æ•°ä¸­ï¼Œå˜é‡ a å’Œ b éƒ½æ˜¯å‡½æ•°é‡Œå†…éƒ¨æ™®é€šå˜é‡ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½æ˜¯æœªé€ƒé€¸å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹å‡½æ•°ä¸­çš„å¯¹è±¡è¿›è¡Œæ›¿æ¢äº†ï¼Œä½¿ç”¨å˜é‡æ›¿æ¢æ‰å¯¹è±¡ï¼Œè¿™æ ·å‡½æ•°å†…éƒ¨å°±ä¸å†æœ‰å¯¹è±¡å®šä¹‰ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ a_x, a_y, b_x, b_yï¼Œå¹¶ä¸”ç›´æ¥æ¥æºäºå‡½æ•°å‚æ•°</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">manhattan_scalar_eplacement</span>(<span class="params">x1, y1, x2, y2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> a_x = x1;</span><br><span class="line">  <span class="keyword">const</span> a_y = y1;</span><br><span class="line">  <span class="keyword">const</span> b_x = x2;</span><br><span class="line">  <span class="keyword">const</span> b_y = y2;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.abs(a_x - b_x) + <span class="built_in">Math</span>.abs(a_y - b_y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å˜é‡åŠ è½½åˆ°å¯„å­˜å™¨ä¸Šï¼Œä¸å†éœ€è¦ä»å†…å­˜ä¸­è®¿é—®å¯¹è±¡äº†ï¼Œæå‡äº†æ‰§è¡Œæ•ˆç‡çš„åŒæ—¶ï¼Œè¿˜å‡å°‘äº†å†…å­˜çš„ä½¿ç”¨</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>V8 æ¶æ„æ¼”è¿›å²</li>
</ul>
<p>æœ€åˆï¼ŒV8 æ˜¯æ²¡æœ‰å­—èŠ‚ç çš„ï¼Œç›´æ¥å°† JavaScript æºç ç¼–è¯‘ä¸ºæœºå™¨ç æ‰§è¡Œï¼Œè¿™ç§æ¶æ„å¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜</p>
<p>åæ¥å¼•å…¥äº†å­—èŠ‚ç </p>
<ul>
<li>V8 æ‰§è¡Œ JavaScript çš„åŸç†</li>
</ul>
<p>å¤§è‡´åˆ†ä¸ºç¬¬ä¸‰ä¸ªæ­¥éª¤</p>
<p>é¦–å…ˆï¼Œè§£é‡Šå™¨å°† JavaScript æºç è§£æä¸º ASTï¼Œè§£æè¿‡ç¨‹åˆ†ä¸ºè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æï¼ŒV8 é€šè¿‡é¢„è§£ææå‡æ‰§è¡Œæ•ˆç‡</p>
<p>ç„¶åï¼Œè§£é‡Šå™¨ Ignition æ ¹æ® AST ç”Ÿæˆå­—èŠ‚ç å¹¶æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ”¶é›†åé¦ˆä¿¡æ¯ï¼Œäº¤ç»™ TurboFan è¿›è¡Œä¼˜åŒ–ç¼–è¯‘ï¼ŒTurboFan æ ¹æ® Ignition æ”¶é›†çš„åé¦ˆä¿¡æ¯ï¼Œå°†å­—èŠ‚ç ç¼–è¯‘ä¸ºä¼˜åŒ–åçš„æœºå™¨ç ï¼Œåç»­ Ignition ç”¨ä¼˜åŒ–æœºå™¨ç ä»£æ›¿å­—èŠ‚ç æ‰§è¡Œï¼Œè¿›è€Œæå‡æ€§èƒ½</p>
<!-- https://segmentfault.com/a/1190000040331440 -->
]]></content>
      <categories>
        <category>æµè§ˆå™¨ç›¸å…³</category>
      </categories>
      <tags>
        <tag>V8</tag>
      </tags>
  </entry>
  <entry>
    <title>ç²¾ç®€ç‰ˆReactæºç æ‰‹ç¨¿</title>
    <url>/bloger/2021/08/10/UI%E6%A1%86%E6%9E%B6/%E7%B2%BE%E7%AE%80%E7%89%88React%E6%BA%90%E7%A0%81%E6%89%8B%E7%A8%BF/</url>
    <content><![CDATA[<h1 id="ç²¾ç®€ç‰ˆ-React-æºç æ‰‹ç¨¿"><a href="#ç²¾ç®€ç‰ˆ-React-æºç æ‰‹ç¨¿" class="headerlink" title="ç²¾ç®€ç‰ˆ React æºç æ‰‹ç¨¿"></a>ç²¾ç®€ç‰ˆ React æºç æ‰‹ç¨¿</h1><blockquote>
<p>TLDR: å…¨æ˜¯æºç ï¼Œé€‚åˆçœ‹è¿‡æºç æƒ³å›å¤´ç»†çœ‹çš„åŒå­¦</p>
</blockquote>
<blockquote>
<p>æœ¬æ¬¡åˆ†äº«æºç ç‰ˆæœ¬<a href="mailto:&#x72;&#101;&#97;&#x63;&#x74;&#x40;&#49;&#x36;&#x2e;&#54;&#46;&#x30;">&#x72;&#101;&#97;&#x63;&#x74;&#x40;&#49;&#x36;&#x2e;&#54;&#46;&#x30;</a>å’Œreact@16.7.0</p>
</blockquote>
<blockquote>
<p>æ³¨ï¼šæœ¬æ­¤åˆ†äº«æ›´å¤šçš„æ˜¯æºç ï¼Œæ¦‚å¿µæ€§çš„ä¸œè¥¿è¯»è€…å¯è‡ªè¡ŒæŸ¥é˜…å®˜ç½‘æ–‡æ¡£æˆ–è€… YouTube React Conference</p>
</blockquote>
<h2 id="ä»£ç ç»“æ„"><a href="#ä»£ç ç»“æ„" class="headerlink" title="ä»£ç ç»“æ„"></a>ä»£ç ç»“æ„</h2><ul>
<li><p>packages/react</p>
</li>
<li><p>packages/react-dom</p>
</li>
<li><p>packages/react-reconciler</p>
</li>
</ul>
<p>å¹³å°æ— å…³ DOM æ“ä½œï¼ŒåŒ…æ‹¬ä»»åŠ¡è°ƒåº¦</p>
<h2 id="JSX-åˆ°-JS"><a href="#JSX-åˆ°-JS" class="headerlink" title="JSX åˆ° JS"></a>JSX åˆ° JS</h2><p>React.createElement, å…¥å‚ type, config, childrenï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡</p>
<h2 id="API-æºç "><a href="#API-æºç " class="headerlink" title="API æºç "></a>API æºç </h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\React.js</span></span><br><span class="line"><span class="comment">// æš´éœ²å‡ºæ¥çš„API</span></span><br><span class="line"><span class="keyword">const</span> React = &#123;</span><br><span class="line">  Children: &#123;</span><br><span class="line">    map,</span><br><span class="line">    forEach,</span><br><span class="line">    count,</span><br><span class="line">    toArray,</span><br><span class="line">    only,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  createRef,</span><br><span class="line">  Component,</span><br><span class="line">  PureComponent,</span><br><span class="line"></span><br><span class="line">  createContext,</span><br><span class="line">  forwardRef,</span><br><span class="line">  lazy,</span><br><span class="line">  memo,</span><br><span class="line"></span><br><span class="line">  Fragment: REACT_FRAGMENT_TYPE,</span><br><span class="line">  StrictMode: REACT_STRICT_MODE_TYPE,</span><br><span class="line">  unstable_ConcurrentMode: REACT_CONCURRENT_MODE_TYPE,</span><br><span class="line">  Suspense: REACT_SUSPENSE_TYPE,</span><br><span class="line">  unstable_Profiler: REACT_PROFILER_TYPE,</span><br><span class="line"></span><br><span class="line">  createElement: __DEV__ ? createElementWithValidation : createElement,</span><br><span class="line">  cloneElement: __DEV__ ? cloneElementWithValidation : cloneElement,</span><br><span class="line">  createFactory: __DEV__ ? createFactoryWithValidation : createFactory,</span><br><span class="line">  isValidElement: isValidElement,</span><br><span class="line"></span><br><span class="line">  version: ReactVersion,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React;</span><br></pre></td></tr></table></figure>

<h3 id="React-Element"><a href="#React-Element" class="headerlink" title="React Element"></a>React Element</h3><ul>
<li>React Element æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\ReactElement.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create and return a new ReactElement of the given type.</span></span><br><span class="line"><span class="comment"> * See https://reactjs.org/docs/react-api.html#createelement</span></span><br><span class="line"><span class="comment"> * type ç±»å‹  åŸç”Ÿæ ‡ç­¾çš„è¯æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè‡ªå®šä¹‰ç»„ä»¶çš„è¯æ˜¯ä¸€ä¸ªå˜é‡</span></span><br><span class="line"><span class="comment"> * config èŠ‚ç‚¹attributes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> propName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reserved names are extracted</span></span><br><span class="line">  <span class="keyword">const</span> props = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> ref = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> self = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> source = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æä¸Šè¿°å››ä¸ªå­—æ®µä»¥åŠpropså±æ€§</span></span><br><span class="line">  <span class="comment">// for/in</span></span><br><span class="line">  <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasValidRef(config)) &#123;</span><br><span class="line">      ref = config.ref;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hasValidKey(config)) &#123;</span><br><span class="line">      key = <span class="string">&quot;&quot;</span> + config.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self = config.__self === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__self;</span><br><span class="line">    source = config.__source === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__source;</span><br><span class="line">    <span class="comment">// Remaining properties are added to a new props object</span></span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> config) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        hasOwnProperty.call(config, propName) &amp;&amp;</span><br><span class="line">        !RESERVED_PROPS.hasOwnProperty(propName)</span><br><span class="line">      ) &#123;</span><br><span class="line">        props[propName] = config[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * https://babeljs.io/repl</span></span><br><span class="line"><span class="comment">   * const jsx = </span></span><br><span class="line"><span class="comment">  &lt;div key=&quot;435ksdfds&quot; class=&quot;wrapper&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;span&gt;matthew&lt;/span&gt;</span></span><br><span class="line"><span class="comment">    &lt;span&gt;green&lt;/span&gt;</span></span><br><span class="line"><span class="comment">  &lt;/div&gt; </span></span><br><span class="line"><span class="comment">   * è½¬æ¢ä¸ºjså°±æ˜¯</span></span><br><span class="line"><span class="comment">   * const jsx = React.createElement(</span></span><br><span class="line"><span class="comment">    &quot;div&quot;,</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        key: &quot;435ksdfds&quot;,</span></span><br><span class="line"><span class="comment">        class: &quot;wrapper&quot;</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    React.createElement(&quot;span&quot;, null, &quot;matthew&quot;),</span></span><br><span class="line"><span class="comment">    React.createElement(&quot;span&quot;, null, &quot;green&quot;)</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">   * å¯ä»¥çœ‹åˆ°childrenä»ä¸‰ä¸ªå‚æ•°å¼€å§‹</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// æ‰¾åˆ°propsçš„childrenå±æ€§ï¼Œchildrenå¯èƒ½æ˜¯å¯¹è±¡ä¹Ÿå¯èƒ½æ˜¯æ•°ç»„</span></span><br><span class="line">  <span class="keyword">const</span> childrenLength = <span class="built_in">arguments</span>.length - <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> (childrenLength === <span class="number">1</span>) &#123;</span><br><span class="line">    props.children = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childrenLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> childArray = <span class="built_in">Array</span>(childrenLength);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      childArray[i] = <span class="built_in">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    props.children = childArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Resolve default props</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œåªæœ‰Classç»„ä»¶æ‰ä¼šèµ°åˆ°ï¼Œå› ä¸ºåŸç”Ÿæ ‡ç­¾typeå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æœ‰æ²¡æœ‰ä½¿ç”¨çš„æ˜¯undefined</span></span><br><span class="line">  <span class="keyword">if</span> (type &amp;&amp; type.defaultProps) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultProps = type.defaultProps;</span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> defaultProps) &#123;</span><br><span class="line">      <span class="keyword">if</span> (props[propName] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        props[propName] = defaultProps[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ReactElement(</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    ref,</span><br><span class="line">    self,</span><br><span class="line">    source,</span><br><span class="line">    ReactCurrentOwner.current, <span class="comment">// å½“å‰FiberèŠ‚ç‚¹, åé¢è§£æ</span></span><br><span class="line">    props</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactElement.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Factory method to create a new React element.</span></span><br><span class="line"><span class="comment"> * ä¸æ˜¯é€šè¿‡classæ¨¡å¼åˆ›å»ºçš„ï¼Œæ‰€ä»¥ä¸è¦ä½¿ç”¨new</span></span><br><span class="line"><span class="comment"> * ä¹Ÿä¸è¦ç”¨instanceOfæ£€æµ‹ç±»å‹ï¼Œè€Œå› è¯¥é€šè¿‡Symbol.for(&#x27;react.element&#x27;)æ£€æµ‹ç±»å‹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ReactElementè¿”å›ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * è¿™ä¹Ÿæ˜¯VDOM diffçš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ReactElement = <span class="function"><span class="keyword">function</span> (<span class="params">type, key, ref, self, source, owner, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡Symbolå”¯ä¸€ç¡®å®šæ˜¯å¦æ˜¯React Element</span></span><br><span class="line">    <span class="comment">// åŒæ—¶å…¼å…·å®‰å…¨çš„åŠŸèƒ½</span></span><br><span class="line">    <span class="comment">// Symbolå‚è€ƒï¼šhttps://www.jianshu.com/p/f6e0972b24d0</span></span><br><span class="line">    $$typeof: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">    type: type,</span><br><span class="line">    key: key,</span><br><span class="line">    ref: ref,</span><br><span class="line">    props: props,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">    _owner: owner, <span class="comment">// çˆ¶FiberèŠ‚ç‚¹</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\shared\ReactSymbols.js</span></span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰Symbolå°±ä½¿ç”¨ä¸€ä¸ªç®€å•çš„å­—ç¬¦</span></span><br><span class="line"><span class="keyword">const</span> hasSymbol = <span class="keyword">typeof</span> <span class="built_in">Symbol</span> === <span class="string">&quot;function&quot;</span> &amp;&amp; <span class="built_in">Symbol</span>.for;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REACT_ELEMENT_TYPE = hasSymbol</span><br><span class="line">  ? <span class="built_in">Symbol</span>.for(<span class="string">&quot;react.element&quot;</span>)</span><br><span class="line">  : <span class="number">0xeac7</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>React Element åªæ˜¯ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡ï¼Œç”¨æ¥å‘Šè¯‰ React æ€ä¹ˆåˆ›å»ºçœŸå®çš„ DOM</p>
</blockquote>
<blockquote>
<p>æ–°çš„ç–‘é—®ï¼š 1. $$typeof å¦‚ä½•ä½¿ç”¨çš„ 2. type, key, ref,owner å¦‚ä½•ä½¿ç”¨çš„</p>
</blockquote>
<h3 id="React-Component"><a href="#React-Component" class="headerlink" title="React Component"></a>React Component</h3><ul>
<li><p>ä»€ä¹ˆæ˜¯ React Componentï¼Ÿå’Œ React Element æœ‰å•¥ä¸ä¸€æ ·ï¼Ÿ</p>
</li>
<li><p>çŒœæµ‹ç»„ä»¶åº”è¯¥æ˜¯ React Element çš„é›†åˆï¼Œä¹Ÿå°±æ˜¯è¿”å›ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œåº”è¯¥è¿˜æä¾›ä¸€äº›æ–¹æ³•ç”¨äºæ›´æ–°å¸è½½æ•è·å¼‚å¸¸å§</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\ReactElement.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; Component, PureComponent &#125; <span class="keyword">from</span> <span class="string">&quot;./ReactBaseClasses&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactBaseClasses.js</span></span><br><span class="line"><span class="comment">// æ›´æ–°Component state çš„åŸºç±»</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params">props, context, updater</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.props = props;</span><br><span class="line">  <span class="comment">// read from getInitialState</span></span><br><span class="line">  <span class="comment">// å¯ç”¨äºè·¨å±‚çº§é€šä¿¡</span></span><br><span class="line">  <span class="built_in">this</span>.context = context;</span><br><span class="line">  <span class="comment">// If a component has string refs, we will assign a different object later.</span></span><br><span class="line">  <span class="built_in">this</span>.refs = emptyObject;</span><br><span class="line">  <span class="comment">// We initialize the default updater but the real one gets injected by the</span></span><br><span class="line">  <span class="comment">// renderer.</span></span><br><span class="line">  <span class="built_in">this</span>.updater = updater || ReactNoopUpdateQueue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Component.prototype.isReactComponent = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * this.stateæ˜¯ä¸å¯å˜çš„ï¼Œæƒ³è¦ä¿®æ”¹éœ€è¦æ‰‹åŠ¨è°ƒç”¨setStateä¿®æ”¹</span></span><br><span class="line"><span class="comment"> * this.state ä¸ä¸€å®šæ˜¯ç«‹å³æ›´æ–°çš„</span></span><br><span class="line"><span class="comment"> * setState ä¸ä¸€å®šæ˜¯åŒæ­¥çš„ï¼Œå› ä¸ºæœ‰å¯èƒ½æœ‰æ‰¹å¤„ç†ç¯èŠ‚</span></span><br><span class="line"><span class="comment"> * å¦‚æœæœ‰callbackï¼Œå®ƒå°†ä¼šå†setStateå®Œæˆåè°ƒç”¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;object|function&#125;</span> </span>partialState Next partial state or function to</span></span><br><span class="line"><span class="comment"> * produce next partial state to be merged with current state.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;?function&#125;</span> </span>callback Called after state is updated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span> (<span class="params">partialState, callback</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.updater.enqueueSetState(<span class="built_in">this</span>, partialState, callback, <span class="string">&quot;setState&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ç»„ä»¶çš„ state æˆ– props å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç»„ä»¶å°†é‡æ–°æ¸²æŸ“ã€‚</span></span><br><span class="line"><span class="comment"> * å¦‚æœ render æ–¹æ³•ä¾èµ–äºå…¶ä»–æ•°æ®ï¼Œåˆ™å¯ä»¥è°ƒç”¨ forceUpdate å¼ºåˆ¶è®©ç»„ä»¶é‡æ–°æ¸²æŸ“</span></span><br><span class="line"><span class="comment"> * ä¸ä¼šè°ƒç”¨ shouldComponentUpdateï¼Œä½†ä¼šè°ƒç”¨ componentWillUpdate å’Œ componentDidUpdate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Component.prototype.forceUpdate = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.updater.enqueueForceUpdate(<span class="built_in">this</span>, callback, <span class="string">&quot;forceUpdate&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å«æœ‰é»˜è®¤æµ…æ¯”è¾ƒçš„Component</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PureComponent</span>(<span class="params">props, context, updater</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.props = props;</span><br><span class="line">  <span class="built_in">this</span>.context = context;</span><br><span class="line">  <span class="built_in">this</span>.refs = emptyObject;</span><br><span class="line">  <span class="built_in">this</span>.updater = updater || ReactNoopUpdateQueue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pureComponentPrototype = (PureComponent.prototype = <span class="keyword">new</span> ComponentDummy());</span><br><span class="line">pureComponentPrototype.constructor = PureComponent;</span><br><span class="line"><span class="built_in">Object</span>.assign(pureComponentPrototype, Component.prototype);</span><br><span class="line"><span class="comment">// çœ‹èµ·æ¥å’ŒComponentå°±åªæœ‰ä¸‹é¢è¿™ç‚¹åŒºåˆ«äº†</span></span><br><span class="line">pureComponentPrototype.isPureReactComponent = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Component æ˜¯ä¸€ä¸ªåŸºç±»ï¼Œæä¾›äº† setState å’Œ forceUpdate ä¸¤ä¸ªæ–¹æ³•</p>
</blockquote>
<blockquote>
<p>æ–°çš„ç–‘é—®ï¼š setState å’Œ forceUpdate è²Œä¼¼è¿›äº† enqueueSetState é˜Ÿåˆ—ä¹‹ç±»çš„ä¸œè¥¿ï¼Œåé¢å‘ç”Ÿäº†ä»€ä¹ˆ</p>
</blockquote>
<h3 id="ReactRef-amp-ref"><a href="#ReactRef-amp-ref" class="headerlink" title="ReactRef &amp; ref"></a>ReactRef &amp; ref</h3><p>ç”¨äºè·å– DOM å®ä¾‹ï¼Œåº”è¯¥å°½é‡é¿å…è¿‡å¤šä½¿ç”¨</p>
<p>æœ‰ä¸‰ç§ä½¿ç”¨å§¿åŠ¿: <code>stringRef, function ref, React.createRef</code></p>
<p><a href="https://reactjs.org/docs/forwarding-refs.html">Forwarding Refs</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸¾ä¾‹ä½¿ç”¨ref</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.objRef = React.createRef();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–</span></span><br><span class="line">    <span class="comment">// this.refs.stringRef</span></span><br><span class="line">    <span class="comment">// this.methodRef</span></span><br><span class="line">    <span class="comment">// this.myRef.current</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;&gt;</span><br><span class="line">        &lt;p ref=<span class="string">&quot;stringRef&quot;</span>&gt;&lt;/p&gt;</span><br><span class="line">        &lt;p ref=&#123;<span class="function">(<span class="params">obj</span>) =&gt;</span> (<span class="built_in">this</span>.methodRef = obj)&#125;&gt;&lt;/p&gt;</span><br><span class="line">        &lt;p ref=&#123;<span class="built_in">this</span>.objRef&#125;&gt;&lt;/p&gt;</span><br><span class="line">      &lt;/&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\ReactCreateRef.js</span></span><br><span class="line"><span class="comment">// çœ‹äº†æºç çš„å‘ç°å°±è¿”å›äº†è¿™ä¹ˆä¸€ä¸ªç®€å•å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRef</span>(<span class="params"></span>): <span class="title">RefObject</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> refObject = &#123;</span><br><span class="line">    current: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> refObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ–°é—®é¢˜ï¼šComponent å’Œ createRef ä¸­ ref åç»­æ˜¯å¦‚ä½•ä½¿ç”¨çš„</p>
</blockquote>
<h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼ŒchildContextType(å³å°†åœ¨ react@17 ç‰ˆæœ¬ä¸­åºŸå¼ƒ), createContext</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// demos\src\context\index.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">&quot;prop-types&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Provider, Consumer &#125; = React.createContext();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    childContext: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">    newContext: <span class="string">&quot;456&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getChildContext</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">value</span>: <span class="built_in">this</span>.state.childContext &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;label&gt;childContext: &lt;/label&gt;</span><br><span class="line">          &lt;input</span><br><span class="line">            type=<span class="string">&quot;text&quot;</span></span><br><span class="line">            value=&#123;<span class="built_in">this</span>.state.childContext&#125;</span><br><span class="line">            onChange=&#123;<span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">childContext</span>: e.target.value &#125;)&#125;</span><br><span class="line">          /&gt;</span><br><span class="line"></span><br><span class="line">          &lt;br /&gt;</span><br><span class="line">          &lt;br /&gt;</span><br><span class="line">          &lt;label&gt;newContext: &lt;/label&gt;</span><br><span class="line">          &lt;input</span><br><span class="line">            type=<span class="string">&quot;text&quot;</span></span><br><span class="line">            value=&#123;<span class="built_in">this</span>.state.newContext&#125;</span><br><span class="line">            onChange=&#123;<span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">newContext</span>: e.target.value &#125;)&#125;</span><br><span class="line">          /&gt;</span><br><span class="line"></span><br><span class="line">          &lt;Provider value=&#123;<span class="built_in">this</span>.state.newContext&#125;&gt;</span><br><span class="line">            &#123;<span class="built_in">this</span>.props.children&#125;</span><br><span class="line">          &lt;/Provider&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Consumer</span>&gt;</span>&#123;(value) =&gt; <span class="tag">&lt;<span class="name">p</span>&gt;</span>newContext: &#123;value&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;<span class="tag">&lt;/<span class="name">Consumer</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child2</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>childContext: &#123;this.context.value&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¡å¿…ç”³æ˜ï¼Œå¦åˆ™æ‹¿ä¸åˆ°</span></span><br><span class="line">Child2.contextTypes = &#123;</span><br><span class="line">  value: PropTypes.string,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// åŠ¡å¿…ç”³æ˜ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line">Parent.childContextTypes = &#123;</span><br><span class="line">  value: PropTypes.string,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Demo = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Parent&gt;</span><br><span class="line">      &lt;Child1 /&gt;</span><br><span class="line">      &lt;Child2 /&gt;</span><br><span class="line">    &lt;/Parent&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Demo;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹çœ‹æºç </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\ReactElement.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createContext &#125; <span class="keyword">from</span> <span class="string">&quot;./ReactContext&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactContext.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContext</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  defaultValue: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  calculateChangedBits: ?(a: T, b: T) =&gt; number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ReactContext</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> context: ReactContext&lt;T&gt; = &#123;</span><br><span class="line">    $$typeof: REACT_CONTEXT_TYPE,</span><br><span class="line">    <span class="comment">// As a workaround to support multiple concurrent renderers, we categorize</span></span><br><span class="line">    <span class="comment">// some renderers as primary and others as secondary. We only expect</span></span><br><span class="line">    <span class="comment">// there to be two concurrent renderers at most: React Native (primary) and</span></span><br><span class="line">    <span class="comment">// Fabric (secondary); React DOM (primary) and React ART (secondary).</span></span><br><span class="line">    <span class="comment">// Secondary renderers store their context values on separate fields.</span></span><br><span class="line">    <span class="comment">// ä¸¤ä¸ªå˜é‡å€¼ç›¸åŒï¼Œæ˜¯åŒçš„åœ°æ–¹ä¸åŒè€Œå·²</span></span><br><span class="line">    _currentValue: defaultValue,</span><br><span class="line">    _currentValue2: defaultValue,</span><br><span class="line">    <span class="comment">// These are circular</span></span><br><span class="line">    Provider: (<span class="literal">null</span>: any),</span><br><span class="line">    Consumer: (<span class="literal">null</span>: any),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  context.Provider = &#123;</span><br><span class="line">    $$typeof: REACT_PROVIDER_TYPE,</span><br><span class="line">    _context: context,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆæŒ‡å‘äº†è‡ªå·±ï¼Œæ„å‘³ç€Consumerè¿˜å¯ä»¥æ˜¯Providerç»§ç»­å‘ä¸‹æ— é™ä¼ é€’</span></span><br><span class="line">  context.Consumer = context;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConcurrentMode"><a href="#ConcurrentMode" class="headerlink" title="ConcurrentMode"></a>ConcurrentMode</h3><p>ä¹‹å‰æ˜¯ AsyncMode<br>react@16 ä¹‹åæå‡ºçš„ä¸€ç§ä¼˜å…ˆçº§ç­–ç•¥ï¼Œå®ƒä½¿å¾— react çš„æ¸²æŸ“æ˜¯å¯ä»¥ä¸­æ–­çš„, ä»è€Œå¯ä»¥æ“ä½œæ¸²æŸ“è°ƒåº¦ï¼Œæœ€ç»ˆè®©æ¸²æŸ“æ›´åŠ æµç•…</p>
<p>æ¡ˆåˆ—å¯ä»¥å‚è€ƒ demo</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\React.js</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// unstable_ConcurrentModeåªæ˜¯ä¸€ä¸ªSymbol</span></span><br><span class="line">unstable_ConcurrentMode: REACT_CONCURRENT_MODE_TYPE,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="Suspense"><a href="#Suspense" class="headerlink" title="Suspense"></a>Suspense</h3><blockquote>
<p>å‚è€ƒï¼š<a href="https://www.infoq.cn/article/sVaeA7Y3pei2sYy_lK9e">React çš„æœªæ¥ï¼šä¸ Suspense å…±èˆ</a></p>
</blockquote>
<ul>
<li><p>React Suspense æ˜¯ç»„ä»¶ä»ç¼“å­˜ä¸­åŠ è½½æ•°æ®æ—¶æš‚åœå‘ˆç°çš„ä¸€ç§é€šè¡Œæ–¹æ³•ã€‚å®ƒè§£å†³çš„é—®é¢˜ï¼šæ¸²æŸ“æ˜¯å’Œ I/O ç»‘å®šæ—¶çš„æƒ…å†µã€‚</p>
</li>
<li><p>æ”¯æŒ lazy, æ­¤æ—¶ lazy çš„ç»„ä»¶ä¼šè¢« webpack è¿›è¡Œä»£ç åˆ†å‰²å¤„ç†</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// åœ¨åŒ…è£¹çš„å¼‚æ­¥ç»„ä»¶å…¨éƒ¨åŠ è½½å®Œæ¯•ä¹‹åSpinneræ‰æ¶ˆå¤±</span></span><br><span class="line">    &lt;React.Suspense fallback=&#123;<span class="xml"><span class="tag">&lt;<span class="name">Spinner</span> /&gt;</span></span>&#125;&gt;</span><br><span class="line">      &lt;LazyComponent /&gt;</span><br><span class="line">      &lt;LazyComponent2 /&gt;</span><br><span class="line">    &lt;/React.Suspense&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\React.js</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// Suspenseåªæ˜¯ä¸€ä¸ªSymbol</span></span><br><span class="line">Suspense: REACT_SUSPENSE_TYPE,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\React.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;lazy&#125; <span class="keyword">from</span> <span class="string">&#x27;./ReactLazy&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactLazy.js</span></span><br><span class="line"><span class="comment">// æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªthenableå‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">lazy</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt;(<span class="params">ctor: () =&gt; Thenable&lt;T, R&gt;</span>): <span class="title">LazyComponent</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    $$typeof: REACT_LAZY_TYPE,</span><br><span class="line">    _ctor: ctor,</span><br><span class="line">    <span class="comment">// React uses these fields to store the result.</span></span><br><span class="line">    _status: -<span class="number">1</span>,</span><br><span class="line">    _result: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Suspense åªæ˜¯ä¸€ä¸ª Symbol</p>
</blockquote>
<blockquote>
<p>æ–°çš„é—®é¢˜ï¼š ä¸€ä¸ª Symbol æ˜¯å¦‚ä½•æ‰¿è½½å…ƒç´ çš„ï¼Ÿ</p>
</blockquote>
<h3 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h3><blockquote>
<p><a href="https://reactjs.org/docs/hooks-intro.html">Hook ç®€ä»‹</a></p>
</blockquote>
<blockquote>
<p><a href="mailto:&#114;&#x65;&#97;&#x63;&#x74;&#x40;&#49;&#54;&#46;&#55;&#46;&#x30;">&#114;&#x65;&#97;&#x63;&#x74;&#x40;&#49;&#54;&#46;&#55;&#46;&#x30;</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\React.js</span></span><br><span class="line"><span class="keyword">if</span> (enableHooks) &#123;</span><br><span class="line">  React.useCallback = useCallback;</span><br><span class="line">  React.useContext = useContext;</span><br><span class="line">  React.useEffect = useEffect;</span><br><span class="line">  React.useImperativeMethods = useImperativeMethods;</span><br><span class="line">  React.useLayoutEffect = useLayoutEffect;</span><br><span class="line">  React.useMemo = useMemo;</span><br><span class="line">  React.useReducer = useReducer;</span><br><span class="line">  React.useRef = useRef;</span><br><span class="line">  React.useState = useState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactHooks.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useState</span>&lt;<span class="title">S</span>&gt;(<span class="params">initialState: (() =&gt; S) | S</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = resolveDispatcher();</span><br><span class="line">  <span class="keyword">return</span> dispatcher.useState(initialState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useEffect</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  create: () =&gt; mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  inputs: <span class="built_in">Array</span>&lt;mixed&gt; | <span class="keyword">void</span> | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = resolveDispatcher();</span><br><span class="line">  <span class="keyword">return</span> dispatcher.useEffect(create, inputs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸€æ­¥æ˜¯åœ¨domæ¸²æŸ“çš„æ—¶å€™æ‰æ‹¿åˆ°çš„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveDispatcher</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = ReactCurrentOwner.currentDispatcher;</span><br><span class="line">  <span class="keyword">return</span> dispatcher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸²æŸ“çš„æ—¶å€™ä»ä¸åŒå¹³å°ä¼ è¿›æ¥çš„å…¨å±€å¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> ReactCurrentOwner = &#123;</span><br><span class="line">  current: (<span class="literal">null</span>: <span class="literal">null</span> | Fiber),</span><br><span class="line">  currentDispatcher: (<span class="literal">null</span>: <span class="literal">null</span> | Dispatcher),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>hooks éƒ½æŒ‚è½½åœ¨ ReactCurrentOwner å…¨å±€å¯¹è±¡ä¸Š</p>
</blockquote>
<blockquote>
<p>æ–°çš„é—®é¢˜ï¼š ReactCurrentOwner æ˜¯ä»€ä¹ˆ</p>
</blockquote>
<h3 id="Children"><a href="#Children" class="headerlink" title="Children"></a>Children</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\React.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; forEach, map, count, toArray, only &#125; <span class="keyword">from</span> <span class="string">&quot;./ReactChildren&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> React = &#123;</span><br><span class="line">  Children: &#123;</span><br><span class="line">    map, <span class="comment">// å’Œæ™®é€šæ•°ç»„mapåŒºåˆ«åœ¨äºæœ€ç»ˆç»“æœæ˜¯ä¸€ç»´æ•°ç»„ï¼Œä¸ç®¡ä½ æ€ä¹ˆåµŒå¥—</span></span><br><span class="line">    forEach,</span><br><span class="line">    count,</span><br><span class="line">    toArray,</span><br><span class="line">    only,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactChildren.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapChildren</span>(<span class="params">children, func, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> result = [];</span><br><span class="line">  mapIntoWithKeyPrefixInternal(children, result, <span class="literal">null</span>, func, context);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mapChildren çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾ï¼š<br><img src="https://cdn.jsdelivr.net/gh/Matthrews/zm_cdn/images/mapChildren.png" alt="mapChildren"></p>
<p>çœ‹æ‡‚æµç¨‹å›¾æˆ‘ä»¬å†æ·±å…¥æºç </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\ReactChildren.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapIntoWithKeyPrefixInternal</span>(<span class="params">children, array, prefix, func, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> escapedPrefix = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (prefix != <span class="literal">null</span>) &#123;</span><br><span class="line">    escapedPrefix = escapeUserProvidedKey(prefix) + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> traverseContext = getPooledTraverseContext(</span><br><span class="line">    array,</span><br><span class="line">    escapedPrefix,</span><br><span class="line">    func,</span><br><span class="line">    context</span><br><span class="line">  );</span><br><span class="line">  traverseAllChildren(children, mapSingleChildIntoContext, traverseContext);</span><br><span class="line">  releaseTraverseContext(traverseContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mapSingleChildIntoContext</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapSingleChildIntoContext</span>(<span class="params">bookKeeping, child, childKey</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// bookKeepingå°±æ˜¯ä»å¯¹è±¡æ± é‡Œé¢å–å‡ºæ¥çš„traverseContext</span></span><br><span class="line">  <span class="keyword">const</span> &#123; result, keyPrefix, func, context &#125; = bookKeeping;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> mappedChild = func.call(context, child, bookKeeping.count++);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(mappedChild)) &#123;</span><br><span class="line">    <span class="comment">// å¤–å±‚é€’å½’ï¼Œæ­¤æ—¶å¯¹è±¡æ± çš„ä½œç”¨å°±ä½“ç°å‡ºæ¥äº†</span></span><br><span class="line">    mapIntoWithKeyPrefixInternal(mappedChild, result, childKey, <span class="function">(<span class="params">c</span>) =&gt;</span> c);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappedChild != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isValidElement(mappedChild)) &#123;</span><br><span class="line">      <span class="comment">// cloneAndReplaceKey</span></span><br><span class="line">      mappedChild = cloneAndReplaceKey(</span><br><span class="line">        mappedChild,</span><br><span class="line">        <span class="comment">// Keep both the (mapped) and old keys if they differ, just as</span></span><br><span class="line">        <span class="comment">// traverseAllChildren used to do for objects as children</span></span><br><span class="line">        keyPrefix +</span><br><span class="line">          (mappedChild.key &amp;&amp; (!child || child.key !== mappedChild.key)</span><br><span class="line">            ? escapeUserProvidedKey(mappedChild.key) + <span class="string">&quot;/&quot;</span></span><br><span class="line">            : <span class="string">&quot;&quot;</span>) +</span><br><span class="line">          childKey</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    result.push(mappedChild);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// traverseAllChildren</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverseAllChildren</span>(<span class="params">children, callback, traverseContext</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> traverseAllChildrenImpl(children, <span class="string">&quot;&quot;</span>, callback, traverseContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// traverseAllChildrenImpl</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverseAllChildrenImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children,</span></span></span><br><span class="line"><span class="function"><span class="params">  nameSoFar,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback,</span></span></span><br><span class="line"><span class="function"><span class="params">  traverseContext</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = <span class="keyword">typeof</span> children;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type === <span class="string">&quot;undefined&quot;</span> || type === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// All of the above are perceived as null.</span></span><br><span class="line">    children = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> invokeCallback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (children === <span class="literal">null</span>) &#123;</span><br><span class="line">    invokeCallback = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;string&quot;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;number&quot;</span>:</span><br><span class="line">        invokeCallback = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;object&quot;</span>:</span><br><span class="line">        <span class="keyword">switch</span> (children.$$typeof) &#123;</span><br><span class="line">          <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">            invokeCallback = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (invokeCallback) &#123;</span><br><span class="line">    callback(</span><br><span class="line">      traverseContext,</span><br><span class="line">      children,</span><br><span class="line">      <span class="comment">// If it&#x27;s the only child, treat the name as if it was wrapped in an array</span></span><br><span class="line">      <span class="comment">// so that it&#x27;s consistent if the number of children grows.</span></span><br><span class="line">      nameSoFar === <span class="string">&quot;&quot;</span> ? SEPARATOR + getComponentKey(children, <span class="number">0</span>) : nameSoFar</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> child;</span><br><span class="line">  <span class="keyword">let</span> nextName;</span><br><span class="line">  <span class="keyword">let</span> subtreeCount = <span class="number">0</span>; <span class="comment">// Count of children found in the current subtree.</span></span><br><span class="line">  <span class="keyword">const</span> nextNamePrefix =</span><br><span class="line">    nameSoFar === <span class="string">&quot;&quot;</span> ? SEPARATOR : nameSoFar + SUBSEPARATOR;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children)) &#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹é€’å½’è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">      child = children[i];</span><br><span class="line">      nextName = nextNamePrefix + getComponentKey(child, i);</span><br><span class="line">      subtreeCount += traverseAllChildrenImpl(</span><br><span class="line">        child,</span><br><span class="line">        nextName,</span><br><span class="line">        callback,</span><br><span class="line">        traverseContext</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> iteratorFn = getIteratorFn(children);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> iteratorFn === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> iterator = iteratorFn.call(children);</span><br><span class="line">      <span class="keyword">let</span> step;</span><br><span class="line">      <span class="keyword">let</span> ii = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (!(step = iterator.next()).done) &#123;</span><br><span class="line">        child = step.value;</span><br><span class="line">        nextName = nextNamePrefix + getComponentKey(child, ii++);</span><br><span class="line">        subtreeCount += traverseAllChildrenImpl(</span><br><span class="line">          child,</span><br><span class="line">          nextName,</span><br><span class="line">          callback,</span><br><span class="line">          traverseContext</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> subtreeCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> POOL_SIZE = <span class="number">10</span>;</span><br><span class="line"><span class="comment">// å¯¹è±¡æ± </span></span><br><span class="line"><span class="comment">// mapFunctionå¯èƒ½ä¼šé¢‘ç¹è°ƒç”¨ï¼Œå¯¹è±¡é¢‘ç¹å£°æ˜é‡Šæ”¾ä¼šå¾ˆæ¶ˆè€—å†…å­˜ï¼Œä½¿ç”¨å¯¹è±¡æ± ä¿å­˜å¯¹è±¡å¼•ç”¨ï¼Œé‡å¤åˆ©ç”¨å‡å°‘å†…å­˜åˆ›å»ºå›æ”¶å¼€é”€</span></span><br><span class="line"><span class="comment">// Reactåˆæˆäº‹ä»¶ç³»ç»Ÿä¸­ä¹Ÿç”¨åˆ°äº†å¯¹è±¡æ± è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</span></span><br><span class="line"><span class="comment">// æ­£å¸¸æƒ…å†µä¸‹å¯¹è±¡æ± é‡Œé¢åªæœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯å¦‚æœåƒä¸‹é¢è¿™æ ·è°ƒç”¨çš„æ—¶å€™å¯¹è±¡æ± é‡Œé¢å°±ä¸æ­¢ä¸€ä¸ªäº†ï¼ŒçœŸæ­£çš„æ•ˆæœä¹Ÿå°±å¼€å§‹ä½“ç°å‡ºæ¥äº†</span></span><br><span class="line"><span class="comment">// React.Children.map(props.children, (c) =&gt; [c, [c, [c, c]]])  å¯¹è±¡æ± é‡Œé¢æœ‰ä¸‰ä¸ª</span></span><br><span class="line"><span class="keyword">const</span> traverseContextPool = [];</span><br><span class="line"><span class="comment">// getPooledTraverseContext</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPooledTraverseContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  mapResult,</span></span></span><br><span class="line"><span class="function"><span class="params">  keyPrefix,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapContext</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (traverseContextPool.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> traverseContext = traverseContextPool.pop();</span><br><span class="line">    traverseContext.result = mapResult;</span><br><span class="line">    traverseContext.keyPrefix = keyPrefix;</span><br><span class="line">    traverseContext.func = mapFunction;</span><br><span class="line">    traverseContext.context = mapContext;</span><br><span class="line">    traverseContext.count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> traverseContext;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      result: mapResult,</span><br><span class="line">      keyPrefix: keyPrefix,</span><br><span class="line">      func: mapFunction,</span><br><span class="line">      context: mapContext,</span><br><span class="line">      count: <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// releaseTraverseContext</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">releaseTraverseContext</span>(<span class="params">traverseContext</span>) </span>&#123;</span><br><span class="line">  traverseContext.result = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.keyPrefix = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.func = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.context = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (traverseContextPool.length &lt; POOL_SIZE) &#123;</span><br><span class="line">    traverseContextPool.push(traverseContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸¤å±‚é€’å½’ï¼Œæœ€ç»ˆè¿”å›ä¸€ç»´æ•°ç»„<br>å­¦åˆ°ä¸€ä¸ªä¼˜åŒ–ï¼š å¯¹è±¡æ±  pool</p>
</blockquote>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ul>
<li><p>memo</p>
</li>
<li><p>Fragment StrictMode</p>
</li>
<li><p>cloneElement createFactory</p>
</li>
</ul>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>React åªæ˜¯åˆ›å»ºäº†ä¸€äº› DOM èŠ‚ç‚¹ï¼Œä»¥åŠä¸€äº› ref ç­‰ï¼Œå¹¶æ²¡æœ‰å…·ä½“çš„æ“ä½œï¼Œå¥½åƒæ˜¯ä¸€ä¸ªç©ºå£³å­ï¼Œè€Œ React-DOM å’Œ React-Native æ‰æ˜¯å…·ä½“å®ç°</p>
<blockquote>
<p><a href="https://github.com/Matthrews/react-core/tree/main/demos">æ¡ˆåˆ— Demo</a></p>
</blockquote>
<hr />

<h2 id="åˆ›å»ºå’Œæ›´æ–°"><a href="#åˆ›å»ºå’Œæ›´æ–°" class="headerlink" title="åˆ›å»ºå’Œæ›´æ–°"></a>åˆ›å»ºå’Œæ›´æ–°</h2><ul>
<li><p>ReactDOM.render/hydrate</p>
</li>
<li><p>setState/replaceState[åè€…å°†ä¼šåºŸå¼ƒ]</p>
</li>
<li><p>forceUpdate</p>
</li>
</ul>
<h3 id="ReactDOM-render-æ­¥éª¤"><a href="#ReactDOM-render-æ­¥éª¤" class="headerlink" title="ReactDOM.render æ­¥éª¤"></a>ReactDOM.render æ­¥éª¤</h3><ul>
<li><p>åˆ›å»º ReactRoot</p>
</li>
<li><p>åˆ›å»º FiberRoot å’Œ RootFiber</p>
</li>
<li><p>åˆ›å»º æ›´æ–°</p>
</li>
</ul>
<blockquote>
<p>åˆ›å»ºå®Œæ›´æ–°ï¼Œè¿›å…¥è°ƒåº¦æ¢èŠ‚ï¼Œè°ƒåº¦æ¢èŠ‚ä¸æ¥æš‚æ—¶ä¸è®²</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOM.js</span></span><br><span class="line"><span class="keyword">const</span> ReactDOM = &#123;</span><br><span class="line">  createPortal,</span><br><span class="line">  findDOMNode,</span><br><span class="line">  <span class="comment">// hydrate æ˜¯ React ä¸­æä¾›åœ¨åˆæ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œå»å¤ç”¨åŸæœ¬å·²ç»å­˜åœ¨çš„ DOM èŠ‚ç‚¹ï¼Œå‡å°‘é‡æ–°ç”ŸæˆèŠ‚ç‚¹ä»¥åŠåˆ é™¤åŸæœ¬ DOM èŠ‚ç‚¹çš„å¼€é”€ï¼Œæ¥åŠ é€Ÿåˆæ¬¡æ¸²æŸ“çš„åŠŸèƒ½ã€‚</span></span><br><span class="line">  <span class="comment">// ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯ æœåŠ¡ç«¯æ¸²æŸ“æˆ–è€…åƒ prerender ç­‰æƒ…å†µ ã€‚</span></span><br><span class="line">  <span class="comment">// ä¸renderåŒºåˆ«åœ¨äºç¬¬å››ä¸ªå‚æ•°</span></span><br><span class="line">  <span class="function"><span class="title">hydrate</span>(<span class="params">element: React$Node, container: DOMContainer, callback: ?<span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> throw or warn if we couldn&#x27;t hydrate?</span></span><br><span class="line">    <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      element,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      callback</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  render(</span><br><span class="line">    element: React$Element&lt;any&gt;,</span><br><span class="line">    container: DOMContainer,</span><br><span class="line">    callback: ?<span class="built_in">Function</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      element,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      callback</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  unstable_renderSubtreeIntoContainer,</span><br><span class="line">  unmountComponentAtNode,</span><br><span class="line">  unstable_createPortal, <span class="comment">// <span class="doctag">TODO:</span> remove in React 17</span></span><br><span class="line">  unstable_batchedUpdates: batchedUpdates,</span><br><span class="line">  unstable_interactiveUpdates: interactiveUpdates,</span><br><span class="line">  flushSync: flushSync,</span><br><span class="line">  unstable_createRoot: createRoot,</span><br><span class="line">  unstable_flushControlled: flushControlled,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ReactDOM;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆå¤§è‡´è¿‡ä¸€ä¸‹renderå‡½æ•°è°ƒç”¨é“¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOM.js</span></span><br><span class="line"><span class="comment">// ======================= //</span></span><br><span class="line"><span class="comment">// render</span></span><br><span class="line"><span class="comment">// legacyRenderSubtreeIntoContainer</span></span><br><span class="line"><span class="comment">//     return new ReactRoot(container, isConcurrent, shouldHydrate);</span></span><br><span class="line"><span class="comment">// ReactRoot</span></span><br><span class="line"><span class="comment">//     createContainer(container, isConcurrent, hydrate)</span></span><br><span class="line"><span class="comment">// ReactRoot.prototype.render = function()&#123;...&#125;</span></span><br><span class="line"><span class="comment">// ReactRoot.prototype.unmount = function()&#123;...&#125;</span></span><br><span class="line"><span class="comment">// ReactRoot.prototype.legacy_renderSubtreeIntoContainer = function()&#123;...&#125;</span></span><br><span class="line"><span class="comment">// ReactRoot.prototype.createBatch = function()&#123;...&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span></span><br><span class="line"><span class="comment">// ======================= //</span></span><br><span class="line"><span class="comment">// createContainer</span></span><br><span class="line"><span class="comment">//     return createFiberRoot(containerInfo, isConcurrent, hydrate)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberRoot.js</span></span><br><span class="line"><span class="comment">// ======================= //</span></span><br><span class="line"><span class="comment">// createFiberRoot</span></span><br><span class="line"><span class="comment">//     return root // æ­¤å¤„rootå°±æ˜¯FiberèŠ‚ç‚¹æ•°æ®å¯¹è±¡  æš‚æ—¶åœä¸‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å†è¯¦ç»†çœ‹ä¸‹renderå‡½æ•°</span></span><br><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOM.js</span></span><br><span class="line">ReactRoot.prototype.render = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?() =&gt; mixed</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Work</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  updateContainer(children, root, <span class="literal">null</span>, work._onCommit);</span><br><span class="line">  <span class="keyword">return</span> work;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = container.current;</span><br><span class="line">  <span class="keyword">const</span> currentTime = requestCurrentTime();</span><br><span class="line">  <span class="keyword">const</span> expirationTime = computeExpirationForFiber(currentTime, current);</span><br><span class="line">  <span class="keyword">return</span> updateContainerAtExpirationTime(</span><br><span class="line">    element,</span><br><span class="line">    container,</span><br><span class="line">    parentComponent,</span><br><span class="line">    expirationTime,</span><br><span class="line">    callback</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainerAtExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> scheduleRootUpdate(current, element, expirationTime, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleRootUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime);</span><br><span class="line">  flushPassiveEffects();</span><br><span class="line">  enqueueUpdate(current, update);</span><br><span class="line">  scheduleWork(current, expirationTime);</span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµç¨‹æœ‰ç‚¹å¤æ‚,æš‚æ—¶å…ˆæŠŠæµç¨‹è®°å½•ä¸‹æ¥</p>
</blockquote>
<blockquote>
<p>æ–°çš„é—®é¢˜ï¼š hydrate å¦‚ä½•å¤ç”¨å·²æœ‰ DOM èŠ‚ç‚¹ï¼Ÿ</p>
</blockquote>
<h3 id="FiberRoot"><a href="#FiberRoot" class="headerlink" title="FiberRoot"></a>FiberRoot</h3><ul>
<li><p>æ•´ä¸ªåº”ç”¨çš„èµ·ç‚¹</p>
</li>
<li><p>åŒ…å«æŒ‚è½½çš„èŠ‚ç‚¹</p>
</li>
<li><p>è®°å½•åº”ç”¨æ›´æ–°è¿‡ç¨‹ä¸­çš„å„ç§ä¿¡æ¯</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberRoot.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  isConcurrent: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Cyclic construction. This cheats the type system right now because</span></span><br><span class="line">  <span class="comment">// stateNode is any.</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(isConcurrent);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> root = (&#123;</span><br><span class="line">      <span class="comment">// The currently active root fiber. This is the mutable root of the tree.</span></span><br><span class="line">      <span class="comment">// å½“å‰åº”ç”¨å¯¹åº”çš„Fiberå¯¹è±¡ï¼Œæ˜¯Root Fiber</span></span><br><span class="line">      <span class="comment">// å…³äºFiberä¸‹èŠ‚åˆ†äº«</span></span><br><span class="line">      current: uninitializedFiber,</span><br><span class="line">      <span class="comment">// Any additional information from the host associated with this root.</span></span><br><span class="line">      <span class="comment">// rootèŠ‚ç‚¹ï¼Œrenderæ–¹æ³•æ¥å—çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">      containerInfo: containerInfo,</span><br><span class="line">      <span class="comment">// Used only by persistent updates.</span></span><br><span class="line">      <span class="comment">// åªæœ‰åœ¨æŒä¹…æ›´æ–°ä¸­ä¼šç”¨åˆ°ï¼Œä¹Ÿå°±æ˜¯ä¸æ”¯æŒå¢é‡æ›´æ–°çš„å¹³å°ï¼Œreact-domä¸ä¼šç”¨åˆ°</span></span><br><span class="line">      pendingChildren: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Suspendå’Œlazyç›¸å…³</span></span><br><span class="line">      pingCache: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The earliest and latest priority levels that are not known to be suspended.</span></span><br><span class="line">      <span class="comment">// æ ‡è®°æœ€æ–°å’Œæœ€è€çš„ä¸ç¡®å®šæ˜¯å¦ä¼šæŒ‚èµ·çš„ä»»åŠ¡</span></span><br><span class="line">      earliestPendingTime: NoWork,</span><br><span class="line">      latestPendingTime: NoWork,</span><br><span class="line">      <span class="comment">// The following priority levels are used to distinguish between 1)</span></span><br><span class="line">      <span class="comment">// uncommitted work, 2) uncommitted work that is suspended, and 3) uncommitted</span></span><br><span class="line">      <span class="comment">// work that may be unsuspended. We choose not to track each individual</span></span><br><span class="line">      <span class="comment">// pending level, trading granularity for performance.</span></span><br><span class="line">      <span class="comment">// The earliest and latest priority levels that are suspended from committing.</span></span><br><span class="line">      <span class="comment">// æ ‡è®°æœ€æ–°å’Œæœ€è€çš„åœ¨æäº¤æ—¶å€™è¢«æŒ‚èµ·çš„ä»»åŠ¡</span></span><br><span class="line">      earliestSuspendedTime: NoWork,</span><br><span class="line">      latestSuspendedTime: NoWork,</span><br><span class="line">      <span class="comment">// The latest priority level that was pinged by a resolved promise and can be retried.</span></span><br><span class="line">      <span class="comment">// æ ‡è®°æœ€æ–°çš„é€šè¿‡ä¸€ä¸ªpromiseè¢«resolveå¹¶ä¸”å¯ä»¥é‡æ–°å°è¯•çš„ä¼˜å…ˆçº§ä»»åŠ¡</span></span><br><span class="line">      latestPingedTime: NoWork,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If an error is thrown, and there are no more updates in the queue, we try</span></span><br><span class="line">      <span class="comment">// rendering from the root one more time, synchronously, before handling</span></span><br><span class="line">      <span class="comment">// the error.</span></span><br><span class="line">      <span class="comment">// å¦‚æœæœ‰é”™è¯¯å¹¶ä¸”æ²¡æœ‰æ›´å¤šçš„æ›´æ–°å­˜åœ¨ï¼Œæˆ‘ä»¬å°è¯•åœ¨å¤„ç†é”™è¯¯å‰åŒæ­¥é‡æ–°ä»å¤´æ¸²æŸ“</span></span><br><span class="line">      <span class="comment">// åœ¨rednerRootå‡ºç°æ— æ³•å¤„ç†çš„é”™è¯¯çš„æ—¶å€™ä¼šè¢«è®¾ç½®ä¸ºtrue</span></span><br><span class="line">      didError: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ ‡è®°æ­£åœ¨ç­‰å¾…æäº¤çš„ä»»åŠ¡</span></span><br><span class="line">      pendingCommitExpirationTime: NoWork,</span><br><span class="line">      <span class="comment">// A finished work-in-progress HostRoot that&#x27;s ready to be committed.</span></span><br><span class="line">      <span class="comment">// å·²ç»å®Œæˆçš„ä»»åŠ¡çš„FiberRootå¯¹è±¡ï¼Œå¦‚æœä½ åªæœ‰ä¸€ä¸ªRootï¼Œé‚£å®ƒæ°¸è¿œåªå¯èƒ½æ˜¯è¿™ä¸ªRootå¯¹ä¸‹ä¸ªçš„Fiberæˆ–è€…æ˜¯null</span></span><br><span class="line">      <span class="comment">// åœ¨commité˜¶æ®µåªä¼šå¤„ç†è¿™ä¸ªå€¼å¯¹åº”çš„ä»»åŠ¡</span></span><br><span class="line">      finishedWork: <span class="literal">null</span>,</span><br><span class="line">      <span class="comment">// åœ¨ä»»åŠ¡è¢«æŒ‚èµ·çš„æ—¶å€™é€šè¿‡setTimeoutè®¾ç½®çš„è¿”å›å†…å®¹ï¼Œç”¨æ¥ä¸‹ä¸€æ¬¡å¦‚æœæœ‰æ–°çš„ä»»åŠ¡æŒ‚èµ·æ—¶æ¸…ç†è¿˜æ²¡è§¦å‘çš„timeout</span></span><br><span class="line">      <span class="comment">// Timeout handle returned by setTimeout. Used to cancel a pending timeout, if</span></span><br><span class="line">      <span class="comment">// it&#x27;s superseded by a new one.</span></span><br><span class="line">      timeoutHandle: noTimeout,</span><br><span class="line">      <span class="comment">// Top context object, used by renderSubtreeIntoContainer</span></span><br><span class="line">      <span class="comment">// é¡¶å±‚contextå¯¹è±¡ï¼Œåªæœ‰ä¸»åŠ¨è°ƒç”¨`renderSubtreeIntoContainer`æ—¶æ‰ä¼šæœ‰ç”¨</span></span><br><span class="line">      context: <span class="literal">null</span>,</span><br><span class="line">      pendingContext: <span class="literal">null</span>,</span><br><span class="line">      <span class="comment">// Determines if we should attempt to hydrate on the initial mount</span></span><br><span class="line">      <span class="comment">// ç”¨æ¥ç¡®å®šç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™æ˜¯å¦éœ€è¦èåˆ</span></span><br><span class="line">      hydrate,</span><br><span class="line">      <span class="comment">// Remaining expiration time on this root.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Lift this into the renderer</span></span><br><span class="line">      <span class="comment">// å½“å‰rootä¸Šå‰©ä½™çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">      nextExpirationTimeToWorkOn: NoWork,</span><br><span class="line">      <span class="comment">// å½“å‰æ›´æ–°å¯¹åº”çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">      expirationTime: NoWork,</span><br><span class="line">      <span class="comment">// List of top-level batches. This list indicates whether a commit should be</span></span><br><span class="line">      <span class="comment">// deferred. Also contains completion callbacks.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Lift this into the renderer</span></span><br><span class="line">      <span class="comment">// é¡¶å±‚æ‰¹æ¬¡ï¼ˆæ‰¹å¤„ç†ä»»åŠ¡ï¼Ÿï¼‰è¿™ä¸ªå˜é‡æŒ‡æ˜ä¸€ä¸ªcommitæ˜¯å¦åº”è¯¥è¢«æ¨è¿Ÿ, åŒæ—¶åŒ…æ‹¬å®Œæˆä¹‹åçš„å›è°ƒ</span></span><br><span class="line">      firstBatch: <span class="literal">null</span>,</span><br><span class="line">      <span class="comment">// Linked-list of roots</span></span><br><span class="line">      <span class="comment">// rootä¹‹é—´å…³è”çš„é“¾è¡¨ç»“æ„</span></span><br><span class="line">      nextScheduledRoot: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FiberRoot ==&gt; current ==&gt; RootFiber</span></span><br><span class="line">  <span class="comment">// RootFiber ==&gt; stateNode  ==&gt; FiberRoot</span></span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h3><ul>
<li><p>æ¯ä¸€ä¸ª ReactElement å¯¹åº”ä¸€ä¸ª Fiber å¯¹è±¡</p>
</li>
<li><p>è®°å½•èŠ‚ç‚¹çš„å„ç§çŠ¶æ€</p>
</li>
<li><p>ä¸²è”æ•´ä¸ªåº”ç”¨æ€§æˆæ•°ç»“æ„</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiber.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params">isConcurrent: boolean</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> mode = isConcurrent ? ConcurrentMode | StrictMode : NoContext;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    <span class="comment">// Always collect profile timings when DevTools are present.</span></span><br><span class="line">    <span class="comment">// This enables DevTools to start capturing timing at any pointâ€“</span></span><br><span class="line">    <span class="comment">// Without some nodes in the tree having empty base times.</span></span><br><span class="line">    mode |= ProfileMode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createFiber(HostRoot, <span class="literal">null</span>, <span class="literal">null</span>, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a constructor function, rather than a POJO constructor, still</span></span><br><span class="line"><span class="comment">// please ensure we do the following:</span></span><br><span class="line"><span class="comment">// 1) Nobody should add any instance methods on this. Instance methods can be</span></span><br><span class="line"><span class="comment">//    more difficult to predict when they get optimized and they are almost</span></span><br><span class="line"><span class="comment">//    never inlined properly in static compilers.</span></span><br><span class="line"><span class="comment">// 2) Nobody should rely on `instanceof Fiber` for type testing. We should</span></span><br><span class="line"><span class="comment">//    always know when it is a fiber.</span></span><br><span class="line"><span class="comment">// 3) We might want to experiment with using numeric keys since they are easier</span></span><br><span class="line"><span class="comment">//    to optimize in a non-JIT environment.</span></span><br><span class="line"><span class="comment">// 4) We can easily go from a constructor to a createFiber object literal if that</span></span><br><span class="line"><span class="comment">//    is faster.</span></span><br><span class="line"><span class="comment">// 5) It should be easy to port this to a C struct and keep a C implementation</span></span><br><span class="line"><span class="comment">//    compatible.</span></span><br><span class="line"><span class="keyword">const</span> createFiber = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="literal">null</span> | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="comment">// $FlowFixMe: the shapes are exact here but Flow doesn&#x27;t like constructors</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A Fiber is work on a Component that needs to be done or was done. There can</span></span><br><span class="line"><span class="comment">// be more than one per component.</span></span><br><span class="line"><span class="comment">// Fiberå¯¹åº”ä¸€ä¸ªç»„ä»¶éœ€è¦è¢«å¤„ç†æˆ–è€…å·²ç»å¤„ç†äº†ï¼Œä¸€ä¸ªç»„ä»¶å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªFiber</span></span><br><span class="line"><span class="keyword">export</span> type Fiber = &#123;|</span><br><span class="line">  <span class="comment">// These first fields are conceptually members of an Instance. This used to</span></span><br><span class="line">  <span class="comment">// be split into a separate type and intersected with the other Fiber fields,</span></span><br><span class="line">  <span class="comment">// but until Flow fixes its intersection bugs, we&#x27;ve merged them into a</span></span><br><span class="line">  <span class="comment">// single type.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// An Instance is shared between all versions of a component. We can easily</span></span><br><span class="line">  <span class="comment">// break this out into a separate object to avoid copying so much to the</span></span><br><span class="line">  <span class="comment">// alternate versions of the tree. We put this on a single object for now to</span></span><br><span class="line">  <span class="comment">// minimize the number of objects created during the initial render.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tag identifying the type of fiber.</span></span><br><span class="line">  <span class="comment">// æ ‡è®°ä¸åŒçš„ç»„ä»¶ç±»å‹</span></span><br><span class="line">  tag: WorkTag,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Unique identifier of this child.</span></span><br><span class="line">  <span class="comment">// ReactElementé‡Œé¢çš„key</span></span><br><span class="line">  key: <span class="literal">null</span> | string,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The value of element.type which is used to preserve the identity during</span></span><br><span class="line">  <span class="comment">// reconciliation of this child.</span></span><br><span class="line">  <span class="comment">// ReactElement.typeï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è°ƒç”¨`createElement`çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">  elementType: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The resolved function/class/ associated with this fiber.</span></span><br><span class="line">  <span class="comment">// å¼‚æ­¥ç»„ä»¶resolvedä¹‹åè¿”å›çš„å†…å®¹ï¼Œä¸€èˆ¬æ˜¯`function`æˆ–è€…`class`</span></span><br><span class="line">  type: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The local state associated with this fiber.</span></span><br><span class="line">  <span class="comment">// è·Ÿå½“å‰Fiberç›¸å…³æœ¬åœ°çŠ¶æ€ï¼ˆæ¯”å¦‚æµè§ˆå™¨ç¯å¢ƒå°±æ˜¯DOMèŠ‚ç‚¹ï¼‰</span></span><br><span class="line">  stateNode: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases</span></span><br><span class="line">  <span class="comment">// parent : Instance -&gt; return The parent happens to be the same as the</span></span><br><span class="line">  <span class="comment">// return fiber since we&#x27;ve merged the fiber and instance.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remaining fields belong to Fiber</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The Fiber to return to after finishing processing this one.</span></span><br><span class="line">  <span class="comment">// This is effectively the parent, but there can be multiple parents (two)</span></span><br><span class="line">  <span class="comment">// so this is only the parent of the thing we&#x27;re currently processing.</span></span><br><span class="line">  <span class="comment">// It is conceptually the same as the return address of a stack frame.</span></span><br><span class="line">  <span class="comment">// æŒ‡å‘ä»–åœ¨FiberèŠ‚ç‚¹æ ‘ä¸­çš„`parent`ï¼Œç”¨æ¥åœ¨å¤„ç†å®Œè¿™ä¸ªèŠ‚ç‚¹ä¹‹åå‘ä¸Šè¿”å›</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly Linked List Tree Structure.</span></span><br><span class="line">  <span class="comment">// å•é“¾è¡¨æ ‘ç»“æ„</span></span><br><span class="line">  <span class="comment">// æŒ‡å‘è‡ªå·±çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æŒ‡å‘è‡ªå·±çš„å…„å¼Ÿç»“æ„</span></span><br><span class="line">  <span class="comment">// å…„å¼ŸèŠ‚ç‚¹çš„returnæŒ‡å‘åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥æˆ‘ä»¬ä¼šå‘ç°çˆ¶èŠ‚ç‚¹ä¸æ˜¯æŒ‡å‘æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè€Œæ˜¯æŒ‡å‘ç¬¬ä¸€ä¸ªå­ç»“ç‚¹ï¼Œç„¶åå­ç»“ç‚¹ä¹‹é—´é€šè¿‡siblingä¸²è”ï¼Œå¹¶ä¸”æ‰€æœ‰å­èŠ‚ç‚¹éƒ½é€šè¿‡returnæŒ‡å‘çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">  index: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The ref last used to attach this node.</span></span><br><span class="line">  <span class="comment">// I&#x27;ll avoid adding an owner field for prod and model that as functions.</span></span><br><span class="line">  <span class="comment">// refå±æ€§</span></span><br><span class="line">  ref: <span class="literal">null</span> | ((<span class="function">(<span class="params">handle: mixed</span>) =&gt;</span> <span class="keyword">void</span>) &amp; &#123; <span class="attr">_stringRef</span>: ?string &#125;) | RefObject,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Input is the data coming into process this fiber. Arguments. Props.</span></span><br><span class="line">  <span class="comment">// æ–°çš„å˜åŠ¨å¸¦æ¥çš„æ–°çš„props</span></span><br><span class="line">  pendingProps: any, <span class="comment">// This type will be more specific once we overload the tag.</span></span><br><span class="line">  <span class="comment">// ä¸Šä¸€æ¬¡æ¸²æŸ“å®Œæˆä¹‹åçš„props</span></span><br><span class="line">  memoizedProps: any, <span class="comment">// The props used to create the output.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// A queue of state updates and callbacks.</span></span><br><span class="line">  <span class="comment">// è¯¥Fiberå¯¹åº”çš„ç»„ä»¶äº§ç”Ÿçš„Updateä¼šå­˜æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢</span></span><br><span class="line">  updateQueue: UpdateQueue&lt;any&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The state used to create the output</span></span><br><span class="line">  <span class="comment">// ä¸Šä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™çš„state</span></span><br><span class="line">  memoizedState: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A linked-list of contexts that this fiber depends on</span></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªåˆ—è¡¨ï¼Œå­˜æ”¾è¿™ä¸ªFiberä¾èµ–çš„context</span></span><br><span class="line">  firstContextDependency: ContextDependency&lt;mixed&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bitfield that describes properties about the fiber and its subtree. E.g.</span></span><br><span class="line">  <span class="comment">// the ConcurrentMode flag indicates whether the subtree should be async-by-</span></span><br><span class="line">  <span class="comment">// default. When a fiber is created, it inherits the mode of its</span></span><br><span class="line">  <span class="comment">// parent. Additional flags can be set at creation time, but after that the</span></span><br><span class="line">  <span class="comment">// value should remain unchanged throughout the fiber&#x27;s lifetime, particularly</span></span><br><span class="line">  <span class="comment">// before its child fibers are created.</span></span><br><span class="line">  <span class="comment">// ç”¨æ¥æè¿°å½“å‰Fiberå’Œä»–å­æ ‘çš„`Bitfield`</span></span><br><span class="line">  <span class="comment">// å…±å­˜çš„æ¨¡å¼è¡¨ç¤ºè¿™ä¸ªå­æ ‘æ˜¯å¦é»˜è®¤æ˜¯å¼‚æ­¥æ¸²æŸ“çš„</span></span><br><span class="line">  <span class="comment">// Fiberè¢«åˆ›å»ºçš„æ—¶å€™ä»–ä¼šç»§æ‰¿çˆ¶Fiber</span></span><br><span class="line">  <span class="comment">// å…¶ä»–çš„æ ‡è¯†ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºçš„æ—¶å€™è¢«è®¾ç½®</span></span><br><span class="line">  <span class="comment">// ä½†æ˜¯åœ¨åˆ›å»ºä¹‹åä¸åº”è¯¥å†è¢«ä¿®æ”¹ï¼Œç‰¹åˆ«æ˜¯ä»–çš„å­Fiberåˆ›å»ºä¹‹å‰</span></span><br><span class="line">  mode: TypeOfMode,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effect</span></span><br><span class="line">  <span class="comment">// ç”¨æ¥è®°å½•Side Effect</span></span><br><span class="line">  effectTag: SideEffectTag,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly linked list fast path to the next fiber with side-effects.</span></span><br><span class="line">  <span class="comment">// å•é“¾è¡¨ç”¨æ¥å¿«é€ŸæŸ¥æ‰¾ä¸‹ä¸€ä¸ªside effect</span></span><br><span class="line">  nextEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The first and last fiber with side-effect within this subtree. This allows</span></span><br><span class="line">  <span class="comment">// us to reuse a slice of the linked list when we reuse the work done within</span></span><br><span class="line">  <span class="comment">// this fiber.</span></span><br><span class="line">  <span class="comment">// å­æ ‘ä¸­ç¬¬ä¸€ä¸ªside effect</span></span><br><span class="line">  firstEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å­æ ‘ä¸­æœ€åä¸€ä¸ªside effect</span></span><br><span class="line">  lastEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Represents a time in the future by which this work should be completed.</span></span><br><span class="line">  <span class="comment">// Does not include work found in its subtree.</span></span><br><span class="line">  <span class="comment">// ä»£è¡¨ä»»åŠ¡åœ¨æœªæ¥çš„å“ªä¸ªæ—¶é—´ç‚¹åº”è¯¥è¢«å®Œæˆ</span></span><br><span class="line">  <span class="comment">// ä¸åŒ…æ‹¬ä»–çš„å­æ ‘äº§ç”Ÿçš„ä»»åŠ¡</span></span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is used to quickly determine if a subtree has no pending changes.</span></span><br><span class="line">  <span class="comment">// å¿«é€Ÿç¡®å®šå­æ ‘ä¸­æ˜¯å¦æœ‰ä¸åœ¨ç­‰å¾…çš„å˜åŒ–</span></span><br><span class="line">  childExpirationTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is a pooled version of a Fiber. Every fiber that gets updated will</span></span><br><span class="line">  <span class="comment">// eventually have a pair. There are cases when we can clean up pairs to save</span></span><br><span class="line">  <span class="comment">// memory if we need to.</span></span><br><span class="line">  <span class="comment">// åœ¨Fiberæ ‘æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªFiberéƒ½ä¼šæœ‰ä¸€ä¸ªè·Ÿå…¶å¯¹åº”çš„Fiber</span></span><br><span class="line">  <span class="comment">// æˆ‘ä»¬ç§°ä»–ä¸º`current &lt;==&gt; workInProgress`</span></span><br><span class="line">  <span class="comment">// åœ¨æ¸²æŸ“å®Œæˆä¹‹åä»–ä»¬ä¼šäº¤æ¢ä½ç½®</span></span><br><span class="line">  alternate: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸‹é¢æ˜¯è°ƒè¯•ç›¸å…³çš„ï¼Œæ”¶é›†æ¯ä¸ªFiberå’Œå­æ ‘æ¸²æŸ“æ—¶é—´çš„</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Time spent rendering this Fiber and its descendants for the current update.</span></span><br><span class="line">  <span class="comment">// This tells us how well the tree makes use of sCU for memoization.</span></span><br><span class="line">  <span class="comment">// It is reset to 0 each time we render and only updated when we don&#x27;t bailout.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  actualDuration?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the Fiber is currently active in the &quot;render&quot; phase,</span></span><br><span class="line">  <span class="comment">// This marks the time at which the work began.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  actualStartTime?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Duration of the most recent render time for this Fiber.</span></span><br><span class="line">  <span class="comment">// This value is not updated when we bailout for memoization purposes.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  selfBaseDuration?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sum of base times for all descedents of this Fiber.</span></span><br><span class="line">  <span class="comment">// This value bubbles up during the &quot;complete&quot; phase.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  treeBaseDuration?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases</span></span><br><span class="line">  <span class="comment">// workInProgress : Fiber -&gt;  alternate The alternate used for reuse happens</span></span><br><span class="line">  <span class="comment">// to be the same as work in progress.</span></span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Update-amp-UpdateQueue"><a href="#Update-amp-UpdateQueue" class="headerlink" title="Update &amp; UpdateQueue"></a>Update &amp; UpdateQueue</h3><ul>
<li><p>ç”¨äºè®°å½•ç»„ä»¶çŠ¶æ€çš„æ”¹å˜</p>
</li>
<li><p>å­˜æ”¾äº UpdateQueue é‡Œé¢</p>
</li>
<li><p>å¤šä¸ª Update å¯ä»¥åŒæ—¶å…±å­˜</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type Update&lt;State&gt; = &#123;</span><br><span class="line">  <span class="comment">// æ›´æ–°çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// export const UpdateState = 0;</span></span><br><span class="line">  <span class="comment">// export const ReplaceState = 1;</span></span><br><span class="line">  <span class="comment">// export const ForceUpdate = 2;</span></span><br><span class="line">  <span class="comment">// export const CaptureUpdate = 3;</span></span><br><span class="line">  <span class="comment">// æŒ‡å®šæ›´æ–°çš„ç±»å‹ï¼Œå€¼ä¸ºä»¥ä¸Šå‡ ç§</span></span><br><span class="line">  tag: <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>,</span><br><span class="line">  <span class="comment">// æ›´æ–°å†…å®¹ï¼Œæ¯”å¦‚`setState`æ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">  payload: any,</span><br><span class="line">  <span class="comment">// å¯¹åº”çš„å›è°ƒï¼Œ`setState`ï¼Œ`render`éƒ½æœ‰</span></span><br><span class="line">  callback: (<span class="function">() =&gt;</span> mixed) | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªæ›´æ–°</span></span><br><span class="line">  next: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ª`side effect`</span></span><br><span class="line">  nextEffect: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">  <span class="comment">// æ¯ä¸€æ¬¡æ“ä½œå®Œæ›´æ–°ä¹‹åçš„`state`</span></span><br><span class="line">  baseState: State,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ª`Update`</span></span><br><span class="line">  firstUpdate: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ª`Update`</span></span><br><span class="line">  lastUpdate: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ªæ•è·ç±»å‹çš„`Update`</span></span><br><span class="line">  firstCapturedUpdate: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æœ€åä¸€ä¸ªæ•è·ç±»å‹çš„`Update`</span></span><br><span class="line">  lastCapturedUpdate: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ª`side effect`</span></span><br><span class="line">  firstEffect: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æœ€åä¸€ä¸ª`side effect`</span></span><br><span class="line">  lastEffect: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ•è·äº§ç”Ÿçš„`side effect`</span></span><br><span class="line">  firstCapturedEffect: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">  lastCapturedEffect: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createUpdate</span>(<span class="params">expirationTime: ExpirationTime</span>): <span class="title">Update</span>&lt;*&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    expirationTime: expirationTime,</span><br><span class="line"></span><br><span class="line">    tag: <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">    payload: <span class="literal">null</span>,</span><br><span class="line">    callback: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">    nextEffect: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params">baseState: State</span>): <span class="title">UpdateQueue</span>&lt;<span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">    baseState,</span><br><span class="line">    firstUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastUpdate: <span class="literal">null</span>,</span><br><span class="line">    firstCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line">    firstEffect: <span class="literal">null</span>,</span><br><span class="line">    lastEffect: <span class="literal">null</span>,</span><br><span class="line">    firstCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentQueue: UpdateQueue&lt;State&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">UpdateQueue</span>&lt;<span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">    baseState: currentQueue.baseState,</span><br><span class="line">    firstUpdate: currentQueue.firstUpdate,</span><br><span class="line">    lastUpdate: currentQueue.lastUpdate,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> With resuming, if we bail out and resuse the child tree, we should</span></span><br><span class="line">    <span class="comment">// keep these effects.</span></span><br><span class="line">    firstCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    firstEffect: <span class="literal">null</span>,</span><br><span class="line">    lastEffect: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    firstCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">appendUpdateToQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  queue: UpdateQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">  <span class="keyword">if</span> (queue.lastUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Queue is empty</span></span><br><span class="line">    queue.firstUpdate = queue.lastUpdate = update;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queue.lastUpdate.next = update;</span><br><span class="line">    queue.lastUpdate = update;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params">fiber: Fiber, update: Update&lt;State&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Update queues are created lazily.</span></span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.alternate;</span><br><span class="line">  <span class="keyword">let</span> queue1;</span><br><span class="line">  <span class="keyword">let</span> queue2;</span><br><span class="line">  <span class="keyword">if</span> (alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s only one fiber.</span></span><br><span class="line">    queue1 = fiber.updateQueue;</span><br><span class="line">    queue2 = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (queue1 === <span class="literal">null</span>) &#123;</span><br><span class="line">      queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There are two owners.</span></span><br><span class="line">    queue1 = fiber.updateQueue;</span><br><span class="line">    queue2 = alternate.updateQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue1 === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (queue2 === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Neither fiber has an update queue. Create new ones.</span></span><br><span class="line">        queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span><br><span class="line">        queue2 = alternate.updateQueue = createUpdateQueue(</span><br><span class="line">          alternate.memoizedState</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Only one fiber has an update queue. Clone to create a new one.</span></span><br><span class="line">        queue1 = fiber.updateQueue = cloneUpdateQueue(queue2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (queue2 === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Only one fiber has an update queue. Clone to create a new one.</span></span><br><span class="line">        queue2 = alternate.updateQueue = cloneUpdateQueue(queue1);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Both owners have an update queue.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (queue2 === <span class="literal">null</span> || queue1 === queue2) &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s only a single queue.</span></span><br><span class="line">    appendUpdateToQueue(queue1, update);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There are two queues. We need to append the update to both queues,</span></span><br><span class="line">    <span class="comment">// while accounting for the persistent structure of the list â€” we don&#x27;t</span></span><br><span class="line">    <span class="comment">// want the same update to be added multiple times.</span></span><br><span class="line">    <span class="keyword">if</span> (queue1.lastUpdate === <span class="literal">null</span> || queue2.lastUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// One of the queues is not empty. We must add the update to both queues.</span></span><br><span class="line">      appendUpdateToQueue(queue1, update);</span><br><span class="line">      appendUpdateToQueue(queue2, update);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Both queues are non-empty. The last update is the same in both lists,</span></span><br><span class="line">      <span class="comment">// because of structural sharing. So, only append to one of the lists.</span></span><br><span class="line">      appendUpdateToQueue(queue1, update);</span><br><span class="line">      <span class="comment">// But we still need to update the `lastUpdate` pointer of queue2.</span></span><br><span class="line">      queue2.lastUpdate = update;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="expirationTime"><a href="#expirationTime" class="headerlink" title="expirationTime"></a>expirationTime</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="comment">// computeExpirationForFiber</span></span><br><span class="line"><span class="comment">//    computeInteractiveExpiration</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberExpirationTime.js</span></span><br><span class="line"><span class="comment">// computeInteractiveExpiration</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ€ç»ˆè®¡ç®—å…¬å¼ï¼š((((currentTime - 2 + 5000 / 10) / 25) | 0) + 1) * 25</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¸åŒç±»å‹çš„-expirationTime"><a href="#ä¸åŒç±»å‹çš„-expirationTime" class="headerlink" title="ä¸åŒç±»å‹çš„ expirationTime"></a>ä¸åŒç±»å‹çš„ expirationTime</h3><ul>
<li><p>Sync æ¨¡å¼ï¼Œä¼˜å…ˆçº§æœ€é«˜</p>
</li>
<li><p>Asnyc/Concurrent æ¨¡å¼</p>
</li>
<li><p>æŒ‡å®š context æ¨¡å¼</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeExpirationForFiber</span>(<span class="params">currentTime: ExpirationTime, fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (expirationContext !== NoWork) &#123;</span><br><span class="line">    <span class="comment">// An explicit expiration context was set;</span></span><br><span class="line">    expirationTime = expirationContext;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isWorking) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCommitting) &#123;</span><br><span class="line">      <span class="comment">// Updates that occur during the commit phase should have sync priority</span></span><br><span class="line">      <span class="comment">// by default.</span></span><br><span class="line">      expirationTime = Sync;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Updates during the render phase should expire at the same time as</span></span><br><span class="line">      <span class="comment">// the work that is being rendered.</span></span><br><span class="line">      expirationTime = nextRenderExpirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No explicit expiration context was set, and we&#x27;re not currently</span></span><br><span class="line">    <span class="comment">// performing work. Calculate a new expiration time.</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.mode &amp; ConcurrentMode) &#123;</span><br><span class="line">      <span class="comment">// å¾€å¾€æ˜¯äº‹ä»¶onClickç­‰</span></span><br><span class="line">      <span class="keyword">if</span> (isBatchingInteractiveUpdates) &#123;</span><br><span class="line">        <span class="comment">// This is an interactive update</span></span><br><span class="line">        expirationTime = computeInteractiveExpiration(currentTime);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is an async update</span></span><br><span class="line">        expirationTime = computeAsyncExpiration(currentTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If we&#x27;re in the middle of rendering a tree, do not update at the same</span></span><br><span class="line">      <span class="comment">// expiration time that is already rendering.</span></span><br><span class="line">      <span class="keyword">if</span> (nextRoot !== <span class="literal">null</span> &amp;&amp; expirationTime === nextRenderExpirationTime) &#123;</span><br><span class="line">        expirationTime -= <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is a sync update</span></span><br><span class="line">      expirationTime = Sync;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBatchingInteractiveUpdates) &#123;</span><br><span class="line">    <span class="comment">// This is an interactive update. Keep track of the lowest pending</span></span><br><span class="line">    <span class="comment">// interactive expiration time. This allows us to synchronously flush</span></span><br><span class="line">    <span class="comment">// all interactive updates when needed.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      lowestPriorityPendingInteractiveExpirationTime === NoWork ||</span><br><span class="line">      expirationTime &lt; lowestPriorityPendingInteractiveExpirationTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      lowestPriorityPendingInteractiveExpirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactTypeOfMode.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type TypeOfMode = number;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoContext = <span class="number">0b000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ConcurrentMode = <span class="number">0b001</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> StrictMode = <span class="number">0b010</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ProfileMode = <span class="number">0b100</span>;</span><br><span class="line"><span class="comment">// fiber.mode &amp; ConcurrentModeè¡¨ç¤ºfiber.modeä¸­æ˜¯å¦åŒ…å«ConcurrentMode</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨äºŒè¿›åˆ¶ä¾¿äºç»„åˆï¼Œå¯å‚è€ƒï¼šhttps://blog.csdn.net/zl544434558/article/details/79252751</span></span><br><span class="line"><span class="comment">// å…³äºä½è¿ç®—çš„æ€§åªï¼Œå¯å‚è€ƒï¼šhttps://www.jianshu.com/p/7faf7c22c146</span></span><br><span class="line"><span class="comment">// fiber.mode |= ConcurrentMode  æ·»åŠ ç±»å‹ConcurrentMode</span></span><br><span class="line"><span class="comment">// fiber.mode ^ ConcurrentMode  æå‡ºç±»å‹ConcurrentMode</span></span><br></pre></td></tr></table></figure>

<h3 id="setState-forceUpdate"><a href="#setState-forceUpdate" class="headerlink" title="setState/forceUpdate"></a>setState/forceUpdate</h3><ul>
<li><p>ç»™èŠ‚ç‚¹çš„<code>Fiber</code>åˆ›å»ºæ›´æ–°</p>
</li>
<li><p>æ›´æ–°ç±»å‹ä¸åŒ</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\ReactBaseClasses.js</span></span><br><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span> (<span class="params">partialState, callback</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.updater.enqueueSetState(<span class="built_in">this</span>, partialState, callback, <span class="string">&quot;setState&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Component.prototype.forceUpdate = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.updater.enqueueForceUpdate(<span class="built_in">this</span>, callback, <span class="string">&quot;forceUpdate&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberClassComponent.js</span></span><br><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  isMounted,</span><br><span class="line">  <span class="comment">// å¯ä»¥çœ‹åˆ°å’ŒupdateContaineræ–¹æ³•æµç¨‹æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">  <span class="function"><span class="title">enqueueSetState</span>(<span class="params">inst, payload, callback</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = getInstance(inst);</span><br><span class="line">    <span class="keyword">const</span> currentTime = requestCurrentTime();</span><br><span class="line">    <span class="keyword">const</span> expirationTime = computeExpirationForFiber(currentTime, fiber);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = createUpdate(expirationTime);</span><br><span class="line">    update.payload = payload;</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.callback = callback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">    enqueueUpdate(fiber, update);</span><br><span class="line">    scheduleWork(fiber, expirationTime);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// å’ŒenqueueSetStateå”¯ä¸€çš„å·®åˆ«å°±åœ¨ç±»å‹ä¸Šupdate.tag</span></span><br><span class="line">  <span class="function"><span class="title">enqueueForceUpdate</span>(<span class="params">inst, callback</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = getInstance(inst);</span><br><span class="line">    <span class="keyword">const</span> currentTime = requestCurrentTime();</span><br><span class="line">    <span class="keyword">const</span> expirationTime = computeExpirationForFiber(currentTime, fiber);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = createUpdate(expirationTime);</span><br><span class="line">    <span class="comment">// enqueueForceUpdateæ ‡è®°ç±»å‹æ˜¯ForceUpdate</span></span><br><span class="line">    <span class="comment">// export const UpdateState = 0;</span></span><br><span class="line">    <span class="comment">// export const ReplaceState = 1;</span></span><br><span class="line">    <span class="comment">// export const ForceUpdate = 2;</span></span><br><span class="line">    <span class="comment">// export const CaptureUpdate = 3;</span></span><br><span class="line">    update.tag = ForceUpdate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.callback = callback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">    enqueueUpdate(fiber, update);</span><br><span class="line">    scheduleWork(fiber, expirationTime);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="fiber-conciler"><a href="#fiber-conciler" class="headerlink" title="fiber-conciler"></a>fiber-conciler</h2><p>åŸºäº<code>Fiber</code>ï¼Œç»™ä»»åŠ¡åŒºåˆ†ä¸åŒä¼˜å…ˆçº§ï¼Œä»¥æ›´å¥½åœ°æ§åˆ¶æ¸²æŸ“</p>
<h3 id="FiberReconciler-æ€»ä½“æµç¨‹"><a href="#FiberReconciler-æ€»ä½“æµç¨‹" class="headerlink" title="FiberReconciler æ€»ä½“æµç¨‹"></a>FiberReconciler æ€»ä½“æµç¨‹</h3><ul>
<li>TODO æµç¨‹å›¾</li>
</ul>
<h3 id="scheduleWork"><a href="#scheduleWork" class="headerlink" title="scheduleWork"></a>scheduleWork</h3><ul>
<li><p>æ‰¾åˆ°æ›´æ–°å¯¹åº”çš„<code>FiberRoot</code>èŠ‚ç‚¹</p>
</li>
<li><p>å¦‚æœç¬¦åˆæ¡ä»¶é‡ç½®<code>stack</code></p>
</li>
<li><p>å¦‚æœç¬¦åˆæ¡ä»¶å°±è¯·æ±‚å·¥ä½œè°ƒåº¦</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleWork</span>(<span class="params">fiber: Fiber, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–FiberRoot</span></span><br><span class="line">  <span class="keyword">const</span> root = scheduleWorkToRoot(fiber, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !isWorking &amp;&amp;</span><br><span class="line">    nextRenderExpirationTime !== NoWork &amp;&amp;</span><br><span class="line">    expirationTime &gt; nextRenderExpirationTime</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// This is an interruption. (Used for performance tracking.)</span></span><br><span class="line">    interruptedBy = fiber;</span><br><span class="line">    <span class="comment">// ä¸­æ–­ï¼Œä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§æ¸²æŸ“</span></span><br><span class="line">    resetStack();</span><br><span class="line">  &#125;</span><br><span class="line">  markPendingPriorityLevel(root, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// If we&#x27;re in the render phase, we don&#x27;t need to schedule this root</span></span><br><span class="line">    <span class="comment">// for an update, because we&#x27;ll do it before we exit...</span></span><br><span class="line">    !isWorking ||</span><br><span class="line">    isCommitting ||</span><br><span class="line">    <span class="comment">// ...unless this is a different root than the one we&#x27;re rendering.</span></span><br><span class="line">    nextRoot !== root</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> rootExpirationTime = root.expirationTime;</span><br><span class="line">    requestWork(root, rootExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nestedUpdateCount &gt; NESTED_UPDATE_LIMIT) &#123;</span><br><span class="line">    <span class="comment">// Reset this back to zero so subsequent updates don&#x27;t throw.</span></span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetStack</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> interruptedWork = nextUnitOfWork.return;</span><br><span class="line">    <span class="keyword">while</span> (interruptedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// undo setState</span></span><br><span class="line">      unwindInterruptedWork(interruptedWork);</span><br><span class="line">      interruptedWork = interruptedWork.return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  nextRoot = <span class="literal">null</span>;</span><br><span class="line">  nextRenderExpirationTime = NoWork;</span><br><span class="line">  nextLatestAbsoluteTimeoutMs = -<span class="number">1</span>;</span><br><span class="line">  nextRenderDidError = <span class="literal">false</span>;</span><br><span class="line">  nextUnitOfWork = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†æ‰¾åˆ°FiberRoot</span></span><br><span class="line"><span class="comment">// å¹¶å¯¹Fiberçš„returnå’Œalternateçš„expirationTimeåšå¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleWorkToRoot</span>(<span class="params">fiber: Fiber, expirationTime</span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Update the source fiber&#x27;s expiration time</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.expirationTime &lt; expirationTime) &#123;</span><br><span class="line">    fiber.expirationTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> alternate = fiber.alternate;</span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span> &amp;&amp; alternate.expirationTime &lt; expirationTime) &#123;</span><br><span class="line">    alternate.expirationTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Walk the parent path to the root and update the child expiration time.</span></span><br><span class="line">  <span class="keyword">let</span> node = fiber.return;</span><br><span class="line">  <span class="keyword">let</span> root = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (node === <span class="literal">null</span> &amp;&amp; fiber.tag === HostRoot) &#123;</span><br><span class="line">    root = fiber.stateNode;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">      alternate = node.alternate;</span><br><span class="line">      <span class="keyword">if</span> (node.childExpirationTime &lt; expirationTime) &#123;</span><br><span class="line">        node.childExpirationTime = expirationTime;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          alternate !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">          alternate.childExpirationTime &lt; expirationTime</span><br><span class="line">        ) &#123;</span><br><span class="line">          alternate.childExpirationTime = expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        alternate !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        alternate.childExpirationTime &lt; expirationTime</span><br><span class="line">      ) &#123;</span><br><span class="line">        alternate.childExpirationTime = expirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> &amp;&amp; node.tag === HostRoot) &#123;</span><br><span class="line">        root = node.stateNode;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="requestWork"><a href="#requestWork" class="headerlink" title="requestWork"></a>requestWork</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// requestWork is called by the scheduler whenever a root receives an update.</span></span><br><span class="line"><span class="comment">// It&#x27;s up to the renderer to call renderRoot at some point in the future.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestWork</span>(<span class="params">root: FiberRoot, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  addRootToSchedule(root, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (isRendering) &#123;</span><br><span class="line">    <span class="comment">// Prevent reentrancy. Remaining work will be scheduled at the end of</span></span><br><span class="line">    <span class="comment">// the currently rendering batch.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹å¤„ç† é‡è¦</span></span><br><span class="line">  <span class="keyword">if</span> (isBatchingUpdates) &#123;</span><br><span class="line">    <span class="comment">// Flush work at the end of the batch.</span></span><br><span class="line">    <span class="keyword">if</span> (isUnbatchingUpdates) &#123;</span><br><span class="line">      <span class="comment">// ...unless we&#x27;re inside unbatchedUpdates, in which case we should</span></span><br><span class="line">      <span class="comment">// flush it now.</span></span><br><span class="line">      nextFlushedRoot = root;</span><br><span class="line">      nextFlushedExpirationTime = Sync;</span><br><span class="line">      performWorkOnRoot(root, Sync, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹è¿›å…¥è°ƒåº¦</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Get rid of Sync and use current time?</span></span><br><span class="line">  <span class="keyword">if</span> (expirationTime === Sync) &#123;</span><br><span class="line">    performSyncWork();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    scheduleCallbackWithExpirationTime(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRootToSchedule</span>(<span class="params">root: FiberRoot, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Add the root to the schedule.</span></span><br><span class="line">  <span class="comment">// Check if this root is already part of the schedule.</span></span><br><span class="line">  <span class="keyword">if</span> (root.nextScheduledRoot === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This root is not already scheduled. Add it.</span></span><br><span class="line">    root.expirationTime = expirationTime;</span><br><span class="line">    <span class="keyword">if</span> (lastScheduledRoot === <span class="literal">null</span>) &#123;</span><br><span class="line">      firstScheduledRoot = lastScheduledRoot = root;</span><br><span class="line">      root.nextScheduledRoot = root;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      lastScheduledRoot.nextScheduledRoot = root;</span><br><span class="line">      lastScheduledRoot = root;</span><br><span class="line">      lastScheduledRoot.nextScheduledRoot = firstScheduledRoot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// This root is already scheduled, but its priority may have increased.</span></span><br><span class="line">    <span class="keyword">const</span> remainingExpirationTime = root.expirationTime;</span><br><span class="line">    <span class="keyword">if</span> (expirationTime &gt; remainingExpirationTime) &#123;</span><br><span class="line">      <span class="comment">// Update the priority.</span></span><br><span class="line">      root.expirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é—®é¢˜ï¼šperformSyncWork å’Œ scheduleCallbackWithExpirationTime æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<h3 id="batchedUpdates"><a href="#batchedUpdates" class="headerlink" title="batchedUpdates"></a>batchedUpdates</h3><p>å…ˆçœ‹ä¸‹æ¡ˆä¾‹æ¼”ç¤º <code>demos/batchedUpdates</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Batching should be implemented at the renderer level, not inside</span></span><br><span class="line"><span class="comment">// the reconciler.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">batchedUpdates</span>&lt;<span class="title">A</span>, <span class="title">R</span>&gt;(<span class="params">fn: (a: A) =&gt; R, a: A</span>): <span class="title">R</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> previousIsBatchingUpdates = isBatchingUpdates;</span><br><span class="line">  isBatchingUpdates = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fn(a);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isBatchingUpdates = previousIsBatchingUpdates;</span><br><span class="line">    <span class="keyword">if</span> (!isBatchingUpdates &amp;&amp; !isRendering) &#123;</span><br><span class="line">      performSyncWork();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é—®é¢˜ï¼šsetState æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ</p>
<p>setState æ–¹æ³•æœ¬èº«è°ƒç”¨æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯è°ƒç”¨äº† setState å¹¶ä¸æ ‡å¿—ç€ state ç«‹é©¬æ›´æ–°ï¼Œè¿™ä¸ªæ›´æ–°è¿‡ç¨‹å–å†³äºå½“å‰æ‰§è¡Œç¯å¢ƒçš„ä¸Šä¸‹æ–‡ï¼Œå¦‚æœå¤„äº batchedUpdates çŠ¶æ€ï¼Œé‚£ state ä¸æ˜¯ç«‹é©¬æ›´æ–°çš„ã€‚åä¹‹æœ‰å¯èƒ½æ˜¯ç«‹é©¬æ›´æ–°çš„</p>
<p>æ¯”å¦‚ï¼ŒflushSync æ˜¯ç«‹é©¬æ›´æ–°çš„ï¼Œè€Œ ConcurrentMode ä¸æ˜¯ç«‹é©¬æ›´æ–°çš„</p>
<h3 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h3><ul>
<li><p>ç»´æŠ¤æ—¶é—´ç‰‡</p>
</li>
<li><p>æ¨¡æ‹Ÿ requestIdleCallback</p>
</li>
<li><p>è°ƒåº¦åˆ—è¡¨å’Œè¶…æ—¶åˆ¤æ–­</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  now,</span><br><span class="line">  scheduleDeferredCallback,</span><br><span class="line">  cancelDeferredCallback,</span><br><span class="line">  shouldYield,</span><br><span class="line">  prepareForCommit,</span><br><span class="line">  resetAfterCommit,</span><br><span class="line">  scheduleTimeout,</span><br><span class="line">  cancelTimeout,</span><br><span class="line">  noTimeout,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./ReactFiberHostConfig&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleCallbackWithExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (callbackExpirationTime !== NoWork) &#123;</span><br><span class="line">    <span class="comment">// A callback is already scheduled. Check its expiration time (timeout).</span></span><br><span class="line">    <span class="keyword">if</span> (expirationTime &lt; callbackExpirationTime) &#123;</span><br><span class="line">      <span class="comment">// Existing callback has sufficient timeout. Exit.</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (callbackID !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Existing callback has insufficient timeout. Cancel and schedule a</span></span><br><span class="line">        <span class="comment">// new one.</span></span><br><span class="line">        cancelDeferredCallback(callbackID);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The request callback timer is already running. Don&#x27;t start a new one.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    startRequestCallbackTimer();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  callbackExpirationTime = expirationTime;</span><br><span class="line">  <span class="keyword">const</span> currentMs = now() - originalStartTimeMs;</span><br><span class="line">  <span class="keyword">const</span> expirationTimeMs = expirationTimeToMs(expirationTime);</span><br><span class="line">  <span class="keyword">const</span> timeout = expirationTimeMs - currentMs;</span><br><span class="line">  callbackID = scheduleDeferredCallback(performAsyncWork, &#123; timeout &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOMHostConfig.js</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  unstable_now <span class="keyword">as</span> now,</span><br><span class="line">  unstable_scheduleCallback <span class="keyword">as</span> scheduleDeferredCallback,</span><br><span class="line">  unstable_shouldYield <span class="keyword">as</span> shouldYield,</span><br><span class="line">  unstable_cancelCallback <span class="keyword">as</span> cancelDeferredCallback,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;scheduler&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\scheduler\src\Scheduler.js</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  ImmediatePriority <span class="keyword">as</span> unstable_ImmediatePriority,</span><br><span class="line">  UserBlockingPriority <span class="keyword">as</span> unstable_UserBlockingPriority,</span><br><span class="line">  NormalPriority <span class="keyword">as</span> unstable_NormalPriority,</span><br><span class="line">  IdlePriority <span class="keyword">as</span> unstable_IdlePriority,</span><br><span class="line">  LowPriority <span class="keyword">as</span> unstable_LowPriority,</span><br><span class="line">  unstable_runWithPriority,</span><br><span class="line">  unstable_scheduleCallback,</span><br><span class="line">  unstable_cancelCallback,</span><br><span class="line">  unstable_wrapCallback,</span><br><span class="line">  unstable_getCurrentPriorityLevel,</span><br><span class="line">  unstable_shouldYield,</span><br><span class="line">  unstable_continueExecution,</span><br><span class="line">  unstable_pauseExecution,</span><br><span class="line">  unstable_getFirstCallbackNode,</span><br><span class="line">  getCurrentTime <span class="keyword">as</span> unstable_now,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_scheduleCallback</span>(<span class="params">callback, deprecated_options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> startTime =</span><br><span class="line">    currentEventStartTime !== -<span class="number">1</span> ? currentEventStartTime : getCurrentTime();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> deprecated_options === <span class="string">&quot;object&quot;</span> &amp;&amp;</span><br><span class="line">    deprecated_options !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> deprecated_options.timeout === <span class="string">&quot;number&quot;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> Remove this branch once we lift expiration times out of React.</span></span><br><span class="line">    expirationTime = startTime + deprecated_options.timeout;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (currentPriorityLevel) &#123;</span><br><span class="line">      <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">        expirationTime = startTime + IMMEDIATE_PRIORITY_TIMEOUT;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">        expirationTime = startTime + USER_BLOCKING_PRIORITY;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> IdlePriority:</span><br><span class="line">        expirationTime = startTime + IDLE_PRIORITY;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> LowPriority:</span><br><span class="line">        expirationTime = startTime + LOW_PRIORITY_TIMEOUT;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> NormalPriority:</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        expirationTime = startTime + NORMAL_PRIORITY_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newNode = &#123;</span><br><span class="line">    callback,</span><br><span class="line">    priorityLevel: currentPriorityLevel,</span><br><span class="line">    expirationTime,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">    previous: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Insert the new callback into the list, ordered first by expiration, then</span></span><br><span class="line">  <span class="comment">// by insertion. So the new callback is inserted any other callback with</span></span><br><span class="line">  <span class="comment">// equal expiration.</span></span><br><span class="line">  <span class="keyword">if</span> (firstCallbackNode === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first callback in the list.</span></span><br><span class="line">    firstCallbackNode = newNode.next = newNode.previous = newNode;</span><br><span class="line">    ensureHostCallbackIsScheduled();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> next = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> node = firstCallbackNode;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.expirationTime &gt; expirationTime) &#123;</span><br><span class="line">        <span class="comment">// The new callback expires before this one.</span></span><br><span class="line">        next = node;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (node !== firstCallbackNode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// No callback with a later expiration was found, which means the new</span></span><br><span class="line">      <span class="comment">// callback has the latest expiration in the list.</span></span><br><span class="line">      next = firstCallbackNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next === firstCallbackNode) &#123;</span><br><span class="line">      <span class="comment">// The new callback has the earliest expiration in the entire list.</span></span><br><span class="line">      firstCallbackNode = newNode;</span><br><span class="line">      ensureHostCallbackIsScheduled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> previous = next.previous;</span><br><span class="line">    previous.next = next.previous = newNode;</span><br><span class="line">    newNode.next = next;</span><br><span class="line">    newNode.previous = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newNode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_cancelCallback</span>(<span class="params">callbackNode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> next = callbackNode.next;</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Already cancelled.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next === callbackNode) &#123;</span><br><span class="line">    <span class="comment">// This is the only scheduled callback. Clear the list.</span></span><br><span class="line">    firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Remove the callback from its position in the list.</span></span><br><span class="line">    <span class="keyword">if</span> (callbackNode === firstCallbackNode) &#123;</span><br><span class="line">      firstCallbackNode = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> previous = callbackNode.previous;</span><br><span class="line">    previous.next = next;</span><br><span class="line">    next.previous = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  callbackNode.next = callbackNode.previous = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureHostCallbackIsScheduled</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isExecutingCallback) &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t schedule work yet; wait until the next time we yield.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Schedule the host callback using the earliest expiration in the list.</span></span><br><span class="line">  <span class="keyword">var</span> expirationTime = firstCallbackNode.expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (!isHostCallbackScheduled) &#123;</span><br><span class="line">    isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Cancel the existing host callback.</span></span><br><span class="line">    cancelHostCallback();</span><br><span class="line">  &#125;</span><br><span class="line">  requestHostCallback(flushWork, expirationTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hasNativePerformanceNow =</span><br><span class="line">  <span class="keyword">typeof</span> performance === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="keyword">typeof</span> performance.now === <span class="string">&quot;function&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (hasNativePerformanceNow) &#123;</span><br><span class="line">  <span class="keyword">var</span> Performance = performance;</span><br><span class="line">  getCurrentTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Performance.now();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  getCurrentTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> localDate.now();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹ŸrequestIdleCallback</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestHostCallback;</span><br><span class="line"><span class="keyword">var</span> cancelHostCallback;</span><br><span class="line"><span class="keyword">var</span> shouldYieldToHost;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> globalValue = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">  globalValue = <span class="built_in">window</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">global</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">  globalValue = <span class="built_in">global</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (globalValue &amp;&amp; globalValue._schedMock) &#123;</span><br><span class="line">  <span class="comment">// Dynamic injection, only for testing purposes.</span></span><br><span class="line">  <span class="comment">// æµ‹è¯•ä½¿ç”¨ä»£ç ç‰‡æ®µ</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">  <span class="comment">// If Scheduler runs in a non-DOM environment, it falls back to a naive</span></span><br><span class="line">  <span class="comment">// implementation using setTimeout.</span></span><br><span class="line">  <span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">&quot;undefined&quot;</span> ||</span><br><span class="line">  <span class="comment">// Check if MessageChannel is supported, too.</span></span><br><span class="line">  <span class="keyword">typeof</span> MessageChannel !== <span class="string">&quot;function&quot;</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// éæµè§ˆå™¨ç¯å¢ƒï¼Œå¦‚JavaScriptCoreï¼Œä½¿ç”¨åŸç”ŸsetTimeoutå®ç°</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// æµè§ˆå™¨ç¯å¢ƒ</span></span><br><span class="line">  <span class="comment">// å¼€å§‹æ¨¡æ‹ŸrequestIdleCallback</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> scheduledHostCallback = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> isMessageEventScheduled = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> timeoutTime = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isAnimationFrameScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isFlushingHostCallback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> frameDeadline = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// We start out assuming that we run at 30fps but then the heuristic tracking</span></span><br><span class="line">  <span class="comment">// will adjust this value to a faster fps if we get more frequent animation</span></span><br><span class="line">  <span class="comment">// frames.</span></span><br><span class="line">  <span class="keyword">var</span> previousFrameTime = <span class="number">33</span>;</span><br><span class="line">  <span class="keyword">var</span> activeFrameTime = <span class="number">33</span>;</span><br><span class="line"></span><br><span class="line">  shouldYieldToHost = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> frameDeadline &lt;= getCurrentTime();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We use the postMessage trick to defer idle work until after the repaint.</span></span><br><span class="line">  <span class="keyword">var</span> channel = <span class="keyword">new</span> MessageChannel();</span><br><span class="line">  <span class="keyword">var</span> port = channel.port2;</span><br><span class="line">  channel.port1.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    isMessageEventScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> prevScheduledCallback = scheduledHostCallback;</span><br><span class="line">    <span class="keyword">var</span> prevTimeoutTime = timeoutTime;</span><br><span class="line">    scheduledHostCallback = <span class="literal">null</span>;</span><br><span class="line">    timeoutTime = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> didTimeout = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (frameDeadline - currentTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// There&#x27;s no time left in this idle period. Check if the callback has</span></span><br><span class="line">      <span class="comment">// a timeout and whether it&#x27;s been exceeded.</span></span><br><span class="line">      <span class="keyword">if</span> (prevTimeoutTime !== -<span class="number">1</span> &amp;&amp; prevTimeoutTime &lt;= currentTime) &#123;</span><br><span class="line">        <span class="comment">// Exceeded the timeout. Invoke the callback even though there&#x27;s no</span></span><br><span class="line">        <span class="comment">// time left.</span></span><br><span class="line">        didTimeout = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No timeout.</span></span><br><span class="line">        <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">          <span class="comment">// Schedule another animation callback so we retry later.</span></span><br><span class="line">          isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">          requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Exit without invoking the callback.</span></span><br><span class="line">        scheduledHostCallback = prevScheduledCallback;</span><br><span class="line">        timeoutTime = prevTimeoutTime;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prevScheduledCallback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      isFlushingHostCallback = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        prevScheduledCallback(didTimeout);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        isFlushingHostCallback = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> animationTick = <span class="function"><span class="keyword">function</span> (<span class="params">rafTime</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scheduledHostCallback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Eagerly schedule the next animation callback at the beginning of the</span></span><br><span class="line">      <span class="comment">// frame. If the scheduler queue is not empty at the end of the frame, it</span></span><br><span class="line">      <span class="comment">// will continue flushing inside that callback. If the queue *is* empty,</span></span><br><span class="line">      <span class="comment">// then it will exit immediately. Posting the callback at the start of the</span></span><br><span class="line">      <span class="comment">// frame ensures it&#x27;s fired within the earliest possible frame. If we</span></span><br><span class="line">      <span class="comment">// waited until the end of the frame to post the callback, we risk the</span></span><br><span class="line">      <span class="comment">// browser skipping a frame and not firing the callback until the frame</span></span><br><span class="line">      <span class="comment">// after that.</span></span><br><span class="line">      requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// No pending work. Exit.</span></span><br><span class="line">      isAnimationFrameScheduled = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> nextFrameTime = rafTime - frameDeadline + activeFrameTime;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      nextFrameTime &lt; activeFrameTime &amp;&amp;</span><br><span class="line">      previousFrameTime &lt; activeFrameTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextFrameTime &lt; <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="comment">// Defensive coding. We don&#x27;t support higher frame rates than 120hz.</span></span><br><span class="line">        <span class="comment">// If the calculated frame time gets lower than 8, it is probably a bug.</span></span><br><span class="line">        nextFrameTime = <span class="number">8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If one frame goes long, then the next one can be short to catch up.</span></span><br><span class="line">      <span class="comment">// If two frames are short in a row, then that&#x27;s an indication that we</span></span><br><span class="line">      <span class="comment">// actually have a higher frame rate than what we&#x27;re currently optimizing.</span></span><br><span class="line">      <span class="comment">// We adjust our heuristic dynamically accordingly. For example, if we&#x27;re</span></span><br><span class="line">      <span class="comment">// running on 120hz display or 90hz VR display.</span></span><br><span class="line">      <span class="comment">// Take the max of the two in case one of them was an anomaly due to</span></span><br><span class="line">      <span class="comment">// missed frame deadlines.</span></span><br><span class="line">      activeFrameTime =</span><br><span class="line">        nextFrameTime &lt; previousFrameTime ? previousFrameTime : nextFrameTime;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      previousFrameTime = nextFrameTime;</span><br><span class="line">    &#125;</span><br><span class="line">    frameDeadline = rafTime + activeFrameTime;</span><br><span class="line">    <span class="keyword">if</span> (!isMessageEventScheduled) &#123;</span><br><span class="line">      isMessageEventScheduled = <span class="literal">true</span>;</span><br><span class="line">      port.postMessage(<span class="literal">undefined</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  requestHostCallback = <span class="function"><span class="keyword">function</span> (<span class="params">callback, absoluteTimeout</span>) </span>&#123;</span><br><span class="line">    scheduledHostCallback = callback;</span><br><span class="line">    timeoutTime = absoluteTimeout;</span><br><span class="line">    <span class="keyword">if</span> (isFlushingHostCallback || absoluteTimeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Don&#x27;t wait for the next frame. Continue working ASAP, in a new event.</span></span><br><span class="line">      port.postMessage(<span class="literal">undefined</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">      <span class="comment">// If rAF didn&#x27;t already schedule one, we need to schedule a frame.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If this rAF doesn&#x27;t materialize because the browser throttles, we</span></span><br><span class="line">      <span class="comment">// might want to still have setTimeout trigger rIC as a backup to ensure</span></span><br><span class="line">      <span class="comment">// that we keep performing work.</span></span><br><span class="line">      isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">      requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  cancelHostCallback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    scheduledHostCallback = <span class="literal">null</span>;</span><br><span class="line">    isMessageEventScheduled = <span class="literal">false</span>;</span><br><span class="line">    timeoutTime = -<span class="number">1</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†æ‰€æœ‰è¿‡æœŸä»»åŠ¡å¼ºåˆ¶è¾“å‡º</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushWork</span>(<span class="params">didTimeout</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Exit right away if we&#x27;re currently paused</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerDebugging &amp;&amp; isSchedulerPaused) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isExecutingCallback = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span> previousDidTimeout = currentDidTimeout;</span><br><span class="line">  currentDidTimeout = didTimeout;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (didTimeout) &#123;</span><br><span class="line">      <span class="comment">// Flush all the expired callbacks without yielding.</span></span><br><span class="line">      <span class="keyword">while</span> (</span><br><span class="line">        firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// TODO Wrap i nfeature flag</span></span><br><span class="line">        <span class="comment">// Read the current time. Flush all the callbacks that expire at or</span></span><br><span class="line">        <span class="comment">// earlier than that time. Then read the current time again and repeat.</span></span><br><span class="line">        <span class="comment">// This optimizes for as few performance.now calls as possible.</span></span><br><span class="line">        <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line">        <span class="comment">// æ­¤å¤„å¾ªç¯é“¾è¡¨ï¼Œæ‰§è¡ŒflushFirstCallbackç›´åˆ°ç¬¬ä¸€ä¸ªä¸è¶…æ—¶çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (firstCallbackNode.expirationTime &lt;= currentTime) &#123;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            flushFirstCallback();</span><br><span class="line">          &#125; <span class="keyword">while</span> (</span><br><span class="line">            firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            firstCallbackNode.expirationTime &lt;= currentTime &amp;&amp;</span><br><span class="line">            !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Keep flushing callbacks until we run out of time in the frame.</span></span><br><span class="line">      <span class="keyword">if</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (enableSchedulerDebugging &amp;&amp; isSchedulerPaused) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          flushFirstCallback();</span><br><span class="line">        &#125; <span class="keyword">while</span> (firstCallbackNode !== <span class="literal">null</span> &amp;&amp; !shouldYieldToHost()); <span class="comment">// å¸§æ—¶é—´è¿˜æœ‰çš„æ—¶å€™</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isExecutingCallback = <span class="literal">false</span>;</span><br><span class="line">    currentDidTimeout = previousDidTimeout;</span><br><span class="line">    <span class="keyword">if</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// There&#x27;s still work remaining. Request another callback.</span></span><br><span class="line">      ensureHostCallbackIsScheduled();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="performWork"><a href="#performWork" class="headerlink" title="performWork"></a>performWork</h3><ul>
<li><p>æ˜¯å¦æœ‰ Deadline åŒºåˆ†</p>
</li>
<li><p>å¾ªç¯æ¸²æŸ“ Root çš„æ¡ä»¶</p>
</li>
<li><p>è¶…è¿‡æ—¶é—´ç‰‡çš„å¤„ç†</p>
</li>
</ul>
<h3 id="renderRoot"><a href="#renderRoot" class="headerlink" title="renderRoot"></a>renderRoot</h3><ul>
<li><p>è°ƒç”¨ workLoop è¿›è¡Œå¾ªç¯å•å…ƒæ›´æ–°</p>
</li>
<li><p>æ•è·é”™è¯¯å¹¶è¿›è¡Œå¤„ç†</p>
</li>
<li><p>èµ°å®Œæµç¨‹ä¹‹åè¿›è¡Œå–„å</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="comment">// renderRoot  ==&gt; workLoop</span></span><br></pre></td></tr></table></figure>

<h2 id="èŠ‚ç‚¹æ›´æ–°-beginWork"><a href="#èŠ‚ç‚¹æ›´æ–°-beginWork" class="headerlink" title="èŠ‚ç‚¹æ›´æ–° beginWork"></a>èŠ‚ç‚¹æ›´æ–° beginWork</h2><h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><p>workLoop ==&gt; performUnitOfWork ==&gt; beginWork ==&gt; completeUnitOfWork</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span></span><br><span class="line"><span class="comment">// beginWork</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps;</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      oldProps === newProps &amp;&amp;</span><br><span class="line">      !hasLegacyContextChanged() &amp;&amp;</span><br><span class="line">      updateExpirationTime &lt; renderExpirationTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// This fiber does not have any pending work. Bailout without entering</span></span><br><span class="line">      <span class="comment">// the begin phase. There&#x27;s still some bookkeeping we that needs to be done</span></span><br><span class="line">      <span class="comment">// in this optimized path, mostly pushing stuff onto the stack.</span></span><br><span class="line">      <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> HostRoot:</span><br><span class="line">          pushHostRootContext(workInProgress);</span><br><span class="line">          resetHydrationState();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HostComponent:</span><br><span class="line">          pushHostContext(workInProgress);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">          <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">            pushLegacyContextProvider(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostPortal:</span><br><span class="line">          pushHostContainer(</span><br><span class="line">            workInProgress,</span><br><span class="line">            workInProgress.stateNode.containerInfo</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ContextProvider: &#123;</span><br><span class="line">          <span class="keyword">const</span> newValue = workInProgress.memoizedProps.value;</span><br><span class="line">          pushProvider(workInProgress, newValue);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Profiler:</span><br><span class="line">          <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">            workInProgress.effectTag |= Update;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> state: SuspenseState | <span class="literal">null</span> = workInProgress.memoizedState;</span><br><span class="line">          <span class="keyword">const</span> didTimeout = state !== <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">if</span> (didTimeout) &#123;</span><br><span class="line">            <span class="comment">// If this boundary is currently timed out, we need to decide</span></span><br><span class="line">            <span class="comment">// whether to retry the primary children, or to skip over it and</span></span><br><span class="line">            <span class="comment">// go straight to the fallback. Check the priority of the primary</span></span><br><span class="line">            <span class="comment">// child fragment.</span></span><br><span class="line">            <span class="keyword">const</span> primaryChildFragment: Fiber = (workInProgress.child: any);</span><br><span class="line">            <span class="keyword">const</span> primaryChildExpirationTime =</span><br><span class="line">              primaryChildFragment.childExpirationTime;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              primaryChildExpirationTime !== NoWork &amp;&amp;</span><br><span class="line">              primaryChildExpirationTime &gt;= renderExpirationTime</span><br><span class="line">            ) &#123;</span><br><span class="line">              <span class="comment">// The primary children have pending work. Use the normal path</span></span><br><span class="line">              <span class="comment">// to attempt to render the primary children again.</span></span><br><span class="line">              <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime</span><br><span class="line">              );</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// The primary children do not have pending work with sufficient</span></span><br><span class="line">              <span class="comment">// priority. Bailout.</span></span><br><span class="line">              <span class="comment">// è·³è¿‡æ›´æ–°</span></span><br><span class="line">              <span class="keyword">const</span> child = bailoutOnAlreadyFinishedWork(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime</span><br><span class="line">              );</span><br><span class="line">              <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// The fallback children have pending work. Skip over the</span></span><br><span class="line">                <span class="comment">// primary children and work on the fallback.</span></span><br><span class="line">                <span class="keyword">return</span> child.sibling;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before entering the begin phase, clear the expiration time.</span></span><br><span class="line">  workInProgress.expirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> elementType = workInProgress.elementType;</span><br><span class="line">      <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        elementType,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> LazyComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> elementType = workInProgress.elementType;</span><br><span class="line">      <span class="keyword">return</span> mountLazyComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        elementType,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateFunctionComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">return</span> updateHostComponent(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> HostText:</span><br><span class="line">      <span class="keyword">return</span> updateHostText(current, workInProgress);</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent:</span><br><span class="line">      <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      <span class="keyword">return</span> updatePortalComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> ForwardRef: &#123;</span><br><span class="line">      <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === type</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(type, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateForwardRef(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        type,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">      <span class="keyword">return</span> updateFragment(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> Mode:</span><br><span class="line">      <span class="keyword">return</span> updateMode(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> Profiler:</span><br><span class="line">      <span class="keyword">return</span> updateProfiler(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> ContextProvider:</span><br><span class="line">      <span class="keyword">return</span> updateContextProvider(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">      <span class="keyword">return</span> updateContextConsumer(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> MemoComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="comment">// Resolve outer props first, then resolve inner props.</span></span><br><span class="line">      <span class="keyword">let</span> resolvedProps = resolveDefaultProps(type, unresolvedProps);</span><br><span class="line">      resolvedProps = resolveDefaultProps(type.type, resolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateMemoComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        type,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span> updateSimpleMemoComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        workInProgress.type,</span><br><span class="line">        workInProgress.pendingProps,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> mountIncompleteClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Unknown unit of work tag. This error is likely caused by a bug in &quot;</span> +</span><br><span class="line">          <span class="string">&quot;React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FunctionComponent"><a href="#FunctionComponent" class="headerlink" title="FunctionComponent"></a>FunctionComponent</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="comment">// Suspendç›¸å…³</span></span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateFunctionComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">updateFunctionComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, Component, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">const</span> context = getMaskedContext(workInProgress, unmaskedContext);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nextChildren;</span><br><span class="line">  prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line">  prepareToUseHooks(current, workInProgress, renderExpirationTime);</span><br><span class="line">  <span class="comment">// å‡½æ•°ç»„ä»¶é‡Œé¢åˆä¼ å…¥äº†ç¬¬äºŒä¸ªå‚æ•°context</span></span><br><span class="line">  nextChildren = Component(nextProps, context);</span><br><span class="line">  nextChildren = finishHooks(Component, nextProps, nextChildren, context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">  workInProgress.effectTag |= PerformedWork;</span><br><span class="line">  <span class="comment">// æ ¸å¿ƒæ­¥éª¤ï¼Œç”¨äºè°ƒå’Œå­ç»“ç‚¹nextChildren</span></span><br><span class="line">  reconcileChildren(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a>reconcileChildren</h3><ul>
<li><p>æ ¹æ® props.children ç”Ÿæˆ Fiber å­æ ‘</p>
</li>
<li><p>åˆ¤æ–­ Fiber å¯¹è±¡æ˜¯å¦å¯ä»¥å¤ç”¨</p>
</li>
<li><p>åˆ—è¡¨æ ¹æ® key ä¼˜åŒ–</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextChildren: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this is a fresh new component that hasn&#x27;t been rendered yet, we</span></span><br><span class="line">    <span class="comment">// won&#x27;t update its child set by applying minimal side-effects. Instead,</span></span><br><span class="line">    <span class="comment">// we will add them all to the child before it gets rendered. That means</span></span><br><span class="line">    <span class="comment">// we can optimize this reconciliation pass by not tracking side-effects.</span></span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If the current child is the same as the work in progress, it means that</span></span><br><span class="line">    <span class="comment">// we haven&#x27;t yet started any work on these children. Therefore, we use</span></span><br><span class="line">    <span class="comment">// the clone algorithm to create a copy of all the current children.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we had any progressed work already, that is invalid at this point so</span></span><br><span class="line">    <span class="comment">// let&#x27;s throw it out.</span></span><br><span class="line">    workInProgress.child = reconcileChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      current.child,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactChildFiber.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reconcileChildFibers = ChildReconciler(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mountChildFibers = ChildReconciler(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This wrapper function exists because I expect to clone the code in each path</span></span><br><span class="line"><span class="comment">// to be able to optimize each path individually by branching early. This needs</span></span><br><span class="line"><span class="comment">// a compiler or we can do it manually. Helpers that don&#x27;t need this branching</span></span><br><span class="line"><span class="comment">// live outside of this function.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ChildReconciler</span>(<span class="params">shouldTrackSideEffects</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteChild</span>(<span class="params">returnFiber: Fiber, childToDelete: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="comment">// Noop.</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Deletions are added in reversed order so we add it to the front.</span></span><br><span class="line">    <span class="comment">// At this point, the return fiber&#x27;s effect list is empty except for</span></span><br><span class="line">    <span class="comment">// deletions, so we can just append the deletion to the list. The remaining</span></span><br><span class="line">    <span class="comment">// effects aren&#x27;t added until the complete phase. Once we implement</span></span><br><span class="line">    <span class="comment">// resuming, this may not be true.</span></span><br><span class="line">    <span class="keyword">const</span> last = returnFiber.lastEffect;</span><br><span class="line">    <span class="keyword">if</span> (last !== <span class="literal">null</span>) &#123;</span><br><span class="line">      last.nextEffect = childToDelete;</span><br><span class="line">      returnFiber.lastEffect = childToDelete;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;</span><br><span class="line">    &#125;</span><br><span class="line">    childToDelete.nextEffect = <span class="literal">null</span>;</span><br><span class="line">    childToDelete.effectTag = Deletion;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="comment">// Noop.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> For the shouldClone case, this could be micro-optimized a bit by</span></span><br><span class="line">    <span class="comment">// assuming that after the first child we&#x27;ve already added everything.</span></span><br><span class="line">    <span class="keyword">let</span> childToDelete = currentFirstChild;</span><br><span class="line">    <span class="keyword">while</span> (childToDelete !== <span class="literal">null</span>) &#123;</span><br><span class="line">      deleteChild(returnFiber, childToDelete);</span><br><span class="line">      childToDelete = childToDelete.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mapRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Map</span>&lt;<span class="title">string</span> | <span class="title">number</span>, <span class="title">Fiber</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// Add the remaining children to a temporary map so that we can find them by</span></span><br><span class="line">    <span class="comment">// keys quickly. Implicit (null) keys get added to this set with their index</span></span><br><span class="line">    <span class="comment">// instead.</span></span><br><span class="line">    <span class="keyword">const</span> existingChildren: <span class="built_in">Map</span>&lt;string | number, Fiber&gt; = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> existingChild = currentFirstChild;</span><br><span class="line">    <span class="keyword">while</span> (existingChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (existingChild.key !== <span class="literal">null</span>) &#123;</span><br><span class="line">        existingChildren.set(existingChild.key, existingChild);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        existingChildren.set(existingChild.index, existingChild);</span><br><span class="line">      &#125;</span><br><span class="line">      existingChild = existingChild.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> existingChildren;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">useFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We currently set sibling to null and index to 0 here because it is easy</span></span><br><span class="line">    <span class="comment">// to forget to do before returning it. E.g. for the single child case.</span></span><br><span class="line">    <span class="keyword">const</span> clone = createWorkInProgress(fiber, pendingProps, expirationTime);</span><br><span class="line">    clone.index = <span class="number">0</span>;</span><br><span class="line">    clone.sibling = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> clone;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    newFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    lastPlacedIndex: number,</span></span></span><br><span class="line"><span class="function"><span class="params">    newIndex: number</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    newFiber.index = newIndex;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="comment">// Noop.</span></span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> current = newFiber.alternate;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldIndex = current.index;</span><br><span class="line">      <span class="keyword">if</span> (oldIndex &lt; lastPlacedIndex) &#123;</span><br><span class="line">        <span class="comment">// This is a move.</span></span><br><span class="line">        newFiber.effectTag = Placement;</span><br><span class="line">        <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This item can stay in place.</span></span><br><span class="line">        <span class="keyword">return</span> oldIndex;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is an insertion.</span></span><br><span class="line">      newFiber.effectTag = Placement;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is simpler for the single child case. We only need to do a</span></span><br><span class="line">    <span class="comment">// placement for inserting new children.</span></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">      newFiber.effectTag = Placement;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newFiber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateTextNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    textContent: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span> || current.tag !== HostText) &#123;</span><br><span class="line">      <span class="comment">// Insert</span></span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromText(</span><br><span class="line">        textContent,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(current, textContent, expirationTime);</span><br><span class="line">      existing.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> existing;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; current.elementType === element.type) &#123;</span><br><span class="line">      <span class="comment">// Move based on index</span></span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(current, element.props, expirationTime);</span><br><span class="line">      existing.ref = coerceRef(returnFiber, current, element);</span><br><span class="line">      existing.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> existing;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Insert</span></span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromElement(</span><br><span class="line">        element,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      created.ref = coerceRef(returnFiber, current, element);</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updatePortal</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    portal: ReactPortal,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      current === <span class="literal">null</span> ||</span><br><span class="line">      current.tag !== HostPortal ||</span><br><span class="line">      current.stateNode.containerInfo !== portal.containerInfo ||</span><br><span class="line">      current.stateNode.implementation !== portal.implementation</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Insert</span></span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromPortal(</span><br><span class="line">        portal,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(current, portal.children || [], expirationTime);</span><br><span class="line">      existing.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> existing;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateFragment</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    fragment: Iterable&lt;*&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    key: <span class="literal">null</span> | string</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span> || current.tag !== Fragment) &#123;</span><br><span class="line">      <span class="comment">// Insert</span></span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">        fragment,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime,</span><br><span class="line">        key</span><br><span class="line">      );</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(current, fragment, expirationTime);</span><br><span class="line">      existing.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> existing;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// Text nodes don&#x27;t have keys. If the previous node is implicitly keyed</span></span><br><span class="line">      <span class="comment">// we can continue to replace it without aborting even if it is not a text</span></span><br><span class="line">      <span class="comment">// node.</span></span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromText(</span><br><span class="line">        <span class="string">&quot;&quot;</span> + newChild,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;object&quot;</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$typeof) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE: &#123;</span><br><span class="line">          <span class="keyword">const</span> created = createFiberFromElement(</span><br><span class="line">            newChild,</span><br><span class="line">            returnFiber.mode,</span><br><span class="line">            expirationTime</span><br><span class="line">          );</span><br><span class="line">          created.ref = coerceRef(returnFiber, <span class="literal">null</span>, newChild);</span><br><span class="line">          created.return = returnFiber;</span><br><span class="line">          <span class="keyword">return</span> created;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> REACT_PORTAL_TYPE: &#123;</span><br><span class="line">          <span class="keyword">const</span> created = createFiberFromPortal(</span><br><span class="line">            newChild,</span><br><span class="line">            returnFiber.mode,</span><br><span class="line">            expirationTime</span><br><span class="line">          );</span><br><span class="line">          created.return = returnFiber;</span><br><span class="line">          <span class="keyword">return</span> created;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isArray(newChild) || getIteratorFn(newChild)) &#123;</span><br><span class="line">        <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">          newChild,</span><br><span class="line">          returnFiber.mode,</span><br><span class="line">          expirationTime,</span><br><span class="line">          <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">        created.return = returnFiber;</span><br><span class="line">        <span class="keyword">return</span> created;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateSlot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    oldFiber: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Update the fiber if the keys match, otherwise return null.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> key = oldFiber !== <span class="literal">null</span> ? oldFiber.key : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// Text nodes don&#x27;t have keys. If the previous node is implicitly keyed</span></span><br><span class="line">      <span class="comment">// we can continue to replace it without aborting even if it is not a text</span></span><br><span class="line">      <span class="comment">// node.</span></span><br><span class="line">      <span class="keyword">if</span> (key !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> updateTextNode(</span><br><span class="line">        returnFiber,</span><br><span class="line">        oldFiber,</span><br><span class="line">        <span class="string">&quot;&quot;</span> + newChild,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;object&quot;</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$typeof) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE: &#123;</span><br><span class="line">          <span class="keyword">if</span> (newChild.key === key) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newChild.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">              <span class="keyword">return</span> updateFragment(</span><br><span class="line">                returnFiber,</span><br><span class="line">                oldFiber,</span><br><span class="line">                newChild.props.children,</span><br><span class="line">                expirationTime,</span><br><span class="line">                key</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> updateElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              oldFiber,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> REACT_PORTAL_TYPE: &#123;</span><br><span class="line">          <span class="keyword">if</span> (newChild.key === key) &#123;</span><br><span class="line">            <span class="keyword">return</span> updatePortal(</span><br><span class="line">              returnFiber,</span><br><span class="line">              oldFiber,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isArray(newChild) || getIteratorFn(newChild)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> updateFragment(</span><br><span class="line">          returnFiber,</span><br><span class="line">          oldFiber,</span><br><span class="line">          newChild,</span><br><span class="line">          expirationTime,</span><br><span class="line">          <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateFromMap</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    existingChildren: <span class="built_in">Map</span>&lt;string | number, Fiber&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    newIdx: number,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// Text nodes don&#x27;t have keys, so we neither have to check the old nor</span></span><br><span class="line">      <span class="comment">// new node for the key. If both are text nodes, they match.</span></span><br><span class="line">      <span class="keyword">const</span> matchedFiber = existingChildren.get(newIdx) || <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">return</span> updateTextNode(</span><br><span class="line">        returnFiber,</span><br><span class="line">        matchedFiber,</span><br><span class="line">        <span class="string">&quot;&quot;</span> + newChild,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;object&quot;</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$typeof) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE: &#123;</span><br><span class="line">          <span class="keyword">const</span> matchedFiber =</span><br><span class="line">            existingChildren.get(</span><br><span class="line">              newChild.key === <span class="literal">null</span> ? newIdx : newChild.key</span><br><span class="line">            ) || <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">if</span> (newChild.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> updateFragment(</span><br><span class="line">              returnFiber,</span><br><span class="line">              matchedFiber,</span><br><span class="line">              newChild.props.children,</span><br><span class="line">              expirationTime,</span><br><span class="line">              newChild.key</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> updateElement(</span><br><span class="line">            returnFiber,</span><br><span class="line">            matchedFiber,</span><br><span class="line">            newChild,</span><br><span class="line">            expirationTime</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> REACT_PORTAL_TYPE: &#123;</span><br><span class="line">          <span class="keyword">const</span> matchedFiber =</span><br><span class="line">            existingChildren.get(</span><br><span class="line">              newChild.key === <span class="literal">null</span> ? newIdx : newChild.key</span><br><span class="line">            ) || <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">return</span> updatePortal(</span><br><span class="line">            returnFiber,</span><br><span class="line">            matchedFiber,</span><br><span class="line">            newChild,</span><br><span class="line">            expirationTime</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isArray(newChild) || getIteratorFn(newChild)) &#123;</span><br><span class="line">        <span class="keyword">const</span> matchedFiber = existingChildren.get(newIdx) || <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> updateFragment(</span><br><span class="line">          returnFiber,</span><br><span class="line">          matchedFiber,</span><br><span class="line">          newChild,</span><br><span class="line">          expirationTime,</span><br><span class="line">          <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šè¿‡keyå°½å¯èƒ½åœ°å¤ç”¨å¯å¤ç”¨çš„FiberèŠ‚ç‚¹ï¼Œå‡å°‘å¯¹è±¡å£°æ˜å’Œå†…å­˜å›æ”¶çš„æŸè€—</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenArray</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChildren: <span class="built_in">Array</span>&lt;*&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This algorithm can&#x27;t optimize by searching from boths ends since we</span></span><br><span class="line">    <span class="comment">// don&#x27;t have backpointers on fibers. I&#x27;m trying to see how far we can get</span></span><br><span class="line">    <span class="comment">// with that model. If it ends up not being worth the tradeoffs, we can</span></span><br><span class="line">    <span class="comment">// add it later.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Even with a two ended optimization, we&#x27;d want to optimize for the case</span></span><br><span class="line">    <span class="comment">// where there are few changes and brute force the comparison instead of</span></span><br><span class="line">    <span class="comment">// going for the Map. It&#x27;d like to explore hitting that path first in</span></span><br><span class="line">    <span class="comment">// forward-only mode and only go for the Map once we notice that we need</span></span><br><span class="line">    <span class="comment">// lots of look ahead. This doesn&#x27;t handle reversal as well as two ended</span></span><br><span class="line">    <span class="comment">// search but that&#x27;s unusual. Besides, for the two ended optimization to</span></span><br><span class="line">    <span class="comment">// work on Iterables, we&#x27;d need to copy the whole set.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// In this first iteration, we&#x27;ll just live with hitting the bad case</span></span><br><span class="line">    <span class="comment">// (adding everything to a Map) in for every insert/move.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If you change this code, also update reconcileChildrenIterator() which</span></span><br><span class="line">    <span class="comment">// uses the same algorithm.</span></span><br><span class="line">    <span class="keyword">let</span> resultingFirstChild: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> previousNewFiber: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> oldFiber = currentFirstChild;</span><br><span class="line">    <span class="keyword">let</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> newIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldFiber.index &gt; newIdx) &#123;</span><br><span class="line">        nextOldFiber = oldFiber;</span><br><span class="line">        oldFiber = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nextOldFiber = oldFiber.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> newFiber = updateSlot(</span><br><span class="line">        returnFiber,</span><br><span class="line">        oldFiber,</span><br><span class="line">        newChildren[newIdx],</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This breaks on empty slots like null children. That&#x27;s</span></span><br><span class="line">        <span class="comment">// unfortunate because it triggers the slow path all the time. We need</span></span><br><span class="line">        <span class="comment">// a better way to communicate whether this was a miss or null,</span></span><br><span class="line">        <span class="comment">// boolean, undefined, etc.</span></span><br><span class="line">        <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          oldFiber = nextOldFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We matched the slot, but we didn&#x27;t reuse the existing fiber, so we</span></span><br><span class="line">          <span class="comment">// need to delete the existing child.</span></span><br><span class="line">          deleteChild(returnFiber, oldFiber);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">        resultingFirstChild = newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Defer siblings if we&#x27;re not at the right index for this slot.</span></span><br><span class="line">        <span class="comment">// I.e. if we had null values before, then we want to defer this</span></span><br><span class="line">        <span class="comment">// for each null value. However, we also don&#x27;t want to call updateSlot</span></span><br><span class="line">        <span class="comment">// with the previous one.</span></span><br><span class="line">        previousNewFiber.sibling = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNewFiber = newFiber;</span><br><span class="line">      oldFiber = nextOldFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newIdx === newChildren.length) &#123;</span><br><span class="line">      <span class="comment">// We&#x27;ve reached the end of the new children. We can delete the rest.</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">      <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If we don&#x27;t have any more existing children we can choose a fast path</span></span><br><span class="line">      <span class="comment">// since the rest will all be insertions.</span></span><br><span class="line">      <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">        <span class="keyword">const</span> newFiber = createChild(</span><br><span class="line">          returnFiber,</span><br><span class="line">          newChildren[newIdx],</span><br><span class="line">          expirationTime</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (!newFiber) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">          resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add all children to a key map for quick lookups.</span></span><br><span class="line">    <span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep scanning and use the map to restore deleted items as moves.</span></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">const</span> newFiber = updateFromMap(</span><br><span class="line">        existingChildren,</span><br><span class="line">        returnFiber,</span><br><span class="line">        newIdx,</span><br><span class="line">        newChildren[newIdx],</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (newFiber) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">          <span class="keyword">if</span> (newFiber.alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The new fiber is a work in progress, but if there exists a</span></span><br><span class="line">            <span class="comment">// current, that means that we reused the fiber. We need to delete</span></span><br><span class="line">            <span class="comment">// it from the child list so that we don&#x27;t add it to the deletion</span></span><br><span class="line">            <span class="comment">// list.</span></span><br><span class="line">            existingChildren.delete(</span><br><span class="line">              newFiber.key === <span class="literal">null</span> ? newIdx : newFiber.key</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="comment">// Any existing children that weren&#x27;t consumed above were deleted. We need</span></span><br><span class="line">      <span class="comment">// to add them to the deletion list.</span></span><br><span class="line">      existingChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> deleteChild(returnFiber, child));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenIterator</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChildrenIterable: Iterable&lt;*&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is the same implementation as reconcileChildrenArray(),</span></span><br><span class="line">    <span class="comment">// but using the iterator instead.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> iteratorFn = getIteratorFn(newChildrenIterable);</span><br><span class="line">    <span class="keyword">const</span> newChildren = iteratorFn.call(newChildrenIterable);</span><br><span class="line">    invariant(newChildren != <span class="literal">null</span>, <span class="string">&quot;An iterable object provided no iterator.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> resultingFirstChild: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> previousNewFiber: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> oldFiber = currentFirstChild;</span><br><span class="line">    <span class="keyword">let</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> newIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> step = newChildren.next();</span><br><span class="line">    <span class="keyword">for</span> (</span><br><span class="line">      ;</span><br><span class="line">      oldFiber !== <span class="literal">null</span> &amp;&amp; !step.done;</span><br><span class="line">      newIdx++, step = newChildren.next()</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldFiber.index &gt; newIdx) &#123;</span><br><span class="line">        nextOldFiber = oldFiber;</span><br><span class="line">        oldFiber = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nextOldFiber = oldFiber.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> newFiber = updateSlot(</span><br><span class="line">        returnFiber,</span><br><span class="line">        oldFiber,</span><br><span class="line">        step.value,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This breaks on empty slots like null children. That&#x27;s</span></span><br><span class="line">        <span class="comment">// unfortunate because it triggers the slow path all the time. We need</span></span><br><span class="line">        <span class="comment">// a better way to communicate whether this was a miss or null,</span></span><br><span class="line">        <span class="comment">// boolean, undefined, etc.</span></span><br><span class="line">        <span class="keyword">if</span> (!oldFiber) &#123;</span><br><span class="line">          oldFiber = nextOldFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We matched the slot, but we didn&#x27;t reuse the existing fiber, so we</span></span><br><span class="line">          <span class="comment">// need to delete the existing child.</span></span><br><span class="line">          deleteChild(returnFiber, oldFiber);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">        resultingFirstChild = newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Defer siblings if we&#x27;re not at the right index for this slot.</span></span><br><span class="line">        <span class="comment">// I.e. if we had null values before, then we want to defer this</span></span><br><span class="line">        <span class="comment">// for each null value. However, we also don&#x27;t want to call updateSlot</span></span><br><span class="line">        <span class="comment">// with the previous one.</span></span><br><span class="line">        previousNewFiber.sibling = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNewFiber = newFiber;</span><br><span class="line">      oldFiber = nextOldFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (step.done) &#123;</span><br><span class="line">      <span class="comment">// We&#x27;ve reached the end of the new children. We can delete the rest.</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">      <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If we don&#x27;t have any more existing children we can choose a fast path</span></span><br><span class="line">      <span class="comment">// since the rest will all be insertions.</span></span><br><span class="line">      <span class="keyword">for</span> (; !step.done; newIdx++, step = newChildren.next()) &#123;</span><br><span class="line">        <span class="keyword">const</span> newFiber = createChild(returnFiber, step.value, expirationTime);</span><br><span class="line">        <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">          resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add all children to a key map for quick lookups.</span></span><br><span class="line">    <span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep scanning and use the map to restore deleted items as moves.</span></span><br><span class="line">    <span class="keyword">for</span> (; !step.done; newIdx++, step = newChildren.next()) &#123;</span><br><span class="line">      <span class="keyword">const</span> newFiber = updateFromMap(</span><br><span class="line">        existingChildren,</span><br><span class="line">        returnFiber,</span><br><span class="line">        newIdx,</span><br><span class="line">        step.value,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (newFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">          <span class="keyword">if</span> (newFiber.alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The new fiber is a work in progress, but if there exists a</span></span><br><span class="line">            <span class="comment">// current, that means that we reused the fiber. We need to delete</span></span><br><span class="line">            <span class="comment">// it from the child list so that we don&#x27;t add it to the deletion</span></span><br><span class="line">            <span class="comment">// list.</span></span><br><span class="line">            existingChildren.delete(</span><br><span class="line">              newFiber.key === <span class="literal">null</span> ? newIdx : newFiber.key</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="comment">// Any existing children that weren&#x27;t consumed above were deleted. We need</span></span><br><span class="line">      <span class="comment">// to add them to the deletion list.</span></span><br><span class="line">      existingChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> deleteChild(returnFiber, child));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleTextNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    textContent: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// There&#x27;s no need to check for keys on text nodes since we don&#x27;t have a</span></span><br><span class="line">    <span class="comment">// way to define them.</span></span><br><span class="line">    <span class="keyword">if</span> (currentFirstChild !== <span class="literal">null</span> &amp;&amp; currentFirstChild.tag === HostText) &#123;</span><br><span class="line">      <span class="comment">// We already have an existing node so let&#x27;s just update it and delete</span></span><br><span class="line">      <span class="comment">// the rest.</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, currentFirstChild.sibling);</span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(currentFirstChild, textContent, expirationTime);</span><br><span class="line">      existing.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> existing;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The existing first child is not a text node so we need to create one</span></span><br><span class="line">    <span class="comment">// and delete the existing ones.</span></span><br><span class="line">    deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromText(</span><br><span class="line">      textContent,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime</span><br><span class="line">    );</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.key;</span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">      <span class="comment">// the first item in the list.</span></span><br><span class="line">      <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          child.tag === Fragment</span><br><span class="line">            ? element.type === REACT_FRAGMENT_TYPE</span><br><span class="line">            : child.elementType === element.type</span><br><span class="line">        ) &#123;</span><br><span class="line">          deleteRemainingChildren(returnFiber, child.sibling);</span><br><span class="line">          <span class="keyword">const</span> existing = useFiber(</span><br><span class="line">            child,</span><br><span class="line">            element.type === REACT_FRAGMENT_TYPE</span><br><span class="line">              ? element.props.children</span><br><span class="line">              : element.props,</span><br><span class="line">            expirationTime</span><br><span class="line">          );</span><br><span class="line">          existing.ref = coerceRef(returnFiber, child, element);</span><br><span class="line">          existing.return = returnFiber;</span><br><span class="line">          <span class="keyword">return</span> existing;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          deleteRemainingChildren(returnFiber, child);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deleteChild(returnFiber, child);</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">        element.props.children,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime,</span><br><span class="line">        element.key</span><br><span class="line">      );</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromElement(</span><br><span class="line">        element,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      created.ref = coerceRef(returnFiber, currentFirstChild, element);</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSinglePortal</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    portal: ReactPortal,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> key = portal.key;</span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">      <span class="comment">// the first item in the list.</span></span><br><span class="line">      <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          child.tag === HostPortal &amp;&amp;</span><br><span class="line">          child.stateNode.containerInfo === portal.containerInfo &amp;&amp;</span><br><span class="line">          child.stateNode.implementation === portal.implementation</span><br><span class="line">        ) &#123;</span><br><span class="line">          deleteRemainingChildren(returnFiber, child.sibling);</span><br><span class="line">          <span class="keyword">const</span> existing = useFiber(</span><br><span class="line">            child,</span><br><span class="line">            portal.children || [],</span><br><span class="line">            expirationTime</span><br><span class="line">          );</span><br><span class="line">          existing.return = returnFiber;</span><br><span class="line">          <span class="keyword">return</span> existing;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          deleteRemainingChildren(returnFiber, child);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deleteChild(returnFiber, child);</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromPortal(</span><br><span class="line">      portal,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime</span><br><span class="line">    );</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This API will tag the children with the side-effect of the reconciliation</span></span><br><span class="line">  <span class="comment">// itself. They will be added to the side-effect list as we pass through the</span></span><br><span class="line">  <span class="comment">// children and the parent.</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is not recursive.</span></span><br><span class="line">    <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">    <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">    <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">    <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">    <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">&quot;object&quot;</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key === <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.props.children;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle object types</span></span><br><span class="line">    <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">&quot;object&quot;</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$typeof) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime</span><br><span class="line">            )</span><br><span class="line">          );</span><br><span class="line">        <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSinglePortal(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime</span><br><span class="line">            )</span><br><span class="line">          );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">&quot;&quot;</span> + newChild,</span><br><span class="line">          expirationTime</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">      <span class="keyword">return</span> reconcileChildrenArray(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getIteratorFn(newChild)) &#123;</span><br><span class="line">      <span class="keyword">return</span> reconcileChildrenIterator(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">      throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ClassComponent"><a href="#ClassComponent" class="headerlink" title="ClassComponent"></a>ClassComponent</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Push context providers early to prevent context stack mismatches.</span></span><br><span class="line">  <span class="comment">// During mounting we don&#x27;t know the child context yet as the instance doesn&#x27;t exist.</span></span><br><span class="line">  <span class="comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span></span><br><span class="line">  <span class="keyword">let</span> hasContext;</span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">    hasContext = <span class="literal">true</span>;</span><br><span class="line">    pushLegacyContextProvider(workInProgress);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hasContext = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line">  <span class="keyword">let</span> shouldUpdate;</span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// An class component without an instance only mounts if it suspended</span></span><br><span class="line">      <span class="comment">// inside a non- concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">      <span class="comment">// tree it like a new mount, even though an empty version of it already</span></span><br><span class="line">      <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">      current.alternate = <span class="literal">null</span>;</span><br><span class="line">      workInProgress.alternate = <span class="literal">null</span>;</span><br><span class="line">      <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">      workInProgress.effectTag |= Placement;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">    constructClassInstance(</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    );</span><br><span class="line">    mountClassInstance(</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    );</span><br><span class="line">    shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// In a resume, we&#x27;ll already have an instance we can reuse.</span></span><br><span class="line">    shouldUpdate = resumeMountClassInstance(</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    shouldUpdate = updateClassInstance(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = finishClassComponent(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    Component,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderExpirationTime</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberClassComponent.js</span></span><br></pre></td></tr></table></figure>

<h3 id="IndeterminateComponent"><a href="#IndeterminateComponent" class="headerlink" title="IndeterminateComponent"></a>IndeterminateComponent</h3><ul>
<li>FunctionComponent é¦–æ¬¡æ¸²æŸ“åˆå§‹åŒ–çš„æ—¶å€™å°±æ˜¯ IndeterminateComponent</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountIndeterminateComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  _current,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// An indeterminate component only mounts if it suspended inside a non-</span></span><br><span class="line">    <span class="comment">// concurrent tree, in an inconsistent state. We want to treat it like</span></span><br><span class="line">    <span class="comment">// a new mount, even though an empty version of it already committed.</span></span><br><span class="line">    <span class="comment">// Disconnect the alternate pointers.</span></span><br><span class="line">    _current.alternate = <span class="literal">null</span>;</span><br><span class="line">    workInProgress.alternate = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">    workInProgress.effectTag |= Placement;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> props = workInProgress.pendingProps;</span><br><span class="line">  <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, Component, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> context = getMaskedContext(workInProgress, unmaskedContext);</span><br><span class="line"></span><br><span class="line">  prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line">  prepareToUseHooks(<span class="literal">null</span>, workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> value = Component(props, context);</span><br><span class="line">  <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">  workInProgress.effectTag |= PerformedWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// æ­¤æ¡ä»¶ä¸‹é¢ä¼šä¸¾ä¸ªåˆ—å­</span></span><br><span class="line">    <span class="keyword">typeof</span> value === <span class="string">&quot;object&quot;</span> &amp;&amp;</span><br><span class="line">    value !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> value.render === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">    value.$$typeof === <span class="literal">undefined</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// Proceed under the assumption that this is a class instance</span></span><br><span class="line">    workInProgress.tag = ClassComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Throw out any hooks that were used.</span></span><br><span class="line">    resetHooks();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push context providers early to prevent context stack mismatches.</span></span><br><span class="line">    <span class="comment">// During mounting we don&#x27;t know the child context yet as the instance doesn&#x27;t exist.</span></span><br><span class="line">    <span class="comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span></span><br><span class="line">    <span class="keyword">let</span> hasContext = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">      hasContext = <span class="literal">true</span>;</span><br><span class="line">      pushLegacyContextProvider(workInProgress);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      hasContext = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    workInProgress.memoizedState =</span><br><span class="line">      value.state !== <span class="literal">null</span> &amp;&amp; value.state !== <span class="literal">undefined</span> ? value.state : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getDerivedStateFromProps = Component.getDerivedStateFromProps;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      applyDerivedStateFromProps(</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        getDerivedStateFromProps,</span><br><span class="line">        props</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    adoptClassInstance(workInProgress, value);</span><br><span class="line">    mountClassInstance(workInProgress, Component, props, renderExpirationTime);</span><br><span class="line">    <span class="keyword">return</span> finishClassComponent(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      hasContext,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Proceed under the assumption that this is a function component</span></span><br><span class="line">    workInProgress.tag = FunctionComponent;</span><br><span class="line">    value = finishHooks(Component, props, value, context);</span><br><span class="line">    reconcileChildren(<span class="literal">null</span>, workInProgress, value, renderExpirationTime);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸¾ä¾‹Demo</span></span><br><span class="line"><span class="comment">// è¯´æ˜æ­¤æ—¶`let value = Component(props, context);`å¾—åˆ°çš„ç»“æœä¼šè¿›å…¥ä¸‹é¢çš„ifæœ€ç»ˆ</span></span><br><span class="line"><span class="comment">// `workInProgress.tag = ClassComponent;` å³è¢«è®¤ä¸ºæ˜¯ClassComponent</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">IndeterminateComponentDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¿™æ ·å†™å°±ä¼šæŠ¥é”™ï¼Œæ—¢ç„¶æ˜¯ClassComponentäº†</span></span><br><span class="line">  <span class="comment">// useEffect(() =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   console.log(&quot;useEffect invoked&quot;);</span></span><br><span class="line">  <span class="comment">//   return () =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//     console.log(&quot;useEffect cleanup&quot;);</span></span><br><span class="line">  <span class="comment">//   &#125;;</span></span><br><span class="line">  <span class="comment">// &#125;, []);</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;componentDidMount invoked&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>IndeterminateComponentDemo<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HostRoot-çš„æ›´æ–°"><a href="#HostRoot-çš„æ›´æ–°" class="headerlink" title="HostRoot çš„æ›´æ–°"></a>HostRoot çš„æ›´æ–°</h3><h3 id="HostComponent-å’Œ-HostText-çš„æ›´æ–°"><a href="#HostComponent-å’Œ-HostText-çš„æ›´æ–°" class="headerlink" title="HostComponent å’Œ HostText çš„æ›´æ–°"></a>HostComponent å’Œ HostText çš„æ›´æ–°</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostComponent</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">  pushHostContext(workInProgress); <span class="comment">// ä¸ºä»€ä¹ˆåŸç”ŸèŠ‚ç‚¹éœ€è¦context</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    tryToClaimNextHydratableInstance(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">  <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">  <span class="keyword">const</span> prevProps = current !== <span class="literal">null</span> ? current.memoizedProps : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nextChildren = nextProps.children;</span><br><span class="line">  <span class="keyword">const</span> isDirectTextChild = shouldSetTextContent(type, nextProps);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isDirectTextChild) &#123;</span><br><span class="line">    <span class="comment">// We special case a direct text child of a host node. This is a common</span></span><br><span class="line">    <span class="comment">// case. We won&#x27;t handle it as a reified child. We will instead handle</span></span><br><span class="line">    <span class="comment">// this in the host environment that also have access to this prop. That</span></span><br><span class="line">    <span class="comment">// avoids allocating another HostText fiber and traversing it.</span></span><br><span class="line">    nextChildren = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevProps !== <span class="literal">null</span> &amp;&amp; shouldSetTextContent(type, prevProps)) &#123;</span><br><span class="line">    <span class="comment">// If we&#x27;re switching from a direct text child to a normal child, or to</span></span><br><span class="line">    <span class="comment">// empty, we need to schedule the text content to be reset.</span></span><br><span class="line">    workInProgress.effectTag |= ContentReset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  markRef(current, workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check the host config to see if the children are offscreen/hidden.</span></span><br><span class="line">  <span class="comment">// è®¾ç½®hiddenæ„å‘³ç€æ°¸è¿œä¸ä¼šè¢«æ›´æ–°</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    renderExpirationTime !== Never &amp;&amp;</span><br><span class="line">    workInProgress.mode &amp; ConcurrentMode &amp;&amp;</span><br><span class="line">    shouldDeprioritizeSubtree(type, nextProps)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// Schedule this fiber to re-render at offscreen priority. Then bailout.</span></span><br><span class="line">    workInProgress.expirationTime = Never;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reconcileChildren(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostText</span>(<span class="params">current, workInProgress</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    tryToClaimNextHydratableInstance(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Nothing to do here. This is terminal. We&#x27;ll do the completion step</span></span><br><span class="line">  <span class="comment">// immediately after.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Portal-çš„æ›´æ–°"><a href="#Portal-çš„æ›´æ–°" class="headerlink" title="Portal çš„æ›´æ–°"></a>Portal çš„æ›´æ–°</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOM.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPortal</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: ?string = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> pass ReactDOM portal implementation as third argument</span></span><br><span class="line">  <span class="keyword">return</span> createPortalImpl(children, container, <span class="literal">null</span>, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\shared\ReactPortal.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPortal</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// <span class="doctag">TODO:</span> figure out the API for cross-renderer implementation.</span></span></span></span><br><span class="line"><span class="function"><span class="params">  implementation: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: ?string = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ReactPortal</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// This tag allow us to uniquely identify this as a React Portal</span></span><br><span class="line">    $$typeof: REACT_PORTAL_TYPE,</span><br><span class="line">    key: key == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="string">&quot;&quot;</span> + key,</span><br><span class="line">    children,</span><br><span class="line">    containerInfo,</span><br><span class="line">    implementation,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactChildFiber.js</span></span><br><span class="line"><span class="comment">// reconcileSinglePortal</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span></span><br><span class="line"><span class="comment">// updatePortalComponent</span></span><br></pre></td></tr></table></figure>

<h3 id="ForwardRef-çš„æ›´æ–°"><a href="#ForwardRef-çš„æ›´æ–°" class="headerlink" title="ForwardRef çš„æ›´æ–°"></a>ForwardRef çš„æ›´æ–°</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateForwardRef</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> render = Component.render;</span><br><span class="line">  <span class="keyword">const</span> ref = workInProgress.ref;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The rest is a fork of updateFunctionComponent</span></span><br><span class="line">  <span class="keyword">let</span> nextChildren;</span><br><span class="line">  prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line">  prepareToUseHooks(current, workInProgress, renderExpirationTime);</span><br><span class="line">  nextChildren = render(nextProps, ref);</span><br><span class="line">  nextChildren = finishHooks(render, nextProps, nextChildren, ref);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">  workInProgress.effectTag |= PerformedWork;</span><br><span class="line">  reconcileChildren(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Memo-ç»„ä»¶çš„æ›´æ–°"><a href="#Memo-ç»„ä»¶çš„æ›´æ–°" class="headerlink" title="Memo ç»„ä»¶çš„æ›´æ–°"></a>Memo ç»„ä»¶çš„æ›´æ–°</h3><h2 id="æ›´æ–°å®Œæˆ-completeUnitOfWork"><a href="#æ›´æ–°å®Œæˆ-completeUnitOfWork" class="headerlink" title="æ›´æ–°å®Œæˆ completeUnitOfWork"></a>æ›´æ–°å®Œæˆ completeUnitOfWork</h2><ul>
<li><p>æ ¹æ®æ˜¯å¦æœ‰ä¸­æ–­è°ƒç”¨ä¸åŒçš„å¤„ç†</p>
</li>
<li><p>åˆ¤æ–­æ˜¯å¦æœ‰å…„å¼ŸèŠ‚ç‚¹è°ƒç”¨ä¸åŒçš„å¤„ç†</p>
</li>
<li><p>å®ŒæˆèŠ‚ç‚¹åèµ‹å€¼ effect é“¾</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="comment">// performUnitOfWork</span></span><br><span class="line"><span class="comment">//     beginWork</span></span><br><span class="line"><span class="comment">//     completeUnitOfWork</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">workInProgress: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Attempt to complete the current unit of work, then move to the</span></span><br><span class="line">  <span class="comment">// next sibling. If there are no more siblings, return to the</span></span><br><span class="line">  <span class="comment">// parent fiber.</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// The current, flushed, state of this fiber is the alternate.</span></span><br><span class="line">    <span class="comment">// Ideally nothing should rely on this, but relying on it here</span></span><br><span class="line">    <span class="comment">// means that we don&#x27;t need an additional field on the work in</span></span><br><span class="line">    <span class="comment">// progress.</span></span><br><span class="line">    <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line">    <span class="keyword">const</span> returnFiber = workInProgress.return;</span><br><span class="line">    <span class="keyword">const</span> siblingFiber = workInProgress.sibling;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((workInProgress.effectTag &amp; Incomplete) === NoEffect) &#123;</span><br><span class="line">      <span class="comment">// This fiber completed.</span></span><br><span class="line">      <span class="comment">// Remember we&#x27;re completing this unit so we can find a boundary if it fails.</span></span><br><span class="line">      nextUnitOfWork = workInProgress;</span><br><span class="line">      <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (workInProgress.mode &amp; ProfileMode) &#123;</span><br><span class="line">          startProfilerTimer(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">        nextUnitOfWork = completeWork(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          nextRenderExpirationTime</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (workInProgress.mode &amp; ProfileMode) &#123;</span><br><span class="line">          <span class="comment">// Update render duration assuming we didn&#x27;t error.</span></span><br><span class="line">          stopProfilerTimerIfRunningAndRecordDelta(workInProgress, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nextUnitOfWork = completeWork(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          nextRenderExpirationTime</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      stopWorkTimer(workInProgress);</span><br><span class="line">      resetChildExpirationTime(workInProgress, nextRenderExpirationTime);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        <span class="keyword">return</span> nextUnitOfWork;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        returnFiber !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// Do not append effects to parents if a sibling failed to complete</span></span><br><span class="line">        (returnFiber.effectTag &amp; Incomplete) === NoEffect</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Append all the effects of the subtree and this fiber onto the effect</span></span><br><span class="line">        <span class="comment">// list of the parent. The completion order of the children affects the</span></span><br><span class="line">        <span class="comment">// side-effect order.</span></span><br><span class="line">        <span class="keyword">if</span> (returnFiber.firstEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">          returnFiber.firstEffect = workInProgress.firstEffect;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (workInProgress.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect = workInProgress.firstEffect;</span><br><span class="line">          &#125;</span><br><span class="line">          returnFiber.lastEffect = workInProgress.lastEffect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this fiber had side-effects, we append it AFTER the children&#x27;s</span></span><br><span class="line">        <span class="comment">// side-effects. We can perform certain side-effects earlier if</span></span><br><span class="line">        <span class="comment">// needed, by doing multiple passes over the effect list. We don&#x27;t want</span></span><br><span class="line">        <span class="comment">// to schedule our own side-effect on our own list because if end up</span></span><br><span class="line">        <span class="comment">// reusing children we&#x27;ll schedule this effect onto itself since we&#x27;re</span></span><br><span class="line">        <span class="comment">// at the end.</span></span><br><span class="line">        <span class="keyword">const</span> effectTag = workInProgress.effectTag;</span><br><span class="line">        <span class="comment">// Skip both NoWork and PerformedWork tags when creating the effect list.</span></span><br><span class="line">        <span class="comment">// PerformedWork effect is read by React DevTools but shouldn&#x27;t be committed.</span></span><br><span class="line">        <span class="keyword">if</span> (effectTag &gt; PerformedWork) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect = workInProgress;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            returnFiber.firstEffect = workInProgress;</span><br><span class="line">          &#125;</span><br><span class="line">          returnFiber.lastEffect = workInProgress;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">        <span class="keyword">return</span> siblingFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If there&#x27;s no more work in this returnFiber. Complete the returnFiber.</span></span><br><span class="line">        workInProgress = returnFiber;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; workInProgress.mode &amp; ProfileMode) &#123;</span><br><span class="line">        <span class="comment">// Record the render duration for the fiber that errored.</span></span><br><span class="line">        stopProfilerTimerIfRunningAndRecordDelta(workInProgress, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Include the time spent working on failed children before continuing.</span></span><br><span class="line">        <span class="keyword">let</span> actualDuration = workInProgress.actualDuration;</span><br><span class="line">        <span class="keyword">let</span> child = workInProgress.child;</span><br><span class="line">        <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">          actualDuration += child.actualDuration;</span><br><span class="line">          child = child.sibling;</span><br><span class="line">        &#125;</span><br><span class="line">        workInProgress.actualDuration = actualDuration;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = unwindWork(workInProgress, nextRenderExpirationTime);</span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don&#x27;t reset its expiration time.</span></span><br><span class="line">      <span class="keyword">if</span> (workInProgress.effectTag &amp; DidCapture) &#123;</span><br><span class="line">        <span class="comment">// Restarting an error boundary</span></span><br><span class="line">        stopFailedWorkTimer(workInProgress);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stopWorkTimer(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        stopWorkTimer(workInProgress);</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; ReactFiberInstrumentation.debugTool) &#123;</span><br><span class="line">          ReactFiberInstrumentation.debugTool.onCompleteWork(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We&#x27;ll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we&#x27;re restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.effectTag &amp;= HostEffectMask;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its effect list.</span></span><br><span class="line">        returnFiber.firstEffect = returnFiber.lastEffect = <span class="literal">null</span>;</span><br><span class="line">        returnFiber.effectTag |= Incomplete;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">        <span class="keyword">return</span> siblingFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If there&#x27;s no more work in this returnFiber. Complete the returnFiber.</span></span><br><span class="line">        workInProgress = returnFiber;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Without this explicit null return Flow complains of invalid return type</span></span><br><span class="line">  <span class="comment">// TODO Remove the above while(true) loop</span></span><br><span class="line">  <span class="comment">// eslint-disable-next-line no-unreachable</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é‡è®¾-childExpirationTime"><a href="#é‡è®¾-childExpirationTime" class="headerlink" title="é‡è®¾ childExpirationTime"></a>é‡è®¾ childExpirationTime</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetChildExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (renderTime !== Never &amp;&amp; workInProgress.childExpirationTime === Never) &#123;</span><br><span class="line">    <span class="comment">// The children of this component are hidden. Don&#x27;t bubble their</span></span><br><span class="line">    <span class="comment">// expiration times.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> newChildExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bubble up the earliest expiration time.</span></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; workInProgress.mode &amp; ProfileMode) &#123;</span><br><span class="line">    <span class="comment">// We&#x27;re in profiling mode.</span></span><br><span class="line">    <span class="comment">// Let&#x27;s use this same traversal to update the render durations.</span></span><br><span class="line">    <span class="keyword">let</span> actualDuration = workInProgress.actualDuration;</span><br><span class="line">    <span class="keyword">let</span> treeBaseDuration = workInProgress.selfBaseDuration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When a fiber is cloned, its actualDuration is reset to 0.</span></span><br><span class="line">    <span class="comment">// This value will only be updated if work is done on the fiber (i.e. it doesn&#x27;t bailout).</span></span><br><span class="line">    <span class="comment">// When work is done, it should bubble to the parent&#x27;s actualDuration.</span></span><br><span class="line">    <span class="comment">// If the fiber has not been cloned though, (meaning no work was done),</span></span><br><span class="line">    <span class="comment">// Then this value will reflect the amount of time spent working on a previous render.</span></span><br><span class="line">    <span class="comment">// In that case it should not bubble.</span></span><br><span class="line">    <span class="comment">// We determine whether it was cloned by comparing the child pointer.</span></span><br><span class="line">    <span class="keyword">const</span> shouldBubbleActualDurations =</span><br><span class="line">      workInProgress.alternate === <span class="literal">null</span> ||</span><br><span class="line">      workInProgress.child !== workInProgress.alternate.child;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> child = workInProgress.child;</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> childUpdateExpirationTime = child.expirationTime;</span><br><span class="line">      <span class="keyword">const</span> childChildExpirationTime = child.childExpirationTime;</span><br><span class="line">      <span class="keyword">if</span> (childUpdateExpirationTime &gt; newChildExpirationTime) &#123;</span><br><span class="line">        newChildExpirationTime = childUpdateExpirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (childChildExpirationTime &gt; newChildExpirationTime) &#123;</span><br><span class="line">        newChildExpirationTime = childChildExpirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (shouldBubbleActualDurations) &#123;</span><br><span class="line">        actualDuration += child.actualDuration;</span><br><span class="line">      &#125;</span><br><span class="line">      treeBaseDuration += child.treeBaseDuration;</span><br><span class="line">      child = child.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    workInProgress.actualDuration = actualDuration;</span><br><span class="line">    workInProgress.treeBaseDuration = treeBaseDuration;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> child = workInProgress.child;</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> childUpdateExpirationTime = child.expirationTime;</span><br><span class="line">      <span class="keyword">const</span> childChildExpirationTime = child.childExpirationTime;</span><br><span class="line">      <span class="keyword">if</span> (childUpdateExpirationTime &gt; newChildExpirationTime) &#123;</span><br><span class="line">        newChildExpirationTime = childUpdateExpirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (childChildExpirationTime &gt; newChildExpirationTime) &#123;</span><br><span class="line">        newChildExpirationTime = childChildExpirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  workInProgress.childExpirationTime = newChildExpirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="completeWork"><a href="#completeWork" class="headerlink" title="completeWork"></a>completeWork</h3><ul>
<li><p>pop å„ç§ context ç›¸å…³å†…å®¹</p>
</li>
<li><p>å¯¹ HostComponent æ‰§è¡Œåˆå§‹åŒ–</p>
</li>
<li><p>åˆå§‹åŒ–ç›‘å¬äº‹ä»¶</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> LazyComponent:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent:</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">        popLegacyContext(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      popHostContainer(workInProgress);</span><br><span class="line">      popTopLevelLegacyContextObject(workInProgress);</span><br><span class="line">      <span class="keyword">const</span> fiberRoot = (workInProgress.stateNode: FiberRoot);</span><br><span class="line">      <span class="keyword">if</span> (fiberRoot.pendingContext) &#123;</span><br><span class="line">        fiberRoot.context = fiberRoot.pendingContext;</span><br><span class="line">        fiberRoot.pendingContext = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (current === <span class="literal">null</span> || current.child === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If we hydrated, pop so that we can delete any remaining children</span></span><br><span class="line">        <span class="comment">// that weren&#x27;t hydrated.</span></span><br><span class="line">        popHydrationState(workInProgress);</span><br><span class="line">        <span class="comment">// This resets the hacky state to fix isMounted before committing.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Delete this when we delete isMounted and findDOMNode.</span></span><br><span class="line">        workInProgress.effectTag &amp;= ~Placement;</span><br><span class="line">      &#125;</span><br><span class="line">      updateHostContainer(workInProgress);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      popHostContext(workInProgress);</span><br><span class="line">      <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">      <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">        updateHostComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          type,</span><br><span class="line">          newProps,</span><br><span class="line">          rootContainerInstance</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.ref !== workInProgress.ref) &#123;</span><br><span class="line">          markRef(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!newProps) &#123;</span><br><span class="line">          invariant(</span><br><span class="line">            workInProgress.stateNode !== <span class="literal">null</span>,</span><br><span class="line">            <span class="string">&quot;We must have new props for new mounts. This error is likely &quot;</span> +</span><br><span class="line">              <span class="string">&quot;caused by a bug in React. Please file an issue.&quot;</span></span><br><span class="line">          );</span><br><span class="line">          <span class="comment">// This can happen when we abort work.</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move createInstance to beginWork and keep it on a context</span></span><br><span class="line">        <span class="comment">// &quot;stack&quot; as the parent. Then append children as we go in beginWork</span></span><br><span class="line">        <span class="comment">// or completeWork depending on we want to add then top-&gt;down or</span></span><br><span class="line">        <span class="comment">// bottom-&gt;up. Top-&gt;down is faster in IE11.</span></span><br><span class="line">        <span class="keyword">let</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">        <span class="keyword">if</span> (wasHydrated) &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Move this and createInstance step into the beginPhase</span></span><br><span class="line">          <span class="comment">// to consolidate.</span></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            prepareToHydrateHostInstance(</span><br><span class="line">              workInProgress,</span><br><span class="line">              rootContainerInstance,</span><br><span class="line">              currentHostContext</span><br><span class="line">            )</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">// If changes to the hydrated node needs to be applied at the</span></span><br><span class="line">            <span class="comment">// commit-phase we mark this as such.</span></span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> instance = createInstance(</span><br><span class="line">            <span class="comment">// createElement</span></span><br><span class="line">            type,</span><br><span class="line">            newProps,</span><br><span class="line">            rootContainerInstance,</span><br><span class="line">            currentHostContext,</span><br><span class="line">            workInProgress</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">          appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Certain renderers require commit-time effects for initial mount.</span></span><br><span class="line">          <span class="comment">// (eg DOM renderer supports auto-focus for certain elements).</span></span><br><span class="line">          <span class="comment">// Make sure such renderers get scheduled for later work.</span></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            finalizeInitialChildren(</span><br><span class="line">              instance,</span><br><span class="line">              type,</span><br><span class="line">              newProps,</span><br><span class="line">              rootContainerInstance,</span><br><span class="line">              currentHostContext</span><br><span class="line">            )</span><br><span class="line">          ) &#123;</span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">          workInProgress.stateNode = instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgress.ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// If there is a ref on a host node we need to schedule a callback</span></span><br><span class="line">          markRef(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      <span class="keyword">let</span> newText = newProps;</span><br><span class="line">      <span class="keyword">if</span> (current &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> oldText = current.memoizedProps;</span><br><span class="line">        <span class="comment">// If we have an alternate, that means this is an update and we need</span></span><br><span class="line">        <span class="comment">// to schedule a side-effect to do the updates.</span></span><br><span class="line">        updateHostText(current, workInProgress, oldText, newText);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> newText !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">          invariant(</span><br><span class="line">            workInProgress.stateNode !== <span class="literal">null</span>,</span><br><span class="line">            <span class="string">&quot;We must have new props for new mounts. This error is likely &quot;</span> +</span><br><span class="line">              <span class="string">&quot;caused by a bug in React. Please file an issue.&quot;</span></span><br><span class="line">          );</span><br><span class="line">          <span class="comment">// This can happen when we abort work.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">        <span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line">        <span class="keyword">let</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">        <span class="keyword">if</span> (wasHydrated) &#123;</span><br><span class="line">          <span class="keyword">if</span> (prepareToHydrateHostTextInstance(workInProgress)) &#123;</span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          workInProgress.stateNode = createTextInstance(</span><br><span class="line">            newText,</span><br><span class="line">            rootContainerInstance,</span><br><span class="line">            currentHostContext,</span><br><span class="line">            workInProgress</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> nextState = workInProgress.memoizedState;</span><br><span class="line">      <span class="keyword">if</span> ((workInProgress.effectTag &amp; DidCapture) !== NoEffect) &#123;</span><br><span class="line">        <span class="comment">// Something suspended. Re-render with the fallback children.</span></span><br><span class="line">        workInProgress.expirationTime = renderExpirationTime;</span><br><span class="line">        <span class="comment">// Do not reset the effect list.</span></span><br><span class="line">        <span class="keyword">return</span> workInProgress;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> nextDidTimeout = nextState !== <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">const</span> prevDidTimeout = current !== <span class="literal">null</span> &amp;&amp; current.memoizedState !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; !nextDidTimeout &amp;&amp; prevDidTimeout) &#123;</span><br><span class="line">        <span class="comment">// We just switched from the fallback to the normal children. Delete</span></span><br><span class="line">        <span class="comment">// the fallback.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Would it be better to store the fallback fragment on</span></span><br><span class="line">        <span class="comment">// the stateNode during the begin phase?</span></span><br><span class="line">        <span class="keyword">const</span> currentFallbackChild: Fiber | <span class="literal">null</span> = (current.child: any).sibling;</span><br><span class="line">        <span class="keyword">if</span> (currentFallbackChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// Deletions go at the beginning of the return fiber&#x27;s effect list</span></span><br><span class="line">          <span class="keyword">const</span> first = workInProgress.firstEffect;</span><br><span class="line">          <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">            workInProgress.firstEffect = currentFallbackChild;</span><br><span class="line">            currentFallbackChild.nextEffect = first;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            workInProgress.firstEffect = workInProgress.lastEffect =</span><br><span class="line">              currentFallbackChild;</span><br><span class="line">            currentFallbackChild.nextEffect = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          currentFallbackChild.effectTag = Deletion;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The children either timed out after previously being visible, or</span></span><br><span class="line">      <span class="comment">// were restored after previously being hidden. Schedule an effect</span></span><br><span class="line">      <span class="comment">// to update their visiblity.</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        nextDidTimeout !== prevDidTimeout ||</span><br><span class="line">        <span class="comment">// Outside concurrent mode, the primary children commit in an</span></span><br><span class="line">        <span class="comment">// inconsistent state, even if they are hidden. So if they are hidden,</span></span><br><span class="line">        <span class="comment">// we need to schedule an effect to re-hide them, just in case.</span></span><br><span class="line">        ((workInProgress.effectTag &amp; ConcurrentMode) === NoContext &amp;&amp;</span><br><span class="line">          nextDidTimeout)</span><br><span class="line">      ) &#123;</span><br><span class="line">        workInProgress.effectTag |= Update;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Mode:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Profiler:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      popHostContainer(workInProgress);</span><br><span class="line">      updateHostContainer(workInProgress);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ContextProvider:</span><br><span class="line">      <span class="comment">// Pop provider fiber</span></span><br><span class="line">      popProvider(workInProgress);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="comment">// Same as class component case. I put it down here so that the tags are</span></span><br><span class="line">      <span class="comment">// sequential to ensure this switch is compiled to a jump table.</span></span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">        popLegacyContext(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Unknown unit of work tag. This error is likely caused by a bug in &quot;</span> +</span><br><span class="line">          <span class="string">&quot;React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡è¦çš„ä¹Ÿå°±HostComponentï¼ŒHostTextå’ŒSuspenseComponent</span></span><br></pre></td></tr></table></figure>

<h3 id="åˆæ¬¡æ¸²æŸ“ä¸­-completeWork-å¯¹äº-DOM-èŠ‚ç‚¹çš„åˆ›å»ºå’Œ-appendAllChil"><a href="#åˆæ¬¡æ¸²æŸ“ä¸­-completeWork-å¯¹äº-DOM-èŠ‚ç‚¹çš„åˆ›å»ºå’Œ-appendAllChil" class="headerlink" title="åˆæ¬¡æ¸²æŸ“ä¸­ completeWork å¯¹äº DOM èŠ‚ç‚¹çš„åˆ›å»ºå’Œ appendAllChil"></a>åˆæ¬¡æ¸²æŸ“ä¸­ completeWork å¯¹äº DOM èŠ‚ç‚¹çš„åˆ›å»ºå’Œ appendAllChil</h3><ul>
<li><p>diff properties è®¡ç®—éœ€è¦æ›´æ–°çš„å†…å®¹</p>
</li>
<li><p>ä¸åŒ dom properties å¤„ç†ä¸åŒ</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberCompleteWork.js</span></span><br><span class="line"><span class="keyword">let</span> appendAllChildren;</span><br><span class="line"><span class="keyword">let</span> updateHostContainer;</span><br><span class="line"><span class="keyword">let</span> updateHostComponent;</span><br><span class="line"><span class="keyword">let</span> updateHostText;</span><br><span class="line"><span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">  <span class="comment">// Mutation mode</span></span><br><span class="line"></span><br><span class="line">  appendAllChildren = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    parent: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    needsVisibilityToggle: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">    isHidden: boolean</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// We only have the top Fiber that was created but we need recurse down its</span></span><br><span class="line">    <span class="comment">// children to find all the terminal nodes.</span></span><br><span class="line">    <span class="keyword">let</span> node = workInProgress.child;</span><br><span class="line">    <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°ç¬¬ä¸€å±‚HostComponentå¹¶æ‰§è¡ŒappendChild, å¹¶ä¸ä¼šåµŒå¥—appendChild</span></span><br><span class="line">        appendInitialChild(parent, node.stateNode);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) &#123;</span><br><span class="line">        <span class="comment">// If we have a portal child, then we don&#x27;t want to traverse</span></span><br><span class="line">        <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">        <span class="comment">// the portal directly.</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">        node.child.return = node;</span><br><span class="line">        node = node.child;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (node === workInProgress) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === workInProgress) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.return; <span class="comment">// å‘ä¸ŠæŸ¥æ‰¾</span></span><br><span class="line">      &#125;</span><br><span class="line">      node.sibling.return = node.return;</span><br><span class="line">      node = node.sibling; <span class="comment">// å…„å¼ŸèŠ‚ç‚¹ä¹‹é—´</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  updateHostContainer = <span class="function"><span class="keyword">function</span> (<span class="params">workInProgress: Fiber</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Noop</span></span><br><span class="line">  &#125;;</span><br><span class="line">  updateHostComponent = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    type: Type,</span></span></span><br><span class="line"><span class="function"><span class="params">    newProps: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">    rootContainerInstance: Container</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// If we have an alternate, that means this is an update and we need to</span></span><br><span class="line">    <span class="comment">// schedule a side-effect to do the updates.</span></span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps;</span><br><span class="line">    <span class="keyword">if</span> (oldProps === newProps) &#123;</span><br><span class="line">      <span class="comment">// In mutation mode, this is sufficient for a bailout because</span></span><br><span class="line">      <span class="comment">// we won&#x27;t touch this node even if children changed.</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we get updated because one of our children updated, we don&#x27;t</span></span><br><span class="line">    <span class="comment">// have newProps so we&#x27;ll have to reuse them.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Split the update API as separate for the props vs. children.</span></span><br><span class="line">    <span class="comment">// Even better would be if children weren&#x27;t special cased at all tho.</span></span><br><span class="line">    <span class="keyword">const</span> instance: Instance = workInProgress.stateNode;</span><br><span class="line">    <span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Experiencing an error where oldProps is null. Suggests a host</span></span><br><span class="line">    <span class="comment">// component is hitting the resume path. Figure out why. Possibly</span></span><br><span class="line">    <span class="comment">// related to `hidden`.</span></span><br><span class="line">    <span class="keyword">const</span> updatePayload = prepareUpdate(</span><br><span class="line">      instance,</span><br><span class="line">      type,</span><br><span class="line">      oldProps,</span><br><span class="line">      newProps,</span><br><span class="line">      rootContainerInstance,</span><br><span class="line">      currentHostContext</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Type this specific to this type of component.</span></span><br><span class="line">    workInProgress.updateQueue = (updatePayload: any);</span><br><span class="line">    <span class="comment">// If the update payload indicates that there is a change or if there</span></span><br><span class="line">    <span class="comment">// is a new ref we mark this as an update. All the work is done in commitWork.</span></span><br><span class="line">    <span class="keyword">if</span> (updatePayload) &#123;</span><br><span class="line">      markUpdate(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  updateHostText = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    oldText: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    newText: string</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// If the text differs, mark it as an update. All the work in done in commitWork.</span></span><br><span class="line">    <span class="keyword">if</span> (oldText !== newText) &#123;</span><br><span class="line">      markUpdate(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (supportsPersistence) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ›´æ–°-DOM-æ—¶è¿›è¡Œçš„-diff-åˆ¤æ–­"><a href="#æ›´æ–°-DOM-æ—¶è¿›è¡Œçš„-diff-åˆ¤æ–­" class="headerlink" title="æ›´æ–° DOM æ—¶è¿›è¡Œçš„ diff åˆ¤æ–­"></a>æ›´æ–° DOM æ—¶è¿›è¡Œçš„ diff åˆ¤æ–­</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOMHostConfig.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domElement: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldProps: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">  newProps: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">  rootContainerInstance: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  hostContext: HostContext</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> | <span class="title">Array</span>&lt;<span class="title">mixed</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> diffProperties(</span><br><span class="line">    domElement,</span><br><span class="line">    type,</span><br><span class="line">    oldProps,</span><br><span class="line">    newProps,</span><br><span class="line">    rootContainerInstance</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOMComponent.js</span></span><br><span class="line"><span class="comment">// Calculate the diff between the two objects.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diffProperties</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domElement: Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  lastRawProps: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextRawProps: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  rootContainerElement: Element | Document</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> | <span class="title">Array</span>&lt;<span class="title">mixed</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> updatePayload: <span class="literal">null</span> | <span class="built_in">Array</span>&lt;any&gt; = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lastProps: <span class="built_in">Object</span>;</span><br><span class="line">  <span class="keyword">let</span> nextProps: <span class="built_in">Object</span>;</span><br><span class="line">  <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;input&quot;</span>:</span><br><span class="line">      lastProps = ReactDOMInputGetHostProps(domElement, lastRawProps);</span><br><span class="line">      nextProps = ReactDOMInputGetHostProps(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;option&quot;</span>:</span><br><span class="line">      lastProps = ReactDOMOptionGetHostProps(domElement, lastRawProps);</span><br><span class="line">      nextProps = ReactDOMOptionGetHostProps(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;select&quot;</span>:</span><br><span class="line">      lastProps = ReactDOMSelectGetHostProps(domElement, lastRawProps);</span><br><span class="line">      nextProps = ReactDOMSelectGetHostProps(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;textarea&quot;</span>:</span><br><span class="line">      lastProps = ReactDOMTextareaGetHostProps(domElement, lastRawProps);</span><br><span class="line">      nextProps = ReactDOMTextareaGetHostProps(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      lastProps = lastRawProps;</span><br><span class="line">      nextProps = nextRawProps;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="keyword">typeof</span> lastProps.onClick !== <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> nextProps.onClick === <span class="string">&quot;function&quot;</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This cast may not be sound for SVG, MathML or custom elements.</span></span><br><span class="line">        trapClickOnNonInteractiveElement(((domElement: any): HTMLElement));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assertValidProps(tag, nextProps);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> propKey;</span><br><span class="line">  <span class="keyword">let</span> styleName;</span><br><span class="line">  <span class="keyword">let</span> styleUpdates = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> lastProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      nextProps.hasOwnProperty(propKey) ||</span><br><span class="line">      !lastProps.hasOwnProperty(propKey) ||</span><br><span class="line">      lastProps[propKey] == <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (propKey === STYLE) &#123;</span><br><span class="line">      <span class="keyword">const</span> lastStyle = lastProps[propKey];</span><br><span class="line">      <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastStyle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastStyle.hasOwnProperty(styleName)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">            styleUpdates = &#123;&#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          styleUpdates[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML || propKey === CHILDREN) &#123;</span><br><span class="line">      <span class="comment">// Noop. This is handled by the clear text mechanism.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      propKey === SUPPRESS_CONTENT_EDITABLE_WARNING ||</span><br><span class="line">      propKey === SUPPRESS_HYDRATION_WARNING</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Noop</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === AUTOFOCUS) &#123;</span><br><span class="line">      <span class="comment">// Noop. It doesn&#x27;t work on updates anyway.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameModules.hasOwnProperty(propKey)) &#123;</span><br><span class="line">      <span class="comment">// This is a special case. If any listener updates we need to ensure</span></span><br><span class="line">      <span class="comment">// that the &quot;current&quot; fiber pointer gets updated so we need a commit</span></span><br><span class="line">      <span class="comment">// to update this element.</span></span><br><span class="line">      <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// For all other deleted properties we add it to the queue. We use</span></span><br><span class="line">      <span class="comment">// the whitelist in the commit phase instead.</span></span><br><span class="line">      (updatePayload = updatePayload || []).push(propKey, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">    <span class="keyword">const</span> nextProp = nextProps[propKey];</span><br><span class="line">    <span class="keyword">const</span> lastProp = lastProps != <span class="literal">null</span> ? lastProps[propKey] : <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !nextProps.hasOwnProperty(propKey) ||</span><br><span class="line">      nextProp === lastProp ||</span><br><span class="line">      (nextProp == <span class="literal">null</span> &amp;&amp; lastProp == <span class="literal">null</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (propKey === STYLE) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastProp) &#123;</span><br><span class="line">        <span class="comment">// Unset styles on `lastProp` but not on `nextProp`.</span></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            lastProp.hasOwnProperty(styleName) &amp;&amp;</span><br><span class="line">            (!nextProp || !nextProp.hasOwnProperty(styleName))</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            styleUpdates[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Update styles that changed since `lastProp`.</span></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> nextProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            nextProp.hasOwnProperty(styleName) &amp;&amp;</span><br><span class="line">            lastProp[styleName] !== nextProp[styleName]</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            styleUpdates[styleName] = nextProp[styleName];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Relies on `updateStylesByID` not mutating `styleUpdates`.</span></span><br><span class="line">        <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">            updatePayload = [];</span><br><span class="line">          &#125;</span><br><span class="line">          updatePayload.push(propKey, styleUpdates);</span><br><span class="line">        &#125;</span><br><span class="line">        styleUpdates = nextProp;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextHtml = nextProp ? nextProp[HTML] : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">const</span> lastHtml = lastProp ? lastProp[HTML] : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">if</span> (nextHtml != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastHtml !== nextHtml) &#123;</span><br><span class="line">          (updatePayload = updatePayload || []).push(propKey, <span class="string">&quot;&quot;</span> + nextHtml);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> It might be too late to clear this if we have children</span></span><br><span class="line">        <span class="comment">// inserted already.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === CHILDREN) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        lastProp !== nextProp &amp;&amp;</span><br><span class="line">        (<span class="keyword">typeof</span> nextProp === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> nextProp === <span class="string">&quot;number&quot;</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        (updatePayload = updatePayload || []).push(propKey, <span class="string">&quot;&quot;</span> + nextProp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      propKey === SUPPRESS_CONTENT_EDITABLE_WARNING ||</span><br><span class="line">      propKey === SUPPRESS_HYDRATION_WARNING</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Noop</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameModules.hasOwnProperty(propKey)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We eagerly listen to this even though we haven&#x27;t committed yet.</span></span><br><span class="line">        ensureListeningTo(rootContainerElement, propKey);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!updatePayload &amp;&amp; lastProp !== nextProp) &#123;</span><br><span class="line">        <span class="comment">// This is a special case. If any listener updates we need to ensure</span></span><br><span class="line">        <span class="comment">// that the &quot;current&quot; props pointer gets updated so we need a commit</span></span><br><span class="line">        <span class="comment">// to update this element.</span></span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// For any other property we always add it to the queue and then we</span></span><br><span class="line">      <span class="comment">// filter it out using the whitelist during the commit.</span></span><br><span class="line">      (updatePayload = updatePayload || []).push(propKey, nextProp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (styleUpdates) &#123;</span><br><span class="line">    (updatePayload = updatePayload || []).push(STYLE, styleUpdates);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> updatePayload;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Apply the diff.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateProperties</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domElement: Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  updatePayload: <span class="built_in">Array</span>&lt;any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  lastRawProps: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextRawProps: <span class="built_in">Object</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Update checked *before* name.</span></span><br><span class="line">  <span class="comment">// In the middle of an update, it is possible to have multiple checked.</span></span><br><span class="line">  <span class="comment">// When a checked radio tries to change name, browser makes another radio&#x27;s checked false.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    tag === <span class="string">&quot;input&quot;</span> &amp;&amp;</span><br><span class="line">    nextRawProps.type === <span class="string">&quot;radio&quot;</span> &amp;&amp;</span><br><span class="line">    nextRawProps.name != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    ReactDOMInputUpdateChecked(domElement, nextRawProps);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> wasCustomComponentTag = isCustomComponent(tag, lastRawProps);</span><br><span class="line">  <span class="keyword">const</span> isCustomComponentTag = isCustomComponent(tag, nextRawProps);</span><br><span class="line">  <span class="comment">// Apply the diff.</span></span><br><span class="line">  updateDOMProperties(</span><br><span class="line">    domElement,</span><br><span class="line">    updatePayload,</span><br><span class="line">    wasCustomComponentTag,</span><br><span class="line">    isCustomComponentTag</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Ensure that an update gets scheduled if any of the special props</span></span><br><span class="line">  <span class="comment">// changed.</span></span><br><span class="line">  <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;input&quot;</span>:</span><br><span class="line">      <span class="comment">// Update the wrapper around inputs *after* updating props. This has to</span></span><br><span class="line">      <span class="comment">// happen after `updateDOMProperties`. Otherwise HTML5 input validations</span></span><br><span class="line">      <span class="comment">// raise warnings and prevent the new value from being assigned.</span></span><br><span class="line">      ReactDOMInputUpdateWrapper(domElement, nextRawProps);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;textarea&quot;</span>:</span><br><span class="line">      ReactDOMTextareaUpdateWrapper(domElement, nextRawProps);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;select&quot;</span>:</span><br><span class="line">      <span class="comment">// &lt;select&gt; value update needs to occur after &lt;option&gt; children</span></span><br><span class="line">      <span class="comment">// reconciliation</span></span><br><span class="line">      ReactDOMSelectPostUpdateWrapper(domElement, nextRawProps);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMProperties</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domElement: Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  updatePayload: <span class="built_in">Array</span>&lt;any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  wasCustomComponentTag: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  isCustomComponentTag: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Handle wasCustomComponentTag</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; updatePayload.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> propKey = updatePayload[i];</span><br><span class="line">    <span class="keyword">const</span> propValue = updatePayload[i + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (propKey === STYLE) &#123;</span><br><span class="line">      setValueForStyles(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML) &#123;</span><br><span class="line">      setInnerHTML(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === CHILDREN) &#123;</span><br><span class="line">      setTextContent(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setValueForProperty(domElement, propKey, propValue, isCustomComponentTag);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="completeWork-é˜¶æ®µå¯¹äº-HostText-çš„æ›´æ–°"><a href="#completeWork-é˜¶æ®µå¯¹äº-HostText-çš„æ›´æ–°" class="headerlink" title="completeWork é˜¶æ®µå¯¹äº HostText çš„æ›´æ–°"></a>completeWork é˜¶æ®µå¯¹äº HostText çš„æ›´æ–°</h3><h3 id="renderRoot-ä¸­å¯¹äºé”™è¯¯çš„å¤„ç†"><a href="#renderRoot-ä¸­å¯¹äºé”™è¯¯çš„å¤„ç†" class="headerlink" title="renderRoot ä¸­å¯¹äºé”™è¯¯çš„å¤„ç†"></a>renderRoot ä¸­å¯¹äºé”™è¯¯çš„å¤„ç†</h3><ul>
<li><p>ç»™æŠ¥é”™èŠ‚ç‚¹å¢åŠ  InComplate å‰¯ä½œç”¨</p>
</li>
<li><p>ç»™çˆ¶é“¾ä¸Šå…·æœ‰ error boundary çš„èŠ‚ç‚¹å¢åŠ å‰¯ä½œç”¨</p>
</li>
<li><p>åˆ›å»ºé”™è¯¯ç›¸å…³çš„æ›´æ–°</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// onUncaughtError</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  throwException</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  completeUnitOfWork  åœæ­¢å­èŠ‚ç‚¹æ¸²æŸ“</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//     thenableå¤„ç†</span></span><br><span class="line"><span class="comment">//     renderDidError</span></span><br><span class="line"><span class="comment">//     createCapturedValue</span></span><br><span class="line"><span class="comment">//     createClassErrorUpdate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘ä¸ŠæŸ¥æ‰¾ç¬¬ä¸€ä¸ªèƒ½å¤„ç†é”™è¯¯çš„é€»è¾‘</span></span><br><span class="line"><span class="comment">// getDerivedStateFromError</span></span><br><span class="line"><span class="comment">// componentDidCatch</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createClassErrorUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  errorInfo: CapturedValue&lt;mixed&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Update</span>&lt;<span class="title">mixed</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime);</span><br><span class="line">  update.tag = CaptureUpdate;</span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromError = fiber.type.getDerivedStateFromError;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromError === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> error = errorInfo.value;</span><br><span class="line">    update.payload = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> getDerivedStateFromError(error);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inst = fiber.stateNode;</span><br><span class="line">  <span class="keyword">if</span> (inst !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> inst.componentDidCatch === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">    update.callback = <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromError !== <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// To preserve the preexisting retry behavior of error boundaries,</span></span><br><span class="line">        <span class="comment">// we keep track of which ones already failed during this batch.</span></span><br><span class="line">        <span class="comment">// This gets reset before we yield back to the browser.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Warn in strict mode if getDerivedStateFromError is</span></span><br><span class="line">        <span class="comment">// not defined.</span></span><br><span class="line">        markLegacyErrorBoundaryAsFailed(<span class="built_in">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> error = errorInfo.value;</span><br><span class="line">      <span class="keyword">const</span> stack = errorInfo.stack;</span><br><span class="line">      logError(fiber, errorInfo);</span><br><span class="line">      <span class="built_in">this</span>.componentDidCatch(error, &#123;</span><br><span class="line">        componentStack: stack !== <span class="literal">null</span> ? stack : <span class="string">&quot;&quot;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> update;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="unwindWork-ä»¥åŠ-React-ä¸­çš„é”™è¯¯å¤„ç†"><a href="#unwindWork-ä»¥åŠ-React-ä¸­çš„é”™è¯¯å¤„ç†" class="headerlink" title="unwindWork ä»¥åŠ React ä¸­çš„é”™è¯¯å¤„ç†"></a>unwindWork ä»¥åŠ React ä¸­çš„é”™è¯¯å¤„ç†</h3><ul>
<li><p>ç±»ä¼¼äº completeWork å¯¹ä¸åŒç±»å‹ç»„ä»¶å¤„ç†</p>
</li>
<li><p>å¯¹äº ShouldCapture ç»„ä»¶è®¾ç½® DidCapture å‰¯ä½œç”¨</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberUnwindWork.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unwindWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">        popLegacyContext(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> effectTag = workInProgress.effectTag;</span><br><span class="line">      <span class="keyword">if</span> (effectTag &amp; ShouldCapture) &#123;</span><br><span class="line">        <span class="comment">// effectTagåŒ…å«ShouldCaptureçš„è¯ï¼Œå°±æŠŠShouldCaptureå»æ‰ï¼ŒåŠ ä¸ŠDidCapture</span></span><br><span class="line">        workInProgress.effectTag = (effectTag &amp; ~ShouldCapture) | DidCapture;</span><br><span class="line">        <span class="keyword">return</span> workInProgress;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      popHostContainer(workInProgress);</span><br><span class="line">      popTopLevelLegacyContextObject(workInProgress);</span><br><span class="line">      <span class="keyword">const</span> effectTag = workInProgress.effectTag;</span><br><span class="line">      invariant(</span><br><span class="line">        (effectTag &amp; DidCapture) === NoEffect,</span><br><span class="line">        <span class="string">&quot;The root failed to unmount after an error. This is likely a bug in &quot;</span> +</span><br><span class="line">          <span class="string">&quot;React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">      workInProgress.effectTag = (effectTag &amp; ~ShouldCapture) | DidCapture;</span><br><span class="line">      <span class="keyword">return</span> workInProgress;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      popHostContext(workInProgress);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> effectTag = workInProgress.effectTag;</span><br><span class="line">      <span class="keyword">if</span> (effectTag &amp; ShouldCapture) &#123;</span><br><span class="line">        workInProgress.effectTag = (effectTag &amp; ~ShouldCapture) | DidCapture;</span><br><span class="line">        <span class="comment">// Captured a suspense effect. Re-render the boundary.</span></span><br><span class="line">        <span class="keyword">return</span> workInProgress;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      popHostContainer(workInProgress);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">case</span> ContextProvider:</span><br><span class="line">      popProvider(workInProgress);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æäº¤é˜¶æ®µ-commitRoot"><a href="#æäº¤é˜¶æ®µ-commitRoot" class="headerlink" title="æäº¤é˜¶æ®µ commitRoot"></a>æäº¤é˜¶æ®µ commitRoot</h2><ul>
<li><p>é¢„å¤‡å·¥ä½œ</p>
</li>
<li><p>ä¸‰ä¸ªå¾ªç¯</p>
</li>
<li><p>å…¶ä»–å·¥ä½œ</p>
</li>
</ul>
<h3 id="å…¥å£-completeRoot"><a href="#å…¥å£-completeRoot" class="headerlink" title="å…¥å£ completeRoot"></a>å…¥å£ completeRoot</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Check if there&#x27;s a batch that matches this expiration time.</span></span><br><span class="line">  <span class="keyword">const</span> firstBatch = root.firstBatch;</span><br><span class="line">  <span class="keyword">if</span> (firstBatch !== <span class="literal">null</span> &amp;&amp; firstBatch._expirationTime &gt;= expirationTime) &#123;</span><br><span class="line">    <span class="keyword">if</span> (completedBatches === <span class="literal">null</span>) &#123;</span><br><span class="line">      completedBatches = [firstBatch];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      completedBatches.push(firstBatch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (firstBatch._defer) &#123;</span><br><span class="line">      <span class="comment">// This root is blocked from committing by a batch. Unschedule it until</span></span><br><span class="line">      <span class="comment">// we receive another update.</span></span><br><span class="line">      root.finishedWork = finishedWork;</span><br><span class="line">      root.expirationTime = NoWork;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Commit the root.</span></span><br><span class="line">  root.finishedWork = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if this is a nested update (a sync update scheduled during the</span></span><br><span class="line">  <span class="comment">// commit phase).</span></span><br><span class="line">  <span class="keyword">if</span> (root === lastCommittedRootDuringThisBatch) &#123;</span><br><span class="line">    <span class="comment">// If the next root is the same as the previous root, this is a nested</span></span><br><span class="line">    <span class="comment">// update. To prevent an infinite loop, increment the nested update count.</span></span><br><span class="line">    nestedUpdateCount++;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Reset whenever we switch roots.</span></span><br><span class="line">    lastCommittedRootDuringThisBatch = root;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  commitRoot(root, finishedWork);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// commitRoot</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRoot</span>(<span class="params">root: FiberRoot, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  isWorking = <span class="literal">true</span>;</span><br><span class="line">  isCommitting = <span class="literal">true</span>;</span><br><span class="line">  startCommitTimer();</span><br><span class="line">  <span class="keyword">const</span> committedExpirationTime = root.pendingCommitExpirationTime;</span><br><span class="line">  root.pendingCommitExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the pending priority levels to account for the work that we are</span></span><br><span class="line">  <span class="comment">// about to commit. This needs to happen before calling the lifecycles, since</span></span><br><span class="line">  <span class="comment">// they may schedule additional updates.</span></span><br><span class="line">  <span class="keyword">const</span> updateExpirationTimeBeforeCommit = finishedWork.expirationTime;</span><br><span class="line">  <span class="keyword">const</span> childExpirationTimeBeforeCommit = finishedWork.childExpirationTime;</span><br><span class="line">  <span class="keyword">const</span> earliestRemainingTimeBeforeCommit =</span><br><span class="line">    childExpirationTimeBeforeCommit &gt; updateExpirationTimeBeforeCommit</span><br><span class="line">      ? childExpirationTimeBeforeCommit</span><br><span class="line">      : updateExpirationTimeBeforeCommit;</span><br><span class="line">  markCommittedPriorityLevels(root, earliestRemainingTimeBeforeCommit);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> prevInteractions: <span class="built_in">Set</span>&lt;Interaction&gt; = (<span class="literal">null</span>: any);</span><br><span class="line">  <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> firstEffect;</span><br><span class="line">  <span class="keyword">if</span> (finishedWork.effectTag &gt; PerformedWork) &#123;</span><br><span class="line">    <span class="comment">// A fiber&#x27;s effect list consists only of its children, not itself. So if</span></span><br><span class="line">    <span class="comment">// the root has an effect, we need to add it to the end of the list. The</span></span><br><span class="line">    <span class="comment">// resulting list is the set that would belong to the root&#x27;s parent, if</span></span><br><span class="line">    <span class="comment">// it had one; that is, all the effects in the tree including the root.</span></span><br><span class="line">    <span class="keyword">if</span> (finishedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">      finishedWork.lastEffect.nextEffect = finishedWork;</span><br><span class="line">      firstEffect = finishedWork.firstEffect;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      firstEffect = finishedWork;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There is no effect on the root.</span></span><br><span class="line">    firstEffect = finishedWork.firstEffect;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  prepareForCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invoke instances of getSnapshotBeforeUpdate before mutation.</span></span><br><span class="line">  nextEffect = firstEffect;</span><br><span class="line">  startCommitSnapshotEffectsTimer();</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> didError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> error;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      commitBeforeMutationLifecycles();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      didError = <span class="literal">true</span>;</span><br><span class="line">      error = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (didError) &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        nextEffect !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;Should have next effect. This error is likely caused by a bug &quot;</span> +</span><br><span class="line">          <span class="string">&quot;in React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">      captureCommitPhaseError(nextEffect, error);</span><br><span class="line">      <span class="comment">// Clean-up</span></span><br><span class="line">      <span class="keyword">if</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stopCommitSnapshotEffectsTimer();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Commit all the side-effects within a tree. We&#x27;ll do this in two passes.</span></span><br><span class="line">  <span class="comment">// The first pass performs all the host insertions, updates, deletions and</span></span><br><span class="line">  <span class="comment">// ref unmounts.</span></span><br><span class="line">  nextEffect = firstEffect;</span><br><span class="line">  startCommitHostEffectsTimer();</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> didError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      commitAllHostEffects();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      didError = <span class="literal">true</span>;</span><br><span class="line">      error = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (didError) &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        nextEffect !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;Should have next effect. This error is likely caused by a bug &quot;</span> +</span><br><span class="line">          <span class="string">&quot;in React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">      captureCommitPhaseError(nextEffect, error);</span><br><span class="line">      <span class="comment">// Clean-up</span></span><br><span class="line">      <span class="keyword">if</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stopCommitHostEffectsTimer();</span><br><span class="line"></span><br><span class="line">  resetAfterCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">  <span class="comment">// the first pass of the commit phase, so that the previous tree is still</span></span><br><span class="line">  <span class="comment">// current during componentWillUnmount, but before the second pass, so that</span></span><br><span class="line">  <span class="comment">// the finished work is current during componentDidMount/Update.</span></span><br><span class="line">  root.current = finishedWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In the second pass we&#x27;ll perform all life-cycles and ref callbacks.</span></span><br><span class="line">  <span class="comment">// Life-cycles happen as a separate pass so that all placements, updates,</span></span><br><span class="line">  <span class="comment">// and deletions in the entire tree have already been invoked.</span></span><br><span class="line">  <span class="comment">// This pass also triggers any renderer-specific initial effects.</span></span><br><span class="line">  nextEffect = firstEffect;</span><br><span class="line">  startCommitLifeCyclesTimer();</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> didError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      commitAllLifeCycles(root, committedExpirationTime);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      didError = <span class="literal">true</span>;</span><br><span class="line">      error = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (didError) &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        nextEffect !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;Should have next effect. This error is likely caused by a bug &quot;</span> +</span><br><span class="line">          <span class="string">&quot;in React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">      captureCommitPhaseError(nextEffect, error);</span><br><span class="line">      <span class="keyword">if</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    enableHooks &amp;&amp;</span><br><span class="line">    firstEffect !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    rootWithPendingPassiveEffects !== <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// This commit included a passive effect. These do not need to fire until</span></span><br><span class="line">    <span class="comment">// after the next paint. Schedule an callback to fire them in an async</span></span><br><span class="line">    <span class="comment">// event. To ensure serial execution, the callback will be flushed early if</span></span><br><span class="line">    <span class="comment">// we enter rootWithPendingPassiveEffects commit phase before then.</span></span><br><span class="line">    <span class="keyword">let</span> callback = commitPassiveEffects.bind(<span class="literal">null</span>, root, firstEffect);</span><br><span class="line">    passiveEffectCallbackHandle = Schedule_scheduleCallback(callback);</span><br><span class="line">    passiveEffectCallback = callback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isCommitting = <span class="literal">false</span>;</span><br><span class="line">  isWorking = <span class="literal">false</span>;</span><br><span class="line">  stopCommitLifeCyclesTimer();</span><br><span class="line">  stopCommitTimer();</span><br><span class="line">  onCommitRoot(finishedWork.stateNode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> updateExpirationTimeAfterCommit = finishedWork.expirationTime;</span><br><span class="line">  <span class="keyword">const</span> childExpirationTimeAfterCommit = finishedWork.childExpirationTime;</span><br><span class="line">  <span class="keyword">const</span> earliestRemainingTimeAfterCommit =</span><br><span class="line">    childExpirationTimeAfterCommit &gt; updateExpirationTimeAfterCommit</span><br><span class="line">      ? childExpirationTimeAfterCommit</span><br><span class="line">      : updateExpirationTimeAfterCommit;</span><br><span class="line">  <span class="keyword">if</span> (earliestRemainingTimeAfterCommit === NoWork) &#123;</span><br><span class="line">    <span class="comment">// If there&#x27;s no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  onCommit(root, earliestRemainingTimeAfterCommit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬ä¸€ä¸ªå¾ªç¯-commitBeforeMutationLifecycles"><a href="#ç¬¬ä¸€ä¸ªå¾ªç¯-commitBeforeMutationLifecycles" class="headerlink" title="ç¬¬ä¸€ä¸ªå¾ªç¯ commitBeforeMutationLifecycles"></a>ç¬¬ä¸€ä¸ªå¾ªç¯ commitBeforeMutationLifecycles</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// commitBeforeMutationLifecycles</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationLifecycles</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; Snapshot) &#123;</span><br><span class="line">      recordEffect();</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">      commitBeforeMutationLifeCycles(current, nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberCommitWork.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationLifeCycles</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      commitHookEffectList(UnmountSnapshot, NoHookEffect, finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (finishedWork.effectTag &amp; Snapshot) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.memoizedProps;</span><br><span class="line">          <span class="keyword">const</span> prevState = current.memoizedState;</span><br><span class="line">          startPhaseTimer(finishedWork, <span class="string">&quot;getSnapshotBeforeUpdate&quot;</span>);</span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.stateNode;</span><br><span class="line">          <span class="comment">// We could update instance props and state here,</span></span><br><span class="line">          <span class="comment">// but instead we rely on them being set during last render.</span></span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> revisit this when we implement resuming.</span></span><br><span class="line">          <span class="comment">// è·å–å¿«ç…§getSnapshotBeforeUpdate</span></span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.getSnapshotBeforeUpdate(</span><br><span class="line">            finishedWork.elementType === finishedWork.type</span><br><span class="line">              ? prevProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, prevProps),</span><br><span class="line">            prevState</span><br><span class="line">          );</span><br><span class="line">          instance.__reactInternalSnapshotBeforeUpdate = snapshot;</span><br><span class="line">          stopPhaseTimer();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">    <span class="keyword">case</span> HostText:</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent:</span><br><span class="line">      <span class="comment">// Nothing to do for these component types</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;This unit of work tag should not have side-effects. This error is &quot;</span> +</span><br><span class="line">          <span class="string">&quot;likely caused by a bug in React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬äºŒä¸ªå¾ªç¯-commitAllHostEffects"><a href="#ç¬¬äºŒä¸ªå¾ªç¯-commitAllHostEffects" class="headerlink" title="ç¬¬äºŒä¸ªå¾ªç¯ commitAllHostEffects"></a>ç¬¬äºŒä¸ªå¾ªç¯ commitAllHostEffects</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitAllHostEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    recordEffect();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹Reset</span></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; ContentReset) &#123;</span><br><span class="line">      commitResetTextContent(nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RefèŠ‚ç‚¹Detach</span></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; Ref) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">        commitDetachRef(current);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤</span></span><br><span class="line">    <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">    <span class="comment">// updates, and deletions. To avoid needing to add a case for every</span></span><br><span class="line">    <span class="comment">// possible bitmap value, we remove the secondary effects from the</span></span><br><span class="line">    <span class="comment">// effect tag and switch on that value.</span></span><br><span class="line">    <span class="keyword">let</span> primaryEffectTag = effectTag &amp; (Placement | Update | Deletion);</span><br><span class="line">    <span class="keyword">switch</span> (primaryEffectTag) &#123;</span><br><span class="line">      <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span></span><br><span class="line">        <span class="comment">// any life-cycles like componentDidMount gets called.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn&#x27;t rely on this any more but isMounted</span></span><br><span class="line">        <span class="comment">// does and isMounted is deprecated anyway so we should be able</span></span><br><span class="line">        <span class="comment">// to kill this.</span></span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement; <span class="comment">// ç°åœ¨æ˜¯åœ¨å¾ªç¯é‡Œé¢ï¼Œæ‰€ä»¥Placementæ‰§è¡Œå®Œäº†å°±å‰”é™¤</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">        <span class="comment">// Placement</span></span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span></span><br><span class="line">        <span class="comment">// any life-cycles like componentDidMount gets called.</span></span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update</span></span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Update: &#123;</span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Deletion: &#123;</span><br><span class="line">        commitDeletion(nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Placement-commitPlacement"><a href="#Placement-commitPlacement" class="headerlink" title="Placement commitPlacement"></a>Placement commitPlacement</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberCommitWork.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPlacement</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Recursively insert all host nodes into the parent.</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line">  <span class="keyword">let</span> parent;</span><br><span class="line">  <span class="keyword">let</span> isContainer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      parent = parentFiber.stateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      parent = parentFiber.stateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      parent = parentFiber.stateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Invalid host parent fiber. This error is likely caused by a bug &quot;</span> +</span><br><span class="line">          <span class="string">&quot;in React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parentFiber.effectTag &amp; ContentReset) &#123;</span><br><span class="line">    <span class="comment">// Reset the text content of the parent before doing any insertions</span></span><br><span class="line">    resetTextContent(parent);</span><br><span class="line">    <span class="comment">// Clear ContentReset from the effect tag</span></span><br><span class="line">    parentFiber.effectTag &amp;= ~ContentReset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> before = getHostSibling(finishedWork);</span><br><span class="line">  <span class="comment">// We only have the top Fiber that was inserted but we need recurse down its</span></span><br><span class="line">  <span class="comment">// children to find all the terminal nodes.</span></span><br><span class="line">  <span class="keyword">let</span> node: Fiber = finishedWork;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">      <span class="keyword">if</span> (before) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">          insertInContainerBefore(parent, node.stateNode, before);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          insertBefore(parent, node.stateNode, before);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">          appendChildToContainer(parent, node.stateNode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          appendChild(parent, node.stateNode);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) &#123;</span><br><span class="line">      <span class="comment">// If the insertion itself is a portal, then we don&#x27;t want to traverse</span></span><br><span class="line">      <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">      <span class="comment">// the portal directly.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      node.child.return = node;</span><br><span class="line">      node = node.child;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node === finishedWork) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === finishedWork) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return;</span><br><span class="line">    &#125;</span><br><span class="line">    node.sibling.return = node.return;</span><br><span class="line">    node = node.sibling;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Update-commitWork"><a href="#Update-commitWork" class="headerlink" title="Update commitWork"></a>Update commitWork</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitWork</span>(<span class="params">current: Fiber | <span class="literal">null</span>, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> MemoComponent:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="comment">// Note: We currently never use MountMutation, but useLayout uses</span></span><br><span class="line">        <span class="comment">// UnmountMutation.</span></span><br><span class="line">        commitHookEffectList(UnmountMutation, MountMutation, finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    commitContainer(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="comment">// Note: We currently never use MountMutation, but useLayout uses</span></span><br><span class="line">      <span class="comment">// UnmountMutation.</span></span><br><span class="line">      commitHookEffectList(UnmountMutation, MountMutation, finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.memoizedProps;</span><br><span class="line">        <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.memoizedProps : newProps;</span><br><span class="line">        <span class="keyword">const</span> type = finishedWork.type;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªå°±æ˜¯éœ€è¦æ›´æ–°çš„å¯¹è±¡æ•°ç»„updatePayload</span></span><br><span class="line">        <span class="keyword">const</span> updatePayload: <span class="literal">null</span> | UpdatePayload =</span><br><span class="line">          (finishedWork.updateQueue: any);</span><br><span class="line">        finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          commitUpdate(</span><br><span class="line">            instance,</span><br><span class="line">            updatePayload,</span><br><span class="line">            type,</span><br><span class="line">            oldProps,</span><br><span class="line">            newProps,</span><br><span class="line">            finishedWork</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        finishedWork.stateNode !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;This should have a text node initialized. This error is likely &quot;</span> +</span><br><span class="line">          <span class="string">&quot;caused by a bug in React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> textInstance: TextInstance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">const</span> newText: string = finishedWork.memoizedProps;</span><br><span class="line">      <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">      <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">      <span class="comment">// this case.</span></span><br><span class="line">      <span class="keyword">const</span> oldText: string =</span><br><span class="line">        current !== <span class="literal">null</span> ? current.memoizedProps : newText;</span><br><span class="line">      commitTextUpdate(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">      <span class="keyword">let</span> newState: SuspenseState | <span class="literal">null</span> = finishedWork.memoizedState;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> newDidTimeout;</span><br><span class="line">      <span class="keyword">let</span> primaryChildParent = finishedWork;</span><br><span class="line">      <span class="keyword">if</span> (newState === <span class="literal">null</span>) &#123;</span><br><span class="line">        newDidTimeout = <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newDidTimeout = <span class="literal">true</span>;</span><br><span class="line">        primaryChildParent = finishedWork.child;</span><br><span class="line">        <span class="keyword">if</span> (newState.timedOutAt === NoWork) &#123;</span><br><span class="line">          <span class="comment">// If the children had not already timed out, record the time.</span></span><br><span class="line">          <span class="comment">// This is used to compute the elapsed time during subsequent</span></span><br><span class="line">          <span class="comment">// attempts to render the children.</span></span><br><span class="line">          newState.timedOutAt = requestCurrentTime();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (primaryChildParent !== <span class="literal">null</span>) &#123;</span><br><span class="line">        hideOrUnhideAllChildren(primaryChildParent, newDidTimeout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If this boundary just timed out, then it will have a set of thenables.</span></span><br><span class="line">      <span class="comment">// For each thenable, attach a listener so that when it resolves, React</span></span><br><span class="line">      <span class="comment">// attempts to re-render the boundary in the primary (pre-timeout) state.</span></span><br><span class="line">      <span class="keyword">const</span> thenables: <span class="built_in">Set</span>&lt;Thenable&gt; | <span class="literal">null</span> = (finishedWork.updateQueue: any);</span><br><span class="line">      <span class="keyword">if</span> (thenables !== <span class="literal">null</span>) &#123;</span><br><span class="line">        finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> retryCache = finishedWork.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (retryCache === <span class="literal">null</span>) &#123;</span><br><span class="line">          retryCache = finishedWork.stateNode = <span class="keyword">new</span> PossiblyWeakSet();</span><br><span class="line">        &#125;</span><br><span class="line">        thenables.forEach(<span class="function">(<span class="params">thenable</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// Memoize using the boundary fiber to prevent redundant listeners.</span></span><br><span class="line">          <span class="keyword">let</span> retry = retryTimedOutBoundary.bind(<span class="literal">null</span>, finishedWork, thenable);</span><br><span class="line">          <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">            retry = Schedule_tracing_wrap(retry);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!retryCache.has(thenable)) &#123;</span><br><span class="line">            retryCache.add(thenable);</span><br><span class="line">            thenable.then(retry, retry);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;This unit of work tag should not have side-effects. This error is &quot;</span> +</span><br><span class="line">          <span class="string">&quot;likely caused by a bug in React. Please file an issue.&quot;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-dom\src\client\ReactDOMHostConfig.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domElement: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  updatePayload: <span class="built_in">Array</span>&lt;mixed&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldProps: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">  newProps: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">  internalInstanceHandle: <span class="built_in">Object</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Update the props handle so that we know which props are the ones with</span></span><br><span class="line">  <span class="comment">// with current event handlers.</span></span><br><span class="line">  updateFiberProps(domElement, newProps);</span><br><span class="line">  <span class="comment">// Apply the diff to the DOM node.</span></span><br><span class="line">  updateProperties(domElement, updatePayload, type, oldProps, newProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬ä¸‰ä¸ªå¾ªç¯-commitAllLifeCycles"><a href="#ç¬¬ä¸‰ä¸ªå¾ªç¯-commitAllLifeCycles" class="headerlink" title="ç¬¬ä¸‰ä¸ªå¾ªç¯ commitAllLifeCycles"></a>ç¬¬ä¸‰ä¸ªå¾ªç¯ commitAllLifeCycles</h3><h2 id="å…¶ä»–-1"><a href="#å…¶ä»–-1" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="context"><a href="#context" class="headerlink" title="context"></a>context</h3><h3 id="event-äº‹ä»¶ç³»ç»Ÿåˆå§‹åŒ–-æ³¨å…¥å¹³å°äº‹ä»¶æ’ä»¶"><a href="#event-äº‹ä»¶ç³»ç»Ÿåˆå§‹åŒ–-æ³¨å…¥å¹³å°äº‹ä»¶æ’ä»¶" class="headerlink" title="event äº‹ä»¶ç³»ç»Ÿåˆå§‹åŒ– æ³¨å…¥å¹³å°äº‹ä»¶æ’ä»¶"></a>event äº‹ä»¶ç³»ç»Ÿåˆå§‹åŒ– æ³¨å…¥å¹³å°äº‹ä»¶æ’ä»¶</h3><ul>
<li><p>ç¡®å®šæ’ä»¶æ³¨å…¥é¡ºåº</p>
</li>
<li><p>æ³¨å…¥æ’ä»¶æ¨¡å—åº</p>
</li>
<li><p>è®¡ç®— registrationModuleNames ç­‰å±æ€§</p>
</li>
</ul>
<h2 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h2><h3 id="Hooks-çš„å®šä¹‰ä»¥åŠæ‰§è¡Œå‰åçš„å‡†å¤‡å’Œé‡ç½®"><a href="#Hooks-çš„å®šä¹‰ä»¥åŠæ‰§è¡Œå‰åçš„å‡†å¤‡å’Œé‡ç½®" class="headerlink" title="Hooks çš„å®šä¹‰ä»¥åŠæ‰§è¡Œå‰åçš„å‡†å¤‡å’Œé‡ç½®"></a>Hooks çš„å®šä¹‰ä»¥åŠæ‰§è¡Œå‰åçš„å‡†å¤‡å’Œé‡ç½®</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages\react\src\React.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;enableHooks&#125; <span class="keyword">from</span> <span class="string">&#x27;shared/ReactFeatureFlags&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  useCallback,</span><br><span class="line">  useContext,</span><br><span class="line">  useEffect,</span><br><span class="line">  useImperativeMethods,</span><br><span class="line">  useLayoutEffect,</span><br><span class="line">  useMemo,</span><br><span class="line">  useReducer,</span><br><span class="line">  useRef,</span><br><span class="line">  useState,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./ReactHooks&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> React = &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (enableHooks) &#123;</span><br><span class="line">  React.useCallback = useCallback;</span><br><span class="line">  React.useContext = useContext;</span><br><span class="line">  React.useEffect = useEffect;</span><br><span class="line">  React.useImperativeMethods = useImperativeMethods;</span><br><span class="line">  React.useLayoutEffect = useLayoutEffect;</span><br><span class="line">  React.useMemo = useMemo;</span><br><span class="line">  React.useReducer = useReducer;</span><br><span class="line">  React.useRef = useRef;</span><br><span class="line">  React.useState = useState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactHooks.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useState</span>&lt;<span class="title">S</span>&gt;(<span class="params">initialState: (() =&gt; S) | S</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = resolveDispatcher();</span><br><span class="line">  <span class="keyword">return</span> dispatcher.useState(initialState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ReactCurrentOwner <span class="keyword">from</span> <span class="string">&#x27;./ReactCurrentOwner&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveDispatcher</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = ReactCurrentOwner.currentDispatcher;</span><br><span class="line">  <span class="keyword">return</span> dispatcher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react\src\ReactCurrentOwner.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Keeps track of the current owner.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The current owner is the component who should own any components that are</span></span><br><span class="line"><span class="comment"> * currently being constructed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ReactCurrentOwner = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@type <span class="type">&#123;ReactComponent&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  current: (<span class="literal">null</span>: <span class="literal">null</span> | Fiber),</span><br><span class="line">  currentDispatcher: (<span class="literal">null</span>: <span class="literal">null</span> | Dispatcher),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ReactCurrentOwner;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberScheduler.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRoot</span>(<span class="params">root: FiberRoot, isYieldy: boolean</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  flushPassiveEffects();</span><br><span class="line"></span><br><span class="line">  isWorking = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (enableHooks) &#123;</span><br><span class="line">    ReactCurrentOwner.currentDispatcher = Dispatcher;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ReactCurrentOwner.currentDispatcher = DispatcherWithoutHooks;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberDispatcher.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;readContext&#125; <span class="keyword">from</span> <span class="string">&#x27;./ReactFiberNewContext&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  useCallback,</span><br><span class="line">  useContext,</span><br><span class="line">  useEffect,</span><br><span class="line">  useImperativeMethods,</span><br><span class="line">  useLayoutEffect,</span><br><span class="line">  useMemo,</span><br><span class="line">  useReducer,</span><br><span class="line">  useRef,</span><br><span class="line">  useState,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./ReactFiberHooks&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Dispatcher = &#123;</span><br><span class="line">  readContext,</span><br><span class="line">  useCallback,</span><br><span class="line">  useContext,</span><br><span class="line">  useEffect,</span><br><span class="line">  useImperativeMethods,</span><br><span class="line">  useLayoutEffect,</span><br><span class="line">  useMemo,</span><br><span class="line">  useReducer,</span><br><span class="line">  useRef,</span><br><span class="line">  useState,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DispatcherWithoutHooks = &#123;</span><br><span class="line">  readContext,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\react-reconciler\src\ReactFiberHooks.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useState</span>&lt;<span class="title">S</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  initialState: (() =&gt; S) | S,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): [<span class="title">S</span>, <span class="title">Dispatch</span>&lt;<span class="title">BasicStateAction</span>&lt;<span class="title">S</span>&gt;&gt;] </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> useReducer(</span><br><span class="line">    basicStateReducer,</span><br><span class="line">    <span class="comment">// useReducer has a special case to support lazy useState initializers</span></span><br><span class="line">    (initialState: any),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">basicStateReducer</span>&lt;<span class="title">S</span>&gt;(<span class="params">state: S, action: BasicStateAction&lt;S&gt;</span>): <span class="title">S</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span> ? action(state) : action;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useReducer</span>&lt;<span class="title">S</span>, <span class="title">A</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  reducer: (S, A) =&gt; S,</span></span></span><br><span class="line"><span class="function"><span class="params">  initialState: S,</span></span></span><br><span class="line"><span class="function"><span class="params">  initialAction: A | <span class="keyword">void</span> | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): [<span class="title">S</span>, <span class="title">Dispatch</span>&lt;<span class="title">A</span>&gt;] </span>&#123;</span><br><span class="line">  currentlyRenderingFiber = resolveCurrentlyRenderingFiber();</span><br><span class="line">  workInProgressHook = createWorkInProgressHook();</span><br><span class="line">  <span class="keyword">let</span> queue: UpdateQueue&lt;A&gt; | <span class="literal">null</span> = (workInProgressHook.queue: any);</span><br><span class="line">  <span class="keyword">if</span> (queue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Already have a queue, so this is an update.</span></span><br><span class="line">    <span class="keyword">if</span> (isReRender) &#123;</span><br><span class="line">      <span class="comment">// This is a re-render. Apply the new render phase updates to the previous</span></span><br><span class="line">      <span class="comment">// work-in-progress hook.</span></span><br><span class="line">      <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch: any);</span><br><span class="line">      <span class="keyword">if</span> (renderPhaseUpdates !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Render phase updates are stored in a map of queue -&gt; linked list</span></span><br><span class="line">        <span class="keyword">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);</span><br><span class="line">        <span class="keyword">if</span> (firstRenderPhaseUpdate !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          renderPhaseUpdates.delete(queue);</span><br><span class="line">          <span class="keyword">let</span> newState = workInProgressHook.memoizedState;</span><br><span class="line">          <span class="keyword">let</span> update = firstRenderPhaseUpdate;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// Process this render phase update. We don&#x27;t have to check the</span></span><br><span class="line">            <span class="comment">// priority because it will always be the same as the current</span></span><br><span class="line">            <span class="comment">// render&#x27;s.</span></span><br><span class="line">            <span class="keyword">const</span> action = update.action;</span><br><span class="line">            newState = reducer(newState, action);</span><br><span class="line">            update = update.next;</span><br><span class="line">          &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">          workInProgressHook.memoizedState = newState;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Don&#x27;t persist the state accumlated from the render phase updates to</span></span><br><span class="line">          <span class="comment">// the base state unless the queue is empty.</span></span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Not sure if this is the desired semantics, but it&#x27;s what we</span></span><br><span class="line">          <span class="comment">// do for gDSFP. I can&#x27;t remember why.</span></span><br><span class="line">          <span class="keyword">if</span> (workInProgressHook.baseUpdate === queue.last) &#123;</span><br><span class="line">            workInProgressHook.baseState = newState;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> [newState, dispatch];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> [workInProgressHook.memoizedState, dispatch];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The last update in the entire queue</span></span><br><span class="line">    <span class="keyword">const</span> last = queue.last;</span><br><span class="line">    <span class="comment">// The last update that is part of the base state.</span></span><br><span class="line">    <span class="keyword">const</span> baseUpdate = workInProgressHook.baseUpdate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the first unprocessed update.</span></span><br><span class="line">    <span class="keyword">let</span> first;</span><br><span class="line">    <span class="keyword">if</span> (baseUpdate !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (last !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// For the first update, the queue is a circular linked list where</span></span><br><span class="line">        <span class="comment">// `queue.last.next = queue.first`. Once the first update commits, and</span></span><br><span class="line">        <span class="comment">// the `baseUpdate` is no longer empty, we can unravel the list.</span></span><br><span class="line">        last.next = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      first = baseUpdate.next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      first = last !== <span class="literal">null</span> ? last.next : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> newState = workInProgressHook.baseState;</span><br><span class="line">      <span class="keyword">let</span> newBaseState = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">let</span> newBaseUpdate = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">let</span> prevUpdate = baseUpdate;</span><br><span class="line">      <span class="keyword">let</span> update = first;</span><br><span class="line">      <span class="keyword">let</span> didSkip = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">        <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">          <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">          <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">          <span class="comment">// update/state.</span></span><br><span class="line">          <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">            didSkip = <span class="literal">true</span>;</span><br><span class="line">            newBaseUpdate = prevUpdate;</span><br><span class="line">            newBaseState = newState;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">          <span class="keyword">if</span> (updateExpirationTime &gt; remainingExpirationTime) &#123;</span><br><span class="line">            remainingExpirationTime = updateExpirationTime;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Process this update.</span></span><br><span class="line">          <span class="keyword">const</span> action = update.action;</span><br><span class="line">          newState = reducer(newState, action);</span><br><span class="line">        &#125;</span><br><span class="line">        prevUpdate = update;</span><br><span class="line">        update = update.next;</span><br><span class="line">      &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">        newBaseUpdate = prevUpdate;</span><br><span class="line">        newBaseState = newState;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      workInProgressHook.memoizedState = newState;</span><br><span class="line">      workInProgressHook.baseUpdate = newBaseUpdate;</span><br><span class="line">      workInProgressHook.baseState = newBaseState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch: any);</span><br><span class="line">    <span class="keyword">return</span> [workInProgressHook.memoizedState, dispatch];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// There&#x27;s no existing queue, so this is the initial render.</span></span><br><span class="line">  <span class="keyword">if</span> (reducer === basicStateReducer) &#123;</span><br><span class="line">    <span class="comment">// Special case for `useState`.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      initialState = initialState();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialAction !== <span class="literal">undefined</span> &amp;&amp; initialAction !== <span class="literal">null</span>) &#123;</span><br><span class="line">    initialState = reducer(initialState, initialAction);</span><br><span class="line">  &#125;</span><br><span class="line">  workInProgressHook.memoizedState = workInProgressHook.baseState = initialState;</span><br><span class="line">  queue = workInProgressHook.queue = &#123;</span><br><span class="line">    last: <span class="literal">null</span>,</span><br><span class="line">    dispatch: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch = (dispatchAction.bind(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    currentlyRenderingFiber,</span><br><span class="line">    queue,</span><br><span class="line">  ): any));</span><br><span class="line">  <span class="keyword">return</span> [workInProgressHook.memoizedState, dispatch];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>useState çš„åº•å±‚ç»“æ„è¿˜æ˜¯ Fiberï¼Œåœ¨å‡½æ•°ç»„ä»¶é‡Œé¢å‡½æ•°ç»„ä»¶æœ¬èº«æ˜¯ä¸€ä¸ª Fiberï¼Œè€Œ hooks åˆ™æ˜¯æ›´ç»†ç²’åº¦çš„ Fiber</p>
</blockquote>
]]></content>
      <categories>
        <category>UIæ¡†æ¶</category>
        <category>è‰ç¨¿</category>
      </categories>
      <tags>
        <tag>React</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
</search>
